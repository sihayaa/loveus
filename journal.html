<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Journal Book â€” 760Ã—1060, passcode 123</title>
<link href="https://fonts.googleapis.com/css2?family=Lobster&display=swap" rel="stylesheet">
<style>
:root{
  --pageW:760px; --pageH:1060px;            /* scrapbook size */
  --bg:#0b0f2f; --paper:#f7eddc; --ink:#0d2a6b;
  --accent:#7a5af8; --mint:#67e4ca; --font:"Lobster",cursive;
}
*{box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{
  margin:0;background:var(--bg);color:var(--ink);font-family:var(--font);
  display:flex;align-items:center;justify-content:center
}

/* Stage + pages */
#stage{position:relative;width:var(--pageW);height:var(--pageH);transform-origin:center;overflow:visible}
.deck{position:absolute;inset:0;perspective:1200px}

.page{
  position:absolute;inset:0;background:var(--paper);border-radius:20px;border:2px solid #efe6d5;
  box-shadow:inset 0 0 60px rgba(0,0,0,.22),0 18px 40px rgba(0,0,0,.35);
  overflow:hidden;transform-origin:center;transition:transform .45s cubic-bezier(.2,.7,.2,1),opacity .45s,filter .45s;
  opacity:.9;filter:saturate(.95);pointer-events:none;z-index:0
}
.page .page-canvas{position:relative;width:100%;height:100%;padding:28px;font-size:22px;line-height:1.35}

.page.active{opacity:1;filter:none;pointer-events:auto;z-index:3}
.pos--2{transform:translateX(-70px) rotate(-1.2deg) scale(.95);z-index:1}
.pos--1{transform:translateX(-36px) rotate(-.6deg) scale(.975);z-index:2}
.active{transform:translateX(0) rotate(0) scale(1);z-index:3}
.pos-1{transform:translateX(36px) rotate(.6deg) scale(.975);z-index:2}
.pos-2{transform:translateX(70px) rotate(1.2deg) scale(.95);z-index:1}

/* === FULL-PAGE COVER via ::before (bulletproof) === */
.page.cover{
  background:transparent !important;   /* keep base transparent */
}
.page.cover .page-canvas{
  display:none !important;             /* hide inner beige canvas on cover */
  padding:0 !important;
  background:none !important;
  pointer-events:none !important;
}
.page.cover::before{
  content:""; position:absolute; inset:0; border-radius:inherit; z-index:0; pointer-events:none;
  background:#0c102c;
  background-image:
    url("https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/journal-bg.png"),
    radial-gradient(closest-side at 50% 40%, #1d2a55 0%, #0c102c 60%);
  background-size: cover, auto;          /* image fills whole page */
  background-position: 50% 28%, center;  /* tweak vertical framing like your sample */
  background-repeat: no-repeat;
}
/* Never allow content on the cover */
.page.cover .scrap-item{display:none!important}

/* Scrap items */
.scrap-item{position:absolute;transform-origin:center;touch-action:none;overflow:visible}
.scrap-item.selected{box-shadow:0 0 0 3px var(--accent)}
.rotator,.mover,.resizer{display:none}
.rotator{position:absolute;left:50%;top:-18px;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;background:#fff;border:3px solid var(--accent);box-shadow:0 2px 8px rgba(0,0,0,.25);cursor:grab;z-index:999}
.mover{position:absolute;left:-10px;top:-10px;width:18px;height:18px;border-radius:50%;background:#fff;border:3px solid var(--accent);cursor:grab}
.resizer{position:absolute;right:-6px;bottom:-6px;width:16px;height:16px;border-radius:4px;background:var(--mint);border:2px solid #0b2c28;cursor:nwse-resize}
.scrap-img{display:block;width:100%;height:100%;object-fit:contain;user-select:none;pointer-events:none;border-radius:16px}
.scrap-item[data-fit="cover"] .scrap-img{object-fit:cover}
.scrap-text{width:100%;background:transparent;border:0;color:inherit;font:inherit;white-space:pre-wrap;overflow:visible;min-height:1.2em}

/* Editability */
.page .page-canvas, .scrap-item { pointer-events:none }
body.editing .page.active .page-canvas, body.editing .scrap-item { pointer-events:auto }
body.editing .scrap-item{cursor:move}
body.editing .scrap-item .rotator, body.editing .scrap-item .mover, body.editing .scrap-item .resizer{display:block}

/* Toolbar */
#toolbar{
  position:fixed;right:16px;top:50%;transform:translateY(-50%);z-index:100;background:#fff;
  border:2px solid #e8dcc6;border-radius:14px;padding:12px;width:260px;gap:10px;
  box-shadow:0 10px 22px rgba(0,0,0,.25);display:none;flex-direction:column
}
#toolbar.open{display:flex}
#toolbar .group{display:flex;gap:8px;flex-wrap:wrap}
#toolbar button{border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700;color:#fff;background:var(--accent);width:100%}
#toolbar button.secondary{background:#5d47d4}
#toolbar button.mint{background:var(--mint);color:#022d2c}
#toolbar button.warn{background:#ff9aa2;color:#4c0a17}
#toolbar input[type="number"], #toolbar select{width:100%;padding:8px;border-radius:8px;border:2px solid #e8dcc6;font-weight:700;color:#0d2a6b;background:#fff}
#toolbar input[type="color"]{width:100%;height:40px;padding:0;border:2px solid #e8dcc6;border-radius:8px;background:#fff}
#toolbar input[type="text"]{width:100%;padding:8px;border-radius:8px;border:2px solid #e8dcc6;font-weight:700;color:#0d2a6b;background:#fff;font-family:monospace}

/* Big text editor */
#textEditor{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:10000;align-items:center;justify-content:center}
#textEditor.open{display:flex}
#textEditor .panel{width:min(820px,90vw);background:#fff;border-radius:16px;padding:18px;border:2px solid #e8dcc6;box-shadow:0 20px 60px rgba(0,0,0,.5)}
#textEditor textarea{width:100%;height:320px;font:28px/1.35 var(--font);color:#0d2a6b;padding:12px;border:2px solid #e8dcc6;border-radius:12px;resize:vertical}
#textEditor .row{display:flex;gap:12px;margin-top:10px}
#textEditor input[type="number"]{flex:1;padding:10px;border-radius:10px;border:2px solid #e8dcc6;font-weight:700;color:#0d2a6b}
#textEditor input[type="color"]{width:110px;height:44px;border-radius:10px;border:2px solid #e8dcc6}
#textEditor input[type="text"]{width:110px;height:44px;border-radius:10px;border:2px solid #e8dcc6;padding:0 10px;font-weight:700;color:#0d2a6b;font-family:monospace}
#textEditor .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
#textEditor button{border:0;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer}
#editorCancel{background:#ff9aa2;color:#4c0a17}
#editorSave{background:var(--mint);color:#022d2c}
.scrap-text[contenteditable="true"]{outline:2px dashed #7a5af888;outline-offset:4px}

/* Nav + Add Page */
.nav{position:absolute;top:50%;transform:translateY(-50%);border:0;width:56px;height:56px;border-radius:50%;cursor:pointer;z-index:10;
  background:#ffffffd8;box-shadow:0 10px 22px rgba(0,0,0,.25);font-weight:900;font-size:22px;color:#182042;display:grid;place-items:center}
.nav.left{left:-72px} .nav.right{right:-72px} .nav:active{transform:translateY(-50%) scale(.96)} .nav.disabled{opacity:.45;pointer-events:none}

.addpage{position:absolute;left:50%;bottom:-64px;transform:translateX(-50%);border:0;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:900;
  background:#ffffffd8;color:#182042;box-shadow:0 10px 22px rgba(0,0,0,.25);display:none}
body.editing .addpage{display:block}
</style>
</head>
<body>

<div id="stage">
  <div class="deck" id="deck">
    <!-- Cover + 5 blank pages -->
    <div class="page cover active" data-page="1"><div class="page-canvas"></div></div>
    <div class="page" data-page="2"><div class="page-canvas"></div></div>
    <div class="page" data-page="3"><div class="page-canvas"></div></div>
    <div class="page" data-page="4"><div class="page-canvas"></div></div>
    <div class="page" data-page="5"><div class="page-canvas"></div></div>
    <div class="page" data-page="6"><div class="page-canvas"></div></div>
  </div>
  <button class="nav left"  id="prev" aria-label="Previous">â—€</button>
  <button class="nav right" id="next" aria-label="Next">â–¶</button>
  <button class="addpage" id="addPageBtn" title="Add Page">ï¼‹ Add Page</button>
</div>

<!-- Toolbar -->
<div id="toolbar" aria-hidden="true" inert>
  <div class="group">
    <button id="addTextBtn" class="mint">Add Text</button>
    <button id="editSelectedBtn" class="secondary">Edit Selected</button>
  </div>
  <div class="group">
    <button id="addPhotoBtn" class="secondary">Add Photo</button>
    <input id="fileInput" type="file" accept="image/*">
  </div>
  <div class="group">
    <label style="font-weight:700;color:#0d2a6b;">Text Size (px)</label>
    <input id="fontSizeInput" type="number" min="8" max="200" step="1" placeholder="px" disabled>
  </div>
  <div class="group">
    <label style="font-weight:700;color:#0d2a6b;">Text Color</label>
    <input id="fontColorInput" type="color" value="#0d2a6b" disabled>
    <input id="fontHexInput" type="text" placeholder="#RRGGBB" value="#0d2a6b" disabled>
  </div>
  <div class="group">
    <button id="fitToggleBtn"  class="secondary">Fit: Contain</button>
    <button id="lockToggleBtn" class="secondary">Lock: On</button>
  </div>
  <div class="group">
    <button id="deleteSelectedBtn" class="warn">Delete Selected</button>
    <button id="clearPageBtn" class="warn">Clear Page</button>
    <button id="saveBtn" class="mint">Save Page</button>
  </div>
  <div class="group">
    <button id="exitEdit" class="warn">Exit Edit</button>
    <button id="hideBar">ðŸ”’ Hide</button>
  </div>
</div>

<!-- Big Text Editor -->
<div id="textEditor" aria-hidden="true" inert>
  <div class="panel">
    <h3 style="margin:0 0 8px;color:#0d2a6b">Edit Text</h3>
    <textarea id="editorInput" placeholder="type hereâ€¦"></textarea>
    <div class="row">
      <label style="font-weight:700;color:#0d2a6b;display:flex;align-items:center;gap:8px;">
        Size (px)
        <input id="editorSize" type="number" min="8" max="200" step="1" value="28">
      </label>
      <label style="font-weight:700;color:#0d2a6b;display:flex;align-items:center;gap:8px;">
        Color
        <input id="editorColor" type="color" value="#0d2a6b">
        <input id="editorHex" type="text" value="#0d2a6b" placeholder="#RRGGBB">
      </label>
    </div>
    <div class="actions">
      <button id="editorCancel">Cancel</button>
      <button id="editorSave">Save</button>
    </div>
  </div>
</div>

<script>
(function(){
  /* ===== Supabase (separate from scrapbook) ===== */
  const SUPABASE_URL  = "https://tmjozxcjylcxgemffnoc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
  const BUCKET   = "journalbook";
  const STATE_ID = "journal_main";

  const apiHeaders = {
    apikey: SUPABASE_ANON,
    Authorization: "Bearer " + SUPABASE_ANON,
    "Content-Type": "application/json",
    Accept: "application/json"
  };

  /* ===== Essentials ===== */
  const deck = document.getElementById('deck');
  const stage = document.getElementById('stage');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const addPageBtn = document.getElementById('addPageBtn');

  const toolbar = document.getElementById('toolbar');
  const fileInput = document.getElementById('fileInput');
  const addTextBtn = document.getElementById('addTextBtn');
  const editSelectedBtn = document.getElementById('editSelectedBtn');
  const addPhotoBtn = document.getElementById('addPhotoBtn');
  const clearPageBtn = document.getElementById('clearPageBtn');
  const saveBtn = document.getElementById('saveBtn');
  const hideBar = document.getElementById('hideBar');
  const exitEdit = document.getElementById('exitEdit');
  const fontSizeInput = document.getElementById('fontSizeInput');
  const fontColorInput = document.getElementById('fontColorInput');
  const fontHexInput = document.getElementById('fontHexInput');
  const fitToggleBtn = document.getElementById('fitToggleBtn');
  const lockToggleBtn = document.getElementById('lockToggleBtn');

  const editor = {
    el: document.getElementById('textEditor'),
    input: document.getElementById('editorInput'),
    size: document.getElementById('editorSize'),
    color: document.getElementById('editorColor'),
    hex:   document.getElementById('editorHex'),
    save: document.getElementById('editorSave'),
    cancel: document.getElementById('editorCancel'),
    targetBox: null
  };

  let current = 0;
  let selectedItem = null, zCounter = 10;

  /* Fit stage to viewport */
  function fitStage(){
    const vw=innerWidth, vh=innerHeight, mx=200, my=40;
    const s=Math.min(1, vw/(parseInt(getComputedStyle(stage).width)+mx),
                        vh/(parseInt(getComputedStyle(stage).height)+my));
    stage.style.transform='scale('+s+')';
  }
  fitStage(); addEventListener('resize', fitStage);

  const getPages = () => Array.from(deck.querySelectorAll('.page'));

  function setClasses(){
    const pages=getPages();
    pages.forEach((p,i)=>{
      p.classList.remove('pos--2','pos--1','pos-1','pos-2','active');
      if(i===current)   p.classList.add('active');
      if(i===current-1) p.classList.add('pos--1');
      if(i===current-2) p.classList.add('pos--2');
      if(i===current+1) p.classList.add('pos-1');
      if(i===current+2) p.classList.add('pos-2');
    });
    prevBtn.classList.toggle('disabled', current===0);
  }
  function go(delta){
    const n=getPages().length; let next=current+delta;
    if(delta>0 && next>=n) next=0;
    if(delta<0 && next<0) next=0;
    if(next!==current){ current=next; setClasses(); }
  }
  prevBtn.onclick = () => go(-1);
  nextBtn.onclick = () => go(1);
  deck.addEventListener('mousedown', e=>{
    if(!document.body.classList.contains('editing')) return;
    const pg=e.target.closest('.page'); if(!pg) return;
    current=getPages().indexOf(pg); setClasses();
  });

  /* Show/hide UI */
  function showToolbar(){ toolbar.classList.add('open'); toolbar.removeAttribute('aria-hidden'); toolbar.removeAttribute('inert'); }
  function hideToolbar(){ if(toolbar.contains(document.activeElement)) document.activeElement.blur();
    toolbar.classList.remove('open'); toolbar.setAttribute('aria-hidden','true'); toolbar.setAttribute('inert',''); }
  function showEditor(){ editor.el.classList.add('open'); editor.el.removeAttribute('aria-hidden'); editor.el.removeAttribute('inert'); setTimeout(()=>editor.input.focus(),0); }
  function hideEditor(){ if(editor.el.contains(document.activeElement)) document.activeElement.blur();
    editor.el.classList.remove('open'); editor.el.setAttribute('aria-hidden','true'); editor.el.setAttribute('inert',''); }

  /* Passcode = 123 */
  const PASSCODE='123'; let keyBuf=''; let keyTimer=null;
  function normDigit(e){
    if(e.key==='1'||e.code==='Digit1'||e.code==='Numpad1')return'1';
    if(e.key==='2'||e.code==='Digit2'||e.code==='Numpad2')return'2';
    if(e.key==='3'||e.code==='Digit3'||e.code==='Numpad3')return'3';
    return /^[0-9]$/.test(e.key)?e.key:'';
  }
  addEventListener('keydown',e=>{
    if(e.ctrlKey||e.metaKey||e.altKey) return;
    const d=normDigit(e); if(!d) return;
    keyBuf+=d; clearTimeout(keyTimer); keyTimer=setTimeout(()=>keyBuf='',1200);
    if(keyBuf.endsWith(PASSCODE)){ keyBuf=''; enterEdit(); }
  });
  function enterEdit(){ document.body.classList.add('editing'); showToolbar(); setClasses(); }
  function exitEditMode(){ document.body.classList.remove('editing'); hideToolbar(); deselect(); }
  exitEdit.onclick=exitEditMode; hideBar.onclick=hideToolbar;

  /* Text editor */
  addTextBtn.onclick=()=>{ if(current===0){ alert('Cover is fixed and cannot be edited.'); return; } openTextEditor(); };
  editSelectedBtn.onclick=()=>{
    if(current===0){ alert('Cover is fixed.'); return; }
    const t=selectedItem?.querySelector('.scrap-text'); if(!t) return;
    openTextEditor({ text:t.textContent, size:parseInt(getComputedStyle(t).fontSize)||28, color:rgbToHex(getComputedStyle(t).color), targetBox:selectedItem });
  };
  editor.cancel.onclick=()=>hideEditor();
  document.getElementById('textEditor').addEventListener('click',e=>{ if(e.target.id==='textEditor') hideEditor(); });

  function openTextEditor({text='',size=28,color='#0d2a6b',targetBox=null}={}){
    editor.targetBox=targetBox; editor.input.value=text; editor.size.value=size; editor.color.value=color; editor.hex.value=color; showEditor();
  }
  function normalizeHex(v){
    v=(v||'').trim(); if(!v) return null; if(v[0]!=='#') v='#'+v; v=v.toLowerCase();
    if(/^#[0-9a-f]{3}$/.test(v)) v='#'+v[1]+v[1]+v[2]+v[2]+v[3]+v[3];
    if(/^#[0-9a-f]{6}$/.test(v)) return v; return null;
  }
  function rgbToHex(rgb){
    const m=String(rgb).match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
    if(!m) return '#0d2a6b';
    const r=(+m[1]).toString(16).padStart(2,'0'), g=(+m[2]).toString(16).padStart(2,'0'), b=(+m[3]).toString(16).padStart(2,'0');
    return '#'+r+g+b;
  }
  editor.color.addEventListener('input',()=>{ editor.hex.value=editor.color.value; });
  editor.hex.addEventListener('input',()=>{ const v=normalizeHex(editor.hex.value); if(v) editor.color.value=v; });

  editor.save.onclick=()=>{
    const text=editor.input.value;
    const size=Math.max(8,Math.min(200,parseInt(editor.size.value||'28',10)));
    const color=normalizeHex(editor.hex.value)||editor.color.value||'#0d2a6b';

    if(editor.targetBox){
      const t=editor.targetBox.querySelector('.scrap-text'); if(!t) return;
      t.textContent=text; t.style.fontSize=size+'px'; t.style.color=color; t.style.height='auto';
      editor.targetBox.style.height=Math.max(40,t.scrollHeight)+'px'; select(editor.targetBox);
    }else{
      const c=getPages()[current].querySelector('.page-canvas');
      const box=document.createElement('div'); box.className='scrap-item'; box.style.left='40px'; box.style.top='40px'; box.style.width='320px';
      box.innerHTML='<div class="scrap-text" contenteditable="false" style="font-size:'+size+'px;color:'+color+'"></div>'+
                    '<div class="mover" title="Drag"></div><div class="resizer"></div><div class="rotator"></div>';
      box.querySelector('.scrap-text').textContent=text; c.appendChild(box); makeDraggable(box); select(box);
    }
    hideEditor();
  };

  /* Photos (blocked on cover) */
  addPhotoBtn.onclick=()=>{ if(current===0){ alert('Cover is fixed and cannot accept photos.'); return; } fileInput.click(); };
  fileInput.addEventListener('change',async e=>{
    if(current===0){ e.target.value=''; return; }
    const f=e.target.files?.[0]; if(!f) return;
    try{
      const url = await uploadToBucket(f, { page: current+1 });
      const c=getPages()[current].querySelector('.page-canvas');
      const box=document.createElement('div'); box.className='scrap-item';
      box.style.left='90px'; box.style.top='90px'; box.style.width='320px'; box.style.height='230px';
      box.dataset.fit='contain'; box.dataset.lock='1';
      box.innerHTML='<img class="scrap-img" alt="" src="'+url+'" decoding="async">'+
                    '<div class="mover" title="Drag"></div><div class="resizer"></div><div class="rotator"></div>';
      c.appendChild(box); makeDraggable(box);
      const imgEl=box.querySelector('.scrap-img');
      const setAspect=()=>{ if(imgEl.naturalWidth&&imgEl.naturalHeight){ box.dataset.aspect=(imgEl.naturalWidth/imgEl.naturalHeight).toFixed(5);} };
      if(imgEl.complete) setAspect(); else imgEl.addEventListener('load',setAspect);
      fileInput.value=''; select(box);
    }catch(err){
      alert("Upload failed: " + (err?.message || err));
      console.warn(err);
    }
  });

  function safeName(name){
    return String(name||'photo')
      .replace(/[\/\\?#%]+/g,'-')
      .replace(/[^\w.\-]+/g,'_')
      .slice(-80);
  }
  function extFromMime(m){ if(!m) return ''; const t=m.split('/')[1]||''; return t.replace(/\+/g,'-'); }
  async function uploadToBucket(file,{page}={}){
    const ext = file.name.includes('.') ? file.name.split('.').pop() : extFromMime(file.type)||'bin';
    const fname = `${Date.now()}_${safeName(file.name)}`.replace(/\.+/g,'.');
    const folder = `${STATE_ID}/page_${String(page||0).padStart(2,'0')}`;
    const path   = `${folder}/${fname}`;
    const put = await fetch(`${SUPABASE_URL}/storage/v1/object/${BUCKET}/${encodeURIComponent(path)}?upsert=true`,{
      method:'PUT',
      headers:{ apikey:SUPABASE_ANON, Authorization:'Bearer '+SUPABASE_ANON, 'Content-Type': file.type || 'application/octet-stream' },
      body:file
    });
    if(!put.ok){
      const txt = await put.text().catch(()=>String(put.status));
      throw new Error(`Storage PUT ${put.status}: ${txt}`);
    }
    return `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${encodeURIComponent(path)}`;
  }

  /* Selection + toolbar + toggles */
  function update
