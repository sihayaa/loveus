<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>dear self — journal</title>
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Great+Vibes&display=swap" rel="stylesheet">
  <style>
    :root{
      --mint:#67e4ca; --purple:#7a5af8; --ink:#342943; --paper:#fffaf9;
      --bg: radial-gradient(1200px 800px at 10% 0%, #f4fffb 0%, #fef6ff 40%, #f7faff 100%);
      --shadow: 0 10px 30px rgba(0,0,0,.12); --radius:18px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; font-family:'Patrick Hand', system-ui; background:var(--bg); color:var(--ink)}
    .wrap{ max-width: 1000px; margin: 16px auto 40px; padding: 0 12px; position: relative; }

    /* back button */
    .back-button{ position:fixed; top:14px; left:14px; z-index:10; text-decoration:none;
      background:#ffffffcc; backdrop-filter:blur(4px); color:#2a2740; padding:8px 12px; border-radius:12px;
      border:1px solid #e0d8ef; box-shadow:0 6px 18px rgba(0,0,0,.08) }
    .back-button:hover{ transform:translateY(-1px) }

    header{ display:flex; align-items:flex-start; justify-content:space-between; gap:16px; margin-bottom:12px; padding-top:36px }
    .brand{ display:flex; align-items:baseline; gap:10px }
    .logo{ width:36px; height:36px; border-radius:50%; background:conic-gradient(from 200deg, var(--mint), var(--purple)); box-shadow:0 4px 10px rgba(0,0,0,.15) }
    h1{ font-family:'Great Vibes', cursive; font-size:36px; margin:0 }
    .sub{ opacity:.7; font-size:14px }

    .moods{ display:flex; flex-wrap:wrap; gap:6px; justify-content:flex-end }
    .chip{ user-select:none; cursor:pointer; padding:6px 10px; border-radius:999px; border:1px dashed #ccd1ff; background:#eef2ff; font-size:14px }
    .chip.sel{ background:#eafff8; border-color:#baf2e7; color:#0e5d4f }
    .chip.disabled{ opacity:.5; pointer-events:none }
    .limit{ font-size:12px; opacity:.6 }

    .card{ background:var(--paper); border-radius: var(--radius); box-shadow: var(--shadow); padding: 14px }

    .datewrap{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    input[type="date"]{ padding:6px 10px; border-radius:10px; border:1px solid #e6e0ee; font:inherit }
    input[type="date"].disabled{ opacity:.6; pointer-events:none }

    .toolbar{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin:10px 0 8px }
    .swatch{ width:22px; height:22px; border-radius:6px; border:1px solid rgba(0,0,0,.08); cursor:pointer }
    .swatch.sel{ outline:2px solid #cfe9ff }
    .swatch.disabled{ opacity:.5; pointer-events:none }
    .hex{ width:110px; padding:6px 8px; border-radius:8px; border:1px solid #e6e0ee; font:inherit }

    #letter{ width:100%; min-height:45vh; resize:vertical; padding:14px; border-radius:14px; border:1px solid #eadff4; background:#fff; line-height:1.5 }
    #letter::placeholder{ color:#aa96bd }
    #letter[readonly]{ background:#fdfdff }

    .footer{ margin-top:12px }
    #notes{ width:100%; min-height:120px; resize:vertical; padding:12px; border-radius:12px; border:1px solid #eadff4; background:#fff }
    #notes[readonly]{ background:#fdfdff }

    .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:12px }
    button{ cursor:pointer; border:none; border-radius:12px; padding:9px 12px; font:inherit; background:#f2f6ff; box-shadow: 0 3px 8px rgba(0,0,0,.06) }
    button.primary{ background:linear-gradient(135deg, var(--mint), #aaf1e0); color:#0c3b33 }
    button.ghost{ background:#f3f1ff }

    .status{ margin-left:6px; font-size:12px; opacity:.75 }
    .banner{ margin:10px 0; padding:10px 12px; border:1px dashed #e0d8ef; border-radius:12px; background:#ffffffaa; backdrop-filter:blur(2px) }

    .history{ margin-top:18px; display:grid; gap:8px }
    .row{ display:flex; justify-content:space-between; gap:8px; align-items:center; padding:10px; border:1px solid #e7ecff; border-radius:12px; background:#f9fbff; cursor:pointer }
    .row:hover{ background:#f2fbf7; border-color:#d2f5ea }

    @media (max-width: 760px){ .moods{ justify-content:flex-start } }
  </style>
</head>
<body>
  <!-- Back button: change href to your site’s home -->
  <a class="back-button" href="index.html">← back</a>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>dear self</h1>
          <div class="sub"><span id="dateStamp">—</span><span id="syncBadge" class="status"></span></div>
        </div>
      </div>
      <div>
        <div class="moods" id="moodsBox"></div>
        <div class="limit" id="moodLimit">pick up to 3</div>
      </div>
    </header>

    <section class="card">
      <div class="datewrap">
        <label for="dateInput">entry date:</label>
        <input id="dateInput" type="date" />
      </div>

      <div class="toolbar">
        <div>text color:</div>
        <div id="swatches" style="display:flex; gap:6px"></div>
        <input id="hex" class="hex" placeholder="#custom" maxlength="7" />
      </div>

      <textarea id="letter" placeholder="Dear self,\n\n…"></textarea>

      <div class="footer">
        <label style="display:block; margin-bottom:6px">notes</label>
        <textarea id="notes" placeholder="freeform notes…"></textarea>
      </div>

      <div class="actions" id="ownerActions">
        <button id="newBtn" class="ghost" title="start a fresh entry">new</button>
        <button id="saveBtn" class="primary">save</button>
        <span class="status" id="status">—</span>
      </div>

      <div class="banner" id="banner" hidden></div>
    </section>

    <section class="history" id="history"></section>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== CONFIG (fill these) ======
    const SUPABASE_URL = "";       // e.g., "https://xxxxx.supabase.co"
    const SUPABASE_ANON_KEY = "";  // your anon public key
    const OWNER_USER_ID = "";      // your uid (set after first load – see steps)

    // presets
    const PRESET_COLORS = ["#67e4ca", "#7a5af8", "#342943", "#e476e9", "#0b3c5d"]; // mint, purple, ink, rose, midnight
    const STARTER_MOODS = ["sad","confused","depressed","angry","numb","anxious","lonely","guilty","overwhelmed","hopeful"];

    // state
    let supa = null, user = null, isOwner = false;
    const localKey = 'dearself_v1';
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const ymd = (d=new Date()) => [d.getFullYear(), String(d.getMonth()+1).padStart(2,'0'), String(d.getDate()).padStart(2,'0')].join('-');
    const uid = () => crypto.randomUUID();
    function freshEntry(){
      return { id: uid(), user_id: null, entry_date: ymd(), body: 'Dear self,\n\n', notes: '', moods: [], palette_hex: PRESET_COLORS[0], is_public: true, created_at: Date.now(), updated_at: Date.now() };
    }
    let draft = loadLocal() || freshEntry();

    // local save/load
    function saveLocal(){ localStorage.setItem(localKey, JSON.stringify(draft)); $('#status').textContent = 'saved local'; }
    function loadLocal(){ try{ return JSON.parse(localStorage.getItem(localKey)); }catch(e){ return null } }

    // render
    function render(){
      $('#dateStamp').textContent = new Date(draft.created_at||Date.now()).toLocaleString();
      $('#dateInput').value = draft.entry_date;
      $('#letter').value = draft.body;
      $('#notes').value = draft.notes;
      setTextColor(draft.palette_hex);
      $$('#moodsBox .chip').forEach(ch => ch.classList.toggle('sel', draft.moods.includes(ch.dataset.mood)));
      setEditable(isOwner);
      renderHistory(window.__history || []);
    }
    function setEditable(edit){
      $('#letter').readOnly = !edit;
      $('#notes').readOnly = !edit;
      $('#dateInput').disabled = !edit; $('#dateInput').classList.toggle('disabled', !edit);
      $('#hex').disabled = !edit; $('#hex').classList.toggle('disabled', !edit);
      $$('#swatches .swatch').forEach(s=> s.classList.toggle('disabled', !edit));
      $$('#moodsBox .chip').forEach(ch=> ch.classList.toggle('disabled', !edit));
      $('#ownerActions').style.display = edit ? 'flex' : 'none';
    }
    function renderSwatches(){
      const box = $('#swatches'); box.innerHTML = '';
      PRESET_COLORS.forEach(c=>{
        const s = document.createElement('div'); s.className='swatch'; s.style.background = c; s.title=c;
        s.onclick = ()=>{ if(!isOwner) return; draft.palette_hex=c; setTextColor(c); saveLocal(); };
        if(draft.palette_hex===c) s.classList.add('sel');
        box.appendChild(s);
      });
    }
    function setTextColor(hex){
      $('#letter').style.color = hex;
      $('#hex').value = hex;
      $$('#swatches .swatch').forEach(s=> s.classList.toggle('sel', s.title===hex));
    }
    function renderMoodChips(){
      const box = $('#moodsBox'); box.innerHTML='';
      STARTER_MOODS.forEach(m=>{
        const el = document.createElement('span'); el.className='chip'; el.textContent=m; el.dataset.mood=m;
        el.onclick = ()=>{ if(!isOwner) return;
          const i = draft.moods.indexOf(m);
          if(i>-1) draft.moods.splice(i,1);
          else { if(draft.moods.length>=3) return flashLimit(); draft.moods.push(m); }
          saveLocal(); render();
        };
        box.appendChild(el);
      });
    }
    function flashLimit(){ const n=$('#moodLimit'); n.style.color='#b33'; setTimeout(()=> n.style.color='', 600); }
    function renderHistory(list){
      const box = $('#history'); box.innerHTML='';
      if(!list.length){ box.innerHTML = '<div class="sub">no entries yet</div>'; return; }
      list.forEach(row=>{
        const div = document.createElement('div'); div.className='row';
        div.innerHTML = `<div><b>${row.entry_date}</b> — ${(row.body||'').split('\n')[0].slice(0,50)}</div><div style="font-size:12px; opacity:.7">${(row.moods||[]).join(', ')}</div>`;
        div.onclick = ()=>{ draft = { ...row, created_at: new Date(row.created_at).getTime(), updated_at: Date.now() }; saveLocal(); render(); window.scrollTo({top:0,behavior:'smooth'}); };
        box.appendChild(div);
      });
    }

    // events
    $('#letter').addEventListener('input', ()=>{ if(!isOwner) return; draft.body = $('#letter').value; draft.updated_at = Date.now(); saveLocal(); });
    $('#notes').addEventListener('input',  ()=>{ if(!isOwner) return; draft.notes = $('#notes').value; draft.updated_at = Date.now(); saveLocal(); });
    $('#hex').addEventListener('change',   ()=>{ if(!isOwner) return; const v=$('#hex').value.trim(); if(/^#([0-9a-f]{6})$/i.test(v)){ draft.palette_hex=v; setTextColor(v); saveLocal(); }});
    $('#dateInput').addEventListener('change', ()=>{ if(!isOwner) return; draft.entry_date = $('#dateInput').value || ymd(); draft.updated_at = Date.now(); saveLocal(); });
    $('#newBtn').onclick = ()=>{ if(!isOwner) return; draft = freshEntry(); draft.user_id = user?.id || null; saveLocal(); render(); };
    $('#saveBtn').onclick = ()=> saveCloud();

    // supabase
    async function bootSupabase(){
      if(!SUPABASE_URL || !SUPABASE_ANON_KEY){
        banner(`cloud is <b>off</b>. paste your SUPABASE_URL and ANON KEY to enable sync.`); $('#syncBadge').textContent=''; window.__history=[]; render(); return;
      }
      supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const { data: { session } } = await supa.auth.getSession();
      if(!session){ await supa.auth.signInAnonymously(); }
      const { data: me } = await supa.auth.getUser();
      user = me?.user || null;

      $('#syncBadge').textContent = user ? ' • cloud: on (anon)' : '';
      if(!OWNER_USER_ID){ banner(`Owner UID not set. Current session uid: <code>${user?.id || 'none'}</code><br/>Copy this uid and paste into <code>OWNER_USER_ID</code> at the top of the script.`); }
      isOwner = !!(user && OWNER_USER_ID && user.id === OWNER_USER_ID);

      // attach uid to draft for new rows
      if(user && !draft.user_id){ draft.user_id = user.id; saveLocal(); }
      await loadHistory();
      render();
    }
    async function saveCloud(){
      if(!supa || !user){ $('#status').textContent = 'cloud off — saved local'; return; }
      if(!isOwner){ banner('view-only mode. only the owner can save.'); return; }
      const row = {
        id: draft.id, user_id: user.id, entry_date: draft.entry_date,
        body: draft.body, notes: draft.notes, moods: draft.moods,
        palette_hex: draft.palette_hex, is_public: true
      };
      const { error } = await supa.from('journal_entries').upsert(row, { onConflict: 'id' });
      if(error){ $('#status').textContent = 'save error'; banner('save error: '+error.message); return; }
      $('#status').textContent = 'saved to cloud';
      await loadHistory();
    }
    async function loadHistory(){
      if(!supa){ window.__history=[]; return; }
      const targetId = OWNER_USER_ID || user?.id || null;
      if(!targetId){ window.__history=[]; return; }
      let query = supa.from('journal_entries').select('*').eq('user_id', targetId).order('created_at', { ascending:false }).limit(20);
      if(!(user && user.id === targetId)) query = query.eq('is_public', true); // visitors see only public
      const { data, error } = await query;
      if(error){ banner('history error: '+error.message); window.__history=[]; return; }
      window.__history = data || [];
    }
    function banner(html){ const b=$('#banner'); b.innerHTML=html; b.hidden=false; }

    // boot
    (function init(){
      // build UI
      (function renderMoodChips(){ const box=$('#moodsBox'); STARTER_MOODS.forEach(m=>{ const el=document.createElement('span'); el.className='chip'; el.dataset.mood=m; el.textContent=m;
        el.onclick=()=>{ if(!isOwner) return; const i=draft.moods.indexOf(m); if(i>-1) draft.moods.splice(i,1); else { if(draft.moods.length>=3) return flashLimit(); draft.moods.push(m);} saveLocal(); render(); };
        box.appendChild(el); }); })();
      renderSwatches(); render();
      bootSupabase();
    })();
  </script>
</body>
</html>
