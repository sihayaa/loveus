<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>dear self — journal</title>
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Great+Vibes&display=swap" rel="stylesheet">
  <style>
    :root{
      --mint:#67e4ca; --purple:#7a5af8; --ink:#342943; --paper:#fffaf9;
      --bg: radial-gradient(1200px 800px at 10% 0%, #f4fffb 0%, #fef6ff 40%, #f7faff 100%);
      --shadow: 0 10px 30px rgba(0,0,0,.12); --radius:18px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; font-family:'Patrick Hand', system-ui; background:var(--bg); color:var(--ink)}
    .wrap{ max-width: 1000px; margin: 16px auto 40px; padding: 0 12px; position: relative; }

    /* back button */
    .back-button{ position:fixed; top:14px; left:14px; z-index:11; text-decoration:none;
      background:#ffffffcc; backdrop-filter:blur(4px); color:#2a2740; padding:8px 12px; border-radius:12px;
      border:1px solid #e0d8ef; box-shadow:0 6px 18px rgba(0,0,0,.08) }
    .back-button:hover{ transform:translateY(-1px) }

    header{ display:flex; align-items:flex-start; justify-content:space-between; gap:16px; margin-bottom:12px; padding-top:36px }
    .brand{ display:flex; align-items:baseline; gap:10px }
    .logo{ width:36px; height:36px; border-radius:50%; background:conic-gradient(from 200deg, var(--mint), var(--purple)); box-shadow:0 4px 10px rgba(0,0,0,.15) }
    h1{ font-family:'Great Vibes', cursive; font-size:36px; margin:0 }
    .sub{ opacity:.7; font-size:14px }

    .moods{ display:flex; flex-wrap:wrap; gap:6px; justify-content:flex-end }
    .chip{ user-select:none; cursor:pointer; padding:6px 10px; border-radius:999px; border:1px dashed #ccd1ff; background:#eef2ff; font-size:14px }
    .chip.sel{ background:#eafff8; border-color:#baf2e7; color:#0e5d4f }
    .chip.disabled{ opacity:.5; pointer-events:none }
    .limit{ font-size:12px; opacity:.6 }

    .card{ background:var(--paper); border-radius: var(--radius); box-shadow: var(--shadow); padding: 14px }

    .datewrap{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    input[type="date"]{ padding:6px 10px; border-radius:10px; border:1px solid #e6e0ee; font:inherit }
    input[type="date"].disabled{ opacity:.6; pointer-events:none }

    .toolbar{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin:10px 0 8px }
    .swatch{ width:22px; height:22px; border-radius:6px; border:1px solid rgba(0,0,0,.08); cursor:pointer }
    .swatch.sel{ outline:2px solid #cfe9ff }
    .swatch.disabled{ opacity:.5; pointer-events:none }
    .hex{ width:110px; padding:6px 8px; border-radius:8px; border:1px solid #e6e0ee; font:inherit }

    #letter{ width:100%; min-height:45vh; resize:vertical; padding:14px; border-radius:14px; border:1px solid #eadff4; background:#fff; line-height:1.5 }
    #letter::placeholder{ color:#aa96bd }
    #letter[readonly]{ background:#fdfdff }

    .letter-view{ white-space:pre-wrap; padding:14px; border-radius:14px; border:1px solid #eadff4; background:#fff; line-height:1.5 }

    .footer{ margin-top:12px }
    #notes{ width:100%; min-height:120px; resize:vertical; padding:12px; border-radius:12px; border:1px solid #eadff4; background:#fff }
    #notes[readonly]{ background:#fdfdff }

    .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:12px }
    button{ cursor:pointer; border:none; border-radius:12px; padding:9px 12px; font:inherit; background:#f2f6ff; box-shadow: 0 3px 8px rgba(0,0,0,.06) }
    button.primary{ background:linear-gradient(135deg, var(--mint), #aaf1e0); color:#0c3b33 }
    button.ghost{ background:#f3f1ff }

    .status{ margin-left:6px; font-size:12px; opacity:.75 }
    .banner{ margin:10px 0; padding:10px 12px; border:1px dashed #e0d8ef; border-radius:12px; background:#ffffffaa; backdrop-filter:blur(2px) }

    .history{ margin-top:18px; display:grid; gap:8px }
    .row{ display:flex; justify-content:space-between; gap:8px; align-items:center; padding:10px; border:1px solid #e7ecff; border-radius:12px; background:#f9fbff; cursor:pointer }
    .row:hover{ background:#f2fbf7; border-color:#d2f5ea }

    /* gate overlay */
    .gate{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:10; background:rgba(14,14,20,.6); backdrop-filter:blur(2px) }
    .gate .box{ background:#fff; padding:16px; border-radius:14px; width:min(420px, 92vw); box-shadow:0 18px 40px rgba(0,0,0,.25) }
    .gate .box h3{ margin:0 0 8px 0; font-size:20px }
    .gate input{ width:100%; padding:10px; border-radius:10px; border:1px solid #e0d8ef; font:inherit }
    .gate .row{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px }
    .tip{ font-size:12px; opacity:.7 }

    @media (max-width: 760px){ .moods{ justify-content:flex-start } }
  </style>
</head>
<body>
  <!-- Back button: change href to your site’s home -->
  <a class="back-button" href="index.html">← back</a>

  <!-- Passcode Gate -->
  <div class="gate" id="gate">
    <div class="box">
      <h3>enter passcode to edit</h3>
      <div class="tip">viewers can read letters without a passcode. the passcode only reveals the editor.</div>
      <input id="gateInput" type="password" placeholder="passcode" />
      <div class="row">
        <button id="gateCancel">cancel</button>
        <button id="gateOk" class="primary">unlock editor</button>
      </div>
      <div class="tip" id="gateMsg"></div>
    </div>
  </div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>dear self</h1>
          <div class="sub"><span id="dateStamp">—</span><span id="syncBadge" class="status"></span></div>
        </div>
      </div>
      <div>
        <div class="moods" id="moodsBox"></div>
        <div class="limit" id="moodLimit">pick up to 3</div>
      </div>
    </header>

    <section class="card">
      <div class="datewrap">
        <label for="dateInput">entry date:</label>
        <input id="dateInput" type="date" />
      </div>

      <div class="toolbar">
        <div>text color:</div>
        <div id="swatches" style="display:flex; gap:6px"></div>
        <input id="hex" class="hex" placeholder="#custom" maxlength="7" />
      </div>

      <!-- edit textarea -->
      <textarea id="letter" placeholder="Dear self,\n\n…"></textarea>
      <!-- read view -->
      <div id="letterView" class="letter-view" hidden></div>

      <div class="footer" id="notesWrap">
        <label style="display:block; margin-bottom:6px">notes (private)</label>
        <textarea id="notes" placeholder="freeform notes…"></textarea>
      </div>

      <div class="actions" id="ownerActions">
        <button id="newBtn" class="ghost" title="start a fresh entry">new</button>
        <button id="saveBtn" class="primary">save</button>
        <span class="status" id="status">—</span>
      </div>
      <div class="banner" id="banner" hidden></div>
    </section>

    <section class="history" id="history"></section>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = "https://tmjozxcjylcxgemffnoc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";

    // Which user's letters to show on this page (so visitors can view). Optional.
    const OWNER_USER_ID = ""; // <- paste your uid after first load, or leave blank to show only the current session's letters

    // Passcode to reveal editor (change this!)
    const EDIT_PASSCODE = "word"; // ← set your secret; editor unlocks only when this matches

    const PRESET_COLORS = ["#67e4ca", "#7a5af8", "#342943", "#e476e9", "#0b3c5d"]; // mint, purple, ink, rose, midnight
    const STARTER_MOODS = ["sad","confused","depressed","angry","numb","anxious","lonely","guilty","overwhelmed","hopeful"];

    // ====== state ======
    let supa = null, user = null, gateOK = false;
    const localKey = 'dearself_v1';
    const $ = s => document.querySelector(s); const $$ = s => Array.from(document.querySelectorAll(s));
    const ymd = (d=new Date()) => [d.getFullYear(), String(d.getMonth()+1).padStart(2,'0'), String(d.getDate()).padStart(2,'0')].join('-');
    const uid = () => crypto.randomUUID();

    function freshEntry(){
      return { id: uid(), user_id: null, entry_date: ymd(), body: 'Dear self,\n\n', notes: '', moods: [], palette_hex: PRESET_COLORS[0], is_public: true, created_at: Date.now(), updated_at: Date.now() };
    }
    function saveLocal(){ localStorage.setItem(localKey, JSON.stringify(draft)); $('#status').textContent = 'saved local'; }
    function loadLocal(){ try{ return JSON.parse(localStorage.getItem(localKey)); }catch(e){ return null }
    }
    let draft = loadLocal() || freshEntry();

    // ====== render ======
    function render(){
      $('#dateStamp').textContent = new Date(draft.created_at||Date.now()).toLocaleString();
      $('#dateInput').value = draft.entry_date;
      $('#letter').value = draft.body;
      $('#letterView').textContent = draft.body;
      $('#notes').value = draft.notes;
      setTextColor(draft.palette_hex);
      $$('#moodsBox .chip').forEach(ch => ch.classList.toggle('sel', draft.moods.includes(ch.dataset.mood)));
      setEditable(gateOK);
      renderHistory(window.__history || []);
    }

    function setEditable(edit){
      // toggle fields
      $('#letter').hidden = !edit; $('#letterView').hidden = edit;
      $('#letter').readOnly = !edit; $('#notes').readOnly = !edit;
      $('#dateInput').disabled = !edit; $('#dateInput').classList.toggle('disabled', !edit);
      $('#hex').disabled = !edit; $('#hex').classList.toggle('disabled', !edit);
      $$('#swatches .swatch').forEach(s=> s.classList.toggle('disabled', !edit));
      $$('#moodsBox .chip').forEach(ch=> ch.classList.toggle('disabled', !edit));
      $('#ownerActions').style.display = edit ? 'flex' : 'none';
      // notes visibility: viewers never see notes
      $('#notesWrap').style.display = edit ? 'block' : 'none';
    }

    function renderSwatches(){
      const box = $('#swatches'); box.innerHTML = '';
      PRESET_COLORS.forEach(c=>{
        const s = document.createElement('div'); s.className='swatch'; s.style.background = c; s.title=c;
        s.onclick = ()=>{ if(!gateOK) return; draft.palette_hex=c; setTextColor(c); saveLocal(); };
        if(draft.palette_hex===c) s.classList.add('sel'); box.appendChild(s);
      });
    }
    function setTextColor(hex){ $('#letter').style.color = hex; $('#hex').value = hex; $$('#swatches .swatch').forEach(s=> s.classList.toggle('sel', s.title===hex)); }

    function renderMoodChips(){
      const box = $('#moodsBox'); box.innerHTML='';
      STARTER_MOODS.forEach(m=>{
        const el = document.createElement('span'); el.className='chip'; el.textContent=m; el.dataset.mood=m;
        el.onclick = ()=>{ if(!gateOK) return; const i = draft.moods.indexOf(m); if(i>-1) draft.moods.splice(i,1); else { if(draft.moods.length>=3) return flashLimit(); draft.moods.push(m); } saveLocal(); render(); };
        box.appendChild(el);
      });
    }
    function flashLimit(){ const n=$('#moodLimit'); n.style.color='#b33'; setTimeout(()=> n.style.color='', 600); }

    function renderHistory(list){
      const box = $('#history'); box.innerHTML='';
      if(!list.length){ box.innerHTML = '<div class="sub">no entries yet</div>'; return; }
      list.forEach(row=>{
        const div = document.createElement('div'); div.className='row';
        div.innerHTML = `<div><b>${row.entry_date}</b> — ${(row.body||'').split('\n')[0].slice(0,50)}</div><div style="font-size:12px; opacity:.7">${(row.moods||[]).join(', ')}</div>`;
        div.onclick = ()=>{ draft = { ...row, created_at: new Date(row.created_at).getTime(), updated_at: Date.now() }; saveLocal(); render(); window.scrollTo({top:0,behavior:'smooth'}); };
        box.appendChild(div);
      });
    }

    // ====== events ======
    $('#letter').addEventListener('input', ()=>{ if(!gateOK) return; draft.body = $('#letter').value; draft.updated_at = Date.now(); saveLocal(); $('#letterView').textContent = draft.body; });
    $('#notes').addEventListener('input',  ()=>{ if(!gateOK) return; draft.notes = $('#notes').value; draft.updated_at = Date.now(); saveLocal(); });
    $('#hex').addEventListener('change',   ()=>{ if(!gateOK) return; const v=$('#hex').value.trim(); if(/^#([0-9a-f]{6})$/i.test(v)){ draft.palette_hex=v; setTextColor(v); saveLocal(); }});
    $('#dateInput').addEventListener('change', ()=>{ if(!gateOK) return; draft.entry_date = $('#dateInput').value || ymd(); draft.updated_at = Date.now(); saveLocal(); });
    $('#newBtn').onclick = ()=>{ if(!gateOK) return; draft = freshEntry(); draft.user_id = user?.id || null; saveLocal(); render(); };
    $('#saveBtn').onclick = ()=> saveCloud();

    // ====== gate ======
    function openGate(){ $('#gate').style.display='flex'; $('#gateInput').focus(); }
    function closeGate(){ $('#gate').style.display='none'; $('#gateMsg').textContent=''; $('#gateInput').value=''; }
    $('#gateOk').onclick = ()=>{
      const v = $('#gateInput').value.trim();
      if(!v){ $('#gateMsg').textContent = 'enter passcode'; return; }
      if(v === EDIT_PASSCODE){ gateOK = true; localStorage.setItem('dearself_gate_ok','1'); closeGate(); setEditable(gateOK); maybeShowUidBanner(); }
      else { $('#gateMsg').textContent = 'wrong passcode'; }
    };
    $('#gateCancel').onclick = ()=>{ closeGate(); gateOK=false; localStorage.removeItem('dearself_gate_ok'); setEditable(false); };

    // ====== supabase ======
    async function bootSupabase(){
      if(!SUPABASE_URL || !SUPABASE_ANON_KEY){ banner(`cloud is <b>off</b>. add your project keys to enable sync.`); $('#syncBadge').textContent=''; window.__history=[]; render(); return; }
      supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const { data: { session } } = await supa.auth.getSession();
      if(!session){ await supa.auth.signInAnonymously(); }
      const { data: me } = await supa.auth.getUser();
      user = me?.user || null;

      $('#syncBadge').textContent = user ? ' • cloud: on (anon)' : '';
      // passcode remembered?
      gateOK = localStorage.getItem('dearself_gate_ok') === '1';

      if(user && !draft.user_id){ draft.user_id = user.id; saveLocal(); }
      await loadHistory();
      maybeShowUidBanner();
      render();
    }

    async function saveCloud(){
      if(!supa || !user){ $('#status').textContent = 'cloud off — saved local'; return; }
      if(!gateOK){ banner('view-only mode. enter passcode to save.'); return; }
      const row = { id: draft.id, user_id: user.id, entry_date: draft.entry_date, body: draft.body, notes: draft.notes, moods: draft.moods, palette_hex: draft.palette_hex, is_public: true };
      const { error } = await supa.from('journal_entries').upsert(row, { onConflict: 'id' });
      if(error){ $('#status').textContent = 'save error'; banner('save error: '+error.message); return; }
      $('#status').textContent = 'saved to cloud';
      // after save, hide editor (show letter only)
      gateOK = false; localStorage.removeItem('dearself_gate_ok'); setEditable(false);
      await loadHistory(); render();
    }

    async function loadHistory(){
      if(!supa){ window.__history=[]; return; }
      const targetId = OWNER_USER_ID || user?.id || null; if(!targetId){ window.__history=[]; return; }
      // viewers: never fetch notes; editor unlocked: include notes
      const cols = gateOK ? 'id,user_id,entry_date,body,notes,moods,palette_hex,created_at' : 'id,user_id,entry_date,body,moods,palette_hex,created_at';
      let query = supa.from('journal_entries').select(cols).eq('user_id', targetId).order('created_at', { ascending:false }).limit(20);
      if(!(user && user.id === targetId)) query = query.eq('is_public', true);
      const { data, error } = await query; if(error){ banner('history error: '+error.message); window.__history=[]; return; }
      window.__history = data || [];
    }

    function banner(html){ const b=$('#banner'); b.innerHTML=html; b.hidden=false; }
    function maybeShowUidBanner(){
      if(!OWNER_USER_ID && user && gateOK){ banner(`Your uid: <code>${user.id}</code><br/>Paste this into <code>OWNER_USER_ID</code> in the script to make this page show your letters to visitors.`); }
    }

    // ====== boot ======
    (function init(){
      // build UI
      (function renderMoodChips(){ const box=$('#moodsBox'); STARTER_MOODS.forEach(m=>{ const el=document.createElement('span'); el.className='chip'; el.dataset.mood=m; el.textContent=m;
        el.onclick=()=>{ if(!gateOK) return; const i=draft.moods.indexOf(m); if(i>-1) draft.moods.splice(i,1); else { if(draft.moods.length>=3) return flashLimit(); draft.moods.push(m);} saveLocal(); render(); };
        box.appendChild(el); }); })();
      renderSwatches(); render(); bootSupabase();
      // open gate on Ctrl+E or long‑press title
      document.addEventListener('keydown', (e)=>{ if(e.ctrlKey && e.key.toLowerCase()==='e'){ openGate(); }});
      let pressTimer=null; document.querySelector('h1').addEventListener('mousedown', ()=>{ pressTimer=setTimeout(openGate, 800); });
      document.querySelector('h1').addEventListener('mouseup', ()=>{ clearTimeout(pressTimer); });
    })();
  </script>
</body>
</html>
