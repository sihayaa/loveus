<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Journal</title>
<link href="https://fonts.googleapis.com/css2?family=Lobster&display=swap" rel="stylesheet">
<style>
:root{
  --pageW:760px; --pageH:1060px;                /* book size */
  --bg:#0b0f2f; --paper:#f7eddc; --ink:#0d2a6b;
  --accent:#7a5af8; --mint:#67e4ca; --font:"Lobster",cursive;

  /* Cover image (fixed on page 1) */
  --cover-img:url("https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/journal-front.png");
  --cover-y:50%;

  /* Site wallpaper (full-screen, behind book) */
  --wall-bg:url("https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/jpurnal-bg1.jpg");

  /* small right nudge so the stack looks centered */
  --book-nudge: 28px;
}

*{box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{
  margin:0; background:var(--bg); color:var(--ink);
  font-family:var(--font); display:flex; align-items:center; justify-content:center;
}

/* ===== WALLPAPER ===== */
#wall{
  position:fixed; inset:0; z-index:0;
  background-image: var(--wall-bg);
  background-size: cover; background-position: center; background-repeat: no-repeat;
  pointer-events:none;
}

/* ===== RAIN (separate overlay so itâ€™s always visible) ===== */
#rain{
  position:fixed; inset:0; z-index:1; pointer-events:none; overflow:hidden;
}
/* two layers, different speeds/opacities */
#rain .layer{
  position:absolute; inset:0;
  background-repeat:repeat;
  transform: skew(-15deg);                /* diagonal streaks */
  background-size: 2px 14px;              /* line width & spacing */
  opacity:.22;                             /* overall visibility */
  animation:rainMoveA 1.8s linear infinite;
}
#rain .layer.b{
  background-size: 1px 10px;
  opacity:.15;
  animation:rainMoveB 3.0s linear infinite;
}
/* bright streaks on any wallpaper */
#rain .layer,
#rain .layer.b{
  background-image: repeating-linear-gradient(
    to bottom,
    rgba(255,255,255,0.35) 0 2px,
    rgba(255,255,255,0.00) 2px 14px
  );
}

/* motion */
@keyframes rainMoveA { from{ background-position:0 -300px } to{ background-position:0 900px } }
@keyframes rainMoveB { from{ background-position:0 -500px } to{ background-position:0 1200px } }

/* ===== BOOK ===== */
#stage{
  position:relative; z-index:2; width:var(--pageW); height:var(--pageH);
  transform-origin:center; overflow:visible;
  margin-left: var(--book-nudge);
}
@media (max-width: 1100px){ #stage{ margin-left:0; } }

.deck{position:absolute; inset:0; perspective:1200px}

.page{
  position:absolute; inset:0; background:var(--paper); border-radius:20px; border:2px solid #efe6d5;
  box-shadow:inset 0 0 60px rgba(0,0,0,.22), 0 18px 40px rgba(0,0,0,.35);
  overflow:hidden; transform-origin:center; transition:transform .45s cubic-bezier(.2,.7,.2,1), opacity .45s, filter .45s;
  opacity:.92; filter:saturate(.95); pointer-events:none; z-index:0;
}
.page .page-canvas{position:relative; width:100%; height:100%; padding:28px}

/* Cover page background (fixed, not editable) */
.page.cover .page-canvas{
  padding:0; background:#0c102c;
  background-image:var(--cover-img), radial-gradient(closest-side at 50% 40%, #1d2a55 0%, #0c102c 60%);
  background-size:cover, auto; background-position:50% var(--cover-y), center; background-repeat:no-repeat;
}

/* Stack offsets */
.page.active{opacity:1; filter:none; pointer-events:auto; z-index:3}
.pos--2{transform:translateX(-70px) rotate(-1.2deg) scale(.95); z-index:1}
.pos--1{transform:translateX(-36px) rotate(-.6deg) scale(.975); z-index:2}
.active{transform:translateX(0) rotate(0) scale(1); z-index:3}
.pos-1{transform:translateX(36px) rotate(.6deg) scale(.975); z-index:2}
.pos-2{transform:translateX(70px) rotate(1.2deg) scale(.95); z-index:1}

/* Scrap items */
.scrap-item{position:absolute; transform-origin:center; touch-action:none; overflow:visible; z-index:1}
.scrap-item.selected{box-shadow:0 0 0 3px var(--accent)}
.rotator,.mover,.resizer{display:none}
.rotator{position:absolute; left:50%; top:-18px; transform:translate(-50%,-50%); width:18px; height:18px; border-radius:50%; background:#fff; border:3px solid var(--accent); box-shadow:0 2px 8px rgba(0,0,0,.25); cursor:grab; z-index:999}
.mover{position:absolute; left:-10px; top:-10px; width:18px; height:18px; border-radius:50%; background:#fff; border:3px solid var(--accent); cursor:grab}
.resizer{position:absolute; right:-6px; bottom:-6px; width:16px; height:16px; border-radius:4px; background:var(--mint); border:2px solid #0b2c28; cursor:nwse-resize}
.scrap-img{display:block; width:100%; height:100%; object-fit:contain; user-select:none; pointer-events:none; border-radius:16px}
.scrap-item[data-fit="cover"] .scrap-img{object-fit:cover}
.scrap-text{width:100%; background:transparent; border:0; color:inherit; font:inherit; white-space:pre-wrap; overflow:visible; min-height:1.2em}

/* Editability */
.page .page-canvas, .scrap-item { pointer-events:none }
body.editing .page.active .page-canvas, body.editing .scrap-item { pointer-events:auto }
body.editing .scrap-item{cursor:move}
body.editing .scrap-item .rotator, body.editing .scrap-item .mover, body.editing .scrap-item .resizer{display:block}

/* Nav + Add Page */
.nav{position:absolute; top:50%; transform:translateY(-50%); border:0; width:56px; height:56px; border-radius:50%; cursor:pointer; z-index:10;
  background:#ffffffd8; box-shadow:0 10px 22px rgba(0,0,0,.25); font-weight:900; font-size:22px; color:#182042; display:grid; place-items:center}
.nav.left{left:-72px} .nav.right{right:-72px} .nav:active{transform:translateY(-50%) scale(.96)} .nav.disabled{opacity:.45; pointer-events:none}

.addpage{position:absolute; left:50%; top:-56px; transform:translateX(-50%); border:0; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:900;
  background:#ffffffd8; color:#182042; box-shadow:0 10px 22px rgba(0,0,0,.25); display:none; z-index:20}
body.editing .addpage{display:block}

/* Toolbar (unchanged) */
#toolbar{position:fixed; right:16px; top:50%; transform:translateY(-50%); z-index:100; background:#fff; border:2px solid #e8dcc6; border-radius:14px; padding:12px; width:260px; gap:10px; box-shadow:0 10px 22px rgba(0,0,0,.25); display:none; flex-direction:column}
#toolbar.open{display:flex}
#toolbar .group{display:flex; gap:8px; flex-wrap:wrap}
#toolbar button{border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; color:#fff; background:var(--accent); width:100%}
#toolbar button.secondary{background:#5d47d4}
#toolbar button.mint{background:var(--mint); color:#022d2c}
#toolbar button.warn{background:#ff9aa2; color:#4c0a17}
#toolbar input[type="number"], #toolbar input[type="color"], #toolbar input[type="text"]{width:100%; padding:8px; border-radius:8px; border:2px solid #e8dcc6; font-weight:700; color:#0d2a6b; background:#fff}
#toolbar input[type="text"]{font-family:monospace}
</style>
</head>
<body>

<!-- Wallpaper and rain (behind the book) -->
<div id="wall" aria-hidden="true"></div>
<div id="rain" aria-hidden="true">
  <div class="layer"></div>
  <div class="layer b"></div>
</div>

<!-- Book -->
<div id="stage">
  <div class="deck" id="deck">
    <div class="page cover active" data-page="1"><div class="page-canvas"></div></div>
    <div class="page" data-page="2"><div class="page-canvas"></div></div>
    <div class="page" data-page="3"><div class="page-canvas"></div></div>
    <div class="page" data-page="4"><div class="page-canvas"></div></div>
    <div class="page" data-page="5"><div class="page-canvas"></div></div>
    <div class="page" data-page="6"><div class="page-canvas"></div></div>
  </div>
  <button class="nav left"  id="prev" aria-label="Previous">â—€</button>
  <button class="nav right" id="next" aria-label="Next">â–¶</button>
  <button class="addpage" id="addPageBtn">ï¼‹ Add Page</button>
</div>

<!-- Toolbar -->
<div id="toolbar" aria-hidden="true" inert>
  <div class="group">
    <button id="addTextBtn" class="mint">Add Text</button>
    <button id="editSelectedBtn" class="secondary">Edit Selected</button>
  </div>
  <div class="group">
    <button id="addPhotoBtn" class="secondary">Add Photo</button>
    <input id="fileInput" type="file" accept="image/*">
  </div>
  <div class="group">
    <label>Text Size (px)</label>
    <input id="fontSizeInput" type="number" min="8" max="200" step="1" placeholder="px" disabled>
  </div>
  <div class="group">
    <label>Text Color</label>
    <input id="fontColorInput" type="color" value="#0d2a6b" disabled>
    <input id="fontHexInput" type="text" placeholder="#RRGGBB" value="#0d2a6b" disabled>
  </div>
  <div class="group">
    <button id="fitToggleBtn"  class="secondary">Fit: Contain</button>
    <button id="lockToggleBtn" class="secondary">Lock: On</button>
  </div>
  <div class="group">
    <button id="addPageToolbarBtn" class="mint">ï¼‹ Add Page</button>
  </div>
  <div class="group">
    <button id="deleteSelectedBtn" class="warn">Delete Selected</button>
    <button id="clearPageBtn" class="warn">Clear Page</button>
    <button id="saveBtn" class="mint">Save Page</button>
  </div>
  <div class="group">
    <button id="exitEdit" class="warn">Exit Edit</button>
    <button id="hideBar">ðŸ”’ Hide</button>
  </div>
</div>

<!-- Big Text Editor -->
<div id="textEditor" aria-hidden="true" inert>
  <div class="panel" style="width:min(820px,90vw);background:#fff;border-radius:16px;padding:18px;border:2px solid #e8dcc6;box-shadow:0 20px 60px rgba(0,0,0,.5)">
    <h3 style="margin:0 0 8px;color:#0d2a6b">Edit Text</h3>
    <textarea id="editorInput" placeholder="type hereâ€¦" style="width:100%;height:320px;font:28px/1.35 var(--font);color:#0d2a6b;padding:12px;border:2px solid #e8dcc6;border-radius:12px;resize:vertical"></textarea>
    <div class="row" style="display:flex;gap:12px;margin-top:10px">
      <label style="font-weight:700;color:#0d2a6b;display:flex;align-items:center;gap:8px;">
        Size (px)
        <input id="editorSize" type="number" min="8" max="200" step="1" value="28" style="flex:1;padding:10px;border-radius:10px;border:2px solid #e8dcc6;font-weight:700;color:#0d2a6b">
      </label>
      <label style="font-weight:700;color:#0d2a6b;display:flex;align-items:center;gap:8px;">
        Color
        <input id="editorColor" type="color" value="#0d2a6b" style="width:110px;height:44px;border-radius:10px;border:2px solid #e8dcc6">
        <input id="editorHex" type="text" value="#0d2a6b" placeholder="#RRGGBB" style="width:110px;height:44px;border-radius:10px;border:2px solid #e8dcc6;padding:0 10px;font-weight:700;color:#0d2a6b;font-family:monospace">
      </label>
    </div>
    <div class="actions" style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
      <button id="editorCancel" style="background:#ff9aa2;color:#4c0a17;border:0;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer">Cancel</button>
      <button id="editorSave"   style="background:#67e4ca;color:#022d2c;border:0;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer">Save</button>
    </div>
  </div>
</div>

<script>
(function(){
  /* ========= Supabase (separate bucket/tables) ========= */
  const SUPABASE_URL  = "https://tmjozxcjylcxgemffnoc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
  const BUCKET="journalbook", STATE_ID="journal_main";
  const apiHeaders={apikey:SUPABASE_ANON, Authorization:"Bearer "+SUPABASE_ANON, "Content-Type":"application/json", Accept:"application/json"};

  const stage=document.getElementById('stage'), deck=document.getElementById('deck');
  const prevBtn=document.getElementById('prev'), nextBtn=document.getElementById('next');
  const addPageBtn=document.getElementById('addPageBtn'), addPageToolbarBtn=document.getElementById('addPageToolbarBtn');

  const toolbar=document.getElementById('toolbar'), fileInput=document.getElementById('fileInput');
  const addTextBtn=document.getElementById('addTextBtn'), editSelectedBtn=document.getElementById('editSelectedBtn');
  const addPhotoBtn=document.getElementById('addPhotoBtn'), clearPageBtn=document.getElementById('clearPageBtn'), saveBtn=document.getElementById('saveBtn');
  const hideBar=document.getElementById('hideBar'), exitEdit=document.getElementById('exitEdit');
  const fontSizeInput=document.getElementById('fontSizeInput'), fontColorInput=document.getElementById('fontColorInput'), fontHexInput=document.getElementById('fontHexInput');
  const fitToggleBtn=document.getElementById('fitToggleBtn'), lockToggleBtn=document.getElementById('lockToggleBtn');

  const editor={ el:document.getElementById('textEditor'), input:document.getElementById('editorInput'), size:document.getElementById('editorSize'),
    color:document.getElementById('editorColor'), hex:document.getElementById('editorHex'), save:document.getElementById('editorSave'), cancel:document.getElementById('editorCancel'), targetBox:null };

  let current=0, selectedItem=null, zCounter=10;

  function fitStage(){ const vw=innerWidth, vh=innerHeight, mx=200, my=40;
    const s=Math.min(1, vw/(parseInt(getComputedStyle(stage).width)+mx), vh/(parseInt(getComputedStyle(stage).height)+my));
    stage.style.transform='scale('+s+')'; }
  fitStage(); addEventListener('resize', fitStage);

  const pages=()=>Array.from(deck.querySelectorAll('.page'));
  function setClasses(){ const P=pages(); P.forEach((p,i)=>{ p.classList.remove('pos--2','pos--1','pos-1','pos-2','active');
    if(i===current)p.classList.add('active'); if(i===current-1)p.classList.add('pos--1'); if(i===current-2)p.classList.add('pos--2'); if(i===current+1)p.classList.add('pos-1'); if(i===current+2)p.classList.add('pos-2'); });
    prevBtn.classList.toggle('disabled', current===0); }
  function go(d){ const n=pages().length; let next=current+d; if(d>0&&next>=n) next=0; if(d<0&&next<0) next=0; if(next!==current){ current=next; setClasses(); } }
  prevBtn.onclick=()=>go(-1); nextBtn.onclick=()=>go(1);
  deck.addEventListener('mousedown',e=>{ if(!document.body.classList.contains('editing')) return; const pg=e.target.closest('.page'); if(pg){ current=pages().indexOf(pg); setClasses(); } });

  function showToolbar(){ toolbar.classList.add('open'); toolbar.removeAttribute('aria-hidden'); toolbar.removeAttribute('inert'); }
  function hideToolbar(){ if(toolbar.contains(document.activeElement)) document.activeElement.blur(); toolbar.classList.remove('open'); toolbar.setAttribute('aria-hidden','true'); toolbar.setAttribute('inert',''); }

  /* Enter edit by typing 123 */
  const PASSCODE='123'; let keyBuf='', keyTimer=null;
  function normDigit(e){ if(e.key==='1'||e.code==='Digit1'||e.code==='Numpad1')return'1'; if(e.key==='2'||e.code==='Digit2'||e.code==='Numpad2')return'2'; if(e.key==='3'||e.code==='Digit3'||e.code==='Numpad3')return'3'; return''; }
  addEventListener('keydown',e=>{ if(e.ctrlKey||e.metaKey||e.altKey) return; const d=normDigit(e); if(!d) return; keyBuf+=d; clearTimeout(keyTimer); keyTimer=setTimeout(()=>keyBuf='',1200);
    if(keyBuf.endsWith(PASSCODE)){ keyBuf=''; document.body.classList.add('editing'); showToolbar(); setClasses(); } });
  exitEdit.onclick=()=>{ document.body.classList.remove('editing'); hideToolbar(); deselect(); };
  hideBar.onclick=hideToolbar;

  /* Text editor */
  function showEditor(el){ el.classList.add('open'); el.removeAttribute('aria-hidden'); el.removeAttribute('inert'); setTimeout(()=>editor.input.focus(),0); }
  function hideEditor(el){ if(el.contains(document.activeElement)) document.activeElement.blur(); el.classList.remove('open'); el.setAttribute('aria-hidden','true'); el.setAttribute('inert',''); }
  function openTextEditor({text='',size=28,color='#0d2a6b',targetBox=null}={}){ editor.targetBox=targetBox; editor.input.value=text; editor.size.value=size; editor.color.value=color; editor.hex.value=color; showEditor(editor.el); }
  editor.cancel.onclick=()=>hideEditor(editor.el);
  document.getElementById('textEditor').addEventListener('click',e=>{ if(e.target.id==='textEditor') hideEditor(editor.el); });
  document.getElementById('addTextBtn').onclick=()=>{ if(current===0){ alert('Cover is locked.'); return; } openTextEditor(); };

  function normalizeHex(v){ v=(v||'').trim(); if(!v) return null; if(v[0]!=='#') v='#'+v; v=v.toLowerCase(); if(/^#[0-9a-f]{3}$/.test(v)) v='#'+v[1]+v[1]+v[2]+v[2]+v[3]+v[3]; if(/^#[0-9a-f]{6}$/.test(v)) return v; return null; }
  function rgbToHex(rgb){ const m=String(rgb).match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i); if(!m) return '#0d2a6b'; const r=(+m[1]).toString(16).padStart(2,'0'), g=(+m[2]).toString(16).padStart(2,'0'), b=(+m[3]).toString(16).padStart(2,'0'); return '#'+r+g+b; }
  editor.color.addEventListener('input',()=>{ editor.hex.value=editor.color.value; });
  editor.hex.addEventListener('input',()=>{ const v=normalizeHex(editor.hex.value); if(v) editor.color.value=v; });
  editor.save.onclick=()=>{ const text=editor.input.value; const size=Math.max(8,Math.min(200,parseInt(editor.size.value||'28',10))); const color=normalizeHex(editor.hex.value)||editor.color.value||'#0d2a6b';
    if(editor.targetBox){ const t=editor.targetBox.querySelector('.scrap-text'); if(!t) return; t.textContent=text; t.style.fontSize=size+'px'; t.style.color=color; t.style.height='auto'; editor.targetBox.style.height=Math.max(40,t.scrollHeight)+'px'; select(editor.targetBox); }
    else{ const c=pages()[current].querySelector('.page-canvas'); const box=document.createElement('div'); box.className='scrap-item'; box.style.left='40px'; box.style.top='40px'; box.style.width='320px';
      box.innerHTML='<div class="scrap-text" contenteditable="false" style="font-size:'+size+'px;color:'+color+'"></div><div class="mover"></div><div class="resizer"></div><div class="rotator"></div>';
      box.querySelector('.scrap-text').textContent=text; c.appendChild(box); makeDraggable(box); select(box); }
    hideEditor(editor.el); };
  editSelectedBtn.onclick=()=>{ if(current===0){ alert('Cover is locked.'); return; } const t=selectedItem?.querySelector('.scrap-text'); if(!t) return;
    openTextEditor({ text:t.textContent, size:parseInt(getComputedStyle(t).fontSize)||28, color:rgbToHex(getComputedStyle(t).color), targetBox:selectedItem }); };

  /* Photo upload */
  addPhotoBtn.onclick=()=>{ if(current===0){ alert('Cover is locked.'); return; } fileInput.click(); };
  fileInput.addEventListener('change',async e=>{
    const f=e.target.files?.[0]; if(!f) return;
    try{
      const url = await uploadToBucket(f, { page: current+1 });
      const c=pages()[current].querySelector('.page-canvas');
      const box=document.createElement('div'); box.className='scrap-item'; box.style.left='90px'; box.style.top='90px'; box.style.width='320px'; box.style.height='230px';
      box.dataset.fit='contain'; box.dataset.lock='1';
      box.innerHTML='<img class="scrap-img" alt="" src="'+url+'" decoding="async"><div class="mover"></div><div class="resizer"></div><div class="rotator"></div>';
      c.appendChild(box); makeDraggable(box);
      const imgEl=box.querySelector('.scrap-img'); const setAspect=()=>{ if(imgEl.naturalWidth&&imgEl.naturalHeight){ box.dataset.aspect=(imgEl.naturalWidth/imgEl.naturalHeight).toFixed(5);} };
      if(imgEl.complete) setAspect(); else imgEl.addEventListener('load',setAspect);
      fileInput.value=''; select(box);
    }catch(err){ alert("Upload failed: " + (err?.message || err)); }
  });
  function safeName(n){ return String(n||'photo').replace(/[\/\\?#%]+/g,'-').replace(/[^\w.\-]+/g,'_').slice(-80); }
  function extFromMime(m){ if(!m) return ''; const t=m.split('/')[1]||''; return t.replace(/\+/g,'-'); }
  async function uploadToBucket(file,{page}={}){ const ext=file.name.includes('.')?file.name.split('.').pop():extFromMime(file.type)||'bin';
    const fname=`${Date.now()}_${safeName(file.name)}`.replace(/\.+/g,'.'); const folder=`${STATE_ID}/page_${String(page||0).padStart(2,'0')}`; const path=`${folder}/${fname}`;
    const put=await fetch(`${SUPABASE_URL}/storage/v1/object/${BUCKET}/${encodeURIComponent(path)}?upsert=true`,{ method:'PUT', headers:{ apikey:SUPABASE_ANON, Authorization:'Bearer '+SUPABASE_ANON, 'Content-Type': file.type || 'application/octet-stream' }, body:file });
    if(!put.ok){ const txt=await put.text().catch(()=>String(put.status)); throw new Error(`Storage PUT ${put.status}: ${txt}`); }
    return `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${encodeURIComponent(path)}`;
  }

  /* Selection + toolbar toggles */
  function select(el){ if(selectedItem) selectedItem.classList.remove('selected'); selectedItem=el; if(selectedItem){ selectedItem.classList.add('selected'); selectedItem.style.zIndex=++zCounter; } updateToolbarState(); }
  function deselect(){ if(selectedItem) selectedItem.classList.remove('selected'); selectedItem=null; updateToolbarState(); }
  function updateToolbarState(){
    const t=selectedItem?.querySelector('.scrap-text'); const img=selectedItem?.querySelector('.scrap-img');
    const onText=!!t, onImg=!!img;
    fontSizeInput.disabled=!onText; fontColorInput.disabled=!onText; fontHexInput.disabled=!onText;

    if(onText){
      const curr=Math.round(parseFloat(getComputedStyle(t).fontSize)||22); fontSizeInput.value=curr;
      const m=String(getComputedStyle(t).color).match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
      const hex=m?('#'+(+m[1]).toString(16).padStart(2,'0')+(+m[2]).toString(16).padStart(2,'0')+(+m[3]).toString(16).padStart(2,'0')):'#0d2a6b';
      fontColorInput.value=hex; fontHexInput.value=hex;
    }else{ fontHexInput.value=''; }

    fitToggleBtn.disabled=!onImg; lockToggleBtn.disabled=!onImg;
    if(onImg){
      const fit=selectedItem.dataset.fit||'contain';
      fitToggleBtn.textContent='Fit: ' + (fit==='cover'?'Fill':'Contain');
      const lock=selectedItem.dataset.lock==='1';
      lockToggleBtn.textContent='Lock: ' + (lock?'On':'Off');
      if(img){ img.style.objectFit=(fit==='cover'?'cover':'contain'); }
    }else{
      fitToggleBtn.textContent='Fit: Contain'; lockToggleBtn.textContent='Lock: On';
    }
  }
  fontSizeInput.addEventListener('input',()=>{ const t=selectedItem?.querySelector('.scrap-text'); if(!t) return; let v=parseInt(fontSizeInput.value,10); if(isNaN(v)) return; v=Math.max(8,Math.min(200,v)); t.style.fontSize=v+'px'; t.style.height='auto'; const b=t.closest('.scrap-item'); if(b) b.style.height=Math.max(40,t.scrollHeight)+'px'; });
  fontColorInput.addEventListener('input',()=>{ const t=selectedItem?.querySelector('.scrap-text'); if(!t) return; fontHexInput.value=fontColorInput.value; t.style.color=fontColorInput.value; });
  fontHexInput.addEventListener('input',()=>{ const t=selectedItem?.querySelector('.scrap-text'); if(!t) return; const v=normalizeHex(fontHexInput.value); if(v){ fontColorInput.value=v; t.style.color=v; } });

  fitToggleBtn.addEventListener('click',()=>{ if(!selectedItem) return; if(!selectedItem.querySelector('.scrap-img')) return;
    selectedItem.dataset.fit = (selectedItem.dataset.fit==='cover'?'contain':'cover'); updateToolbarState(); });
  lockToggleBtn.addEventListener('click',()=>{ if(!selectedItem) return; if(!selectedItem.querySelector('.scrap-img')) return;
    selectedItem.dataset.lock = (selectedItem.dataset.lock==='1'?'0':'1'); updateToolbarState(); });

  function makeDraggable(el){
    let startX=0,startY=0,origX=0,origY=0,resizing=false,startW=0,startH=0; let dragging=false, dragPointerId=null; let rotating=false,startAngle=0,startPointerAngle=0;
    const res=el.querySelector('.resizer'); let rot=el.querySelector('.rotator'); if(!rot){ rot=document.createElement('div'); rot.className='rotator'; el.appendChild(rot); }
    let mover=el.querySelector('.mover'); if(!mover){ mover=document.createElement('div'); mover.className='mover'; el.appendChild(mover); }
    el.addEventListener('dragstart', e=>e.preventDefault());
    if(res){ res.addEventListener('mousedown',e=>{ if(!document.body.classList.contains('editing')) return; e.stopPropagation(); e.preventDefault(); resizing=true; startX=e.clientX; startY=e.clientY; startW=el.offsetWidth; startH=el.offsetHeight; document.addEventListener('mousemove',onMove); document.addEventListener('mouseup',onUp); }); }
    function onMove(e){ if(!resizing) return; const dx=e.clientX-startX, dy=e.clientY-startY; el.style.width=Math.max(60,startW+dx)+'px'; el.style.height=Math.max(40,startH+dy)+'px'; }
    function onUp(){ document.removeEventListener('mousemove',onMove); document.removeEventListener('mouseup',onUp); resizing=false; }
    rot.addEventListener('mousedown',e=>{ if(!document.body.classList.contains('editing')) return; e.stopPropagation(); e.preventDefault();
      rotating=true; const r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2; startPointerAngle=Math.atan2(e.clientY-cy,e.clientX-cx); startAngle=parseFloat(el.dataset.rot||'0')||0;
      document.addEventListener('mousemove',onRotate); document.addEventListener('mouseup',endRotate); });
    function onRotate(e){ if(!rotating) return; const r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2; const a=Math.atan2(e.clientY-cy,e.clientX-cx); const deg=startAngle+(a-startPointerAngle)*180/Math.PI; el.dataset.rot=String(deg); el.style.transform='rotate('+deg+'deg)'; }
    function endRotate(){ rotating=false; document.removeEventListener('mousemove',onRotate); document.removeEventListener('mouseup',endRotate); }
    function startDrag(e){ if(!document.body.classList.contains('editing')) return; dragging=true; dragPointerId=e.pointerId ?? 'mouse';
      try{ if(e.pointerId!=null && el.setPointerCapture) el.setPointerCapture(e.pointerId);}catch(_){} startX=e.clientX; startY=e.clientY; origX=el.offsetLeft; origY=el.offsetTop;
      window.addEventListener('pointermove',onPointerMove); window.addEventListener('pointerup',onPointerUp); window.addEventListener('pointercancel',onPointerUp); el.addEventListener('lostpointercapture',onPointerUp); }
    function onPointerMove(e){ if(!dragging) return; const dx=e.clientX-startX, dy=e.clientY-startY; el.style.left=(origX+dx)+'px'; el.style.top=(origY+dy)+'px'; }
    function onPointerUp(){ if(!dragging) return; try{ if(dragPointerId!=null && el.releasePointerCapture) el.releasePointerCapture(dragPointerId);}catch(_){} dragging=false; dragPointerId=null;
      window.removeEventListener('pointermove',onPointerMove); window.removeEventListener('pointerup',onPointerUp); window.removeEventListener('pointercancel',onPointerUp); el.removeEventListener('lostpointercapture',onPointerUp); }
    el.addEventListener('pointerdown', e=>{ if(!document.body.classList.contains('editing')) return; const isCtl=e.target.classList.contains('resizer')||e.target.classList.contains('rotator')||e.target.classList.contains('mover'); if(isCtl) return; e.preventDefault(); e.stopPropagation(); select(el); startDrag(e); });
    mover.addEventListener('pointerdown', e=>{ if(!document.body.classList.contains('editing')) return; e.preventDefault(); e.stopPropagation(); select(el); startDrag(e); });
  }

  document.getElementById('deleteSelectedBtn').onclick=()=>{ if(selectedItem){ selectedItem.remove(); deselect(); } };
  clearPageBtn.onclick=()=>{ if(current===0){ alert('Cover is locked.'); return; } const c=pages()[current].querySelector('.page-canvas'); if(confirm('Clear Page?')) c.querySelectorAll('.scrap-item').forEach(el=>el.remove()); };

  /* Add Page (top & toolbar) */
  function addPage(){
    const el=document.createElement('div');
    el.className='page';
    el.innerHTML='<div class="page-canvas"></div>';
    deck.appendChild(el);
    current=pages().length-1;
    setClasses();
  }
  addPageBtn.addEventListener('click', addPage);
  addPageToolbarBtn.addEventListener('click', addPage);

  /* Save current page */
  async function saveCurrentPage(){
    if(current===0){ alert('Cover is locked.'); return; }
    const p=current+1;
    await fetch(`${SUPABASE_URL}/rest/v1/journal_text?doc_id=eq.${encodeURIComponent(STATE_ID)}&page_no=eq.${p}`,{method:'DELETE',headers:apiHeaders});
    await fetch(`${SUPABASE_URL}/rest/v1/journal_photo?doc_id=eq.${encodeURIComponent(STATE_ID)}&page_no=eq.${p}`,{method:'DELETE',headers:apiHeaders});
    const c=pages()[current].querySelector('.page-canvas'); const texts=[], photos=[];
    [...c.querySelectorAll('.scrap-item')].forEach(el=>{
      const S={left:parseInt(el.style.left||'0',10), top:parseInt(el.style.top||'0',10), width:parseInt(el.style.width||'0',10), height:parseInt(el.style.height||'0',10)};
      const rot=parseFloat(el.dataset.rot||'0')||0; const img=el.querySelector('.scrap-img');
      if(img){ photos.push({doc_id:STATE_ID,page_no:p,x:S.left,y:S.top,w:S.width,h:S.height,rot,fit:el.dataset.fit||'contain',lock:(el.dataset.lock==='1'),src:img.src}); }
      else{ const t=el.querySelector('.scrap-text'); texts.push({doc_id:STATE_ID,page_no:p,x:S.left,y:S.top,w:S.width,h:S.height,rot,html:t?t.outerHTML:''}); }
    });
    if(texts.length) await fetch(`${SUPABASE_URL}/rest/v1/journal_text`,{method:'POST',headers:{...apiHeaders,Prefer:'return=minimal'},body:JSON.stringify(texts)});
    if(photos.length) await fetch(`${SUPABASE_URL}/rest/v1/journal_photo`,{method:'POST',headers:{...apiHeaders,Prefer:'return=minimal'},body:JSON.stringify(photos)});
  }
  saveBtn.addEventListener('click', async ()=>{ const orig=saveBtn.textContent; saveBtn.disabled=true; saveBtn.textContent='Savingâ€¦';
    try{ await saveCurrentPage(); saveBtn.textContent='Saved âœ“'; setTimeout(()=>{ saveBtn.textContent=orig; saveBtn.disabled=false; document.body.classList.remove('editing'); hideToolbar(); },600); }
    catch(e){ console.warn(e); saveBtn.textContent='Retry Save'; saveBtn.disabled=false; }
  });

  /* Load all existing content */
  async function cloudLoadAll(){
    const [tRes,pRes]=await Promise.all([
      fetch(`${SUPABASE_URL}/rest/v1/journal_text?doc_id=eq.${encodeURIComponent(STATE_ID)}&select=*`,{headers:apiHeaders}),
      fetch(`${SUPABASE_URL}/rest/v1/journal_photo?doc_id=eq.${encodeURIComponent(STATE_ID)}&select=*`,{headers:apiHeaders})
    ]);
    if(!tRes.ok||!pRes.ok){ setClasses(); return; }
    const texts=await tRes.json(), photos=await pRes.json();
    const need=Math.max(6, ...texts.map(r=>r.page_no||1), ...photos.map(r=>r.page_no||1));
    while(pages().length<need){ const el=document.createElement('div'); el.className='page'; el.innerHTML='<div class="page-canvas"></div>'; deck.appendChild(el); }
    const byPage=new Map(); for(let i=1;i<=pages().length;i++) byPage.set(i,{texts:[],photos:[]});
    texts.forEach(r=>byPage.get(r.page_no)?.texts.push(r));
    photos.forEach(r=>byPage.get(r.page_no)?.photos.push(r));
    for(let i=2;i<=pages().length;i++){
      const c=pages()[i-1]?.querySelector('.page-canvas'); if(!c) continue;
      (byPage.get(i).texts||[]).forEach(it=>{ const box=document.createElement('div'); box.className='scrap-item';
        box.style.left=it.x+'px'; box.style.top=it.y+'px'; box.style.width=it.w+'px'; box.style.height=it.h+'px';
        if(it.rot){ box.dataset.rot=it.rot; box.style.transform='rotate('+it.rot+'deg)'; }
        const holder=document.createElement('div'); holder.innerHTML=(it.html||'').trim();
        const inner=holder.firstElementChild||document.createElement('div'); inner.setAttribute('contenteditable','false');
        box.appendChild(inner); box.insertAdjacentHTML('beforeend','<div class="mover"></div><div class="resizer"></div><div class="rotator"></div>');
        c.appendChild(box); makeDraggable(box);
      });
      (byPage.get(i).photos||[]).forEach(it=>{ const box=document.createElement('div'); box.className='scrap-item';
        box.style.left=it.x+'px'; box.style.top=it.y+'px'; box.style.width=it.w+'px'; box.style.height=it.h+'px';
        box.dataset.fit=it.fit||'contain'; box.dataset.lock=it.lock?'1':'0';
        if(it.rot){ box.dataset.rot=it.rot; box.style.transform='rotate('+it.rot+'deg)'; }
        box.innerHTML='<img class="scrap-img" alt="" src="'+it.src+'" decoding="async"><div class="mover"></div><div class="resizer"></div><div class="rotator"></div>';
        c.appendChild(box); makeDraggable(box);
      });
    }
    setClasses();
  }

  (async function(){ await cloudLoadAll(); setClasses(); })();
})();
</script>
</body>
</html>
