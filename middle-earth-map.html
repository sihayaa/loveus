<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Middle-earth Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=IM+Fell+English:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#1a140f; --ink:#d7c6a3; --ring:#bfa35a;
      --shadow:0 8px 24px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; overflow:hidden; user-select:none;
      background: radial-gradient(1200px 800px at 70% 10%, #2a221b, #15100b 70%, #0d0a07 100%), var(--bg);
      color:var(--ink); font-family:"IM Fell English",serif;
    }
    #particles{position:fixed; inset:0; z-index:0; pointer-events:none}

    .topbar{
      position:fixed; inset:12px 12px auto 12px; z-index:5;
      display:flex; align-items:center; gap:12px; width:calc(100% - 24px);
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border:1px solid rgba(191,163,90,.5);
      border-radius:10px; background:rgba(32,26,20,.6); color:var(--ink);
      box-shadow:var(--shadow); backdrop-filter:blur(3px); cursor:pointer; text-decoration:none; font-size:14px;
    }
    .chip:hover{background:rgba(50,40,30,.75)}
    .title{
      flex:1; text-align:center; font-family:"Cinzel",serif; font-weight:700;
      letter-spacing:.5px; font-size:28px; text-shadow:0 0 8px rgba(255,231,160,.2);
    }

    .drawer{
      position:fixed; left:12px; bottom:12px; z-index:5;
      background:rgba(32,26,20,.8); border:1px solid rgba(191,163,90,.45);
      border-radius:12px; padding:10px; display:flex; gap:10px; align-items:center; box-shadow:var(--shadow);
      backdrop-filter:blur(3px);
    }
    .drawer label{font-size:12px; opacity:.85}
    .drawer input[type="range"]{width:140px}

    .viewport{position:absolute; inset:64px 0 0 0; z-index:2; overflow:hidden; touch-action:none}
    /* FIX: anchor at (0,0), not 50%/50% */
    .map-inner{position:absolute; top:0; left:0; transform-origin:0 0; will-change:transform}
    .map-img{display:block; width:100%; height:auto; pointer-events:none; filter:contrast(1.02) brightness(.96) sepia(.08)}

    .quote{
      position:fixed; z-index:4; max-width:min(70ch,90vw); left:50%; bottom:26px; transform:translateX(-50%);
      background:rgba(40,30,22,.9); border:1px solid rgba(191,163,90,.5); border-radius:14px; padding:12px 16px;
      box-shadow:var(--shadow); text-align:center; font-family:"Forte","Cinzel",serif; font-size:22px; letter-spacing:.2px;
      opacity:0; animation:fade 4.2s ease forwards;
    }
    @keyframes fade{
      0%{opacity:0; transform:translate(-50%,10px)}
      12%{opacity:1; transform:translate(-50%,0)}
      70%{opacity:1}
      100%{opacity:0; transform:translate(-50%,8px)}
    }
  </style>
</head>
<body>
  <canvas id="particles"></canvas>

  <div class="topbar">
    <a class="chip" href="javascript:void(0)" onclick="history.back()">‚üµ Back Home</a>
    <div class="title">Middle-earth Map</div>
    <a class="chip" href="#" onclick="resetView()">Reset View</a>
  </div>

  <div class="drawer">
    <label>Particles:</label>
    <button class="chip" id="modeBtn">Snow</button>
    <label>Intensity</label>
    <input type="range" id="intensity" min="0" max="2" step="1" value="1" />
    <button class="chip" id="pauseBtn">Pause</button>
  </div>

  <div id="viewport" class="viewport">
    <div id="mapInner" class="map-inner">
      <img id="mapImg" class="map-img" alt="Map"
        src="https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/mem_map.png" />
    </div>
  </div>

  <script>
    // Quotes
    const quotes=[
      "There and back again.","Not all those who wander are lost.",
      "Even the smallest person can change the course of the future.",
      "May it be a light for you in dark places.","The road goes ever on and on."
    ];
    function spawnQuote(){
      const q=quotes[Math.floor(Math.random()*quotes.length)];
      const el=document.createElement('div'); el.className='quote'; el.textContent=q;
      document.body.appendChild(el); setTimeout(()=>el.remove(),4200);
    }

    // Map pan/zoom
    const viewport=document.getElementById('viewport');
    const mapInner=document.getElementById('mapInner');
    const mapImg=document.getElementById('mapImg');

    const state={scale:1,minScale:.4,maxScale:3.5,tx:0,ty:0,dragging:false,lastX:0,lastY:0,natW:1000,natH:1000};

    mapImg.addEventListener('load',()=>{ state.natW=mapImg.naturalWidth; state.natH=mapImg.naturalHeight; centerFit(); apply(); });

    function centerFit(){
      const vw=viewport.clientWidth, vh=viewport.clientHeight;
      const s=Math.min(vw/state.natW, vh/state.natH)*0.95;
      state.scale=s;
      state.tx=vw/2 - (state.natW*s)/2;
      state.ty=vh/2 - (state.natH*s)/2;
    }
    function apply(){ mapInner.style.transform=`translate(${state.tx}px, ${state.ty}px) scale(${state.scale})`; }
    function clamp(v,min,max){return Math.max(min,Math.min(max,v));}

    viewport.addEventListener('pointerdown',e=>{
      state.dragging=true; state.lastX=e.clientX; state.lastY=e.clientY; viewport.setPointerCapture(e.pointerId);
    });
    viewport.addEventListener('pointermove',e=>{
      if(!state.dragging) return;
      const dx=e.clientX-state.lastX, dy=e.clientY-state.lastY;
      state.tx+=dx; state.ty+=dy; state.lastX=e.clientX; state.lastY=e.clientY; apply();
    });
    viewport.addEventListener('pointerup',e=>{
      state.dragging=false; viewport.releasePointerCapture(e.pointerId);
    });

    viewport.addEventListener('wheel',e=>{
      e.preventDefault();
      const factor=(e.deltaY<0)?1.1:0.9;
      const newScale=clamp(state.scale*factor, state.minScale, state.maxScale);
      zoomAt(e.clientX,e.clientY,newScale);
    },{passive:false});

    function zoomAt(cx,cy,newScale){
      const prev=state.scale; if(newScale===prev) return;
      const rect=viewport.getBoundingClientRect();
      const x=(cx-rect.left-state.tx)/prev;
      const y=(cy-rect.top -state.ty)/prev;
      state.tx=cx-rect.left - x*newScale;
      state.ty=cy-rect.top  - y*newScale;
      state.scale=newScale; apply();
    }

    function resetView(){ centerFit(); apply(); }
    viewport.addEventListener('dblclick', resetView);

    // click empty to show quote
    let moved=false;
    viewport.addEventListener('pointerdown',()=>{moved=false;});
    viewport.addEventListener('pointermove',()=>{moved=true;});
    viewport.addEventListener('click',e=>{
      if(moved) return;
      if(e.target.closest('.chip')) return;
      spawnQuote();
    });

    window.addEventListener('resize',()=>{ centerFit(); apply(); });

    // Particles
    const canvas=document.getElementById('particles'), ctx=canvas.getContext('2d');
    let W=0,H=0; function resize(){ W=canvas.width=innerWidth; H=canvas.height=innerHeight; } addEventListener('resize',resize); resize();

    let mode='snow', intensity=1, paused=false;
    const modeBtn=document.getElementById('modeBtn'), pauseBtn=document.getElementById('pauseBtn'), intensitySlider=document.getElementById('intensity');
    modeBtn.onclick=()=>{ mode=(mode==='snow'?'embers':'snow'); modeBtn.textContent=(mode==='snow'?'Snow':'Embers'); };
    pauseBtn.onclick=()=>{ paused=!paused; pauseBtn.textContent=paused?'Resume':'Pause'; };
    intensitySlider.oninput=e=>{ intensity=+e.target.value; };

    const parts=[];
    function seed(n=200){ parts.length=0; for(let i=0;i<n;i++) parts.push(makeP()); }
    function makeP(){ return {x:Math.random()*W,y:Math.random()*H,vx:(Math.random()-0.5)*0.2,vy:mode==='snow'?(0.3+Math.random()*0.6):(0.6+Math.random()*1.2),s:0.7+Math.random()*1.6,a:0.4+Math.random()*0.6}; }
    function step(){
      requestAnimationFrame(step); if(paused) return;
      const target=[120,220,420][intensity]; if(parts.length!==target) seed(target);
      ctx.clearRect(0,0,W,H);
      for(const p of parts){
        p.x+=p.vx + (mode==='snow'? Math.sin(p.y*0.002)*0.05 : Math.sin(p.y*0.01)*0.08);
        p.y+=p.vy;
        if(p.y>H+8){ p.y=-8; p.x=Math.random()*W; }
        if(p.x<-8) p.x=W+8; if(p.x>W+8) p.x=-8;
        if(mode==='snow'){
          ctx.globalAlpha=p.a*.9; ctx.beginPath(); ctx.arc(p.x,p.y,p.s+0.6,0,Math.PI*2); ctx.fillStyle="rgba(255,255,255,.9)"; ctx.fill();
        } else {
          ctx.globalAlpha=p.a; ctx.beginPath(); ctx.arc(p.x,p.y,p.s,0,Math.PI*2);
          ctx.fillStyle="rgba(255,200,120,.85)"; ctx.shadowColor="rgba(255,180,80,.8)"; ctx.shadowBlur=6; ctx.fill(); ctx.shadowBlur=0;
        }
      }
      ctx.globalAlpha=1;
    }
    seed(220); step();
  </script>
</body>
</html>
