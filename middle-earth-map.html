<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Middle-earth Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0e0f12; --ink:#e7dbc3; --zoom:1;
    --gold:#d4af37; --glow:rgba(160,220,255,.55);
    --shadow:0 18px 55px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.06);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; overflow:hidden; user-select:none;
    background: radial-gradient(1400px 800px at 70% 10%, #1b1b1f, #0f1114 70%, #0a0b0d 100%), var(--bg);
    color:var(--ink); font-family: ui-serif, Georgia, "Times New Roman", serif;
  }

  /* particles */
  #particles{position:fixed; inset:0; z-index:1; pointer-events:none}

  /* top bar */
  .topbar{position:fixed; inset:12px 12px auto 12px; z-index:12; display:flex; gap:12px; align-items:center}
  .chip{display:inline-flex; align-items:center; gap:8px; padding:7px 12px; border:1px solid rgba(212,175,55,.5);
    border-radius:10px; background:rgba(36,31,24,.6); color:var(--ink); box-shadow:var(--shadow); text-decoration:none; font-size:13px; cursor:pointer}
  .chip[disabled]{opacity:.45; pointer-events:none}
  .chip:hover{background:rgba(54,46,36,.78)}
  .title{flex:1; text-align:center; font-family:"Cinzel",serif; font-weight:700; letter-spacing:.5px; font-size:28px; text-shadow:0 0 8px rgba(255,231,160,.2)}

  /* === One Ring pin counter === */
  .ring-badge{
    width:42px; height:42px; border-radius:50%;
    display:inline-flex; align-items:center; justify-content:center;
    border:2px solid rgba(212,175,55,.85);
    background:
      radial-gradient(circle at 50% 50%, rgba(255,220,130,.12), rgba(0,0,0,0) 62%),
      conic-gradient(from 0deg, rgba(255,210,120,.20), rgba(212,175,55,.36), rgba(255,210,120,.20));
    box-shadow:0 0 12px rgba(212,175,55,.35), inset 0 0 12px rgba(212,175,55,.22);
    margin-left:4px;
    animation:ringPulse 3.8s ease-in-out infinite;
  }
  .ring-badge span{
    font-family:"Cinzel",serif; font-weight:700; font-size:14px;
    color:#2b2414; text-shadow:0 0 6px rgba(255,240,200,.45);
    line-height:1;
  }
  @keyframes ringPulse{
    0%,100%{ box-shadow:0 0 10px rgba(212,175,55,.30), inset 0 0 10px rgba(212,175,55,.18) }
    50%     { box-shadow:0 0 16px rgba(212,175,55,.55), inset 0 0 12px rgba(212,175,55,.28) }
  }

  /* map */
  .viewport{position:absolute; inset:64px 0 0 0; z-index:2; overflow:hidden; touch-action:none; cursor:grab}
  .viewport.dragging{cursor:grabbing}
  .map-inner{position:absolute; top:0; left:0; transform-origin:0 0; will-change:transform}
  .map-img{display:block; height:auto; pointer-events:none; filter:contrast(1.02) brightness(.96) sepia(.08); box-shadow:var(--shadow); border-radius:4px}

  /* pins */
  .pins{position:absolute; inset:0; z-index:6; pointer-events:auto}
  .pin{
    position:absolute; cursor:pointer; transform:translate(-50%,-100%) scale(calc(1/var(--zoom)));
    width:24px; height:24px; border-radius:50%;
    background:radial-gradient(circle at 45% 40%, #f5e7b0, #c9a84b 60%, #7b6230 100%);
    box-shadow:0 0 0 1px rgba(0,0,0,.5), 0 2px 6px rgba(0,0,0,.45);
    display:flex; align-items:center; justify-content:center
  }
  .pin.secret{
    background:radial-gradient(circle at 45% 40%, #e9d5ff, #b987ff 60%, #5a33a6 100%);
    box-shadow:0 0 0 1px rgba(40,0,70,.45), 0 2px 7px rgba(90,51,166,.55);
  }
  .pin span{font-size:14px; line-height:1; color:#281f11}
  .pin:hover{box-shadow:0 0 0 1px rgba(0,0,0,.6), 0 0 12px rgba(212,175,55,.45)}
  .pin.secret:hover{box-shadow:0 0 0 1px rgba(40,0,70,.6), 0 0 12px rgba(185,135,255,.55)}
  .pintip{position:absolute; transform:translate(-50%,-120%); background:rgba(30,25,20,.92);
    color:#e7dbc3; border:1px solid rgba(212,175,55,.55); border-radius:8px; padding:4px 8px; font-size:12px; white-space:nowrap; pointer-events:none}

  .hint{position:fixed; right:16px; top:58px; z-index:12; background:rgba(30,25,20,.92); border:1px solid rgba(212,175,55,.5);
    color:#e7dbc3; border-radius:10px; padding:8px 10px; font-size:12px; display:none}
  .hint.on{display:block}

  /* modals base */
  .modal{position:fixed; inset:0; z-index:1000; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55); overflow:hidden}
  .modal.on{display:flex}
  .panel{
    position:relative; width:min(720px, 92vw); max-height:85vh;
    overflow-y:auto; overflow-x:clip;
    border-radius:16px; box-shadow:var(--shadow);
  }
  .panel::-webkit-scrollbar{ width:0; height:0; }
  .panel{ scrollbar-width:none; -ms-overflow-style:none; }

  /* === PARCHMENT w/ TRUE SCROLL (rolled top & bottom) === */
  .parchment{
    background:
      radial-gradient(120% 100% at 10% 0%, rgba(255,255,255,.35), rgba(0,0,0,0) 60%),
      radial-gradient(120% 100% at 90% 100%, rgba(0,0,0,.18), rgba(0,0,0,0) 60%),
      linear-gradient(#efe6cf, #e2d4b0);
    color:#2b2414;
    border:1px solid #b79b5a;
  }
  .parchment::before{
    content:""; position:absolute; inset:12px; pointer-events:none; border-radius:12px;
    background:
      repeating-linear-gradient(0deg, rgba(0,0,0,.035) 0 3px, rgba(0,0,0,0) 3px 6px),
      radial-gradient(420px 240px at 50% 10%, rgba(0,0,0,.08), transparent 60%);
    mix-blend-mode:multiply; opacity:.45;
  }
  .rolled::after{
    content:""; position:absolute; inset:0; border-radius:16px; pointer-events:none;
    box-shadow:
      inset 0 0 18px rgba(0,0,0,.32),
      inset 0 18px 30px rgba(0,0,0,.12),
      inset 0 -18px 30px rgba(0,0,0,.12),
      inset 18px 0 30px rgba(0,0,0,.10),
      inset -18px 0 30px rgba(0,0,0,.10);
    mix-blend-mode:multiply;
  }
  .scrollpaper{ padding-top:36px; padding-bottom:32px; }
  .scrollpaper::before,
  .scrollpaper::after{
    content:"";
    position:absolute;
    left:12px;
    right:12px;
    height:26px;
    border-radius:18px;
    background:
      radial-gradient(120% 100% at 15% 50%, rgba(255,255,255,.75), rgba(255,255,255,.05) 45%, transparent 60%),
      radial-gradient(120% 100% at 85% 50%, rgba(255,255,255,.55), rgba(255,255,255,.05) 50%, transparent 65%),
      linear-gradient(90deg, #d7c39a, #c9b182 40%, #bfa171 60%, #d7c39a);
    box-shadow:0 6px 18px rgba(0,0,0,.25), inset 0 0 12px rgba(0,0,0,.15);
  }
  .scrollpaper::before{ top:-14px; }
  .scrollpaper::after { bottom:-14px; box-shadow:0 -6px 18px rgba(0,0,0,.25), inset 0 0 12px rgba(0,0,0,.15); }

  .scroll-body{padding:18px 20px 14px 20px}
  .scribe-line{display:flex; align-items:center; gap:10px; margin:8px 0 4px}
  .scribe-line .label{font-weight:700; font-family:"Cinzel",serif; letter-spacing:.3px}
  .scribe-line .rule{flex:1; height:1px; background:linear-gradient(90deg,#b79b5a,rgba(183,155,90,.1)); opacity:.6}

  .scribe-text{
    margin:0 0 10px; white-space:pre-wrap; line-height:1.5;
    font-family:"Brush Script MT","Brush Script Std","Segoe Script","Comic Sans MS",cursive;
    color:#496CBA; font-size:1.2rem;
  }
  .image-wrap img{max-width:100%; height:auto; border-radius:8px; border:1px solid rgba(0,0,0,.14); box-shadow:0 6px 16px rgba(0,0,0,.25)}

  /* Form inputs (parchment) */
  .row{display:flex; gap:10px; margin:10px 0}
  .row label{width:90px; opacity:.9; font-size:13px; padding-top:9px; color:#3b2f1b; font-family:"Cinzel",serif}
  .row input[type="text"], .row textarea{
    flex:1; background:#f3ead0; color:#2b2414;
    border:1px solid #b79b5a; border-radius:10px; padding:9px 10px; font-size:14px;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.6), 0 2px 6px rgba(0,0,0,.08);
  }
  .row textarea{min-height:86px; resize:vertical}
  .row input[type="text"]::placeholder, .row textarea::placeholder{color:#7b6a4a}
  .row input[type="file"]{flex:1; color:#2b2414}
  .row input[type="file"]::file-selector-button{
    background:#e8dcc0; color:#2b2414; border:1px solid #b79b5a; border-radius:9px; padding:7px 10px; cursor:pointer;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.6), 0 2px 6px rgba(0,0,0,.08);
  }
  .row input[type="text"]:focus, .row textarea:focus{
    outline:none; border-color:#c9ac68; box-shadow:0 0 0 2px rgba(201,172,104,.25), inset 0 1px 0 rgba(255,255,255,.6);
  }

  .panel .icon-btn{
    position:absolute; top:8px; right:8px; border:none; background:transparent; font-size:18px; line-height:1;
    color:#5b4723; cursor:pointer; padding:6px 8px; border-radius:8px;
  }
  .panel .icon-btn:hover{background:rgba(183,155,90,.18)}
  .actions{display:flex; gap:8px; justify-content:flex-end; padding:0 14px 14px}
  .btn{padding:8px 12px; border-radius:10px; border:1px solid rgba(212,175,55,.55); background:#2b231a; color:#e7dbc3; cursor:pointer}
  .btn:hover{filter:brightness(1.06)}

  /* Evenstar overlay (unchanged visuals) */
  .gondor{position:fixed; inset:0; z-index:2000; display:none; place-items:center}
  .gondor.on{display:grid}
  .veil{position:absolute; inset:0; background: radial-gradient(1200px 800px at 50% 45%, rgba(5,14,20,.85), rgba(0,0,0,.65) 70%, rgba(0,0,0,.80)); opacity:0; animation:veilIn .45s ease-out forwards; pointer-events:none;}
  .gate{position:absolute; width:min(72vmin,680px); aspect-ratio:1/1; border-radius:50%;
    background:
      radial-gradient(closest-side, rgba(159,227,255,.18), rgba(159,227,255,0) 65%),
      radial-gradient(closest-side, rgba(159,227,255,.10), rgba(159,227,255,0) 40%);
    box-shadow:0 0 32px rgba(159,227,255,.22), inset 0 0 18px rgba(159,227,255,.20);
    opacity:0; transform:scale(.92);
    animation:gateShow .40s ease-out forwards var(--gate-pop-delay, 1.8s); pointer-events:none;}
  .gate.ring::before{content:""; position:absolute; inset:8%; border-radius:50%; border:1px solid rgba(159,227,255,.45); box-shadow:0 0 12px rgba(159,227,255,.20), inset 0 0 8px rgba(159,227,255,.12)}
  .gate.open{animation:gateOpen 1.05s ease-in forwards}
  .evenstar-wrap{position:relative; display:grid; place-items:center}
  .evenstar{width:min(52vmin,520px); height:auto; filter:drop-shadow(0 0 12px var(--glow)) drop-shadow(0 0 26px rgba(160,220,255,.22))}
  .evenstar.core{opacity:0; animation:starIn .6s ease-out .05s forwards}
  .evenstar.glow{position:absolute; inset:0; margin:auto; opacity:.85; filter:blur(10px) brightness(1.25) saturate(1.3) drop-shadow(0 0 22px rgba(160,220,255,.35)); mix-blend-mode:screen; animation:glowPulse 2.6s ease-in-out .6s infinite}
  .evenstar.shine{position:absolute; inset:0; margin:auto; opacity:.9; mix-blend-mode:screen; -webkit-mask-image: linear-gradient(115deg, transparent 40%, rgba(255,255,255,.95) 50%, transparent 60%); mask-image: linear-gradient(115deg, transparent 40%, rgba(255,255,255,.95) 50%, transparent 60%); -webkit-mask-size: 220% 220%; mask-size:220% 220%; animation:shineSweep 1.6s ease-in-out .7s 2}
  @keyframes veilIn{from{opacity:0} to{opacity:1}}
  @keyframes starIn{from{opacity:0; transform:scale(.985)} to{opacity:1; transform:scale(1)}}
  @keyframes glowPulse{0%,100%{opacity:.75; filter:blur(10px) brightness(1.15) saturate(1.2) drop-shadow(0 0 18px rgba(160,220,255,.28))} 50%{opacity:1; filter:blur(12px) brightness(1.33) saturate(1.35) drop-shadow(0 0 28px rgba(160,220,255,.40))}}
  @keyframes shineSweep{0%{-webkit-mask-position:-60% -60%; mask-position:-60% -60%}100%{-webkit-mask-position:160% 160%; mask-position:160% 160%}}
  @keyframes gateShow{from{opacity:0; transform:scale(.92)} to{opacity:1; transform:scale(1)}}
  @keyframes gateOpen{from{transform:scale(1); opacity:1} to{transform:scale(1.35); opacity:0}}

  /* DELETE confirm — parchment scroll, orange cursive text */
  .scroll-confirm.parchment{width:min(560px, 92vw)}
  .doom-msg{
    font-family:"Freestyle Script","Freestyle Cursive","Brush Script MT","Brush Script Std","Segoe Script",cursive;
    color:#E86415; font-size:28px; letter-spacing:.4px; line-height:1.25;
    margin:16px 18px 20px; text-align:center;
  }
  .doom-actions{display:flex; gap:10px; justify-content:center; padding:0 0 14px}
  .btn-ghost{padding:9px 14px; border-radius:10px; border:1px solid #b79b5a; background:#f1e7cc; color:#2b2414; cursor:pointer}
  .btn-danger{padding:9px 14px; border-radius:10px; border:1px solid #E86415; background:linear-gradient(#ffe0cc,#ffd0b3); color:#521f00; font-weight:700; cursor:pointer}
  .btn-ghost:hover{filter:brightness(1.03)}
  .btn-danger:hover{filter:brightness(1.02)}
</style>
</head>
<body>
  <canvas id="particles"></canvas>

  <div class="topbar">
    <a class="chip" href="javascript:history.back()">⟵ Back Home</a>
    <div class="title">MIDDLE-EARTH MAP</div>
    <button id="pinBtn" class="chip">📍 Pin it</button>
    <button id="exitSecretBtn" class="chip" style="display:none">✨ Exit Secret</button>

    <!-- One Ring counter -->
    <div id="ringCount" class="ring-badge" aria-label="Total pins" title="Total pins">
      <span>0</span>
    </div>

    <a class="chip" href="#" onclick="resetView(); return false;">Reset View</a>
  </div>
  <div id="pinHint" class="hint">Pin mode: click anywhere on the map</div>

  <div id="viewport" class="viewport">
    <div id="mapInner" class="map-inner">
      <img id="mapImg" class="map-img" alt="Map"
           loading="eager" decoding="async" fetchpriority="high"
           src="https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/mem_map.png" />
      <div id="pins" class="pins"></div>
    </div>
  </div>

  <!-- Add Pin -->
  <div id="modalAdd" class="modal" aria-hidden="true">
    <div class="panel parchment rolled scrollpaper" role="dialog" aria-modal="true" aria-labelledby="addTitle">
      <h3 id="addTitle" style="margin:0; padding:16px 18px 0; font-family:'Cinzel',serif">Add Pin</h3>
      <div class="scroll-body">
        <div class="row"><label>Title*</label><input id="aTitle" type="text" placeholder="Title for hover…" required /></div>
        <div class="row"><label>Caption</label><textarea id="aCaption" rows="3" placeholder="Optional caption…"></textarea></div>
        <div class="row"><label>Photo</label><input id="aFile" type="file" accept="image/*" /></div>
      </div>
      <div class="actions"><button class="btn" id="aCancel">Cancel</button><button class="btn" style="background:#3a2e21" id="aSave">Save Pin</button></div>
    </div>
  </div>

  <!-- View Pin -->
  <div id="modalView" class="modal" aria-hidden="true">
    <div class="panel parchment rolled scrollpaper" role="dialog" aria-modal="true" aria-labelledby="viewTitle">
      <button id="vDelete" class="icon-btn" title="Delete pin">✕</button>
      <div class="scroll-body">
        <div class="scribe-line"><span class="label">Title:</span><div class="rule"></div></div>
        <div id="viewTitleText" class="scribe-text"></div>

        <div id="viewCaptionRow">
          <div class="scribe-line"><span class="label">Caption:</span><div class="rule"></div></div>
          <div id="viewCaptionText" class="scribe-text"></div>
        </div>

        <div id="viewImageWrap" class="image-wrap"></div>
      </div>
      <div class="actions"><button class="btn" id="vClose">Close</button></div>
    </div>
  </div>

  <!-- Delete confirm -->
  <div id="modalConfirm" class="modal" aria-hidden="true">
    <div class="panel parchment rolled scrollpaper scroll-confirm" role="dialog" aria-modal="true">
      <div class="doom-msg">
        You stand upon the edge of doom. Deleting this file will seal its fate.<br>
        Do you wish to continue?
      </div>
      <div class="doom-actions">
        <button id="cCancel" class="btn-ghost">Cancel</button>
        <button id="cDelete" class="btn-danger">Delete</button>
      </div>
    </div>
  </div>

  <!-- Evenstar overlay -->
  <div id="gondor" class="gondor" aria-hidden="true">
    <div class="veil"></div>
    <div class="evenstar-wrap">
      <img id="evenstarCore" class="evenstar core"  alt="Evenstar" src="">
      <img id="evenstarGlow" class="evenstar glow"  alt=""         src="">
      <img id="evenstarShine"class="evenstar shine" alt=""         src="">
    </div>
    <div id="gate" class="gate ring" aria-hidden="true"></div>
  </div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const EVENSTAR_URL = "https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/evenstar-dark.png";

  /* ===== Supabase (table-only) ===== */
  const SUPABASE_URL = "https://tmjozxcjylcxgemffnoc.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
  let sb=null, useSB=false;
  try{ sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY); useSB=true; }catch(e){ console.warn("Supabase init failed; using localStorage.", e); }

  /* ===== Camera (pan/zoom) ===== */
  const viewport = document.getElementById('viewport');
  const mapInner = document.getElementById('mapInner');
  const mapImg   = document.getElementById('mapImg');

  const FIT = 0.70;
  const ZOOM_SMOOTH = 0.24;
  const cam = { x:0,y:0,s:1, tx:0,ty:0,ts:1, sMin:0.35, sMax:3.5, dragging:false, lx:0, ly:0, natW:2048, natH:1536 };

  mapImg.addEventListener('load', ()=>{
    cam.natW = mapImg.naturalWidth || cam.natW;
    cam.natH = mapImg.naturalHeight || cam.natH;
    mapImg.style.width  = cam.natW + 'px';
    mapImg.style.height = 'auto';
    centerFit(); refreshPins(); setZoomVar();
    for (const id of ["evenstarCore","evenstarGlow","evenstarShine"]){
      document.getElementById(id).src = EVENSTAR_URL;
    }
  });
  if (mapImg.complete) mapImg.dispatchEvent(new Event('load'));

  function centerFit(){
    const vw = viewport.clientWidth, vh = viewport.clientHeight;
    const s  = Math.min(vw/cam.natW, vh/cam.natH) * FIT;
    cam.s = cam.ts = s;
    cam.x = cam.tx = vw/2 - (cam.natW*s)/2;
    cam.y = cam.ty = vh/2 - (cam.natH*s)/2;
    applyCam();
  }
  function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
  function applyCam(){ mapInner.style.transform = `matrix(${cam.s},0,0,${cam.s},${cam.x},${cam.y})`; }
  function setZoomVar(){ document.documentElement.style.setProperty('--zoom', cam.s.toFixed(3)); }
  function zoomAt(cx,cy,newScale){
    newScale = clamp(newScale, cam.sMin, cam.sMax);
    const r = viewport.getBoundingClientRect();
    const wx = (cx - r.left - cam.x) / cam.s;
    const wy = (cy - r.top  - cam.y) / cam.s;
    cam.ts = newScale;
    cam.tx = cx - r.left - wx * newScale;
    cam.ty = cy - r.top  - wy * newScale;
  }

  viewport.addEventListener('pointerdown', e=>{
    if (e.target.closest('.pin')) return;  // don't start panning on pins
    cam.dragging = true; moved=false; cam.lx=e.clientX; cam.ly=e.clientY;
    viewport.classList.add('dragging'); viewport.setPointerCapture(e.pointerId);
  });
  let moved=false;
  viewport.addEventListener('pointermove', e=>{
    if(!cam.dragging) return;
    const dx=e.clientX-cam.lx, dy=e.clientY-cam.ly; moved = moved || Math.hypot(dx,dy)>2;
    cam.tx+=dx; cam.ty+=dy; cam.lx=e.clientX; cam.ly=e.clientY;
  });
  viewport.addEventListener('pointerup', e=>{
    cam.dragging=false; viewport.classList.remove('dragging'); if (e.pointerId) viewport.releasePointerCapture(e.pointerId);
  });
  viewport.addEventListener('wheel', e=>{
    e.preventDefault(); const factor=(e.deltaY<0)?1.08:0.92; zoomAt(e.clientX,e.clientY, cam.ts*factor);
  },{passive:false});
  function resetView(){ centerFit(); renderPins(); }

  let lastCam = performance.now();
  function animateCam(now){
    const dt = Math.min((now-lastCam)/16.6667, 2); lastCam=now;
    const t = 1 - Math.pow(1 - ZOOM_SMOOTH, dt);
    cam.x += (cam.tx-cam.x)*t; cam.y += (cam.ty-cam.y)*t; cam.s += (cam.ts-cam.s)*t;
    applyCam(); setZoomVar(); requestAnimationFrame(animateCam);
  }
  requestAnimationFrame(animateCam);
  addEventListener('resize', ()=>{ centerFit(); renderPins(); });

  /* ===== Background falling symbols (adaptive + pausable) ===== */
  const glyphs=["✶","✷","✸","✹","✺","✧","✦","✳"];
  const runes =["ᚠ","ᚱ","ᛃ","ᚨ","ᛟ","ᛞ","ᚾ","ᛋ"];
  const leaves=["🍂","🍁"];
  const SYMBOLS=[...glyphs, ...runes, ...leaves];

  const canvas=document.getElementById('particles'), ctx=canvas.getContext('2d');
  let W=0,H=0;
  function sizeCanvas(){ const dpr=Math.min(window.devicePixelRatio||1,1.5);
    canvas.width=Math.floor(innerWidth*dpr); canvas.height=Math.floor(innerHeight*dpr);
    canvas.style.width=innerWidth+'px'; canvas.style.height=innerHeight+'px'; ctx.setTransform(dpr,0,0,dpr,0,0); W=innerWidth; H=innerHeight; }
  addEventListener('resize', sizeCanvas); sizeCanvas();

  const GOLD="#d4af37", FALL_SPEED=2.3, DRIFT=.35, EDGE=110;
  // Adaptive density by screen area & device memory
  const DM = navigator.deviceMemory || 4;
  const AREA = (innerWidth*innerHeight)/(1280*720);
  let FLAKE_COUNT = Math.round(180 * Math.min(1.6, Math.max(.6, AREA)) * (DM>=8?1.2:DM>=4?1:0.8));

  const spriteCache=new Map();
  function getSprite(ch,sz){ const k=ch+"@"+sz; if(spriteCache.has(k)) return spriteCache.get(k);
    const pad=Math.ceil(sz*.55), c=document.createElement('canvas'); c.width=c.height=sz+pad*2; const x=c.getContext('2d');
    x.textAlign="center"; x.textBaseline="middle";
    x.font=`${sz}px "Noto Sans Symbols 2","Noto Sans Runic","Segoe UI Symbol","Symbola","Noto Color Emoji","Apple Color Emoji","Noto Sans",serif`;
    x.fillStyle=GOLD; x.fillText(ch,c.width/2,c.height/2);
    x.strokeStyle="rgba(0,0,0,.28)"; x.lineWidth=Math.max(1,sz*.06); x.strokeText(ch,c.width/2,c.height/2);
    spriteCache.set(k,c); return c;
  }
  const flakes=[];
  function makeFlake(){ const ch=SYMBOLS[(Math.random()*SYMBOLS.length)|0]; const sz=Math.round(16+Math.random()*12);
    return {x:Math.random()*(W+EDGE*2)-EDGE, y:-20-Math.random()*(H+EDGE), vy:(0.6+Math.random()*0.55)*FALL_SPEED, sway:Math.random()*Math.PI*2, rate:.8+Math.random()*.6, alpha:.95, sp:getSprite(ch,sz)};}
  for(let i=0;i<FLAKE_COUNT;i++) flakes.push(makeFlake());

  let last = performance.now();
  let particlesPaused = false;
  function pauseParticles(ms=0){
    particlesPaused = true;
    if(ms>0) setTimeout(()=>particlesPaused=false, ms);
  }
  document.addEventListener('visibilitychange',()=>{ last=performance.now(); });

  function snow(now){
    requestAnimationFrame(snow);
    if(document.hidden || particlesPaused){ last=now; return; }
    let dt=(now-last)/16.6667; dt=Math.max(.5,Math.min(dt,1.2)); last=now;
    ctx.clearRect(0,0,W,H); const breeze=Math.sin(now*.00035)*DRIFT;
    for(let i=0;i<flakes.length;i++){
      const f=flakes[i]; f.sway+=f.rate*.02*dt; f.x+=(Math.sin(f.sway)*(DRIFT*.9)+breeze)*dt*16; f.y+=f.vy*dt;
      if(f.y>H+EDGE){ const nf=makeFlake(); nf.y=-EDGE; flakes[i]=nf; continue; }
      if(f.x<-EDGE) f.x=W+EDGE; if(f.x>W+EDGE) f.x=-EDGE;
      const sp=f.sp; ctx.globalAlpha=f.alpha; ctx.drawImage(sp, f.x-sp.width/2, f.y-sp.height/2);
    }
    ctx.globalAlpha=1;
  }
  requestAnimationFrame(snow);

  /* ===== Pins + Secrets ===== */
  const pinsEl = document.getElementById('pins');
  const pinBtn = document.getElementById('pinBtn');
  const hint   = document.getElementById('pinHint');
  const exitSecretBtn = document.getElementById('exitSecretBtn');
  const ringEl = document.getElementById('ringCount');
  let addingPin=false, addingSecret=false, secretView=false;

  function setRing(n){ ringEl.querySelector('span').textContent = String(n ?? 0); }

  async function refreshRingCount(){
    try{
      if(useSB){
        const { count, error } = await sb.from('pins').select('id', { count:'exact', head:true });
        if(error){ setRing(loadPinsLocal().length); }
        else { setRing(count ?? 0); }
      }else{
        setRing(loadPinsLocal().length);
      }
    }catch(_){
      setRing(loadPinsLocal().length);
    }
  }

  function togglePinMode(on){
    addingPin = (on!=null)?on:!addingPin; addingSecret=false;
    pinBtn.textContent = addingPin ? "✅ Place pin" : "📍 Pin it";
    hint.textContent = "Pin mode: click anywhere on the map";
    hint.classList.toggle('on', addingPin);
    viewport.style.cursor = addingPin ? "crosshair" : "grab";
  }
  pinBtn.addEventListener('click',()=>{ if(secretView) return; togglePinMode(); });

  exitSecretBtn.addEventListener('click',()=>{
    secretView=false; exitSecretBtn.style.display="none"; pinBtn.disabled=false; refreshPins();
  });

  const SECRET_ADD_CODE = "1314";
  const SECRET_VIEW_CODE = "1013";
  let codeBuf="";
  document.addEventListener('keydown', (e)=>{
    const t=e.target.tagName; if(t==="INPUT"||t==="TEXTAREA") return;
    if(!/^\d$/.test(e.key)) return;
    codeBuf=(codeBuf+e.key).slice(-4);
    if(codeBuf===SECRET_ADD_CODE) activateSecretAdd();
    if(codeBuf===SECRET_VIEW_CODE) activateSecretView();
  });
  function activateSecretAdd(){
    addingPin=false; addingSecret=true; pinBtn.textContent="📍 Pin it";
    hint.textContent="Secret Pin mode: click anywhere on the map"; hint.classList.add('on'); viewport.style.cursor="crosshair";
  }

  /* Evenstar transition (pause particles during) */
  const gondor = document.getElementById('gondor');
  const gate   = document.getElementById('gate');
  function playEvenstarTransition(done){
    const FADE_MS=600, HOLD_MS=1200, GATE_MS=1050, TOTAL=FADE_MS+HOLD_MS+GATE_MS+250;
    pauseParticles(TOTAL); // <-- smooths things while anim plays
    for (const id of ["evenstarCore","evenstarGlow","evenstarShine"]){
      document.getElementById(id).src = EVENSTAR_URL;
    }
    gate.classList.remove('open');
    gondor.classList.add('on'); gondor.setAttribute('aria-hidden','false');
    setTimeout(()=>{ gate.classList.add('open'); }, FADE_MS + HOLD_MS);
    setTimeout(()=>{ gondor.classList.remove('on'); gondor.setAttribute('aria-hidden','true'); if(typeof done==='function') done(); }, TOTAL);
  }
  function activateSecretView(){
    playEvenstarTransition(()=>{
      secretView=true; addingPin=false; addingSecret=false;
      hint.classList.remove('on'); viewport.style.cursor="grab";
      exitSecretBtn.style.display="inline-flex"; pinBtn.disabled=true;
      refreshPins();
    });
  }

  /* Storage */
  const LS_KEY="mem_pins_tableonly_v1";
  let PINS = [];
  function savePinsLocal(all){ localStorage.setItem(LS_KEY, JSON.stringify(all)); }
  function loadPinsLocal(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"[]"); }catch{ return []; } }

  async function refreshPins(){
    if(useSB){
      const { data, error } = await sb.from('pins')
        .select('id,x,y,title,caption,secret,created_at')   // (no photo_data here)
        .eq('secret', secretView)
        .order('created_at', { ascending:true });
      if(error){ console.warn(error); PINS=[]; }
      else{
        PINS = data.map(r=>({ id:r.id, x:r.x, y:r.y, title:r.title, caption:r.caption||"", secret:!!r.secret, created_at:r.created_at }));
      }
    } else {
      const all = loadPinsLocal();
      PINS = all
        .filter(p => !!p.secret === !!secretView)
        .map(({photo_data, ...rest}) => rest); // drop blobs from memory list
    }
    renderPins();
    refreshRingCount();   /* update One Ring count */
  }

  function renderPins(){
    const frag = document.createDocumentFragment();
    for(const p of PINS){
      const el=document.createElement('button');
      el.className='pin';
      if (p.secret) el.classList.add('secret');
      el.dataset.id = p.id;
      el.style.left=(p.x*cam.natW)+'px';
      el.style.top =(p.y*cam.natH)+'px';
      el.innerHTML=`<span>✶</span>`;

      const tip=document.createElement('div');
      tip.className='pintip';
      tip.textContent=p.title || "Untitled";
      tip.style.display='none';

      el.addEventListener('mouseenter',()=>tip.style.display='block');
      el.addEventListener('mouseleave',()=>tip.style.display='none');
      el.addEventListener('click',(e)=>{
        if(addingPin||addingSecret) return;
        e.preventDefault(); e.stopPropagation();
        showPinById(el.dataset.id);
      });

      el.appendChild(tip);
      frag.appendChild(el);
    }
    pinsEl.replaceChildren(frag);
  }

  async function showPinById(id){
    let pin = PINS.find(x => String(x.id) === String(id));

    if (useSB){
      if (!pin || !pin.photo_data){
        const { data, error } = await sb
          .from('pins')
          .select('id,x,y,title,caption,photo_data,created_at,secret')
          .eq('id', id)
          .maybeSingle();
        if (!error && data) pin = data;
      }
    } else {
      const full = loadPinsLocal().find(p => String(p.id)===String(id));
      if (full) pin = full;
    }

    if (pin) openViewPin(pin);
  }

  /* Add pin */
  const modalAdd=document.getElementById('modalAdd'); const aTitle=document.getElementById('aTitle'); const aCaption=document.getElementById('aCaption');
  const aFile=document.getElementById('aFile'); const aCancel=document.getElementById('aCancel'); const aSave=document.getElementById('aSave');
  let pendingCoord=null, pendingSecret=false;

  function openAdd(title="Add Pin", isSecret=false){ document.getElementById('addTitle').textContent=title; pendingSecret=isSecret; modalAdd.classList.add('on'); modalAdd.setAttribute('aria-hidden','false'); }
  function closeAdd(){ modalAdd.classList.remove('on'); modalAdd.setAttribute('aria-hidden','true'); aTitle.value=""; aCaption.value=""; aFile.value=""; pendingCoord=null; pendingSecret=false; }
  aCancel.addEventListener('click', closeAdd);
  modalAdd.addEventListener('click', (e)=>{ if(e.target===modalAdd) closeAdd(); });

  /* ENTER = Save (Add modal open; ignore when typing in textarea) */
  window.addEventListener('keydown', (e)=>{
    if(e.key!=='Enter') return;
    if(!modalAdd.classList.contains('on')) return;
    if(e.target.tagName==='TEXTAREA') return;
    e.preventDefault(); aSave.click();
  });

  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeAdd(); closeView(); }});

  viewport.addEventListener('click', async (e)=>{
    if (e.target.closest('.pin')) return;
    if(moved){ moved=false; return; }
    if(!(addingPin||addingSecret)) return;
    pendingCoord = screenToNorm(e.clientX,e.clientY);
    openAdd(addingSecret ? "Add Secret Pin" : "Add Pin", addingSecret);
    addingPin=false; addingSecret=false; hint.classList.remove('on'); viewport.style.cursor="grab"; pinBtn.textContent="📍 Pin it";
  });

  function screenToNorm(cx,cy){
    const r=viewport.getBoundingClientRect(); const px=(cx-r.left-cam.x)/cam.s, py=(cy-r.top-cam.y)/cam.s;
    return { x:Math.min(1,Math.max(0,px/cam.natW)), y:Math.min(1,Math.max(0,py/cam.natH)) };
  }

  aSave.addEventListener('click', async ()=>{
    pauseParticles(400);
    if(!pendingCoord){ closeAdd(); return; }
    if(!aTitle.value.trim()){ aTitle.focus(); return; }
    let photo_data = null;
    if(aFile.files && aFile.files[0]){ photo_data = await fileToDataURLResized(aFile.files[0], 1280, 0.85); }
    const record = { x: pendingCoord.x, y: pendingCoord.y, title: aTitle.value.trim(), caption: aCaption.value.trim(), photo_data, secret: pendingSecret };
    try{
      if(useSB){ const { error } = await sb.from('pins').insert(record); if(error) throw error; }
      else { const all=loadPinsLocal(); all.push({ id:"p_"+Date.now(), created_at:new Date().toISOString(), ...record }); savePinsLocal(all); }
    }catch(err){ console.error("Save failed:", err); alert("Saving pin failed. Check console/network and your Supabase policies."); }
    closeAdd(); await refreshPins(); refreshRingCount();
  });

  function fileToDataURLResized(file, maxDim=1280, quality=0.85){
    return new Promise((resolve, reject)=>{
      const fr=new FileReader();
      fr.onload=()=>{ const img=new Image(); img.onload=()=>{
        let w=img.width, h=img.height; const s=Math.min(1, maxDim/Math.max(w,h)); w=Math.round(w*s); h=Math.round(h*s);
        const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h);
        resolve(c.toDataURL('image/jpeg', quality));
      }; img.onerror=reject; img.src=fr.result; };
      fr.onerror=reject; fr.readAsDataURL(file);
    });
  }

  /* View / Delete pin */
  const modalView=document.getElementById('modalView');
  const viewTitleText=document.getElementById('viewTitleText');
  const viewCaptionRow=document.getElementById('viewCaptionRow');
  const viewCaptionText=document.getElementById('viewCaptionText');
  const viewImageWrap=document.getElementById('viewImageWrap');
  const vClose=document.getElementById('vClose');
  const vDelete=document.getElementById('vDelete');

  let openPinId=null;

  function openViewPin(pin){
    openPinId = pin.id;
    viewTitleText.textContent = pin.title || "";
    const caption = (pin.caption||"").trim();
    if(caption){ viewCaptionRow.style.display='block'; viewCaptionText.textContent=caption; }
    else{ viewCaptionRow.style.display='none'; viewCaptionText.textContent=""; }

    viewImageWrap.innerHTML = "";
    if(pin.photo_data){
      const img=new Image(); img.loading="lazy"; img.alt=pin.title||"Pin image";
      img.src=pin.photo_data; viewImageWrap.appendChild(img);
    } else {
      const ph=document.createElement('div'); ph.style.cssText="opacity:.7;padding-top:7px"; ph.textContent="No image"; viewImageWrap.appendChild(ph);
    }

    modalView.classList.add('on'); modalView.setAttribute('aria-hidden','false');
  }

  /* Themed delete confirm */
  const modalConfirm = document.getElementById('modalConfirm');
  const cCancel = document.getElementById('cCancel');
  const cDelete = document.getElementById('cDelete');
  function confirmDoom(){
    return new Promise(resolve=>{
      modalConfirm.classList.add('on'); modalConfirm.setAttribute('aria-hidden','false');

      const onCancel=()=>{ cleanup(); resolve(false); };
      const onDelete=()=>{ cleanup(); resolve(true); };
      const onKey=(e)=>{ if(e.key==='Escape'){ onCancel(); } }
      const onOverlay=(e)=>{ if(e.target===modalConfirm) onCancel(); }

      function cleanup(){
        modalConfirm.classList.remove('on'); modalConfirm.setAttribute('aria-hidden','true');
        cCancel.removeEventListener('click', onCancel);
        cDelete.removeEventListener('click', onDelete);
        document.removeEventListener('keydown', onKey);
        modalConfirm.removeEventListener('click', onOverlay);
      }

      cCancel.addEventListener('click', onCancel);
      cDelete.addEventListener('click', onDelete);
      document.addEventListener('keydown', onKey);
      modalConfirm.addEventListener('click', onOverlay);
    });
  }

  async function deleteOpenPin(){
    pauseParticles(400);
    if(!openPinId) return;
    const yes = await confirmDoom();
    if(!yes) return;
    try{
      if(useSB){
        const { error } = await sb.from('pins').delete().eq('id', openPinId);
        if(error) throw error;
      }else{
        const all = loadPinsLocal().filter(p => String(p.id)!==String(openPinId));
        savePinsLocal(all);
      }
    }catch(err){
      console.error(err); alert("Failed to delete pin. Check console/network and your Supabase policies.");
    }
    openPinId=null;
    closeView(); await refreshPins(); refreshRingCount();
  }

  vDelete.addEventListener('click', deleteOpenPin);

  function closeView(){ modalView.classList.remove('on'); modalView.setAttribute('aria-hidden','true'); }
  vClose.addEventListener('click', closeView);
  modalView.addEventListener('click', (e)=>{ if(e.target===modalView) closeView(); });

  /* expose reset for the topbar link */
  window.resetView = resetView;
</script>
</body>
</html>
