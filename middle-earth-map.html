<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Middle-earth Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#1a140f; --ink:#d7c6a3; --ring:#bfa35a; --zoom:1;
    --shadow:0 18px 55px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.06);
    --gondor:#9fe3ff;              /* blue-white */
    --gondorGlow: rgba(159,227,255,.38);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; overflow:hidden; user-select:none;
    background: radial-gradient(1200px 800px at 70% 10%, #2a221b, #15100b 70%, #0d0a07 100%), var(--bg);
    color:var(--ink); font-family: ui-serif, Georgia, "Times New Roman", serif;
  }

  /* background particles (behind the map) */
  #particles{position:fixed; inset:0; z-index:1; pointer-events:none}

  /* top bar */
  .topbar{position:fixed; inset:12px 12px auto 12px; z-index:12; display:flex; gap:12px; align-items:center}
  .chip{display:inline-flex; align-items:center; gap:8px; padding:7px 10px; border:1px solid rgba(191,163,90,.5);
    border-radius:10px; background:rgba(32,26,20,.6); color:var(--ink); box-shadow:var(--shadow); text-decoration:none; font-size:13px; cursor:pointer}
  .chip[disabled]{opacity:.45; pointer-events:none}
  .chip:hover{background:rgba(50,40,30,.75)}
  .title{flex:1; text-align:center; font-family:"Cinzel",serif; font-weight:700; letter-spacing:.5px; font-size:28px; text-shadow:0 0 8px rgba(255,231,160,.2)}

  /* map */
  .viewport{position:absolute; inset:64px 0 0 0; z-index:2; overflow:hidden; touch-action:none; cursor:grab}
  .viewport.dragging{cursor:grabbing}
  .map-inner{position:absolute; top:0; left:0; transform-origin:0 0; will-change:transform}
  .map-img{display:block; height:auto; pointer-events:none; filter:contrast(1.02) brightness(.96) sepia(.08); box-shadow:var(--shadow); border-radius:4px}

  /* pins */
  .pins{position:absolute; inset:0; z-index:6; pointer-events:none}
  .pin{position:absolute; pointer-events:auto; cursor:pointer;
    transform:translate(-50%,-100%) scale(calc(1/var(--zoom)));
    width:24px; height:24px; border-radius:50%;
    background:radial-gradient(circle at 45% 40%, #e9d487, #c9a84b 60%, #7b6230 100%);
    box-shadow:0 0 0 1px rgba(0,0,0,.5), 0 2px 6px rgba(0,0,0,.45);
    display:flex; align-items:center; justify-content:center}
  .pin span{font-size:14px; line-height:1; color:#281f11}
  .pin:hover{box-shadow:0 0 0 1px rgba(0,0,0,.6), 0 0 12px rgba(212,175,55,.45)}
  .pintip{position:absolute; transform:translate(-50%,-120%);
    background:rgba(40,30,22,.92); color:#d7c6a3; border:1px solid rgba(191,163,90,.55); border-radius:8px; padding:4px 8px; font-size:12px; white-space:nowrap; pointer-events:none}

  .hint{position:fixed; right:16px; top:58px; z-index:12; background:rgba(40,30,22,.92); border:1px solid rgba(191,163,90,.5);
    color:#d7c6a3; border-radius:10px; padding:8px 10px; font-size:12px; display:none}
  .hint.on{display:block}

  /* modal */
  .modal{position:fixed; inset:0; z-index:1000; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55)}
  .modal.on{display:flex}
  .panel{width:min(520px, 92vw); max-height:85vh; overflow:auto; background:linear-gradient(#2a221b,#1e1812);
    border:1px solid rgba(191,163,90,.55); border-radius:14px; box-shadow:var(--shadow); padding:16px; color:#e7dbc3}
  .panel h3{margin:0 0 10px; font-family:"Cinzel",serif; letter-spacing:.4px}
  .row{display:flex; gap:10px; margin:8px 0}
  .row label{width:90px; opacity:.9; font-size:13px; padding-top:7px}
  .row input[type="text"], .row textarea{flex:1; background:#1b1510; color:#e7dbc3; border:1px solid rgba(191,163,90,.45); border-radius:8px; padding:8px 10px; font-size:14px}
  .row input[type="file"]{flex:1; color:#e7dbc3}
  .actions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
  .btn{padding:8px 12px; border-radius:10px; border:1px solid rgba(191,163,90,.55); background:#2b221a; color:#e7dbc3; cursor:pointer}
  .btn.primary{background:#3a2e21}
  .btn:hover{filter:brightness(1.06)}

  /* ===== White Tree of Gondor (final) ===== */
  .gondor{position:fixed; inset:0; z-index:2000; display:none; align-items:center; justify-content:center}
  .gondor.on{display:flex}
  .gondor .veil{position:absolute; inset:0; background: radial-gradient(1200px 800px at 50% 45%, rgba(5,14,20,.88), rgba(0,0,0,.96)); opacity:0; animation:veilIn .45s ease-out forwards}
  .gondor .stage{position:relative; width:100%; height:100%; display:flex; align-items:center; justify-content:center}

  .tree{
    width:min(680px,88vw);
    filter:drop-shadow(0 0 12px var(--gondorGlow)) drop-shadow(0 0 26px rgba(159,227,255,.18));
    opacity:0; animation:treeIn .5s ease-out .05s forwards;
  }
  .tree .stroke{
    stroke:var(--gondor); fill:none; stroke-width:2.4; stroke-linecap:round; stroke-linejoin:round;
    stroke-dasharray:1; stroke-dashoffset:1;
    animation:draw 2.6s cubic-bezier(.22,.7,.12,1) forwards .18s;
  }
  .tree .stroke.slow{ animation-duration:3.0s; animation-delay:.28s; }

  .tree .star{ fill:var(--gondor); opacity:0; filter:drop-shadow(0 0 7px var(--gondorGlow)); animation:twinkle 2s ease-in-out infinite alternate }
  .tree .star.top{animation-delay:1.1s}
  .tree .star.d1{animation-delay:1.35s} .tree .star.d2{animation-delay:1.47s} .tree .star.d3{animation-delay:1.59s}
  .tree .star.d4{animation-delay:1.71s} .tree .star.d5{animation-delay:1.83s} .tree .star.d6{animation-delay:1.95s} .tree .star.d7{animation-delay:2.07s}

  .pulses circle{stroke:var(--gondor); stroke-width:1.2; fill:none; opacity:0; animation:pulse 2.1s ease-out forwards 1.6s}

  .curtains .panel{
    position:absolute; top:50%; height:56vh; width:32vw; max-width:520px; transform:translateY(-50%);
    border:1px solid rgba(159,227,255,.52);
    background:radial-gradient(260px 120px at 50% 30%, rgba(159,227,255,.08), rgba(159,227,255,0) 60%), linear-gradient(180deg, rgba(159,227,255,.06), rgba(159,227,255,.02));
    box-shadow:0 0 22px rgba(159,227,255,.16), inset 0 0 12px rgba(159,227,255,.10);
    border-radius:10px; opacity:0; animation:curtainsPop .32s ease-out forwards var(--curtain-pop-delay, 2.0s);
  }
  .curtains .panel.left{left:50%; transform:translate(-100%,-50%)}
  .curtains .panel.right{left:50%; transform:translate(0,-50%)}
  .curtains.open .panel.left{animation:openLeft 1.05s ease-in forwards}
  .curtains.open .panel.right{animation:openRight 1.05s ease-in forwards}

  @keyframes veilIn{from{opacity:0} to{opacity:1}}
  @keyframes treeIn{from{opacity:0; transform:scale(.985)} to{opacity:1; transform:scale(1)}}
  @keyframes draw{to{stroke-dashoffset:0}}
  @keyframes twinkle{0%{opacity:0} 50%{opacity:.95} 100%{opacity:.48}}
  @keyframes pulse{0%{r:6; opacity:.0} 35%{opacity:.35} 100%{r:150; opacity:0}}
  @keyframes curtainsPop{from{opacity:0; transform:translate(-100%,-50%) scale(.985)} to{opacity:1; transform:translate(-100%,-50%) scale(1)}}
  @keyframes openLeft{from{transform:translate(-100%,-50%)} to{transform:translate(-180%,-50%); opacity:.0}}
  @keyframes openRight{from{transform:translate(0,-50%)} to{transform:translate(80%,-50%); opacity:.0}}
</style>
</head>
<body>
  <canvas id="particles"></canvas>

  <div class="topbar">
    <a class="chip" href="javascript:history.back()">‚üµ Back Home</a>
    <div class="title">MIDDLE-EARTH MAP</div>
    <button id="pinBtn" class="chip">üìç Pin it</button>
    <button id="exitSecretBtn" class="chip" style="display:none">‚ú® Exit Secret</button>
    <a class="chip" href="#" onclick="resetView(); return false;">Reset View</a>
  </div>
  <div id="pinHint" class="hint">Pin mode: click anywhere on the map</div>

  <div id="viewport" class="viewport">
    <div id="mapInner" class="map-inner">
      <img id="mapImg" class="map-img" alt="Map"
           src="https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/mem_map.png" />
      <div id="pins" class="pins"></div>
    </div>
  </div>

  <!-- Add Pin modal -->
  <div id="modalAdd" class="modal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="addTitle">
      <h3 id="addTitle">Add Pin</h3>
      <div class="row"><label>Title*</label><input id="aTitle" type="text" placeholder="Title for hover‚Ä¶" required /></div>
      <div class="row"><label>Caption</label><textarea id="aCaption" rows="3" placeholder="Optional caption‚Ä¶"></textarea></div>
      <div class="row"><label>Photo</label><input id="aFile" type="file" accept="image/*" /></div>
      <div class="actions"><button class="btn" id="aCancel">Cancel</button><button class="btn primary" id="aSave">Save Pin</button></div>
    </div>
  </div>

  <!-- View Pin modal -->
  <div id="modalView" class="modal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="viewTitle">
      <h3 id="viewTitle">Pin</h3>
      <div id="viewCaption" class="row" style="display:none"><label>Caption</label><div id="viewCaptionText" style="flex:1;padding-top:7px"></div></div>
      <div class="row"><label>Photo</label><div id="viewImageWrap" style="flex:1"></div></div>
      <div class="actions"><button class="btn" id="vClose">Close</button></div>
    </div>
  </div>

  <!-- White Tree of Gondor overlay -->
  <div id="gondor" class="gondor" aria-hidden="true">
    <div class="veil"></div>
    <div class="stage">
      <!-- Tree built left-half then mirrored for symmetry -->
      <svg class="tree" viewBox="0 0 400 520" aria-hidden="true">
        <!-- trunk -->
        <path class="stroke slow" pathLength="1" d="M200 430 L200 110" />

        <!-- roots: curled flourishes, mirrored -->
        <g>
          <path class="stroke" pathLength="1"
            d="M200 430
               C182 446,166 455,150 463
               C142 468,138 476,138 484
               C138 494,148 499,164 500" />
          <g transform="translate(400,0) scale(-1,1)">
            <path class="stroke" pathLength="1"
              d="M200 430
                 C182 446,166 455,150 463
                 C142 468,138 476,138 484
                 C138 494,148 499,164 500" />
          </g>
        </g>

        <!-- left half boughs (rich curls) -->
        <g id="left">
          <!-- lowest wide bough -->
          <path class="stroke" pathLength="1"
            d="M200 326
               C176 308,156 294,138 286
               C122 279,112 266,102 249" />
          <!-- mid-low bough -->
          <path class="stroke" pathLength="1"
            d="M200 300
               C182 285,168 273,155 261
               C144 251,136 240,128 230" />
          <!-- mid bough -->
          <path class="stroke" pathLength="1"
            d="M200 276
               C188 264,176 252,166 242
               C158 234,151 226,145 219" />
          <!-- upper bough -->
          <path class="stroke" pathLength="1"
            d="M200 254
               C191 244,182 235,174 227
               C166 219,160 213,154 207" />
          <!-- inner curls -->
          <path class="stroke" pathLength="1" d="M156 261 C150 255,144 251,138 247" />
          <path class="stroke" pathLength="1" d="M165 243 C159 237,153 233,147 229" />
          <path class="stroke" pathLength="1" d="M146 286 C140 281,134 277,128 273" />
        </g>
        <use href="#left" transform="translate(400,0) scale(-1,1)"></use>

        <!-- seven stars + top star -->
        <polygon class="star top" points="200,138 204,146 213,147 206,153 208,161 200,157 192,161 194,153 187,147 196,146"/>
        <polygon class="star d1"  points="168,190 172,198 181,199 174,205 176,213 168,209 160,213 162,205 155,199 164,198"/>
        <polygon class="star d2"  points="232,190 236,198 245,199 238,205 240,213 232,209 224,213 226,205 219,199 228,198"/>
        <polygon class="star d3"  points="150,220 154,228 163,229 156,235 158,243 150,239 142,243 144,235 137,229 146,228"/>
        <polygon class="star d4"  points="250,220 254,228 263,229 256,235 258,243 250,239 242,243 244,235 237,229 246,228"/>
        <polygon class="star d5"  points="180,220 184,228 193,229 186,235 188,243 180,239 172,243 174,235 167,229 176,228"/>
        <polygon class="star d6"  points="220,220 224,228 233,229 226,235 228,243 220,239 212,243 214,235 207,229 216,228"/>
        <polygon class="star d7"  points="200,180 204,188 213,189 206,195 208,203 200,199 192,203 194,195 187,189 196,188"/>

        <!-- subtle pulses -->
        <g class="pulses">
          <circle cx="200" cy="248" r="6"/>
          <circle cx="200" cy="248" r="6" style="animation-delay:1.7s"/>
        </g>
      </svg>

      <div class="curtains" id="curtains">
        <div class="panel left"></div>
        <div class="panel right"></div>
      </div>
    </div>
  </div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  /* ===== Supabase (table-only; your credentials) ===== */
  const SUPABASE_URL = "https://tmjozxcjylcxgemffnoc.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
  let sb=null, useSB=false;
  try{
    if (SUPABASE_URL.startsWith("https://") && SUPABASE_ANON_KEY.length > 20){
      sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      useSB = true;
      console.log("Supabase enabled (table-only).");
    } else {
      console.log("Supabase not configured; using localStorage.");
    }
  }catch(e){ console.warn("Supabase init failed; using localStorage.", e); }

  /* ===== Smooth pan/zoom camera ===== */
  const viewport = document.getElementById('viewport');
  const mapInner = document.getElementById('mapInner');
  const mapImg   = document.getElementById('mapImg');

  const FIT = 0.70;              // initial fit
  const ZOOM_SMOOTH = 0.24;      // easing
  const cam = { x:0,y:0,s:1, tx:0,ty:0,ts:1, sMin:0.35, sMax:3.5, dragging:false, lx:0, ly:0, natW:2048, natH:1536 };

  mapImg.addEventListener('load', ()=>{
    cam.natW = mapImg.naturalWidth || cam.natW;
    cam.natH = mapImg.naturalHeight || cam.natH;
    mapImg.style.width  = cam.natW + 'px';
    mapImg.style.height = 'auto';
    centerFit(); refreshPins(); setZoomVar();
  });
  function centerFit(){
    const vw = viewport.clientWidth, vh = viewport.clientHeight;
    const s  = Math.min(vw/cam.natW, vh/cam.natH) * FIT;
    cam.s = cam.ts = s;
    cam.x = cam.tx = vw/2 - (cam.natW*s)/2;
    cam.y = cam.ty = vh/2 - (cam.natH*s)/2;
    applyCam();
  }
  function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
  function applyCam(){ mapInner.style.transform = `matrix(${cam.s},0,0,${cam.s},${cam.x},${cam.y})`; }
  function setZoomVar(){ document.documentElement.style.setProperty('--zoom', cam.s.toFixed(3)); }
  function zoomAt(cx,cy,newScale){
    newScale = clamp(newScale, cam.sMin, cam.sMax);
    const r = viewport.getBoundingClientRect();
    const wx = (cx - r.left - cam.x) / cam.s;
    const wy = (cy - r.top  - cam.y) / cam.s;
    cam.ts = newScale;
    cam.tx = cx - r.left - wx * newScale;
    cam.ty = cy - r.top  - wy * newScale;
  }
  viewport.addEventListener('pointerdown', e=>{
    cam.dragging = true; moved = false; cam.lx = e.clientX; cam.ly = e.clientY;
    viewport.classList.add('dragging'); viewport.setPointerCapture(e.pointerId);
  });
  let moved=false;
  viewport.addEventListener('pointermove', e=>{
    if(!cam.dragging) return;
    const dx=e.clientX-cam.lx, dy=e.clientY-cam.ly; moved = moved || Math.hypot(dx,dy)>2;
    cam.tx+=dx; cam.ty+=dy; cam.lx=e.clientX; cam.ly=e.clientY;
  });
  viewport.addEventListener('pointerup', e=>{
    cam.dragging = false; viewport.classList.remove('dragging'); viewport.releasePointerCapture(e.pointerId);
  });
  viewport.addEventListener('wheel', e=>{
    e.preventDefault(); const factor=(e.deltaY<0)?1.08:0.92; zoomAt(e.clientX,e.clientY, cam.ts*factor);
  },{passive:false});
  function resetView(){ centerFit(); renderPins(); }

  let lastCam = performance.now();
  function animateCam(now){
    const dt = Math.min((now-lastCam)/16.6667, 2); lastCam=now;
    const t = 1 - Math.pow(1 - ZOOM_SMOOTH, dt);
    cam.x += (cam.tx-cam.x)*t; cam.y += (cam.ty-cam.y)*t; cam.s += (cam.ts-cam.s)*t;
    applyCam(); setZoomVar(); requestAnimationFrame(animateCam);
  }
  requestAnimationFrame(animateCam);
  addEventListener('resize', ()=>{ centerFit(); renderPins(); });

  /* ===== Background ‚Äúsnow‚Äù with your symbols ===== */
  const glyphs=["‚ú∂","‚ú∑","‚ú∏","‚úπ","‚ú∫","‚úß","‚ú¶","‚ú≥"];
  const runes =["·ö†","·ö±","·õÉ","·ö®","·õü","·õû","·öæ","·õã"];
  const leaves=["üçÇ","üçÅ"];
  const SYMBOLS=[...glyphs, ...runes, ...leaves];

  const canvas=document.getElementById('particles'), ctx=canvas.getContext('2d');
  let W=0,H=0;
  function sizeCanvas(){ const dpr=Math.min(window.devicePixelRatio||1,1.5);
    canvas.width=Math.floor(innerWidth*dpr); canvas.height=Math.floor(innerHeight*dpr);
    canvas.style.width=innerWidth+'px'; canvas.style.height=innerHeight+'px'; ctx.setTransform(dpr,0,0,dpr,0,0); W=innerWidth; H=innerHeight; }
  addEventListener('resize', sizeCanvas); sizeCanvas();

  const GOLD="#d4af37", FLAKE_COUNT=260, FALL_SPEED=2.6, DRIFT=.35, EDGE=110;
  const spriteCache=new Map();
  function getSprite(ch,sz){ const k=ch+"@"+sz; if(spriteCache.has(k)) return spriteCache.get(k);
    const pad=Math.ceil(sz*.55), c=document.createElement('canvas'); c.width=c.height=sz+pad*2; const x=c.getContext('2d');
    x.textAlign="center"; x.textBaseline="middle";
    x.font=`${sz}px "Noto Sans Symbols 2","Noto Sans Runic","Segoe UI Symbol","Symbola","Noto Color Emoji","Apple Color Emoji","Noto Sans",serif`;
    x.fillStyle=GOLD; x.fillText(ch,c.width/2,c.height/2);
    x.strokeStyle="rgba(0,0,0,.28)"; x.lineWidth=Math.max(1,sz*.06); x.strokeText(ch,c.width/2,c.height/2);
    spriteCache.set(k,c); return c;
  }
  const flakes=[]; function makeFlake(){ const ch=SYMBOLS[(Math.random()*SYMBOLS.length)|0]; const sz=Math.round(16+Math.random()*12);
    return {x:Math.random()*(W+EDGE*2)-EDGE, y:-20-Math.random()*(H+EDGE), vy:(0.6+Math.random()*0.55)*FALL_SPEED, sway:Math.random()*Math.PI*2, rate:.8+Math.random()*.6, alpha:.95, sp:getSprite(ch,sz)};}
  for(let i=0;i<FLAKE_COUNT;i++) flakes.push(makeFlake());
  let last = performance.now(); document.addEventListener('visibilitychange',()=>{ last=performance.now(); });
  function snow(now){ requestAnimationFrame(snow); if(document.hidden){ last=now; return; }
    let dt=(now-last)/16.6667; dt=Math.max(.5,Math.min(dt,1.2)); last=now;
    ctx.clearRect(0,0,W,H); const breeze=Math.sin(now*.00035)*DRIFT;
    for(let i=0;i<flakes.length;i++){ const f=flakes[i]; f.sway+=f.rate*.02*dt; f.x+=(Math.sin(f.sway)*(DRIFT*.9)+breeze)*dt*16; f.y+=f.vy*dt;
      if(f.y>H+EDGE){ const nf=makeFlake(); nf.y=-EDGE; flakes[i]=nf; continue; } if(f.x<-EDGE) f.x=W+EDGE; if(f.x>W+EDGE) f.x=-EDGE;
      const sp=f.sp; ctx.globalAlpha=f.alpha; ctx.drawImage(sp, f.x-sp.width/2, f.y-sp.height/2); } ctx.globalAlpha=1; }
  requestAnimationFrame(snow);

  /* ===== Pins + Secrets ===== */
  const pinsEl=document.getElementById('pins'); const pinBtn=document.getElementById('pinBtn'); const hint=document.getElementById('pinHint'); const exitSecretBtn=document.getElementById('exitSecretBtn');
  let addingPin=false, addingSecret=false, secretView=false;

  function togglePinMode(on){
    addingPin = (on!=null)?on:!addingPin; addingSecret=false;
    pinBtn.textContent = addingPin ? "‚úÖ Place pin" : "üìç Pin it";
    hint.textContent = "Pin mode: click anywhere on the map";
    hint.classList.toggle('on', addingPin);
    viewport.style.cursor = addingPin ? "crosshair" : "grab";
  }
  pinBtn.addEventListener('click',()=>{ if(secretView) return; togglePinMode(); });

  exitSecretBtn.addEventListener('click',()=>{
    secretView=false; exitSecretBtn.style.display="none"; pinBtn.disabled=false; refreshPins();
  });

  // Codes: 2024 = add secret pin, 1013 = enter secret-only view
  const SECRET_ADD_CODE = "2024";
  const SECRET_VIEW_CODE = "1013";
  let codeBuf="";
  document.addEventListener('keydown', (e)=>{
    const t=e.target.tagName; if(t==="INPUT"||t==="TEXTAREA") return;
    if(!/^\d$/.test(e.key)) return;
    codeBuf=(codeBuf+e.key).slice(-4);
    if(codeBuf===SECRET_ADD_CODE) activateSecretAdd();
    if(codeBuf===SECRET_VIEW_CODE) activateSecretView();
  });
  function activateSecretAdd(){
    addingPin=false; addingSecret=true; pinBtn.textContent="üìç Pin it";
    hint.textContent="Secret Pin mode: click anywhere on the map"; hint.classList.add('on'); viewport.style.cursor="crosshair";
  }
  function activateSecretView(){
    playGondorTransition(()=>{
      secretView=true; addingPin=false; addingSecret=false;
      hint.classList.remove('on'); viewport.style.cursor="grab";
      exitSecretBtn.style.display="inline-flex"; pinBtn.disabled=true;
      refreshPins();
    });
  }

  // Storage (Supabase or local)
  const LS_KEY="mem_pins_tableonly_v1";
  let PINS = [];
  function savePinsLocal(all){ localStorage.setItem(LS_KEY, JSON.stringify(all)); }
  function loadPinsLocal(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"[]"); }catch{ return []; } }

  async function refreshPins(){
    if(useSB){
      const { data, error } = await sb.from('pins')
        .select('id,x,y,title,caption,photo_data,secret,created_at')
        .eq('secret', secretView)
        .order('created_at', { ascending:true });
      if(error){ console.warn(error); PINS=[]; }
      else{
        PINS = data.map(r=>({ id:r.id, x:r.x, y:r.y, title:r.title, caption:r.caption||"", photo_data:r.photo_data||null, secret:!!r.secret, created_at:r.created_at }));
      }
    } else {
      const all = loadPinsLocal();
      PINS = all.filter(p => !!p.secret === !!secretView);
    }
    renderPins();
  }

  function renderPins(){
    pinsEl.innerHTML="";
    for(const p of PINS){
      const el=document.createElement('button'); el.className='pin';
      el.style.left=(p.x*cam.natW)+'px'; el.style.top=(p.y*cam.natH)+'px';
      el.innerHTML=`<span>‚ú∂</span>`;
      const tip=document.createElement('div'); tip.className='pintip'; tip.textContent=p.title||"Untitled"; tip.style.display='none';
      el.addEventListener('mouseenter',()=>tip.style.display='block');
      el.addEventListener('mouseleave',()=>tip.style.display='none');
      el.addEventListener('click',(e)=>{ if(addingPin||addingSecret){ e.stopPropagation(); return; } e.stopPropagation(); openViewPin(p); });
      el.appendChild(tip); pinsEl.appendChild(el);
    }
  }

  // Add Pin modal + save
  const modalAdd=document.getElementById('modalAdd'); const aTitle=document.getElementById('aTitle'); const aCaption=document.getElementById('aCaption');
  const aFile=document.getElementById('aFile'); const aCancel=document.getElementById('aCancel'); const aSave=document.getElementById('aSave');
  let pendingCoord=null, pendingSecret=false;

  function openAdd(title="Add Pin", isSecret=false){ document.getElementById('addTitle').textContent=title; pendingSecret=isSecret; modalAdd.classList.add('on'); modalAdd.setAttribute('aria-hidden','false'); }
  function closeAdd(){ modalAdd.classList.remove('on'); modalAdd.setAttribute('aria-hidden','true'); aTitle.value=""; aCaption.value=""; aFile.value=""; pendingCoord=null; pendingSecret=false; }
  aCancel.addEventListener('click', closeAdd);
  modalAdd.addEventListener('click', (e)=>{ if(e.target===modalAdd) closeAdd(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeAdd(); closeView(); }});

  viewport.addEventListener('click', async (e)=>{
    if(moved){ moved=false; return; }
    if(!(addingPin||addingSecret)) return;
    pendingCoord = screenToNorm(e.clientX,e.clientY);
    openAdd(addingSecret ? "Add Secret Pin" : "Add Pin", addingSecret);
    addingPin=false; addingSecret=false; hint.classList.remove('on'); viewport.style.cursor="grab"; pinBtn.textContent="üìç Pin it";
  });
  function screenToNorm(cx,cy){ const r=viewport.getBoundingClientRect(); const px=(cx-r.left-cam.x)/cam.s, py=(cy-r.top-cam.y)/cam.s;
    return { x:Math.min(1,Math.max(0,px/cam.natW)), y:Math.min(1,Math.max(0,py/cam.natH)) }; }

  aSave.addEventListener('click', async ()=>{
    if(!pendingCoord){ closeAdd(); return; }
    if(!aTitle.value.trim()){ aTitle.focus(); return; }
    let photo_data = null;
    if(aFile.files && aFile.files[0]){ photo_data = await fileToDataURLResized(aFile.files[0], 1280, 0.85); }
    const record = { x: pendingCoord.x, y: pendingCoord.y, title: aTitle.value.trim(), caption: aCaption.value.trim(), photo_data, secret: pendingSecret };
    try{
      if(useSB){ const { error } = await sb.from('pins').insert(record); if(error) throw error; }
      else { const all=loadPinsLocal(); all.push({ id:"p_"+Date.now(), created_at:new Date().toISOString(), ...record }); savePinsLocal(all); }
    }catch(err){ console.error("Save failed:", err); alert("Saving pin failed. Check console/network and your Supabase policies."); }
    closeAdd(); await refreshPins();
  });

  function fileToDataURLResized(file, maxDim=1280, quality=0.85){
    return new Promise((resolve, reject)=>{
      const fr=new FileReader();
      fr.onload=()=>{ const img=new Image(); img.onload=()=>{
        let w=img.width, h=img.height; const s=Math.min(1, maxDim/Math.max(w,h)); w=Math.round(w*s); h=Math.round(h*s);
        const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h);
        resolve(c.toDataURL('image/jpeg', quality));
      }; img.onerror=reject; img.src=fr.result; };
      fr.onerror=reject; fr.readAsDataURL(file);
    });
  }

  // View Pin
  const modalView=document.getElementById('modalView'); const viewTitle=document.getElementById('viewTitle');
  const viewCaptionRow=document.getElementById('viewCaption'); const viewCaptionText=document.getElementById('viewCaptionText'); const viewImageWrap=document.getElementById('viewImageWrap'); const vClose=document.getElementById('vClose');
  function openViewPin(pin){
    viewTitle.textContent = pin.title || "Pin";
    const caption = pin.caption || "";
    if(caption.trim()){ viewCaptionRow.style.display='flex'; viewCaptionText.textContent=caption.trim(); }
    else{ viewCaptionRow.style.display='none'; viewCaptionText.textContent=""; }
    viewImageWrap.innerHTML = "";
    const src = pin.photo_data || null;
    if(src){ const img=new Image(); img.loading="lazy"; img.style.maxWidth="100%"; img.style.borderRadius="8px"; img.alt=pin.title||"Pin image"; img.src=src; viewImageWrap.appendChild(img); }
    else { const ph=document.createElement('div'); ph.style.cssText="opacity:.7;padding-top:7px"; ph.textContent="No image"; viewImageWrap.appendChild(ph); }
    modalView.classList.add('on'); modalView.setAttribute('aria-hidden','false');
  }
  function closeView(){ modalView.classList.remove('on'); modalView.setAttribute('aria-hidden','true'); }
  vClose.addEventListener('click', closeView);
  modalView.addEventListener('click', (e)=>{ if(e.target===modalView) closeView(); });

  /* === Gondor transition with ~2s hold === */
  const gondor = document.getElementById('gondor');
  const curtains = document.getElementById('curtains');
  function playGondorTransition(done){
    const DRAW_MS   = 2600;  // matches CSS draw
    const HOLD_MS   = 2000;  // hold visible
    const CURTAIN_MS= 1050;  // slide duration
    const TOTAL = DRAW_MS + HOLD_MS + CURTAIN_MS + 250;

    curtains.classList.remove('open');
    curtains.style.setProperty('--curtain-pop-delay', (DRAW_MS + HOLD_MS) / 1000 + 's');

    gondor.classList.add('on');
    gondor.setAttribute('aria-hidden','false');

    setTimeout(()=>{ curtains.classList.add('open'); }, DRAW_MS + HOLD_MS);

    setTimeout(()=>{
      gondor.classList.remove('on');
      gondor.setAttribute('aria-hidden','true');
      if (typeof done === 'function') done();
    }, TOTAL);
  }

  // init if image already cached
  if (mapImg.complete) mapImg.dispatchEvent(new Event('load'));
</script>
</body>
</html>
