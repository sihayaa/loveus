<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Middle-earth Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=IM+Fell+English:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#1a140f; --ink:#d7c6a3; --ring:#bfa35a; --shadow:0 18px 55px rgba(0,0,0,.5); }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; overflow:hidden; user-select:none;
    background: radial-gradient(1200px 800px at 70% 10%, #2a221b, #15100b 70%, #0d0a07 100%), var(--bg);
    color:var(--ink); font-family:"IM Fell English",serif;
  }

  /* BACKGROUND particles (behind map) */
  #particles{ position:fixed; inset:0; z-index:1; pointer-events:none }

  /* UI */
  .topbar{position:fixed; inset:12px 12px auto 12px; z-index:10; display:flex; gap:12px; align-items:center}
  .chip{display:inline-flex; align-items:center; gap:8px; padding:7px 10px; border:1px solid rgba(191,163,90,.5);
        border-radius:10px; background:rgba(32,26,20,.6); color:var(--ink); box-shadow:var(--shadow); cursor:pointer; text-decoration:none; font-size:13px}
  .title{flex:1; text-align:center; font-family:"Cinzel",serif; font-weight:700; letter-spacing:.5px; font-size:28px}
  .drawer{position:fixed; left:10px; bottom:10px; z-index:10; background:rgba(32,26,20,.8); border:1px solid rgba(191,163,90,.45);
          border-radius:10px; padding:6px 8px; display:flex; gap:8px; align-items:center; box-shadow:var(--shadow)}
  .seg{display:inline-flex; background:rgba(255,255,255,.04); border:1px solid rgba(191,163,90,.35); border-radius:8px; overflow:hidden}
  .seg button{border:none; background:transparent; color:var(--ink); padding:5px 9px; font-size:12px; cursor:pointer}
  .seg button.active{background:rgba(255,255,255,.09); outline:1px solid rgba(191,163,90,.6)}

  /* Map viewer */
  .viewport{position:absolute; inset:64px 0 0 0; z-index:2; overflow:hidden; touch-action:none}
  .map-inner{position:absolute; top:0; left:0; transform-origin:0 0; will-change:transform}
  .map-img{display:block; width:100%; height:auto; pointer-events:none; filter:contrast(1.02) brightness(.96) sepia(.08); box-shadow:var(--shadow); border-radius:4px}

  /* (optional) click-quote bubble */
  .quote{position:fixed; z-index:9; max-width:min(70ch,90vw); left:50%; bottom:26px; transform:translateX(-50%);
    background:rgba(40,30,22,.9); border:1px solid rgba(191,163,90,.5); border-radius:14px; padding:10px 14px;
    box-shadow:var(--shadow); text-align:center; font-family:"Forte","Cinzel",serif; font-size:20px; letter-spacing:.2px;
    opacity:0; animation:fade 4.2s ease forwards;}
  @keyframes fade{0%{opacity:0; transform:translate(-50%,10px)}12%{opacity:1; transform:translate(-50%,0)}70%{opacity:1}100%{opacity:0; transform:translate(-50%,8px)}}
</style>
</head>
<body>
  <!-- background particles -->
  <canvas id="particles"></canvas>

  <!-- header -->
  <div class="topbar">
    <a class="chip" href="javascript:history.back()">‚üµ Back Home</a>
    <div class="title">MIDDLE-EARTH MAP</div>
    <a class="chip" href="#" onclick="resetView()">Reset View</a>
  </div>

  <!-- controls (no intensity slider) -->
  <div class="drawer">
    <span style="font-size:11px;opacity:.85">Particles:</span>
    <div class="seg">
      <button id="btnGlyphs" class="active">Glyphs</button>
      <button id="btnRunes">Runes</button>
      <button id="btnLeaves">Leaves</button>
    </div>
    <button class="chip" id="pauseBtn">Pause</button>
  </div>

  <!-- map -->
  <div id="viewport" class="viewport">
    <div id="mapInner" class="map-inner">
      <img id="mapImg" class="map-img" alt="Map"
           src="https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/mem_map.png" />
    </div>
  </div>

<script>
/* ===== Map pan/zoom ===== */
const viewport=document.getElementById('viewport'), mapInner=document.getElementById('mapInner'), mapImg=document.getElementById('mapImg');
const FIT=0.82, S={scale:1,min:.45,max:3.5,tx:0,ty:0,drag:false,lx:0,ly:0,nw:1000,nh:1000};
mapImg.addEventListener('load',()=>{S.nw=mapImg.naturalWidth;S.nh=mapImg.naturalHeight;fit();apply();});
function fit(){const vw=viewport.clientWidth,vh=viewport.clientHeight;const s=Math.min(vw/S.nw,vh/S.nh)*FIT;S.scale=s;S.tx=vw/2-(S.nw*s)/2;S.ty=vh/2-(S.nh*s)/2;}
function apply(){mapInner.style.transform=`translate(${S.tx}px,${S.ty}px) scale(${S.scale})`;}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
viewport.addEventListener('pointerdown',e=>{S.drag=true;S.lx=e.clientX;S.ly=e.clientY;viewport.setPointerCapture(e.pointerId);});
viewport.addEventListener('pointermove',e=>{if(!S.drag)return;const dx=e.clientX-S.lx,dy=e.clientY-S.ly;S.tx+=dx;S.ty+=dy;S.lx=e.clientX;S.ly=e.clientY;apply();});
viewport.addEventListener('pointerup',e=>{S.drag=false;viewport.releasePointerCapture(e.pointerId);});
viewport.addEventListener('wheel',e=>{e.preventDefault();const f=(e.deltaY<0)?1.08:0.92;const ns=clamp(S.scale*f,S.min,S.max);const r=viewport.getBoundingClientRect();
  const x=(e.clientX-r.left-S.tx)/S.scale, y=(e.clientY-r.top-S.ty)/S.scale; S.tx=e.clientX-r.left-x*ns; S.ty=e.clientY-r.top-y*ns; S.scale=ns; apply();},{passive:false});
function resetView(){fit();apply();} window.addEventListener('resize',()=>{fit();apply();});

/* ===== Background particles: EXACT symbols, snow field (uniform fall together) ===== */
const glyphs=["‚ú∂","‚ú∑","‚ú∏","‚úπ","‚ú∫","‚úß","‚ú¶","‚ú≥"];
const runes =["·ö†","·ö±","·õÉ","·ö®","·õü","·õû","·öæ","·õã"];
const leaves=["üçÇ","üçÅ"];
let mode="glyphs", paused=false;

document.getElementById('btnGlyphs').onclick=()=>setMode('glyphs');
document.getElementById('btnRunes').onclick =()=>setMode('runes');
document.getElementById('btnLeaves').onclick=()=>setMode('leaves');
document.getElementById('pauseBtn').onclick =()=>{paused=!paused; document.getElementById('pauseBtn').textContent=paused?'Resume':'Pause';};

function setMode(m){ mode=m; ['btnGlyphs','btnRunes','btnLeaves'].forEach(id=>document.getElementById(id).classList.remove('active'));
  document.getElementById(m==='glyphs'?'btnGlyphs':m==='runes'?'btnRunes':'btnLeaves').classList.add('active'); seed(); }

const canvas=document.getElementById('particles'), ctx=canvas.getContext('2d');
let W=0,H=0;
function sizeCanvas(){ const dpr=Math.min(devicePixelRatio||1,2);
  canvas.width=Math.floor(innerWidth*dpr); canvas.height=Math.floor(innerHeight*dpr);
  canvas.style.width=innerWidth+'px'; canvas.style.height=innerHeight+'px';
  ctx.setTransform(dpr,0,0,dpr,0,0); W=innerWidth; H=innerHeight; seed(); }
addEventListener('resize', sizeCanvas); sizeCanvas();

/* Fixed ‚Äúsnow‚Äù settings (no intensity) */
const COUNT=260;        // how many
const SIZE=22;          // base font px
const SPEED=0.48;       // downward speed

let parts=[], t=0;

function pick(a){ return a[(Math.random()*a.length)|0]; }
function fontFor(m,px){
  return m==='leaves'
    ? `${px}px "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Twemoji Mozilla","Segoe UI Symbol",sans-serif`
    : `${px}px "Noto Sans Symbols 2","Noto Sans Runic","Segoe UI Symbol","Symbola","Noto Sans",serif`;
}
function supportsChar(ch,px){
  ctx.save(); ctx.font=fontFor(mode,px); const w=ctx.measureText(ch).width; ctx.restore(); return w>0;
}
function fallbackStar(x,y,r){
  ctx.save(); ctx.translate(x,y); ctx.strokeStyle="#d4af37"; ctx.lineWidth=1.2;
  ctx.beginPath(); for(let i=0;i<8;i++){const a=i*Math.PI/4; ctx.moveTo(0,0); ctx.lineTo(Math.cos(a)*r, Math.sin(a)*r);} ctx.stroke(); ctx.restore();
}
function fallbackLeaf(x,y,r){
  ctx.save(); ctx.translate(x,y); ctx.fillStyle="#b6a47a";
  ctx.beginPath(); ctx.moveTo(0,-r); ctx.quadraticCurveTo(r*0.9,-r*0.2,0,r); ctx.quadraticCurveTo(-r*0.9,-r*0.2,0,-r); ctx.fill(); ctx.restore();
}

function seed(){
  parts.length=0;
  for(let i=0;i<COUNT;i++){
    parts.push({
      x:Math.random()*W,
      y:Math.random()*H,
      vx:(Math.random()-0.5)*0.12,          // gentle side drift
      vy:SPEED*(0.95+Math.random()*0.1),    // almost uniform (falls together)
      s:SIZE*(0.85+Math.random()*0.3),      // slight size variance
      sway:Math.random()*6.283,             // personal sway phase
      rot:Math.random()*6.283, rv:(Math.random()-0.5)*0.02,
      char: (mode==='glyphs'? pick(glyphs) : mode==='runes'? pick(runes) : pick(leaves))
    });
  }
}

function step(){
  requestAnimationFrame(step);
  if(paused) return;

  t += 0.016;
  ctx.clearRect(0,0,W,H);
  ctx.textAlign="center"; ctx.textBaseline="middle";

  // Global breeze so everything moves together
  const breeze = Math.sin(t*0.15)*0.25;

  for(const p of parts){
    p.x += p.vx + Math.sin(t*0.9 + p.sway)*0.4 + breeze;
    p.y += p.vy;
    p.rot += p.rv;

    if(p.y > H + 30){ p.y = -30; p.x = Math.random()*W; }
    if(p.x < -30) p.x = W + 30;
    if(p.x > W + 30) p.x = -30;

    ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot);
    const px = p.s;

    if(mode==='leaves'){
      ctx.font = fontFor('leaves', px);
      if(supportsChar(p.char, px)){ ctx.fillText(p.char,0,0); }
      else { fallbackLeaf(0,0,px); }
    }else{
      ctx.font = fontFor(mode, px);
      ctx.fillStyle = "#d4af37";
      if(supportsChar(p.char, px)){ ctx.fillText(p.char,0,0); }
      else { fallbackStar(0,0,px); }
    }
    ctx.restore();
  }
}
seed(); step();

/* init default mode */
setMode('glyphs');
</script>
</body>
</html>
