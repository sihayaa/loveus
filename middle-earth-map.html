<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Middle-earth Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#1a140f; --ink:#d7c6a3; --ring:#bfa35a; --zoom:1;
      --shadow:0 18px 55px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.06);
      --durin-blue:#9fe3ff;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; overflow:hidden; user-select:none;
      background: radial-gradient(1200px 800px at 70% 10%, #2a221b, #15100b 70%, #0d0a07 100%), var(--bg);
      color:var(--ink); font-family: ui-serif, Georgia, "Times New Roman", serif;
    }

    /* background particles */
    #particles{position:fixed; inset:0; z-index:1; pointer-events:none}

    /* top bar */
    .topbar{position:fixed; inset:12px 12px auto 12px; z-index:12; display:flex; gap:12px; align-items:center}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:7px 10px;
      border:1px solid rgba(191,163,90,.5); border-radius:10px;
      background:rgba(32,26,20,.6); color:var(--ink); box-shadow:var(--shadow);
      text-decoration:none; font-size:13px; cursor:pointer}
    .chip[disabled]{opacity:.45; pointer-events:none}
    .chip:hover{background:rgba(50,40,30,.75)}
    .title{flex:1; text-align:center; font-family:"Cinzel",serif; font-weight:700; letter-spacing:.5px; font-size:28px; text-shadow:0 0 8px rgba(255,231,160,.2)}

    /* map */
    .viewport{position:absolute; inset:64px 0 0 0; z-index:2; overflow:hidden; touch-action:none; cursor:grab}
    .viewport.dragging{cursor:grabbing}
    .map-inner{position:absolute; top:0; left:0; transform-origin:0 0; will-change:transform}
    .map-img{display:block; height:auto; pointer-events:none; filter:contrast(1.02) brightness(.96) sepia(.08); box-shadow:var(--shadow); border-radius:4px}

    /* pins */
    .pins{position:absolute; inset:0; z-index:6; pointer-events:none}
    .pin{position:absolute; pointer-events:auto; cursor:pointer;
      transform:translate(-50%,-100%) scale(calc(1/var(--zoom)));
      width:24px; height:24px; border-radius:50%;
      background:radial-gradient(circle at 45% 40%, #e9d487, #c9a84b 60%, #7b6230 100%);
      box-shadow:0 0 0 1px rgba(0,0,0,.5), 0 2px 6px rgba(0,0,0,.45);
      display:flex; align-items:center; justify-content:center}
    .pin span{font-size:14px; line-height:1; color:#281f11}
    .pin:hover{box-shadow:0 0 0 1px rgba(0,0,0,.6), 0 0 12px rgba(212,175,55,.45)}
    .pintip{position:absolute; transform:translate(-50%,-120%);
      background:rgba(40,30,22,.92); color:#d7c6a3; border:1px solid rgba(191,163,90,.55); border-radius:8px; padding:4px 8px; font-size:12px; white-space:nowrap; pointer-events:none}

    .hint{position:fixed; right:16px; top:58px; z-index:12; background:rgba(40,30,22,.92); border:1px solid rgba(191,163,90,.5);
      color:#d7c6a3; border-radius:10px; padding:8px 10px; font-size:12px; display:none}
    .hint.on{display:block}

    /* modal */
    .modal{position:fixed; inset:0; z-index:1000; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55)}
    .modal.on{display:flex}
    .panel{width:min(520px, 92vw); max-height:85vh; overflow:auto; background:linear-gradient(#2a221b,#1e1812);
      border:1px solid rgba(191,163,90,.55); border-radius:14px; box-shadow:var(--shadow); padding:16px; color:#e7dbc3}
    .panel h3{margin:0 0 10px; font-family:"Cinzel",serif; letter-spacing:.4px}
    .row{display:flex; gap:10px; margin:8px 0}
    .row label{width:90px; opacity:.9; font-size:13px; padding-top:7px}
    .row input[type="text"], .row textarea{flex:1; background:#1b1510; color:#e7dbc3; border:1px solid rgba(191,163,90,.45); border-radius:8px; padding:8px 10px; font-size:14px}
    .row input[type="file"]{flex:1; color:#e7dbc3}
    .actions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
    .btn{padding:8px 12px; border-radius:10px; border:1px solid rgba(191,163,90,.55); background:#2b221a; color:#e7dbc3; cursor:pointer}
    .btn.primary{background:#3a2e21}
    .btn:hover{filter:brightness(1.06)}

    /* Door of Durin overlay */
    .durin{position:fixed; inset:0; z-index:2000; display:none; align-items:center; justify-content:center}
    .durin.on{display:flex}
    .durin .veil{position:absolute; inset:0; background: radial-gradient(1200px 800px at 50% 45%, rgba(10,28,36,.85), rgba(0,0,0,.95)); opacity:0; animation:veilIn .25s ease-out forwards}
    .durin .stage{position:relative; width:100%; height:100%; display:flex; align-items:center; justify-content:center}
    .sigil{width:min(520px,78vw); filter: drop-shadow(0 0 10px rgba(159,227,255,.35)) drop-shadow(0 0 20px rgba(159,227,255,.2)); opacity:0; animation:sigilIn .3s ease-out .05s forwards}
    .sigil path, .sigil circle{stroke:var(--durin-blue); fill:none; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-dasharray:1; stroke-dashoffset:1; animation:dash 1.2s ease-out forwards .15s}
    .doors .panel{position:absolute; top:50%; height:56vh; width:32vw; max-width:520px; transform:translateY(-50%); border:1px solid rgba(159,227,255,.65);
      background:radial-gradient(260px 120px at 50% 30%, rgba(159,227,255,.08), rgba(159,227,255,0) 60%), linear-gradient(180deg, rgba(159,227,255,.06), rgba(159,227,255,.02));
      box-shadow:0 0 24px rgba(159,227,255,.18), inset 0 0 12px rgba(159,227,255,.12); border-radius:10px; opacity:0; animation:doorsPop .2s ease-out .9s forwards}
    .doors .panel.left{left:50%; transform:translate(-100%,-50%)}
    .doors .panel.right{left:50%; transform:translate(0,-50%)}
    .doors.open .panel.left{animation:openLeft .9s ease-in forwards}
    .doors.open .panel.right{animation:openRight .9s ease-in forwards}
    @keyframes veilIn{from{opacity:0} to{opacity:1}} @keyframes sigilIn{from{opacity:0; transform:scale(.98)} to{opacity:1; transform:scale(1)}}
    @keyframes dash{to{stroke-dashoffset:0}} @keyframes doorsPop{from{opacity:0; transform:translate(-100%,-50%) scale(.98)} to{opacity:1; transform:translate(-100%,-50%) scale(1)}}
    @keyframes openLeft{from{transform:translate(-100%,-50%)} to{transform:translate(-180%,-50%); opacity:.0}}
    @keyframes openRight{from{transform:translate(0,-50%)} to{transform:translate(80%,-50%); opacity:.0}}
  </style>
</head>
<body>
  <canvas id="particles"></canvas>

  <div class="topbar">
    <a class="chip" href="javascript:history.back()">‚üµ Back Home</a>
    <div class="title">MIDDLE-EARTH MAP</div>
    <button id="pinBtn" class="chip">üìç Pin it</button>
    <button id="exitSecretBtn" class="chip" style="display:none">‚ú® Exit Secret</button>
    <a class="chip" href="#" onclick="resetView(); return false;">Reset View</a>
  </div>
  <div id="pinHint" class="hint">Pin mode: click anywhere on the map</div>

  <div id="viewport" class="viewport">
    <div id="mapInner" class="map-inner">
      <img id="mapImg" class="map-img" alt="Map"
           src="https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/mem_map.png" />
      <div id="pins" class="pins"></div>
    </div>
  </div>

  <!-- Add Pin modal -->
  <div id="modalAdd" class="modal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="addTitle">
      <h3 id="addTitle">Add Pin</h3>
      <div class="row"><label>Title*</label><input id="aTitle" type="text" placeholder="Title for hover‚Ä¶" required /></div>
      <div class="row"><label>Caption</label><textarea id="aCaption" rows="3" placeholder="Optional caption‚Ä¶"></textarea></div>
      <div class="row"><label>Photo</label><input id="aFile" type="file" accept="image/*" /></div>
      <div class="actions"><button class="btn" id="aCancel">Cancel</button><button class="btn primary" id="aSave">Save Pin</button></div>
    </div>
  </div>

  <!-- View Pin modal -->
  <div id="modalView" class="modal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="viewTitle">
      <h3 id="viewTitle">Pin</h3>
      <div id="viewCaption" class="row" style="display:none"><label>Caption</label><div id="viewCaptionText" style="flex:1;padding-top:7px"></div></div>
      <div class="row"><label>Photo</label><div id="viewImageWrap" style="flex:1"></div></div>
      <div class="actions"><button class="btn" id="vClose">Close</button></div>
    </div>
  </div>

  <!-- Door of Durin -->
  <div id="durin" class="durin" aria-hidden="true">
    <div class="veil"></div>
    <div class="stage">
      <svg class="sigil" viewBox="0 0 400 520">
        <path pathLength="1" d="M80,420 A120,120 0 1 1 320,420" />
        <path pathLength="1" d="M100,300 H300" />
        <path pathLength="1" d="M120,420 V300" />
        <path pathLength="1" d="M280,420 V300" />
        <circle pathLength="1" cx="200" cy="250" r="4"/>
        <circle pathLength="1" cx="170" cy="270" r="3"/>
        <circle pathLength="1" cx="230" cy="270" r="3"/>
      </svg>
      <div class="doors" id="doors"><div class="panel left"></div><div class="panel right"></div></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    /* ===== Supabase (table-only) ===== */
    const SUPABASE_URL = "https://tmjozxcjylcxgemffnoc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
    let sb=null, useSB=false;
    try{
      if (SUPABASE_URL.startsWith("https://") && SUPABASE_ANON_KEY.length > 20){
        sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        useSB = true;
        console.log("Supabase enabled (table-only).");
      } else {
        console.log("Supabase not configured; using localStorage.");
      }
    }catch(e){ console.warn("Supabase init failed; using localStorage.", e); }

    /* ========= Smooth pan/zoom camera ========= */
    const viewport = document.getElementById('viewport');
    const mapInner = document.getElementById('mapInner');
    const mapImg   = document.getElementById('mapImg');

    const FIT = 0.70;                      // << smaller to start more zoomed out
    const ZOOM_SMOOTH = 0.24;
    const cam = { x:0,y:0,s:1, tx:0,ty:0,ts:1, sMin:0.35, sMax:3.5, dragging:false, lx:0, ly:0, natW:2048, natH:1536 };

    mapImg.addEventListener('load', ()=>{
      cam.natW = mapImg.naturalWidth || cam.natW;
      cam.natH = mapImg.naturalHeight || cam.natH;
      mapImg.style.width  = cam.natW + 'px';
      mapImg.style.height = 'auto';
      centerFit(); refreshPins(); setZoomVar();
    });
    function centerFit(){
      const vw = viewport.clientWidth, vh = viewport.clientHeight;
      const s  = Math.min(vw/cam.natW, vh/cam.natH) * FIT;
      cam.s = cam.ts = s;
      cam.x = cam.tx = vw/2 - (cam.natW*s)/2;
      cam.y = cam.ty = vh/2 - (cam.natH*s)/2;
      applyCam();
    }
    function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
    function applyCam(){ mapInner.style.transform = `matrix(${cam.s},0,0,${cam.s},${cam.x},${cam.y})`; }
    function setZoomVar(){ document.documentElement.style.setProperty('--zoom', cam.s.toFixed(3)); }
    function zoomAt(cx,cy,newScale){
      newScale = clamp(newScale, cam.sMin, cam.sMax);
      const r = viewport.getBoundingClientRect();
      const wx = (cx - r.left - cam.x) / cam.s;
      const wy = (cy - r.top  - cam.y) / cam.s;
      cam.ts = newScale;
      cam.tx = cx - r.left - wx * newScale;
      cam.ty = cy - r.top  - wy * newScale;
    }
    viewport.addEventListener('pointerdown', e=>{
      cam.dragging = true; moved = false; cam.lx = e.clientX; cam.ly = e.clientY;
      viewport.classList.add('dragging'); viewport.setPointerCapture(e.pointerId);
    });
    let moved=false;
    viewport.addEventListener('pointermove', e=>{
      if(!cam.dragging) return;
      const dx=e.clientX-cam.lx, dy=e.clientY-cam.ly; moved = moved || Math.hypot(dx,dy)>2;
      cam.tx+=dx; cam.ty+=dy; cam.lx=e.clientX; cam.ly=e.clientY;
    });
    viewport.addEventListener('pointerup', e=>{
      cam.dragging = false; viewport.classList.remove('dragging'); viewport.releasePointerCapture(e.pointerId);
    });
    viewport.addEventListener('wheel', e=>{
      e.preventDefault(); const factor=(e.deltaY<0)?1.08:0.92; zoomAt(e.clientX,e.clientY, cam.ts*factor);
    },{passive:false});
    function resetView(){ centerFit(); renderPins(); }

    let lastCam = performance.now();
    function animateCam(now){
      const dt = Math.min((now-lastCam)/16.6667, 2); lastCam=now;
      const t = 1 - Math.pow(1 - ZOOM_SMOOTH, dt);
      cam.x += (cam.tx-cam.x)*t; cam.y += (cam.ty-cam.y)*t; cam.s += (cam.ts-cam.s)*t;
      applyCam(); setZoomVar(); requestAnimationFrame(animateCam);
    }
    requestAnimationFrame(animateCam);
    addEventListener('resize', ()=>{ centerFit(); renderPins(); });

    /* ========= Light snowfall with runes/glyphs ========= */
    const GOLD="#d4af37";
    const glyphs=["‚ú∂","‚ú∑","‚ú∏","‚úπ","‚ú∫","‚úß","‚ú¶","‚ú≥"], runes=["·ö†","·ö±","·õÉ","·ö®","·õü","·õû","·öæ","·õã"]; const SYMBOLS=glyphs.concat(runes);
    const canvas=document.getElementById('particles'), ctx=canvas.getContext('2d');
    let W=0,H=0;
    function sizeCanvas(){ const dpr=Math.min(window.devicePixelRatio||1,1.5);
      canvas.width=Math.floor(innerWidth*dpr); canvas.height=Math.floor(innerHeight*dpr);
      canvas.style.width=innerWidth+'px'; canvas.style.height=innerHeight+'px'; ctx.setTransform(dpr,0,0,dpr,0,0); W=innerWidth; H=innerHeight;}
    addEventListener('resize', sizeCanvas); sizeCanvas();
    const FLAKE_COUNT=200, FALL_SPEED=2.4, DRIFT=.35, EDGE=100;
    const spriteCache=new Map();
    function getSprite(char,size){ const key=char+"@"+size; if(spriteCache.has(key)) return spriteCache.get(key);
      const pad=Math.ceil(size*.55), s=document.createElement('canvas'); s.width=s.height=size+pad*2; const c=s.getContext('2d');
      c.textAlign="center"; c.textBaseline="middle"; c.font=`${size}px "Noto Sans Symbols 2","Noto Sans Runic","Segoe UI Symbol","Symbola","Noto Sans",serif`;
      c.fillStyle=GOLD; c.fillText(char,s.width/2,s.height/2); c.strokeStyle="rgba(0,0,0,.28)"; c.lineWidth=Math.max(1,size*.06); c.strokeText(char,s.width/2,s.height/2);
      spriteCache.set(key,s); return s;}
    const flakes=[]; function makeFlake(){ const ch=SYMBOLS[(Math.random()*SYMBOLS.length)|0]; const sz=Math.round(16+Math.random()*10);
      return { x:Math.random()*(W+EDGE*2)-EDGE, y:-20-Math.random()*(H+EDGE), vy:(0.6+Math.random()*0.5)*FALL_SPEED,
        sway:Math.random()*Math.PI*2, rate:.8+Math.random()*.6, alpha:.95, sprite:getSprite(ch,sz) }; }
    for(let i=0;i<FLAKE_COUNT;i++) flakes.push(makeFlake());
    let last = performance.now(); document.addEventListener('visibilitychange',()=>{ last=performance.now(); });
    function snow(now){ requestAnimationFrame(snow); if(document.hidden){ last=now; return; }
      let dt=(now-last)/16.6667; dt=Math.max(.5,Math.min(dt,1.2)); last=now;
      ctx.clearRect(0,0,W,H); const breeze=Math.sin(now*.00035)*DRIFT;
      for(let i=0;i<flakes.length;i++){ const f=flakes[i]; f.sway+=f.rate*.02*dt; f.x+=(Math.sin(f.sway)*(DRIFT*.9)+breeze)*dt*16; f.y+=f.vy*dt;
        if(f.y>H+EDGE){ const nf=makeFlake(); nf.y=-EDGE; flakes[i]=nf; continue; } if(f.x<-EDGE) f.x=W+EDGE; if(f.x>W+EDGE) f.x=-EDGE;
        const s=f.sprite; ctx.globalAlpha=f.alpha; ctx.drawImage(s, f.x-s.width/2, f.y-s.height/2); } ctx.globalAlpha=1; }
    requestAnimationFrame(snow);

    /* ========= Pins + Secrets ========= */
    const pinsEl=document.getElementById('pins'); const pinBtn=document.getElementById('pinBtn'); const hint=document.getElementById('pinHint'); const exitSecretBtn=document.getElementById('exitSecretBtn');
    let addingPin=false, addingSecret=false, secretView=false;

    function togglePinMode(on){
      addingPin = (on!=null)?on:!addingPin; addingSecret=false;
      pinBtn.textContent = addingPin ? "‚úÖ Place pin" : "üìç Pin it";
      hint.textContent = "Pin mode: click anywhere on the map";
      hint.classList.toggle('on', addingPin);
      viewport.style.cursor = addingPin ? "crosshair" : "grab";
    }
    pinBtn.addEventListener('click',()=>{ if(secretView) return; togglePinMode(); });

    exitSecretBtn.addEventListener('click',()=>{
      secretView=false; exitSecretBtn.style.display="none"; pinBtn.disabled=false; refreshPins();
    });

    // NEW codes: 2024 = add secret pin, 1013 = enter secret view
    const SECRET_ADD_CODE = "2024";
    const SECRET_VIEW_CODE = "1013";
    let codeBuf="";
    document.addEventListener('keydown', (e)=>{
      const t=e.target.tagName; if(t==="INPUT"||t==="TEXTAREA") return;
      if(!/^\d$/.test(e.key)) return;
      codeBuf=(codeBuf+e.key).slice(-4);
      if(codeBuf===SECRET_ADD_CODE) activateSecretAdd();
      if(codeBuf===SECRET_VIEW_CODE) activateSecretView();
    });
    function activateSecretAdd(){
      addingPin=false; addingSecret=true; pinBtn.textContent="üìç Pin it";
      hint.textContent="Secret Pin mode: click anywhere on the map"; hint.classList.add('on'); viewport.style.cursor="crosshair";
    }
    function activateSecretView(){
      playDurinTransition(()=>{
        secretView=true; addingPin=false; addingSecret=false;
        hint.classList.remove('on'); viewport.style.cursor="grab";
        exitSecretBtn.style.display="inline-flex"; pinBtn.disabled=true;
        refreshPins();
      });
    }

    // Storage (Supabase or local)
    const LS_KEY="mem_pins_tableonly_v1";
    let PINS = [];
    function savePinsLocal(all){ localStorage.setItem(LS_KEY, JSON.stringify(all)); }
    function loadPinsLocal(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"[]"); }catch{ return []; } }

    async function refreshPins(){
      if(useSB){
        const { data, error } = await sb.from('pins')
          .select('id,x,y,title,caption,photo_data,secret,created_at')
          .eq('secret', secretView)
          .order('created_at', { ascending:true });
        if(error){ console.warn(error); PINS=[]; }
        else{
          PINS = data.map(r=>({ id:r.id, x:r.x, y:r.y, title:r.title, caption:r.caption||"", photo_data:r.photo_data||null, secret:!!r.secret, created_at:r.created_at }));
        }
      } else {
        const all = loadPinsLocal();
        PINS = all.filter(p => !!p.secret === !!secretView);
      }
      renderPins();
    }

    function renderPins(){
      pinsEl.innerHTML="";
      for(const p of PINS){
        const el=document.createElement('button'); el.className='pin';
        el.style.left=(p.x*cam.natW)+'px'; el.style.top=(p.y*cam.natH)+'px';
        el.innerHTML=`<span>‚ú∂</span>`;
        const tip=document.createElement('div'); tip.className='pintip'; tip.textContent=p.title||"Untitled"; tip.style.display='none';
        el.addEventListener('mouseenter',()=>tip.style.display='block');
        el.addEventListener('mouseleave',()=>tip.style.display='none');
        el.addEventListener('click',(e)=>{ if(addingPin||addingSecret){ e.stopPropagation(); return; } e.stopPropagation(); openViewPin(p); });
        el.appendChild(tip); pinsEl.appendChild(el);
      }
    }

    // Add Pin modal + save
    const modalAdd=document.getElementById('modalAdd'); const aTitle=document.getElementById('aTitle'); const aCaption=document.getElementById('aCaption');
    const aFile=document.getElementById('aFile'); const aCancel=document.getElementById('aCancel'); const aSave=document.getElementById('aSave');
    let pendingCoord=null, pendingSecret=false;

    function openAdd(title="Add Pin", isSecret=false){ document.getElementById('addTitle').textContent=title; pendingSecret=isSecret; modalAdd.classList.add('on'); modalAdd.setAttribute('aria-hidden','false'); }
    function closeAdd(){ modalAdd.classList.remove('on'); modalAdd.setAttribute('aria-hidden','true'); aTitle.value=""; aCaption.value=""; aFile.value=""; pendingCoord=null; pendingSecret=false; }
    aCancel.addEventListener('click', closeAdd);
    modalAdd.addEventListener('click', (e)=>{ if(e.target===modalAdd) closeAdd(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeAdd(); closeView(); }});

    viewport.addEventListener('click', async (e)=>{
      if(moved){ moved=false; return; }
      if(!(addingPin||addingSecret)) return;
      pendingCoord = screenToNorm(e.clientX,e.clientY);
      const isSecret = addingSecret;
      openAdd(isSecret ? "Add Secret Pin" : "Add Pin", isSecret);
      addingPin=false; addingSecret=false; hint.classList.remove('on'); viewport.style.cursor="grab"; pinBtn.textContent="üìç Pin it";
    });
    function screenToNorm(cx,cy){ const r=viewport.getBoundingClientRect(); const px=(cx-r.left-cam.x)/cam.s, py=(cy-r.top-cam.y)/cam.s;
      return { x:Math.min(1,Math.max(0,px/cam.natW)), y:Math.min(1,Math.max(0,py/cam.natH)) }; }

    aSave.addEventListener('click', async ()=>{
      if(!pendingCoord){ closeAdd(); return; }
      if(!aTitle.value.trim()){ aTitle.focus(); return; }

      // Prepare data
      let photo_data = null;
      if(aFile.files && aFile.files[0]){
        photo_data = await fileToDataURLResized(aFile.files[0], 1280, 0.85); // JPEG data URL
      }
      const record = {
        x: pendingCoord.x, y: pendingCoord.y,
        title: aTitle.value.trim(), caption: aCaption.value.trim(),
        photo_data, secret: pendingSecret
      };

      try{
        if(useSB){
          const { error } = await sb.from('pins').insert(record);
          if(error) throw error;
        } else {
          const all = loadPinsLocal();
          all.push({ id:"p_"+Date.now(), created_at:new Date().toISOString(), ...record });
          savePinsLocal(all);
        }
      }catch(err){
        console.error("Save failed:", err);
        alert("Saving pin failed. Check console/network and your Supabase policies.");
      }

      closeAdd(); await refreshPins();
    });

    function fileToDataURLResized(file, maxDim=1280, quality=0.85){
      return new Promise((resolve, reject)=>{
        const fr=new FileReader();
        fr.onload=()=>{ const img=new Image(); img.onload=()=>{
          let w=img.width, h=img.height; const s=Math.min(1, maxDim/Math.max(w,h)); w=Math.round(w*s); h=Math.round(h*s);
          const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h);
          resolve(c.toDataURL('image/jpeg', quality));
        }; img.onerror=reject; img.src=fr.result; };
        fr.onerror=reject; fr.readAsDataURL(file);
      });
    }

    // View Pin
    const modalView=document.getElementById('modalView'); const viewTitle=document.getElementById('viewTitle');
    const viewCaptionRow=document.getElementById('viewCaption'); const viewCaptionText=document.getElementById('viewCaptionText'); const viewImageWrap=document.getElementById('viewImageWrap'); const vClose=document.getElementById('vClose');
    function openViewPin(pin){
      viewTitle.textContent = pin.title || "Pin";
      const caption = pin.caption || "";
      if(caption.trim()){ viewCaptionRow.style.display='flex'; viewCaptionText.textContent=caption.trim(); }
      else{ viewCaptionRow.style.display='none'; viewCaptionText.textContent=""; }
      viewImageWrap.innerHTML = "";
      const src = pin.photo_data || null;
      if(src){ const img=new Image(); img.loading="lazy"; img.style.maxWidth="100%"; img.style.borderRadius="8px"; img.alt=pin.title||"Pin image"; img.src=src; viewImageWrap.appendChild(img); }
      else { const ph=document.createElement('div'); ph.style.cssText="opacity:.7;padding-top:7px"; ph.textContent="No image"; viewImageWrap.appendChild(ph); }
      modalView.classList.add('on'); modalView.setAttribute('aria-hidden','false');
    }
    function closeView(){ modalView.classList.remove('on'); modalView.setAttribute('aria-hidden','true'); }
    vClose.addEventListener('click', closeView);
    modalView.addEventListener('click', (e)=>{ if(e.target===modalView) closeView(); });

    /* Door of Durin transition */
    const durin = document.getElementById('durin');
    const doors = document.getElementById('doors');
    function playDurinTransition(done){
      doors.classList.remove('open');
      durin.classList.add('on'); durin.setAttribute('aria-hidden','false');
      setTimeout(()=>{ doors.classList.add('open'); }, 1000);
      setTimeout(()=>{ durin.classList.remove('on'); durin.setAttribute('aria-hidden','true'); if (typeof done === 'function') done(); }, 1900);
    }

    // initial render if image cached
    if (mapImg.complete) mapImg.dispatchEvent(new Event('load'));
  </script>
</body>
</html>
