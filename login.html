<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sign in | Beyond the Shire</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/dist/umd/supabase.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Uncial+Antiqua&family=Lobster&display=swap" rel="stylesheet" />

  <style>
    *, *::before, *::after { box-sizing: border-box; }

    :root{
      --primary:#7a4bd8;
      --accent:#67e4ca;
      --ink:#2f2a38;
      --muted:#7b7b88;
      --card:rgba(255,255,255,0.15);
      --gold:#d4af37;
    }

    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      background:url('https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/login-bg.png') no-repeat center/cover fixed;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; color:var(--ink);
    }

    .wrap{ width:min(92vw,360px); display:flex; flex-direction:column; align-items:center; gap:14px; }

    .title{
      font-family:'Cinzel Decorative', serif;
      font-size:44px; line-height:1.05; text-align:center;
      color:var(--gold);
      text-shadow:0 0 10px rgba(212,175,55,0.7), 0 4px 18px rgba(0,0,0,.5);
      margin:0 0 6px; user-select:none;
    }

    .subtitle{
      font-family:'Uncial Antiqua', serif; font-size:18px; text-align:center;
      color:#f4e3c1; text-shadow:0 1px 6px rgba(0,0,0,.4);
      margin:0 0 12px; user-select:none;
    }

    .card{
      width:100%;
      background:var(--card);
      border-radius:16px;
      box-shadow:0 0 12px rgba(212,175,55,0.8), 0 0 25px rgba(212,175,55,0.4);
      padding:26px 24px 24px;
      position:relative; overflow:hidden;
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border:1px solid rgba(212,175,55,0.6);
    }

    .card::before,.card::after{
      content:"üíö üíú"; position:absolute; font-size:14px; opacity:.25;
      animation:float 6s linear infinite; left:14px; top:12px;
    }
    .card::after{ left:auto; right:14px; bottom:12px; top:auto; animation-duration:7.2s; }
    @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}

    label{
      display:block; font-size:12px; color:var(--muted);
      margin:10px 2px 6px; font-weight:600; letter-spacing:.2px;
    }
    input{
      width:100%;
      border:1px solid rgba(229,229,238,.6);
      border-radius:12px;
      padding:12px;
      font-size:14px;
      outline:none;
      background:rgba(255,255,255,0.78);
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
      margin-bottom:12px;
    }
    input:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(122,75,216,.12); }

    .actions{ display:flex; gap:10px; align-items:center; margin-top:4px; }
    button{
      width:100%;
      border:0; border-radius:12px; padding:12px 14px;
      font-weight:700; cursor:pointer; color:#fff;
      background:linear-gradient(135deg,var(--primary),var(--accent));
      box-shadow:0 6px 18px rgba(0,0,0,.15);
    }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    .error{ min-height:18px; color:#b00020; font-size:12px; margin-top:10px; white-space:pre-wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">Beyond the Shire</h1>
    <p class="subtitle">üóùÔ∏è Keep it secret, keep it safe üîí</p>

    <div class="card">
      <form id="loginForm" autocomplete="on">
        <label for="email">Email</label>
        <input id="email" type="email" inputmode="email" autocomplete="email" required />

        <label for="password">Password</label>
        <input id="password" type="password" autocomplete="current-password" required />

        <div class="actions">
          <button id="submitBtn" type="submit">Sign in</button>
        </div>
        <div id="err" class="error"></div>
      </form>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://tmjozxcjylcxgemffnoc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const ALLOW = ["gokumeng48@gmail.com","micdmick@gmail.com"].map(e => e.toLowerCase());
    const AFTER_LOGIN = "/loveus/index.html";

    (async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (user && ALLOW.includes((user.email || "").toLowerCase())) {
        location.replace(AFTER_LOGIN);
      }
    })();

    const form = document.getElementById("loginForm");
    const emailEl = document.getElementById("email");
    const passEl  = document.getElementById("password");
    const errEl   = document.getElementById("err");
    const btn     = document.getElementById("submitBtn");

    [emailEl, passEl].forEach(el=>{
      el.addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){ e.preventDefault(); form.requestSubmit(); }
      });
    });

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      errEl.textContent = "";
      btn.disabled = true;

      const email = emailEl.value.trim();
      const password = passEl.value;
      if(!email || !password){
        errEl.textContent = "Please enter your email and password.";
        btn.disabled = false;
        return;
      }

      try{
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if(error) throw error;

        const userEmail = (data.user?.email || "").toLowerCase();
        if(!ALLOW.includes(userEmail)){
          await supabase.auth.signOut();
          throw new Error("Not authorized for this space.");
        }

        location.replace(AFTER_LOGIN);

      }catch(err){
        if (String(err.message || "").toLowerCase().includes("invalid login")) {
          errEl.textContent = "Wrong email or password.";
        } else {
          errEl.textContent = err.message || "Sign-in failed. Please try again.";
        }
      }finally{
        btn.disabled = false;
      }
    });
  </script>

  <canvas id="me-fx" style="position:fixed;inset:0;pointer-events:none;z-index:1"></canvas>
  <div id="quote-pop"
       style="position:fixed;left:-9999px;top:-9999px;max-width:min(80vw,520px);
              padding:14px 18px;border-radius:12px;
              background:rgba(10,14,10,0.88);
              backdrop-filter: blur(4px);
              color:#f4e3c1;
              font:16px/1.5 'Forte','Lobster',cursive;
              box-shadow:0 0 12px rgba(212,175,55,.4), inset 0 0 0 1px rgba(212,175,55,.35);
              transform:translate(-50%,-140%);
              opacity:0;transition:opacity .45s ease;z-index:2">
  </div>

  <script>
  (() => {
    const palette = { gold:"#d4af37", ember:"rgba(255,140,60,.9)", leaf:"#b6a47a" };
    const glyphs = ["‚ú∂","‚ú∑","‚ú∏","‚úπ","‚ú∫","‚úß","‚ú¶","‚ú≥"];
    const runes  = ["·ö†","·ö±","·õÉ","·ö®","·õü","·õû","·öæ","·õã"];
    const leaves = ["üçÇ","üçÅ"];
    const QUOTES = [
      "All we have to decide is what to do with the time that is given us. ‚Äî Gandalf",
      "Not all those who wander are lost. ‚Äî Bilbo",
      "There is some good in this world, and it‚Äôs worth fighting for. ‚Äî Sam",
      "Even the smallest person can change the course of the future. ‚Äî Galadriel",
      "I would rather share one lifetime with you than face all the ages of this world alone. ‚Äî Arwen",
      "Deeds will not be less valiant because they are unpraised. ‚Äî Aragorn",
      "A day may come when the courage of men fails‚Ä¶ but it is not this day. ‚Äî Aragorn",
    ];

    const cvs = document.getElementById('me-fx');
    const ctx = cvs.getContext('2d');
    const quote = document.getElementById('quote-pop');

    let W = innerWidth, H = innerHeight;
    const DPR = Math.min(devicePixelRatio || 1, 2);
    function resize(){
      W = innerWidth; H = innerHeight;
      cvs.width = W*DPR; cvs.height = H*DPR;
      cvs.style.width = W+'px'; cvs.style.height = H+'px';
      ctx.setTransform(DPR,0,0,DPR,0,0);
    }
    resize(); addEventListener('resize', resize);

    const flakes = [];
    const FLAKE_COUNT = 60;
    function makeFlake() {
      const kind = Math.random();
      let type, char, color, size;
      if (kind < .34){ type='rune';  char = runes[(Math.random()*runes.length)|0];  color = palette.gold;  size = 14+Math.random()*8; }
      else if (kind < .67){ type='leaf'; char = leaves[(Math.random()*leaves.length)|0]; color = palette.leaf; size = 16+Math.random()*10; }
      else { type='ember'; char="‚Ä¢"; color = palette.ember; size = 3+Math.random()*2; }
      return {
        x: Math.random()*W, y: -20-Math.random()*H, vy: 0.4+Math.random()*0.6,
        drift: (Math.random()*0.6)+0.2, phase: Math.random()*Math.PI*2,
        rot: Math.random()*Math.PI, spin: (Math.random()-0.5)*0.02,
        type, char, color, size, alpha: type==='ember' ? 0.8 : 0.95
      };
    }
    for (let i=0;i<FLAKE_COUNT;i++) flakes.push(makeFlake());

    let bursts = [];
    function burst(x,y){
      const n = 18;
      for (let i=0;i<n;i++){
        bursts.push({
          x,y, vx: Math.cos((i/n)*Math.PI*2)*(1.5+Math.random()*1.2),
          vy: Math.sin((i/n)*Math.PI*2)*(1.5+Math.random()*1.2) - 0.6,
          life: 1, char: glyphs[i%glyphs.length], size: 10+Math.random()*10
        });
      }
    }
    function showQuote(x,y){
      quote.textContent = QUOTES[(Math.random()*QUOTES.length)|0];
      quote.style.left = x+'px'; 
      quote.style.top = y+'px';
      quote.style.opacity = '1';
      clearTimeout(showQuote._t);
      // show ~4.2s before fading
      showQuote._t = setTimeout(()=>{
        quote.style.opacity='0';
      }, 4200);
    }
    addEventListener('click', (e)=>{
      const t = e.target.tagName;
      if (['INPUT','BUTTON','A','LABEL','TEXTAREA'].includes(t)) return;
      const x = e.clientX, y = e.clientY;
      burst(x,y); showQuote(x,y);
    });

    function tick(){
      ctx.clearRect(0,0,W,H);

      for (let f of flakes){
        f.phase += 0.01;
        f.x += Math.sin(f.phase)*f.drift;
        f.y += f.vy;
        f.rot += f.spin;
        if (f.y > H+30) Object.assign(f, makeFlake(), { y: -30 });
        ctx.save();
        ctx.globalAlpha = f.alpha;
        ctx.translate(f.x, f.y);
        ctx.rotate(f.rot);
        ctx.font = `${f.size}px serif`;
        ctx.fillStyle = f.color;
        ctx.fillText(f.char, 0, 0);
        ctx.restore();
      }

      bursts = bursts.filter(b => b.life > 0);
      for (let b of bursts){
        ctx.save();
        ctx.globalAlpha = Math.max(0, b.life);
        ctx.translate(b.x, b.y);
        ctx.font = `${b.size}px serif`;
        ctx.fillStyle = palette.gold;
        ctx.fillText(b.char, 0, 0);
        ctx.restore();
        b.x += b.vx; b.y += b.vy; b.vy += 0.02;
        b.life -= 0.03;
      }

      requestAnimationFrame(tick);
    }
    tick();
  })();
  </script>
</body>
</html>
