<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Wish List</title>
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Fredoka+One&family=Freestyle+Script&family=Great+Vibes&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.min.js"></script>
  <style>
    :root{--btn-bg:#129CA6;--title:#8451DB;--subtitle:#E831B0;--sihaya:#458565}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
    body{font-family:'Patrick Hand',cursive;background:url('https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/wish_bg.png') no-repeat center/cover fixed;margin:0;padding:40px;display:flex;flex-direction:column;align-items:center;color:#333}
    h1{color:var(--title);font-size:64px;margin:0 0 10px;font-family:'Brush Script MT',cursive;text-shadow:0 0 6px rgba(132,81,219,.65),0 0 18px rgba(132,81,219,.35)}
    h3.subtitle{font-family:'Freestyle Script',cursive;color:var(--subtitle);font-size:34px;margin-top:-4px;animation:pulse 2.5s infinite}
    .back-btn{position:absolute;top:20px;left:20px;background:#f7b7ea;color:#4b2354;padding:10px 20px;border-radius:8px;text-decoration:none;font-weight:700;box-shadow:1px 1px 5px rgba(0,0,0,.1)}
    .container{display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:40px;width:100%;align-items:start}
    .wishlist{background:rgba(255,255,255,.65);padding:20px;border-radius:16px;box-shadow:0 4px 10px rgba(0,0,0,.15);display:flex;flex-direction:column;align-items:center}
    .wishlist h2{font-family:'Freestyle Script',cursive;font-size:36px;margin:0 0 10px}
    #godbrand-list h2{color:#A581DB}
    #sihaya-list h2{color:var(--sihaya)}
    .wishlist input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;font-size:16px}
    .file-row{display:flex;justify-content:center;align-items:center;gap:12px;width:100%;margin:8px 0}
    .wishlist input[type=file]{display:block;margin:0 auto;padding:8px 10px;width:auto;border:1px solid #ccc;border-radius:10px;background:#fff}
    .wishlist button{display:block;margin:6px auto 0;padding:8px 16px;background:var(--btn-bg);color:#000;border:none;border-radius:10px;font-family:'Edwardian Script ITC','Great Vibes',cursive;font-size:20px;line-height:1;cursor:pointer;box-shadow:2px 2px 6px rgba(0,0,0,.1)}
    .items{overflow-y:auto;width:100%;padding-right:6px;margin-top:8px;max-height:52vh}
    ul{list-style:none;padding:0;margin:0;width:100%}
    li{display:flex;align-items:center;gap:10px;margin:10px 0}
    li.checked span{text-decoration:line-through;opacity:.6}
    li img{width:40px;height:40px;object-fit:cover;cursor:pointer;border:2px solid #ccc;border-radius:6px}
    .icon{cursor:pointer;margin-left:auto;font-size:18px}
    .icon.edit{color:#555}.icon.delete{color:#c0392b;margin-left:6px}
    .zoomed{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;justify-content:center;align-items:center;z-index:100}
    .zoomed img{max-width:90%;max-height:90%;border-radius:10px}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:120}
    .cloud{background:linear-gradient(180deg,rgba(255,255,255,.96),rgba(255,255,255,.9));padding:24px 22px;border-radius:40px;box-shadow:0 10px 30px rgba(0,0,0,.25);min-width:320px;max-width:90vw;text-align:center;display:flex;flex-direction:column;align-items:center}
    .cloud h4{margin:0 0 10px;font-family:'Freestyle Script',cursive;font-size:28px;color:#6d4ea6}
    .cloud input[type=text]{width:90%;padding:12px;border-radius:12px;border:1px solid #ccc;font-size:16px;margin:8px auto 0}
    .actions{margin-top:16px;display:flex;gap:12px;justify-content:center;align-items:center}
    .btn{padding:10px 18px;border:none;border-radius:12px;cursor:pointer;font-family:'Fredoka One',sans-serif}
    .btn.primary{background:var(--btn-bg);color:#000}
    .btn.ghost{background:#f3e7ff;color:#5a3bc6}
  </style>
</head>
<body>
  <a href="index.html" class="back-btn">‚¨Ö Back Home</a>
  <h1>Our Wish List</h1>
  <h3 class="subtitle">Where wishes may come true üçÄ</h3>

  <div class="container">
    <div class="wishlist" id="godbrand-list">
      <h2>Godbrand's Wish</h2>
      <input type="text" placeholder="Add a wish..." id="godbrand-input" />
      <div class="file-row">
        <input type="file" id="godbrand-file" accept="image/*" />
        <button onclick="addWish('godbrand')">Wish it</button>
      </div>
      <div class="items"><ul id="godbrand-ul"></ul></div>
    </div>

    <div class="wishlist" id="sihaya-list">
      <h2>Sihaya's Wish</h2>
      <input type="text" placeholder="Add a wish..." id="sihaya-input" />
      <div class="file-row">
        <input type="file" id="sihaya-file" accept="image/*" />
        <button onclick="addWish('sihaya')">Wish it</button>
      </div>
      <div class="items"><ul id="sihaya-ul"></ul></div>
    </div>
  </div>

  <div id="zoomed-view" class="zoomed" onclick="this.style.display='none'">
    <img id="zoom-img" alt="zoom" onclick="event.stopPropagation()">
  </div>

  <div id="overlay" class="overlay">
    <div class="cloud" id="modal-edit">
      <h4>Edit your wish</h4>
      <input type="text" id="edit-input" />
      <div class="actions">
        <button class="btn primary" id="edit-save">Save</button>
        <button class="btn ghost" id="edit-cancel">Cancel</button>
      </div>
    </div>
    <div class="cloud" id="modal-confirm" style="display:none;">
      <h4 id="confirm-text">Delete this wish?</h4>
      <div class="actions">
        <button class="btn primary" id="confirm-yes">Yes</button>
        <button class="btn ghost" id="confirm-no">No</button>
      </div>
    </div>
  </div>

  <script>
    const db = window.supabase.createClient(
      'https://tmjozxcjylcxgemffnoc.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI'
    );

    function toBase64(file){
      return new Promise((res,rej)=>{
        const r=new FileReader();
        r.onload=()=>res(r.result);
        r.onerror=rej;
        r.readAsDataURL(file);
      });
    }

    function compressImage(file, maxDim = 640, quality = 0.8){
      return new Promise((resolve, reject) => {
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.onload = () => {
          let { width, height } = img;
          const scale = Math.min(1, maxDim / Math.max(width, height));
          width = Math.round(width * scale);
          height = Math.round(height * scale);
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          try {
            const dataUrl = canvas.toDataURL('image/jpeg', quality);
            URL.revokeObjectURL(url);
            resolve(dataUrl);
          } catch (e) { reject(e); }
        };
        img.onerror = reject;
        img.src = url;
      });
    }

    function zoom(url){
      document.getElementById('zoom-img').src=url;
      document.getElementById('zoomed-view').style.display='flex';
    }

    const overlay=document.getElementById('overlay');
    const modalEdit=document.getElementById('modal-edit');
    const modalConfirm=document.getElementById('modal-confirm');
    const editInput=document.getElementById('edit-input');

    function closeModal(){ overlay.style.display='none'; }

    function openEditModal(initial,onSave){
      editInput.value=initial||'';
      overlay.style.display='flex';
      modalConfirm.style.display='none';
      modalEdit.style.display='flex';
      document.getElementById('edit-save').onclick=()=>{ onSave(editInput.value.trim()); closeModal(); };
      document.getElementById('edit-cancel').onclick=closeModal;
      editInput.focus();
    }

    function openConfirmModal(text,onYes){
      document.getElementById('confirm-text').textContent=text;
      overlay.style.display='flex';
      modalEdit.style.display='none';
      modalConfirm.style.display='flex';
      document.getElementById('confirm-yes').onclick=()=>{ onYes(); closeModal(); };
      document.getElementById('confirm-no').onclick=closeModal;
    }

    function makeItem(w){
      const li=document.createElement('li');

      const cb=document.createElement('input');
      cb.type='checkbox';
      cb.checked=!!w.checked;
      cb.onchange=async()=>{
        li.classList.toggle('checked',cb.checked);
        await db.from('wish_list').update({checked:cb.checked}).eq('id',w.id);
      };

      const span=document.createElement('span');
      span.textContent=w.text;

      li.append(cb,span);

      if(w.image){
        const img=document.createElement('img');
        img.src=w.image;
        img.onclick=()=>zoom(w.image);
        img.onerror=()=>img.remove();
        li.appendChild(img);
      }

      const edit=document.createElement('span');
      edit.textContent='‚úé';
      edit.className='icon edit';
      edit.onclick=()=>openEditModal(span.textContent,async t=>{
        if(!t)return;
        span.textContent=t;
        await db.from('wish_list').update({text:t}).eq('id',w.id);
      });

      const del=document.createElement('span');
      del.textContent='‚úñ';
      del.className='icon delete';
      del.onclick=()=>openConfirmModal('Delete this wish?',async()=>{
        await db.from('wish_list').delete().eq('id',w.id);
        li.remove();
      });

      li.append(edit,del);
      li.classList.toggle('checked',!!w.checked);
      return li;
    }

    async function addWish(user){
      const input=document.getElementById(`${user}-input`);
      const fileEl=document.getElementById(`${user}-file`);
      const text=input.value.trim();
      const file=fileEl.files[0];
      if(!text && !file) return;

      let img='';
      if(file){
        try{
          // compress image before saving to DB to speed things up
          img = await compressImage(file, 640, 0.8);
        }catch(e){
          // fall back to raw base64 if compression fails
          try{ img = await toBase64(file); }catch(_){}
        }
      }

      const {data,error}=await db
        .from('wish_list')
        .insert([{user,text,image:img,checked:false}])
        .select();

      if(error){ alert('Could not save wish.'); return; }

      document.getElementById(`${user}-ul`).appendChild(makeItem(data[0]));
      input.value='';
      fileEl.value='';
    }

    async function loadAll(){
      const {data,error}=await db.from('wish_list').select('*').order('id');
      if(error) return;
      document.getElementById('godbrand-ul').innerHTML='';
      document.getElementById('sihaya-ul').innerHTML='';
      data.forEach(w=>{
        const ul=document.getElementById(`${w.user}-ul`);
        if(ul) ul.appendChild(makeItem(w));
      });
    }

    ['godbrand','sihaya'].forEach(u=>{
      document.getElementById(`${u}-input`).addEventListener('keydown',e=>{
        if(e.key==='Enter'){ e.preventDefault(); addWish(u); }
      });
    });

    loadAll();
  </script>
</body>
</html>
