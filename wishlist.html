<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wish List</title>
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Fredoka+One&family=Great+Vibes&family=Freestyle+Script&family=Brush+Script+MT&display=swap" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Dreaming+Outloud+Pro&display=swap');
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.min.js"></script>
  <style>
    .edit-btn, .delete-btn {
      cursor: pointer;
      font-size: 16px;
      margin-left: auto;
    }
    .edit-btn {
      color: #555;
    }
    .delete-btn {
      color: red;
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-btn">‚¨Ö Back Home</a>
  <h1>Our Wish Lists</h1>
  <h3 class="subtitle">Where wishes may come true üçÄ</h3>

  <div class="container">
    <div class="wishlist" id="godbrand-list">
      <h2>Godbrand</h2>
      <input type="text" placeholder="Add a wish..." id="godbrand-input">
      <input type="file" id="godbrand-file">
      <button onclick="addWish('godbrand')">Wish it</button>
      <ul id="godbrand-ul"></ul>
    </div>

    <div class="wishlist" id="sihaya-list">
      <h2>Sihaya</h2>
      <input type="text" placeholder="Add a wish..." id="sihaya-input">
      <input type="file" id="sihaya-file">
      <button onclick="addWish('sihaya')">Wish it</button>
      <ul id="sihaya-ul"></ul>
    </div>
  </div>

  <div id="zoomed-view" class="zoomed" style="display: none;" onclick="this.style.display='none'"><img id="zoom-img"></div>

  <script>
    const supabase = window.supabase.createClient(
      'https://tmjozxcjylcxgemffnoc.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI'
    );

    async function addWish(user) {
      const input = document.getElementById(`${user}-input`);
      const fileInput = document.getElementById(`${user}-file`);
      const ul = document.getElementById(`${user}-ul`);
      const text = input.value.trim();
      if (!text) return;

      let imgUrl = '';
      const file = fileInput.files[0];
      if (file) {
        const fileExt = file.name.split('.').pop();
        const filePath = `wishlist/${user}/${Date.now()}.${fileExt}`;
        const { error: uploadError } = await supabase.storage.from('uploads').upload(filePath, file);
        if (!uploadError) {
          const { data } = supabase.storage.from('uploads').getPublicUrl(filePath);
          imgUrl = data.publicUrl;
        }
      }

      const { data: inserted, error } = await supabase.from('wish_list').insert([
        { user, text, image: imgUrl, checked: false }
      ]).select();

      if (!error && inserted.length > 0) displayWish(inserted[0], ul);

      input.value = '';
      fileInput.value = '';
    }

    function displayWish(wish, ul) {
      const li = document.createElement('li');
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = wish.checked;

      const span = document.createElement('span');
      span.textContent = wish.text;

      if (wish.checked) li.classList.add('checked');
      li.appendChild(checkbox);
      li.appendChild(span);

      if (wish.image) {
        const img = document.createElement('img');
        img.src = wish.image;
        img.onerror = () => img.style.display = 'none';
        img.onclick = () => {
          document.getElementById('zoom-img').src = wish.image;
          document.getElementById('zoomed-view').style.display = 'flex';
        }
        li.appendChild(img);
      }

      const edit = document.createElement('span');
      edit.textContent = '‚úé';
      edit.className = 'edit-btn';
      edit.onclick = async () => {
        const newText = prompt('Edit your wish:', span.textContent);
        if (newText) {
          span.textContent = newText;
          await supabase.from('wish_list')
            .update({ text: newText })
            .eq('id', wish.id);
        }
      };

      const del = document.createElement('span');
      del.textContent = '‚úñ';
      del.className = 'delete-btn';
      del.onclick = async () => {
        li.remove();
        await supabase.from('wish_list').delete().eq('id', wish.id);
      };

      checkbox.addEventListener('change', () => {
        li.classList.toggle('checked', checkbox.checked);
        supabase.from('wish_list')
          .update({ checked: checkbox.checked })
          .eq('id', wish.id);
      });

      li.appendChild(edit);
      li.appendChild(del);
      ul.appendChild(li);
    }

    async function loadWishes() {
      const { data, error } = await supabase.from('wish_list').select('*').order('id');
      if (data) {
        data.forEach(wish => {
          const ul = document.getElementById(`${wish.user}-ul`);
          if (ul) displayWish(wish, ul);
        });
      }
    }

    loadWishes();

    ['godbrand', 'sihaya'].forEach(user => {
      document.getElementById(`${user}-input`).addEventListener('keypress', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addWish(user);
        }
      });
    });
  </script>
</body>
</html>
