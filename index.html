<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Our Love Space</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="icon" href="https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/icon.png?v=2" type="image/png" sizes="32x32">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/dist/umd/supabase.min.js"></script>

  <script>
    const SUPABASE_URL = "https://tmjozxcjylcxgemffnoc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const ALLOW = ["gokumeng48@gmail.com","micdmick@gmail.com"];
    const ROOM_KEY = "couple";

    let CURRENT_USER = null;
    let HAS_SORT_COLUMN = true;

    (async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { location.href = "login.html"; return; }
      const email = (user.email || "").toLowerCase();
      if (!ALLOW.includes(email)) {
        await supabase.auth.signOut();
        document.body.innerHTML = "<p style='font:16px system-ui;padding:24px'>Not authorized.</p>";
        return;
      }
      CURRENT_USER = user;

      try {
        const { error } = await supabase.from('reminders').select('id, sort').eq('room_key', ROOM_KEY).limit(1);
        if (error && /does not exist/i.test(error.message)) HAS_SORT_COLUMN = false;
      } catch { HAS_SORT_COLUMN = false; }

      loadReminders();

      supabase
        .channel('reminders-feed')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'reminders', filter: `room_key=eq.${ROOM_KEY}` }, loadReminders)
        .subscribe();
    })();
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Patrick+Hand&display=swap" rel="stylesheet">
  <style>
    :root{
      --quote-green:#246B3E;
      --quote-blue:#27658A;
      --quote-purple:#453299;
      --teal:#67e4ca;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: url('https://github.com/sihayaa/loveus/blob/main/ChatGPT%20Image%20May%205,%202025,%2005_04_14%20AM.png?raw=true') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      margin: 0;
      padding: 40px;
      text-align: center;
      overflow-x: hidden;
    }

    h1 {
      font-family: 'Great Vibes', cursive;
      font-size: 3.4em;
      color: white;
      text-shadow: 2px 2px 8px #8e5dd2;
      margin-bottom: 20px;
    }

    #duration-block {
      background: rgba(255, 255, 255, 0.65);
      display: inline-block;
      padding: 12px 20px;
      border-radius: 12px;
      margin-bottom: 30px;
    }

    #duration-label {
      font-family: 'Great Vibes', cursive;
      color: #111;
      font-weight: normal;
      font-size: 1.9em;
      text-shadow: 0 0 6px #4fa981, 0 0 10px #4fa981;
    }

    #duration-value {
      color: #4fa981;
      font-weight: bold;
      font-size: 1.9em;
      text-shadow:
        -1px -1px 0 #000, 1px -1px 0 #000,
        -1px  1px 0 #000, 1px  1px 0 #000,
        0 0 6px #4fa981, 0 0 10px #4fa981;
      animation: pulseGlow 2s ease-in-out infinite;
    }

    @keyframes pulseGlow {
      0%, 100% { text-shadow:
        -1px -1px 0 #000, 1px -1px 0 #000,
        -1px 1px 0 #000, 1px  1px 0 #000,
        0 0 4px #4fa981, 0 0 8px #4fa981; }
      50% { text-shadow:
        -1px -1px 0 #000, 1px -1px 0 #000,
        -1px 1px 0 #000, 1px  1px 0 #000,
        0 0 10px #4fa981, 0 0 18px #4fa981; }
    }

    button {
      padding: 10px 20px;
      margin: 10px;
      font-size: 1em;
      background-color: #a3d2ca;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    button:hover { background-color: #8fc6bb; transform: scale(1.07); box-shadow: 0 0 15px #fff; }

    #icon-area { }

    .album-icon {
      position: fixed; left: 20px; width: 80px; height: 80px;
      background-color: #884ea0; border-radius: 20px;
      box-shadow: 0 0 12px #d2b4de, 4px 4px 12px rgba(0,0,0,0.3);
      padding: 6px; cursor: pointer; z-index: 10; transition: all 0.3s ease;
      display: grid; place-items: center; text-decoration: none;
    }
    .album-icon:hover { transform: scale(1.07); box-shadow: 0 0 15px #e43fec, 0 0 25px #d2b4de, 4px 4px 12px rgba(0,0,0,0.3); }
    .album-icon img { width: 100%; height: 100%; border-radius: 12px; object-fit: cover; display: block; }
    .album-icon .icon-label{
      width: 100%; height: 100%; border-radius: 12px; display: flex; align-items: center; justify-content: center; padding: 6px;
      text-align: center; font-family: 'Patrick Hand', cursive; font-weight: 800; font-size: 14px; line-height: 1.1; color: #fff;
      text-shadow: 0 1px 2px rgba(0,0,0,.6); background: rgba(255,255,255,0.06); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.22);
    }

    #timezone-box {
      position: fixed; top: 40px; right: 40px;
      background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px);
      border-radius: 20px; padding: 18px 22px; width: 220px; color: white; font-family: 'Segoe UI', sans-serif;
      box-shadow: 0 0 12px #d2b4de, 4px 4px 12px rgba(0, 0, 0, 0.3); text-align: left; z-index: 5;
    }
    .tz-header { font-family: 'Great Vibes', cursive; font-size: 1.6em; color: #ffffff; text-shadow: 1px 1px 4px #8e5dd2; margin-bottom: 10px; }
    .tz-line { margin: 6px 0; font-size: 1em; color: #111; text-shadow: 0 0 3px #4a004a, 0 0 6px #4a004a, 0 0 9px #4a004a; }
    .tz-label { font-weight: bold; color: #111; text-shadow: 0 0 3px #4a004a, 0 0 6px #4a004a, 0 0 9px #4a004a; }

    #countdown-box {
      position: fixed; top: 180px; right: 40px;
      background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(10px);
      border-radius: 20px; padding: 18px; width: 220px; color: #fff;
      font-family: 'Segoe UI', sans-serif; box-shadow: 0 0 12px #f5b3f5, 4px 4px 12px rgba(0,0,0,0.3);
      text-align: center; z-index: 5;
    }
    #countdown-box .count-number { font-size: 1.6em; font-weight: bold; color: #ffecf7; text-shadow: 0 0 8px #a027a0; }
    #countdown-box .count-label { font-size: 1em; color: #f8e5f8; text-shadow: 0 0 6px #a027a0; }

    #mood-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }

    /* -- daily quote (bottom-left) -- */
    #daily-quote {
      position: fixed;
      left: 20px;
      bottom: 20px;
      max-width: 320px;
      padding: 10px 14px;
      border-radius: 12px;
      background: rgba(255,255,255,0.18);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,.25);
      color: #fff;
      font-family: 'Patrick Hand', cursive;
      font-size: 16px;
      line-height: 1.25;
      text-align: left;
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
      z-index: 6;
    }
    @media (max-width: 768px){
      #daily-quote { left: 10px; bottom: 10px; max-width: 70vw; font-size: 15px; }
    }

    .quote-box{
      /* the old center-quote style is now unused */
      display:none !important;
    }

    #reminder-box {
      position: fixed;
      top: 330px;
      right: 40px;
      bottom: 16px;
      width: 290px;
      padding: 14px;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 0 12px #7e5bd2, 4px 4px 12px rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.25);
      color: #fff;
      z-index: 5;
      text-align: left;
      display: flex;
      flex-direction: column;
    }
    #reminder-box h3 {
      margin: 0 0 10px 0;
      font-family: 'Patrick Hand', cursive;
      font-size: 20px;
      text-shadow: 0 0 6px #a027a0;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .history-btn{
      margin-left: auto;
      font: 12px 'Patrick Hand', cursive;
      background: rgba(255,255,255,.18);
      color: #fff; border: 1px solid rgba(255,255,255,.25);
      border-radius: 8px; padding: 4px 8px;
      cursor: pointer;
    }
    .history-btn:hover{ background: rgba(255,255,255,.28); }

    .reminder-input-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
    #reminder-input {
      flex: 1; padding: 10px 12px; border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.9); color: #000; font-size: 14px; outline: none; min-width: 0; cursor: text;
    }
    #add-reminder-btn { padding: 10px 12px; border-radius: 10px; border: none; background: #a3d2ca; cursor: pointer; font-size: 14px; flex: 0 0 auto; }
    #add-reminder-btn:hover { background:#8fc6bb; transform:none; box-shadow:0 0 10px rgba(0,0,0,.2); }

    #reminder-list {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding-right: 0;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    #reminder-list::-webkit-scrollbar { width: 0; height: 0; }

    .reminder-item {
      position: relative;
      display: grid;
      grid-template-columns: 22px 1fr;
      align-items: center;
      gap: 8px;
      padding: 10px 26px 10px 10px;
      margin-bottom: 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(255,255,255,0.35);
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      min-height: 52px;
    }
    .reminder-item::before{
      content:"";
      position:absolute; left:-1px; top:0; bottom:0; width:4px;
      border-radius:12px 0 0 12px;
      background: var(--teal); box-shadow: 0 0 10px var(--teal);
    }
    .reminder-item input[type="checkbox"] { cursor: pointer; transform: scale(1.2); }

    .reminder-text {
      font-size: 18px; font-weight: 800; color: #000; letter-spacing: 0.2px;
      word-break: break-word;
    }
    .reminder-text.done{ text-decoration: line-through; opacity: 0.7; }

    .edit-btn{
      position: absolute;
      top: 6px;
      right: 6px;
      background: transparent;
      border: none;
      padding: 0;
      line-height: 1;
      font-size: 14px;
      color: #7a5af8;
      cursor: pointer;
      opacity: .9;
    }
    .edit-btn:hover { transform: scale(1.05); opacity: 1; }

    .secret-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.65); display: grid; place-items: center; opacity: 0; pointer-events: none; transition: opacity .22s ease; z-index: 12000; }
    .secret-backdrop.show { opacity: 1; pointer-events: auto; }
    .secret-modal { width: min(92vw, 920px); background: #000; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,.55); overflow: hidden; transform: translateY(8px) scale(.985); opacity: 0; transition: transform .22s ease, opacity .22s ease; position: relative; z-index: 12001; border: 2px solid #e43fec; }
    .secret-backdrop.show .secret-modal { transform: translateY(0) scale(1); opacity: 1; }
    .secret-frame { width: 100%; height: clamp(220px, 56vw, 520px); display:block; background:#000; }

    .editor-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: grid; place-items: center; z-index: 10000; opacity: 0; pointer-events: none; transition: opacity .2s ease; }
    .editor-backdrop.show { opacity: 1; pointer-events: auto; }
    .editor-modal { width: min(92vw, 720px); background: #111; border: 1px solid #7a5af8; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,.5); padding: 20px; }
    .editor-title { color: #fff; font-weight: 700; margin: 0 0 8px 0; }
    .editor-area {
      display: block; width: 100%; box-sizing: border-box;
      min-height: 160px; border-radius: 12px; resize: vertical;
      border: 1px solid #333; padding: 12px; font-size: 15px; line-height: 1.5;
      background: #fff; color: #000; outline: none; margin: 0;
    }
    .editor-actions { margin-top: 12px; display: flex; gap: 8px; justify-content: flex-end; }
    .btn { padding: 10px 14px; border-radius: 10px; border: none; cursor: pointer; font-size: 14px; }
    .btn-primary { background: #7a5af8; color: #fff; }
    .btn-secondary { background: #e6e6e6; color: #111; }

    .title-heart{ margin-left: 6px; font-size: 0.8em; line-height: 1; display: inline-block; user-select: none; cursor: default; vertical-align: baseline; }
    #startHeart { margin-left: 0; margin-right: 6px; cursor: pointer; }
    #startHeart:focus { outline: 2px solid #67e4ca55; outline-offset: 2px; border-radius: 6px; }

    @media (max-width: 1024px){
      body{ padding: 28px }
      h1{ font-size: 2.8em }
      #timezone-box, #countdown-box, #reminder-box{ right: 20px }
    }

    @media (max-width: 768px){
      body{ padding:16px }
      h1{ font-size:2.2em; margin-bottom:12px }
      #duration-block{ padding:10px 14px }
      #duration-label, #duration-value{ font-size:1.5em }

      #timezone-box, #countdown-box, #reminder-box{
        position: static;
        width: 100%;
        max-width: 540px;
        margin: 10px auto;
      }
      #reminder-list{ max-height: 40vh; overflow-y: auto; }
      #icon-area{
        position: fixed;
        left: 50%;
        bottom: 8px;
        transform: translateX(-50%);
        width: min(680px, calc(100% - 16px));
        display: grid;
        grid-auto-flow: column;
        grid-auto-columns: 76px;
        gap: 10px;
        padding: 8px;
        overflow-x: auto;
        background: rgba(0,0,0,0.35);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border-radius: 16px;
        z-index: 30;
      }
      #icon-area::-webkit-scrollbar{ height:6px }
      #icon-area::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.25); border-radius: 999px }

      .album-icon{
        position: static !important;
        left: auto !important;
        top: auto !important;
        width: 64px; height: 64px;
      }
      .album-icon .icon-label{ font-size: 12px }
    }

    @media (max-width:420px){
      h1{ font-size:1.8em }
      #duration-label, #duration-value{ font-size:1.35em }
      button{ padding:9px 14px; font-size:.95em }
    }
  </style>
</head>
<body>
  <h1>
    <span id="startHeart" class="title-heart" title="Open Journal" role="link" tabindex="0">üíö</span>
    Started Dating: October 13, 2024
    <span id="title-heart" class="title-heart">üíú</span>
  </h1>

  <div id="duration-block">
    <span id="duration-label">Together for: </span>
    <span id="duration-value">loading...</span>
  </div>

  <br>
  <button onclick="location.href='games.html'">üéÆ Mini Games</button>

  <!-- ============ LOVE WALL (mobile-friendly, edit/delete/done) ============ -->
  <div id="love-wall">
    <h3 class="lw-title">Love Wall</h3>
    <div class="lw-stream" id="lwList" aria-live="polite"></div>
    <div class="lw-composer">
      <div class="lw-toggle" id="lwToggle" role="tablist" aria-label="Sender">
        <button class="lw-tbtn" data-sender="üíö" title="Sihaya">üíö</button>
        <button class="lw-tbtn" data-sender="üíú" title="Godbrand">üíú</button>
      </div>
      <textarea id="lwInput" class="lw-input" rows="1" maxlength="700"
        placeholder="Type a message‚Ä¶ (Shift+Enter = new line)"></textarea>
      <button id="lwSend" class="lw-send" aria-label="Send">Send</button>
    </div>
  </div>
  <!-- ===================================================================== -->

  <div id="icon-area">
    <div class="album-icon" style="top: 100px;" onclick="location.href='album.html'">
      <img src="album-icon.png" alt="Album Icon">
    </div>

    <div class="album-icon" style="top: 100px; left: 150px;" onclick="location.href='schedule.html'" title="Work Schedule">
      <img
        src="https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/schedule_icon.png"
        alt="Work Schedule Icon"
        onerror="this.replaceWith(document.getElementById('work-schedule-label-template').content.cloneNode(true));">
    </div>

    <div class="album-icon" style="top: 200px; left: 150px;" onclick="location.href='gamelist.html'" title="Game List">
      <img
        src="https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/gamelist_icon.png"
        alt="Game List Icon"
        onerror="this.replaceWith(document.getElementById('gamelist-label-template').content.cloneNode(true));">
    </div>

    <div class="album-icon" style="top: 300px; left: 150px;" onclick="location.href='middle-earth-map.html'" title="Middle Earth Map">
      <img
        src="https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/mem.png"
        alt="Middle Earth Map Icon"
        onerror="this.replaceWith(document.getElementById('mem-label-template').content.cloneNode(true));">
    </div>

    <div class="album-icon" style="top: 400px; left: 150px;" onclick="location.href='letters.html'" title="Love Letters">
      <img
        src="https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/love_letters_icon.png"
        alt="Love Letters Icon"
        onerror="this.replaceWith(document.getElementById('letters-label-template').content.cloneNode(true));">
    </div>

    <div class="album-icon" style="top: 500px; left: 150px;" onclick="location.href='learning.html'" title="Learning">
      <img
        src="https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/learning.icon.png"
        alt="Learning Icon"
        onerror="this.replaceWith(document.getElementById('learning-label-template').content.cloneNode(true));">
    </div>

    <div class="album-icon" style="top: 200px;" onclick="location.href='dateplans.html'" title="Date Plans">
      <img src="https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/dateplan_bg.png" alt="Date Plans Icon">
    </div>

    <div class="album-icon" style="top: 300px;" onclick="location.href='chatwall.html'">
      <img src="https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/chatwallbg.png" alt="Chat Wall Icon">
    </div>
    <div class="album-icon" style="top: 400px;" onclick="location.href='doctor.html'">
      <img src="https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/doctor-icon.png" alt="Doctor Icon">
    </div>
    <div class="album-icon" style="top: 500px;" onclick="location.href='wishlist.html'">
      <img src="https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/wish-icon.png" alt="Wishlist Icon">
    </div>
    <div class="album-icon" style="top: 600px;" onclick="location.href='tracking.html'">
      <img src="https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/tracking-icon.png" alt="Tracking Icon">
    </div>
  </div>

  <div id="timezone-box">
    <div class="tz-header">Time Zones</div>
    <div class="tz-line"><span class="tz-label">üåÜ Las Vegas:</span> <span id="vegas-time">loading...</span></div>
    <div class="tz-line"><span class="tz-label">üåá Manila:</span> <span id="manila-time">loading...</span></div>
  </div>

  <div id="countdown-box">
    <div class="count-number" id="countdown-number">loading...</div>
    <div class="count-label">before</div>
    <div class="count-label">1-year anniversary</div>
  </div>

  <div id="reminder-box">
    <h3>
      üìÑ Reminders
      <span style="flex:1"></span>
      <button id="toggleHistory" class="history-btn" title="Show checked reminders">History</button>
    </h3>
    <div class="reminder-input-row">
      <input id="reminder-input" type="text" placeholder="Click to write a reminder‚Ä¶" maxlength="200" readonly>
      <button id="add-reminder-btn" title="Quick add using the small box">Add</button>
    </div>
    <div id="reminder-list"></div>
  </div>

  <div class="editor-backdrop" id="editorBackdrop" aria-hidden="true">
    <div class="editor-modal" role="dialog" aria-modal="true" aria-labelledby="editorTitle">
      <h4 class="editor-title" id="editorTitle">New Reminder</h4>
      <textarea class="editor-area" id="editorArea" placeholder="Type your reminder here‚Ä¶"></textarea>
      <div class="editor-actions">
        <button class="btn btn-secondary" id="editorCancel">Cancel</button>
        <button class="btn btn-primary" id="editorSave">Save</button>
      </div>
    </div>
  </div>

  <canvas id="heart-canvas" style="position:fixed;inset:0;pointer-events:none"></canvas>
  <script>
    const canvas = document.getElementById('heart-canvas');
    const ctx = canvas.getContext('2d');
    const HEART_COLORS = ['#CF27F5', '#5D7EDE', '#5DDE8A', '#42B396'];
    let hearts = [];

    function resizeCanvas() {
      const dpr = window.devicePixelRatio || 1;
      const w = window.innerWidth;
      const h = window.innerHeight;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      canvas.width = Math.round(w * dpr);
      canvas.height = Math.round(h * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    document.addEventListener('mousemove', e => {
      for (let i = 0; i < 3; i++) {
        hearts.push({
          x: e.clientX,
          y: e.clientY,
          size: Math.random() * 8 + 4,
          alpha: 1,
          dx: (Math.random() - 0.5) * 60,
          dy: -(Math.random() * 60 + 40),
          fadePerSec: 0.6,
          color: HEART_COLORS[(Math.random() * HEART_COLORS.length) | 0]
        });
      }

      if (hearts.length > 1500) hearts = hearts.slice(-1500);
    });

    let lastTime = 0;
    function drawHearts(ts) {
      if (!lastTime) lastTime = ts;
      const dt = Math.min((ts - lastTime) / 1000, 0.05);
      lastTime = ts;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      for (let i = hearts.length - 1; i >= 0; i--) {
        const h = hearts[i];

        h.x += h.dx * dt;
        h.y += h.dy * dt;
        h.alpha -= h.fadePerSec * dt;

        if (h.alpha <= 0) {
          hearts.splice(i, 1);
          continue;
        }

        ctx.globalAlpha = h.alpha;
        ctx.fillStyle = h.color;
        ctx.font = `${h.size}px "Times New Roman","Georgia","DejaVu Serif","Noto Serif",serif`;
        ctx.textBaseline = 'middle';
        ctx.textAlign = 'center';
        ctx.fillText('‚ô•', h.x, h.y);
      }

      ctx.globalAlpha = 1;
      requestAnimationFrame(drawHearts);
    }
    requestAnimationFrame(drawHearts);
  </script>

  <div id="mood-overlay"></div>

  <!-- label fallbacks -->
  <template id="work-schedule-label-template"><div class="icon-label">üóì<br>Schedule</div></template>
  <template id="gamelist-label-template"><div class="icon-label">üéÆ<br>Game&nbsp;List</div></template>
  <template id="letters-label-template"><div class="icon-label">üíå<br>Letters</div></template>
  <template id="learning-label-template"><div class="icon-label">‚úèÔ∏è<br>Learning</div></template>
  <template id="mem-label-template"><div class="icon-label">üó∫Ô∏è<br>Middle-Earth</div></template>

  <div class="secret-backdrop" id="secretBackdrop" aria-hidden="true">
    <div class="secret-modal" role="dialog" aria-modal="true" aria-label="Surprise video">
      <iframe
        id="secretFrame"
        class="secret-frame"
        src="about:blank"
        title="Surprise Video"
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        allowfullscreen
      ></iframe>
    </div>
  </div>

  <script>
    const TZ = 'America/Los_Angeles';
    const MS_DAY = 24 * 60 * 60 * 1000;

    function vegasTodayParts() {
      const fmt = new Intl.DateTimeFormat('en-CA', { timeZone: TZ, year: 'numeric', month: '2-digit', day: '2-digit' });
      const parts = fmt.formatToParts(new Date());
      const y = +parts.find(p => p.type === 'year').value;
      const m = +parts.find(p => p.type === 'month').value;
      const d = +parts.find(p => p.type === 'day').value;
      return { y, m0: m - 1, d };
    }

    function monthsAndDaysSince(startY, startM0, startD) {
      const { y, m0, d } = vegasTodayParts();
      let months = (y - startY) * 12 + (m0 - startM0);
      if (d < startD) months--;

      let anchorY = startY + Math.floor((startM0 + months) / 12);
      let anchorM0 = (startM0 + months) % 12;
      if (anchorM0 < 0) { anchorM0 += 12; anchorY--; }

      const anchorUTC = Date.UTC(anchorY, anchorM0, startD);
      const todayUTC  = Date.UTC(y, m0, d);

      const days = Math.max(0, Math.floor((todayUTC - anchorUTC) / MS_DAY));
      return { months: Math.max(months, 0), days };
    }

    function updateDurationAndCountdown() {
      const { months, days } = monthsAndDaysSince(2024, 9, 13);
      const years = Math.floor(months / 12);
      const remMonths = months % 12;

      const durEl = document.getElementById('duration-value');
      if (years > 0) {
        durEl.textContent = `${years} year${years!==1?'s':''} ${remMonths} month${remMonths!==1?'s':''} ${days} day${days!==1?'s':''}`;
      } else {
        durEl.textContent = `${remMonths} month${remMonths!==1?'s':''} and ${days} day${days!==1?'s':''}`;
      }

      const { y, m0, d } = vegasTodayParts();
      const todayUTC = Date.UTC(y, m0, d);
      const annivUTC = Date.UTC(2025, 9, 13);
      const diffDays = Math.max(0, Math.floor((annivUTC - todayUTC) / MS_DAY));
      const box = document.getElementById('countdown-number');
      if (diffDays > 0) {
        box.textContent = `${diffDays} days`;
        document.querySelectorAll('.count-label')[0].textContent = 'before';
        document.querySelectorAll('.count-label')[1].textContent = '1-year anniversary';
      } else {
        box.textContent = `Happy üíñ`;
        document.querySelectorAll('.count-label')[0].textContent = 'Anniversary';
        document.querySelectorAll('.count-label')[1].textContent = '';
      }
    }

    function vegasTimeParts() {
      const opts = { timeZone: TZ, hour: '2-digit', minute: '2-digit', hour12: true };
      const fmt = new Intl.DateTimeFormat('en-US', opts);
      const parts = fmt.formatToParts(new Date());
      const hour = parts.find(p => p.type === 'hour')?.value || '00';
      const minute = parts.find(p => p.type === 'minute')?.value || '00';
      const dayPeriod = parts.find(p => p.type === 'dayPeriod')?.value || '';
      return { hour, minute, dayPeriod };
    }

    function updateTimeZones() {
      const timeOpts12 = { hour: '2-digit', minute: '2-digit', hour12: true };
      const vegasFormatter = new Intl.DateTimeFormat('en-US', { timeZone: 'America/Los_Angeles', ...timeOpts12 });
      const manilaFormatter = new Intl.DateTimeFormat('en-PH', { timeZone: 'Asia/Manila', ...timeOpts12 });

      const vegasTime = vegasFormatter.format(new Date());
      const manilaTime = manilaFormatter.format(new Date());

      document.getElementById('vegas-time').textContent = vegasTime;
      document.getElementById('manila-time').textContent = manilaTime;
    }

    function applyMoodOverlay() {
      try {
        const { hour: hStr, dayPeriod } = vegasTimeParts();
        let hour = parseInt(hStr, 10);
        if (Number.isNaN(hour)) hour = 0;

        if (dayPeriod && /pm/i.test(dayPeriod) && hour < 12) hour += 12;
        if (dayPeriod && /am/i.test(dayPeriod) && hour === 12) hour = 0;

        let color;
        if (hour >= 6 && hour < 12) color = 'rgba(255, 231, 214, 0.35)';
        else if (hour >= 12 && hour < 18) color = 'rgba(214, 255, 226, 0.35)';
        else if (hour >= 18 && hour < 22) color = 'rgba(232, 214, 255, 0.35)';
        else color = 'rgba(10, 15, 60, 0.30)';

        document.getElementById('mood-overlay').style.background = color;
      } catch (err) {
        console.warn('applyMoodOverlay error', err);
      }
    }

    updateTimeZones();
    updateDurationAndCountdown();
    applyMoodOverlay();
    setInterval(updateTimeZones, 60000);
    setInterval(applyMoodOverlay, 60 * 60 * 1000);
  </script>

  <!-- LOVE WALL styles + logic -->
  <style>
    /* --- Love Wall (chatwall vibe) --- */
    #love-wall{
      width:100%;
      max-width:700px;
      margin:8px auto;
      padding:0 8px;
      font-family:'Patrick Hand',cursive;
    }
    .lw-title{
      font-size:21px;
      margin:0 0 8px 0;
      text-align:center;
      color:#fff;
      text-shadow:0 0 6px #a027a0;
    }

    .lw-stream{
      width:100%;
      min-height:50px;
      max-height:240px;
      overflow-y:auto;
      padding:12px;
      border-radius:14px;
      background:rgba(255,255,255,0.18);
      backdrop-filter:blur(6px);
      -webkit-backdrop-filter:blur(6px);
      border:1px solid rgba(255,255,255,.25);
      display:flex;flex-direction:column;
      scrollbar-width:thin;
    }
    .lw-bubble{
      position:relative;
      margin-bottom:10px;
      padding:8px 12px 7px 12px;
      max-width:75%;
      word-wrap:break-word;
      overflow-wrap:anywhere;
      border-radius:10px;
      box-shadow:0 1px 4px rgba(0,0,0,.1);
      background:rgba(255,255,255,.95);
      color:#000;
      font-size:15px;
      line-height:1.25;
    }
    .lw-left{align-self:flex-start;background:#f3e7ff;color:#6e2fb9;}
    .lw-right{align-self:flex-end;background:#dcffec;color:#28a745;}
    .lw-text{ white-space:pre-wrap; }
    .lw-meta{font-size:11px;opacity:.7;margin-top:4px;}

    .lw-check{
      position:absolute;right:6px;top:6px;
      display:inline-flex;gap:6px;align-items:center;
      font-size:12px;
    }

    .lw-actions{
      position:absolute; left:6px; top:6px;
      display:none; gap:6px; align-items:center;
    }
    .lw-bubble:hover .lw-actions{ display:flex; }
    .lw-actbtn{
      border:none; background:transparent; cursor:pointer;
      padding:6px; border-radius:8px; font-size:14px; line-height:1;
      color:#333; min-width:36px; min-height:36px;
    }
    .lw-actbtn:hover{ background:rgba(0,0,0,.06); }

    .lw-editing .lw-actions,
    .lw-editing .lw-check{ display:none !important; }
    .lw-editbox{
      width:100%; box-sizing:border-box;
      font-family:'Patrick Hand',cursive;
      font-size:15px; line-height:1.3;
      padding:8px 10px; border-radius:8px; border:1px solid rgba(0,0,0,.15);
      resize:vertical; min-height:64px; background:#fff; color:#000;
      margin:2px 0 6px 0;
    }
    .lw-editbar{ display:flex; gap:6px; justify-content:flex-end; }
    .lw-btn{
      padding:8px 12px; border:none; border-radius:10px; cursor:pointer; font-size:14px;
      min-height:40px;
    }
    .lw-btn.primary{ background:#7a5af8; color:#fff; }
    .lw-btn.ghost{ background:#eee; color:#111; }

    .lw-faded{opacity:.55}

    .lw-composer{
      margin-top:8px;
      display:flex;align-items:center;gap:8px;
    }
    .lw-toggle{
      display:inline-flex;gap:6px;padding:3px;
      background:rgba(0,0,0,.20);
      border-radius:10px;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.25);
    }
    .lw-tbtn{
      border:none;background:transparent;color:#fff;cursor:pointer;
      padding:8px; border-radius:10px; font-size:16px;
      min-width:40px; min-height:40px;
    }
    .lw-tbtn.active{
      background:rgba(255,255,255,.18);
      box-shadow:0 0 10px #67e4ca55,inset 0 0 0 1px rgba(255,255,255,.25);
    }
    .lw-input{
      flex:1;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.95);
      color:#000;font-size:16px;
      outline:none;
      resize:none;line-height:1.35;max-height:120px;
    }
    .lw-send{
      padding:10px 12px;
      border-radius:10px;border:none;cursor:pointer;
      font-size:16px;
      background:#7a5af8;color:#fff;
      box-shadow:0 0 6px rgba(0,0,0,.2);
      min-height:40px;
    }

    @media (max-width: 640px){
      #love-wall{ padding:0 6px; }
      .lw-stream{
        max-height:58svh;
        background:rgba(255,255,255,0.7);
        border-radius:14px;
        backdrop-filter:blur(3px);
      }
      .lw-actions{ display:none !important; } /* hide edit/delete buttons on mobile (like your chatwall) */
    }
  </style>

  <script>
    /* ===== Love Wall (Supabase table: mini_wall) =====
       Required columns: id, room_key, sender (üíö/üíú), text, created_at (default now()), checked_at (nullable)
    */
    const lwList  = document.getElementById('lwList');
    const lwToggle= document.getElementById('lwToggle');
    const lwInput = document.getElementById('lwInput');
    const lwSend  = document.getElementById('lwSend');

    const LW_SENDER_KEY = `loveWallSender:${ROOM_KEY}`;
    let LW_SENDER = localStorage.getItem(LW_SENDER_KEY) || 'üíö';

    function lwSetSender(heart){
      LW_SENDER = heart;
      localStorage.setItem(LW_SENDER_KEY, heart);
      [...lwToggle.querySelectorAll('.lw-tbtn')].forEach(b=>{
        b.classList.toggle('active', b.dataset.sender === heart);
      });
    }
    lwToggle.addEventListener('click', e=>{
      const b = e.target.closest('.lw-tbtn'); if(!b) return;
      lwSetSender(b.dataset.sender);
    });
    lwSetSender(LW_SENDER);

    function lwAutosize(){
      lwInput.style.height = 'auto';
      lwInput.style.height = Math.min(lwInput.scrollHeight, 120) + 'px';
    }
    lwInput.addEventListener('input', lwAutosize);
    setTimeout(lwAutosize, 0);

    function fmtTime(iso){
      try{
        const d=new Date(iso);
        return d.toLocaleString(undefined,{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
      }catch{ return '' }
    }

    async function lwSendMsg(){
      const text = (lwInput.value || '').trim();
      if(!text || !CURRENT_USER) return;
      await supabase.from('mini_wall').insert({ room_key: ROOM_KEY, sender: LW_SENDER, text });
      lwInput.value=''; lwAutosize(); lwLoad();
    }
    lwSend.addEventListener('click', lwSendMsg);
    lwInput.addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); lwSendMsg(); }
    });

    async function lwCleanup(){
      const cutoff = new Date(Date.now()-24*60*60*1000).toISOString();
      await supabase.from('mini_wall').delete().lt('checked_at', cutoff).eq('room_key', ROOM_KEY);
    }

    function buildBubble(row){
      const isPurple = row.sender === 'üíú';
      const div = document.createElement('div');
      div.className = 'lw-bubble '+(isPurple?'lw-left':'lw-right')+(row.checked_at?' lw-faded':'');

      const act = document.createElement('div');
      act.className = 'lw-actions';

      const btnEdit = document.createElement('button');
      btnEdit.className = 'lw-actbtn'; btnEdit.title = 'Edit'; btnEdit.textContent = '‚úé';
      btnEdit.addEventListener('click', ()=>enterEdit(div, row));

      const btnDel = document.createElement('button');
      btnDel.className = 'lw-actbtn'; btnDel.title = 'Delete'; btnDel.textContent = '√ó';
      btnDel.addEventListener('click', async ()=>{
        if(!confirm('Delete this message?')) return;
        await supabase.from('mini_wall').delete().eq('id', row.id);
        lwLoad();
      });

      act.append(btnEdit, btnDel);
      div.appendChild(act);

      const label = document.createElement('label');
      label.className = 'lw-check';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = !!row.checked_at;
      cb.addEventListener('change', async ()=>{
        const nowISO = cb.checked ? new Date().toISOString() : null;
        await supabase.from('mini_wall').update({ checked_at: nowISO }).eq('id', row.id);
        lwLoad();
      });
      label.append(cb, document.createTextNode(' done'));
      div.appendChild(label);

      const textEl = document.createElement('div');
      textEl.className = 'lw-text';
      textEl.textContent = row.text || '';
      div.appendChild(textEl);

      const meta = document.createElement('div');
      meta.className = 'lw-meta';
      meta.textContent = `${row.sender || ''} ¬∑ ${fmtTime(row.created_at)}`;
      div.appendChild(meta);

      return div;

      function enterEdit(host, data){
        if(host.classList.contains('lw-editing')) return;
        host.classList.add('lw-editing');

        const oldHTML = host.innerHTML;
        host.innerHTML = '';

        const editBox = document.createElement('textarea');
        editBox.className = 'lw-editbox';
        editBox.value = data.text || '';

        const bar = document.createElement('div');
        bar.className = 'lw-editbar';

        const btnCancel = document.createElement('button');
        btnCancel.className = 'lw-btn ghost'; btnCancel.textContent = 'Cancel';
        btnCancel.addEventListener('click', ()=>{ host.innerHTML = oldHTML; host.classList.remove('lw-editing'); rewire(host, data); });

        const btnSave = document.createElement('button');
        btnSave.className = 'lw-btn primary'; btnSave.textContent = 'Save';
        btnSave.addEventListener('click', async ()=>{
          const newText = (editBox.value||'').trim();
          if(!newText || newText === data.text){ host.innerHTML = oldHTML; host.classList.remove('lw-editing'); rewire(host, data); return; }
          await supabase.from('mini_wall').update({ text: newText }).eq('id', data.id);
          lwLoad();
        });

        editBox.addEventListener('keydown', (e)=>{
          if(e.key==='Escape'){ e.preventDefault(); btnCancel.click(); }
          if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); btnSave.click(); }
        });

        bar.append(btnCancel, btnSave);
        host.append(editBox, bar);
        editBox.focus();
        editBox.setSelectionRange(editBox.value.length, editBox.value.length);
      }

      function rewire(host, data){
        const editBtn = host.querySelector('.lw-actions .lw-actbtn:nth-child(1)');
        const delBtn  = host.querySelector('.lw-actions .lw-actbtn:nth-child(2)');
        const cbx     = host.querySelector('.lw-check input');

        editBtn?.addEventListener('click', ()=>enterEdit(host, data));
        delBtn?.addEventListener('click', async ()=>{
          if(!confirm('Delete this message?')) return;
          await supabase.from('mini_wall').delete().eq('id', data.id);
          lwLoad();
        });
        cbx?.addEventListener('change', async (e)=>{
          const nowISO = e.target.checked ? new Date().toISOString() : null;
          await supabase.from('mini_wall').update({ checked_at: nowISO }).eq('id', data.id);
          lwLoad();
        });
      }
    }

    async function lwLoad(){
      const { data, error } = await supabase
        .from('mini_wall')
        .select('id,sender,text,created_at,checked_at')
        .eq('room_key', ROOM_KEY)
        .order('created_at', { ascending: true });

      if(error){ console.error('Love Wall load error:', error.message); return; }

      const now = Date.now();
      const rows = (data||[]).filter(r => !r.checked_at || (now - new Date(r.checked_at).getTime()) < 24*60*60*1000);

      lwList.innerHTML = '';
      rows.forEach(r => lwList.appendChild(buildBubble(r)));
      lwList.scrollTop = lwList.scrollHeight;
    }

    lwLoad(); lwCleanup();
    supabase.channel('love-wall-feed')
      .on('postgres_changes', { event:'*', schema:'public', table:'mini_wall', filter:`room_key=eq.${ROOM_KEY}` }, lwLoad)
      .subscribe();
    setInterval(lwCleanup, 60*60*1000);
  </script>

  <!-- daily sweet quote -->
  <div id="daily-quote" aria-live="polite"></div>
  <script>
    // Only sweetQuotes; one-per-day; pinned bottom-left
    const sweetQuotes = [
      "You make ordinary moments feel special.","Your laugh is my favorite sound.","I‚Äôm grateful for you every day.","You‚Äôre my calm in the chaos.",
      "I love the way you care.","You‚Äôre my soft place to land.","Thank you for choosing me.","Your smile makes everything lighter.",
      "Being with you feels like home.","You‚Äôre the best part of my day.","You make life taste sweeter.","I cherish our quiet minutes.",
      "Every little thing with you matters.","You‚Äôre my favorite comfort.","I adore your kind heart.","We‚Äôre a team, and we win together.",
      "You make even the dullest days shine.","Your voice is my favorite comfort.","I love the way you listen to me.","Being around you feels effortless.",
      "You always know how to make me smile.","You turn small moments into treasures.","My heart feels lighter when you‚Äôre here.",
      "You‚Äôre the calm after every storm.","I love how you notice the little things.","Just thinking of you makes me happy."
    ];
    (function dailySweet(){
      const key = 'dailySweetQuote';
      const today = new Date();
      const stamp = today.toISOString().slice(0,10); // YYYY-MM-DD
      const saved = JSON.parse(localStorage.getItem(key) || 'null');
      let idx;
      if (saved && saved.date === stamp) {
        idx = saved.index;
      } else {
        // deterministically pick based on date so both of you see same one
        const seed = parseInt(stamp.replace(/-/g,''),10);
        idx = seed % sweetQuotes.length;
        localStorage.setItem(key, JSON.stringify({ date: stamp, index: idx }));
      }
      const el = document.getElementById('daily-quote');
      el.textContent = sweetQuotes[idx];
    })();
  </script>

  <script>
    const canvas2 = document.getElementById('heart-canvas');
  </script>

  <!-- Reminders + Editor + History toggle -->
  <script>
    const listEl = document.getElementById('reminder-list');
    const inputEl = document.getElementById('reminder-input');
    const addBtn = document.getElementById('add-reminder-btn');

    const editorBackdrop = document.getElementById('editorBackdrop');
    const editorArea = document.getElementById('editorArea');
    const editorSave = document.getElementById('editorSave');
    const editorCancel = document.getElementById('editorCancel');
    const editorTitle = document.getElementById('editorTitle');
    const toggleHistoryBtn = document.getElementById('toggleHistory');

    let editingId = null;
    let SHOW_HISTORY = false; // false = active; true = checked

    function openEditor(prefill = '', id = null) {
      editingId = id;
      editorTitle.textContent = id ? 'Edit Reminder' : 'New Reminder';
      editorArea.value = prefill;
      editorBackdrop.classList.add('show');
      editorBackdrop.setAttribute('aria-hidden','false');
      setTimeout(() => editorArea.focus(), 0);
    }
    function closeEditor() {
      editingId = null;
      editorBackdrop.classList.remove('show');
      editorBackdrop.setAttribute('aria-hidden','true');
    }

    inputEl.addEventListener('click', () => openEditor(inputEl.value));
    inputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') openEditor(inputEl.value); });
    editorCancel.addEventListener('click', closeEditor);
    editorBackdrop.addEventListener('click', e => { if (e.target === editorBackdrop) closeEditor(); });

    editorArea.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.shiftKey) return;
      if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.metaKey) { e.preventDefault(); editorSave.click(); return; }
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'enter') { e.preventDefault(); editorSave.click(); }
    });

    editorSave.addEventListener('click', async () => {
      const text = (editorArea.value || '').trim();
      if (!text) { closeEditor(); return; }
      if (editingId) { await updateReminderText(editingId, text); } else { await addReminderText(text); }
      closeEditor();
    });

    toggleHistoryBtn.addEventListener('click', ()=>{
      SHOW_HISTORY = !SHOW_HISTORY;
      toggleHistoryBtn.textContent = SHOW_HISTORY ? 'Active' : 'History';
      toggleHistoryBtn.title = SHOW_HISTORY ? 'Show active reminders' : 'Show checked reminders';
      loadReminders();
    });

    async function loadReminders() {
      if (!CURRENT_USER) return;
      const cols = HAS_SORT_COLUMN ? 'id, text, done, sort, created_at' : 'id, text, done, created_at';
      const { data, error } = await supabase
        .from('reminders')
        .select(cols)
        .eq('room_key', ROOM_KEY);

      if (error) {
        console.warn('Load reminders error:', error.message);
        listEl.innerHTML = `<div style="font-size:12px;opacity:.8">Couldn‚Äôt load reminders.</div>`;
        return;
      }

      let rows = (data || []).filter(r => SHOW_HISTORY ? !!r.done : !r.done);

      const saved = JSON.parse(localStorage.getItem('reminderOrder:'+ROOM_KEY) || '[]');
      if (HAS_SORT_COLUMN) {
        rows.sort((a,b) => (a.sort ?? 0) - (b.sort ?? 0) || (a.created_at > b.created_at ? 1 : -1));
      } else if (!SHOW_HISTORY && saved.length) {
        const idx = Object.fromEntries(saved.map((id,i)=>[id,i]));
        rows.sort((a,b) => (idx[a.id] ?? 99999) - (idx[b.id] ?? 99999));
      } else {
        // newest first for active; newest first for history too
        rows.sort((a,b) => (a.created_at < b.created_at ? 1 : -1));
      }

      renderReminders(rows);
    }

    function renderReminders(rows) {
      listEl.innerHTML = '';
      if (!rows.length) {
        listEl.innerHTML = `<div style="font-size:12px;opacity:.8">${SHOW_HISTORY ? 'No checked reminders.' : 'No reminders yet.'}</div>`;
        return;
      }

      rows.forEach((r) => {
        const item = document.createElement('div');
        item.className = 'reminder-item';
        item.dataset.id = r.id;
        item.draggable = !SHOW_HISTORY; // disable drag when viewing history

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = !!r.done;
        cb.addEventListener('change', async () => {
          await toggleDone(r.id, cb.checked);
          if (!SHOW_HISTORY && cb.checked) {
            item.style.transition = 'opacity .18s ease, height .18s ease, margin .18s ease, padding .18s ease';
            item.style.opacity = '0';
            item.style.margin = '0';
            item.style.paddingTop = '0';
            item.style.paddingBottom = '0';
            setTimeout(() => item.remove(), 200);
          } else {
            loadReminders();
          }
        });

        const span = document.createElement('span');
        span.className = 'reminder-text' + (r.done ? ' done' : '');
        span.textContent = r.text;

        const edit = document.createElement('button');
        edit.className = 'edit-btn';
        edit.title = 'Edit';
        edit.setAttribute('aria-label','Edit reminder');
        edit.textContent = '‚úèÔ∏è';
        edit.addEventListener('click', () => openEditor(r.text, r.id));
        if (SHOW_HISTORY) edit.style.display = 'none';

        item.appendChild(cb);
        item.appendChild(span);
        item.appendChild(edit);
        listEl.appendChild(item);
      });

      if (!SHOW_HISTORY) wireDnD();
    }

    async function addReminderText(text) {
      if (!CURRENT_USER) return;
      const payload = { room_key: ROOM_KEY, text, done: false };
      if (HAS_SORT_COLUMN) payload.sort = Date.now();
      const { error } = await supabase.from('reminders').insert(payload);
      if (error) console.warn('Add reminder error:', error.message);
      await loadReminders();
    }

    async function updateReminderText(id, text) {
      const { error } = await supabase.from('reminders').update({ text }).eq('id', id);
      if (error) console.warn('Update text error:', error.message);
      await loadReminders();
    }

    async function toggleDone(id, done) {
      const { error } = await supabase.from('reminders').update({ done }).eq('id', id);
      if (error) console.warn('Toggle error:', error.message);
    }

    async function addReminder() {
      const text = (inputEl.value || '').trim();
      if (!text) return;
      await addReminderText(text);
      inputEl.value = '';
    }

    addBtn.addEventListener('click', addReminder);
    inputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') addReminder(); });

    function wireDnD() {
      const items = Array.from(listEl.querySelectorAll('.reminder-item'));
      let dragEl = null;

      items.forEach(it => {
        it.addEventListener('dragstart', e => {
          dragEl = it;
          it.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', it.dataset.id);
        });
        it.addEventListener('dragend', () => { if (dragEl) dragEl.classList.remove('dragging'); dragEl = null; });
        it.addEventListener('dragover', e => {
          e.preventDefault();
          const after = getDragAfterElement(listEl, e.clientY);
          if (after == null) listEl.appendChild(dragEl);
          else listEl.insertBefore(dragEl, after);
        });
      });

      listEl.addEventListener('drop', async () => {
        const orderIds = Array.from(listEl.querySelectorAll('.reminder-item')).map(x => x.dataset.id);
        localStorage.setItem('reminderOrder:'+ROOM_KEY, JSON.stringify(orderIds));
        if (HAS_SORT_COLUMN) {
          const base = Date.now();
          await Promise.all(orderIds.map((id, idx) => supabase.from('reminders').update({ sort: base + idx }).eq('id', id)));
        }
      });

      function getDragAfterElement(container, y) {
        const els = [...container.querySelectorAll('.reminder-item:not(.dragging)')];
        return els.reduce((closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height/2;
          if (offset < 0 && offset > closest.offset) return { offset, element: child };
          else return closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
      }
    }
  </script>

  <script>
    (() => {
      const backdrop = document.getElementById('secretBackdrop');
      const iframe = document.getElementById('secretFrame');
      const YT_ID = "HJyvMmyQOYQ";

      let buffer = '';
      window.addEventListener('keydown', (e) => {
        if (e.key.length === 1 && /\d/.test(e.key)) {
          buffer = (buffer + e.key).slice(-4);
          if (buffer === '1013') { openModal(); buffer=''; }
        } else if (e.key === 'Escape' && backdrop.classList.contains('show')) {
          closeModal();
        }
      });

      function openModal() {
        if (!backdrop.classList.contains('show')) {
          document.querySelectorAll('.quote-box').forEach(el => el.remove());
          window.QUOTES_DISABLED = true;

          backdrop.classList.add('show');
          backdrop.setAttribute('aria-hidden','false');
          document.body.style.overflow = 'hidden';
          iframe.src = `https://www.youtube.com/embed/${YT_ID}?autoplay=1&rel=0&modestbranding=1&playsinline=1`;
        }
      }
      function closeModal() {
        backdrop.classList.remove('show');
        backdrop.setAttribute('aria-hidden','true');
        document.body.style.overflow = '';
        iframe.src = "about:blank";
        window.QUOTES_DISABLED = false;
      }

      backdrop.addEventListener('click', (e) => { if (e.target === backdrop) closeModal(); }, true);
    })();
  </script>

  <script>
    (() => {
      const start = document.getElementById('startHeart');
      if (!start) return;
      const go = () => { window.location.href = 'journal.html'; };
      start.addEventListener('click', (e) => { e.stopPropagation(); go(); });
      start.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); e.stopPropagation(); go(); }
      });
    })();
  </script>

  <script>
    (() => {
      const heartEl = document.getElementById('title-heart');
      if (!heartEl) return;

      const HOLD_MS = 3000;
      let holdTimer = null;

      const startHold = (e) => {
        e.preventDefault();
        e.stopPropagation();
        clearTimeout(holdTimer);
        holdTimer = setTimeout(() => {
          window.location.href = 'story.html';
        }, HOLD_MS);
      };

      const cancelHold = (e) => {
        if (e) e.stopPropagation();
        clearTimeout(holdTimer);
        holdTimer = null;
      };

      heartEl.addEventListener('pointerdown', startHold, { passive: false });
      ['pointerup','pointerleave','pointercancel'].forEach(ev =>
        heartEl.addEventListener(ev, cancelHold)
      );

      heartEl.addEventListener('contextmenu', (e) => { e.preventDefault(); e.stopPropagation(); });
      heartEl.addEventListener('click', (e) => e.stopPropagation());
    })();
  </script>
</body>
</html>
