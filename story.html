<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scrapbook — Layered Deck (16p, secret 123, Supabase)</title>
<link rel="icon" href="data:," />

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#0b0f2f;
  --paper:#f7eddc;
  --ink:#0d2a6b;
  --accent:#7a5af8;
  --mint:#67e4ca;
  --cover-front:url("lovestory_cover.png?v=8"); /* change this to your front cover image */
  --cover-back:url("https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/backcover.png");
  --page-w:720px;
  --page-h:1020px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--ink);
  display:flex; align-items:center; justify-content:center; overflow:hidden;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
}

/* Stage */
#stage{ position:relative; width:calc(var(--page-w) + 220px); height:calc(var(--page-h) + 120px); }
@media (max-width:1100px){
  #stage{ transform:scale(.9); transform-origin:center; }
}
@media (max-width:980px){
  #stage{ transform:scale(.8); }
}

/* Layered frame (fake stack on right) */
.frame{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); }
.stack{
  position:absolute; inset:auto; width:var(--page-w); height:var(--page-h);
  background:#e7dfcf; border-radius:18px; border:2px solid #efe6d5;
  box-shadow: 0 12px 30px rgba(0,0,0,.35);
  right:-26px; top:-22px; opacity:.8;
}
.stack.s2{ right:-52px; top:-44px; opacity:.6; }
.stack.s3{ right:-78px; top:-66px; opacity:.4; }

/* Page itself */
.page{
  position:relative; width:var(--page-w); height:var(--page-h);
  background:var(--paper); border:2px solid #efe6d5; border-radius:20px;
  box-shadow:0 14px 36px rgba(0,0,0,.38);
  overflow:hidden;
}
.page .page-canvas{
  position:relative; width:100%; height:100%; padding:40px;
  color:var(--ink); font-size:22px; line-height:1.35;
}
.page.cover{
  border-color:#ffffff; background:#0c102c;
}
.page.cover.front .page-canvas{
  background-image:var(--cover-front); background-size:cover;
  background-position:center; background-repeat:no-repeat; padding:0;
}
.page.cover.back .page-canvas{
  background-image:var(--cover-back); background-size:cover;
  background-position:center; background-repeat:no-repeat; padding:0;
}

/* Nav buttons */
.nav{
  position:absolute; z-index:20; width:48px; height:48px; border-radius:50%;
  border:0; cursor:pointer; background:#ffffffee; box-shadow:0 6px 14px rgba(0,0,0,.35);
  display:grid; place-items:center;
}
.nav svg{ width:26px; height:26px; }
#prev{ left:40px; top:50%; transform:translateY(-50%); }
#next{ right:40px; top:50%; transform:translateY(-50%); }
.nav:disabled{ opacity:.35; cursor:default; }

/* Items */
.scrap-item{ position:absolute; transform-origin:center; touch-action:none; overflow:visible; }
.scrap-item.selected{ box-shadow:0 0 0 3px var(--accent); }
.rotator{ display:none; position:absolute; left:50%; top:-18px; transform:translate(-50%,-50%); width:18px; height:18px; border-radius:50%;
  background:#fff; border:3px solid var(--accent); box-shadow:0 2px 8px rgba(0,0,0,.25); cursor:grab; z-index:5; }
.mover{ display:none; position:absolute; left:-10px; top:-10px; width:18px; height:18px; border-radius:50%; background:#fff; border:3px solid var(--accent); cursor:grab; z-index:5; }
.resizer{ display:none; position:absolute; right:-6px; bottom:-6px; width:16px; height:16px; border-radius:4px; background:var(--mint); border:2px solid #0b2c28; cursor:nwse-resize; z-index:5; }
.scrap-img{ display:block; width:100%; height:100%; object-fit:contain; user-select:none; pointer-events:none; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.18); }
.scrap-item[data-fit="cover"] .scrap-img{ object-fit:cover; }
.scrap-text{ width:100%; background:transparent; border:0; color:inherit; font:inherit; white-space:pre-wrap; overflow:visible; min-height:1.2em; }

/* Only interactive while editing */
.page .page-canvas, .scrap-item { pointer-events:none; }
body.editing .page .page-canvas, body.editing .scrap-item { pointer-events:auto; }
body.editing .scrap-item{ cursor:move; }
body.editing .scrap-item .rotator, body.editing .scrap-item .mover, body.editing .scrap-item .resizer{ display:block; }

/* Toolbar (SECRET – only shows after 123) */
#toolbar{
  position:fixed; right:16px; top:50%; transform:translateY(-50%); z-index:100;
  background:#fff; border:2px solid #e8dcc6; border-radius:14px; padding:12px;
  width:260px; gap:10px; box-shadow:0 10px 22px rgba(0,0,0,.25); display:none; flex-direction:column;
}
#toolbar.open{ display:flex; }
#toolbar .group{ display:flex; gap:8px; flex-wrap:wrap; }
#toolbar button{ border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; color:#fff; background:var(--accent); width:100%; }
#toolbar button.secondary{ background:#5d47d4; }
#toolbar button.mint{ background:var(--mint); color:#022d2c; }
#toolbar button.warn{ background:#ff9aa2; color:#4c0a17; }
#toolbar input[type="number"]{ width:100%; padding:8px; border-radius:8px; border:2px solid #e8dcc6; font-weight:700; color:#0d2a6b; background:#fff; }
#toolbar input[type="color"]{ width:100%; height:40px; padding:0; border:2px solid #e8dcc6; border-radius:8px; background:#fff; }
#fileInput{ display:none; }

/* HUD */
#itemHud{ position:absolute; z-index:120; display:none; background:#151a30; color:#fff; border:2px solid #fff2; border-radius:10px; padding:6px; gap:6px;
  box-shadow:0 12px 24px rgba(0,0,0,.35); align-items:center; flex-wrap:wrap; }
#itemHud button{ border:0; padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:700; font-size:12px; color:#fff; background:#5d47d4; }
#itemHud button.warn{ background:#ff9aa2; color:#4c0a17; }
#itemHud button.mint{ background:var(--mint); color:#022d2c; }
#itemHud input[type="number"]{ width:70px; padding:6px 8px; border-radius:8px; border:2px solid #2b3258; background:#0f1430; color:#fff; font-weight:700; font-size:12px; }

/* subtle focus ring when editing text */
.scrap-text[contenteditable="true"]{ outline:2px dashed #7a5af888; outline-offset:4px; }
</style>
</head>
<body>

<div id="stage">
  <button id="prev" class="nav" aria-label="Previous" disabled>
    <svg viewBox="0 0 24 24" fill="none"><path d="M15 6l-6 6 6 6" stroke="#0d2a6b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
  </button>
  <button id="next" class="nav" aria-label="Next">
    <svg viewBox="0 0 24 24" fill="none"><path d="M9 6l6 6-6 6" stroke="#0d2a6b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
  </button>

  <div class="frame">
    <div class="stack s3" aria-hidden="true"></div>
    <div class="stack s2" aria-hidden="true"></div>
    <div class="stack s1" aria-hidden="true"></div>

    <!-- Active page -->
    <div id="page" class="page cover front">
      <div class="page-canvas"></div>
    </div>
  </div>
</div>

<!-- Secret Toolbar (hidden until 123) -->
<div id="toolbar" aria-hidden="true">
  <div class="group">
    <button id="addTextBtn"  class="mint">Add Text</button>
    <button id="addPhotoBtn" class="secondary">Add Photo</button>
    <input id="fileInput" type="file" accept="image/*" />
  </div>
  <div class="group">
    <label for="fontSizeInput" style="font-weight:700;color:#0d2a6b;">Text Size (px)</label>
    <input id="fontSizeInput" type="number" min="8" max="200" step="1" placeholder="px" disabled>
  </div>
  <div class="group">
    <label for="fontColorInput" style="font-weight:700;color:#0d2a6b;">Text Color</label>
    <input id="fontColorInput" type="color" value="#0d2a6b" disabled>
  </div>
  <div class="group">
    <button id="fitToggleBtn"  class="secondary">Fit: Contain</button>
    <button id="lockToggleBtn" class="secondary">Lock: On</button>
  </div>
  <div class="group">
    <button id="deleteSelectedBtn" class="warn">Delete Selected</button>
    <button id="clearPageBtn"     class="warn">Clear Page</button>
    <button id="saveBtn"          class="mint">Save</button>
  </div>
</div>

<!-- HUD -->
<div id="itemHud" aria-hidden="true">
  <button id="hudEdit"  class="mint only-text">Edit</button>
  <input  id="hudFont"  class="only-text" type="number" min="8" max="200" step="1" placeholder="size">
  <button id="hudFit"   class="only-img">Fit: Contain</button>
  <button id="hudLock"  class="only-img">Lock: On</button>
  <button id="hudRotL" title="Rotate left 5°">↺ 5°</button>
  <input  id="hudRot"  type="number" step="1" style="width:70px" placeholder="deg">
  <button id="hudRotR" title="Rotate right 5°">↻ 5°</button>
  <button id="hudDup">Duplicate</button>
  <button id="hudFront">Front</button>
  <button id="hudBack">Back</button>
  <button id="hudDelete" class="warn">Delete</button>
</div>

<script>
(function(){
  /* ===== Supabase (simple single-table JSON) ===== */
  const SUPABASE_URL  = "https://tmjozxcjylcxgemffnoc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
  const STATE_ID = "main";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  /* ===== Book state ===== */
  const PAGE_COUNT = 16;
  let current = 0; // start on front cover (page 1)
  // Each element is { items: [...] } where item = {type:'text'|'image', style:{left,top,width,height}, rot, html? | src?, fit, lock }
  let book = Array.from({length:PAGE_COUNT}, ()=>({items:[]}));

  /* ===== Refs ===== */
  const pageEl = document.getElementById('page');
  const canvas = pageEl.querySelector('.page-canvas');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');

  const toolbar  = document.getElementById('toolbar');
  const addTextBtn = document.getElementById('addTextBtn');
  const addPhotoBtn= document.getElementById('addPhotoBtn');
  const fileInput = document.getElementById('fileInput');
  const fontSizeInput = document.getElementById('fontSizeInput');
  const fontColorInput= document.getElementById('fontColorInput');
  const fitBtn  = document.getElementById('fitToggleBtn');
  const lockBtn = document.getElementById('lockToggleBtn');
  const delBtn  = document.getElementById('deleteSelectedBtn');
  const clearBtn= document.getElementById('clearPageBtn');
  const saveBtn = document.getElementById('saveBtn');

  const itemHud   = document.getElementById('itemHud');
  const hudEdit   = document.getElementById('hudEdit');
  const hudFont   = document.getElementById('hudFont');
  const hudFit    = document.getElementById('hudFit');
  const hudLock   = document.getElementById('hudLock');
  const hudDup    = document.getElementById('hudDup');
  const hudFront  = document.getElementById('hudFront');
  const hudBack   = document.getElementById('hudBack');
  const hudDelete = document.getElementById('hudDelete');
  const hudRot    = document.getElementById('hudRot');
  const hudRotL   = document.getElementById('hudRotL');
  const hudRotR   = document.getElementById('hudRotR');

  let selectedItem = null, zCounter=10;

  /* ===== Secret unlock: type 123 ===== */
  const PASSCODE='123'; let keyBuffer='', keyTimer=null;
  document.addEventListener('keydown',(e)=>{
    if(e.metaKey||e.ctrlKey||e.altKey) return;
    if(typeof e.key!=='string' || e.key.length!==1) return;
    keyBuffer+=e.key; clearTimeout(keyTimer); keyTimer=setTimeout(()=>keyBuffer='',1200);
    if(keyBuffer.endsWith(PASSCODE)){ keyBuffer=''; enterEdit(); }
  });

  function setEditing(on){
    document.body.classList.toggle('editing', on);
    toolbar.classList.toggle('open', on);
    if(!on){ deselect(); }
    // Covers stay uneditable
    updateCoverClass();
  }
  function enterEdit(){ setEditing(true); }
  function isCover(i){ return i===0 || i===PAGE_COUNT-1; }

  /* ===== Navigation ===== */
  function updateCoverClass(){
    pageEl.className='page';
    if(isCover(current)){
      pageEl.classList.add('cover');
      pageEl.classList.add(current===0?'front':'back');
    }
  }
  function updateNav(){
    // Left disabled on front cover only
    prevBtn.disabled = (current===0);
  }
  function goTo(idx){
    saveDomIntoBook(); // keep current edits
    current = ((idx%PAGE_COUNT)+PAGE_COUNT)%PAGE_COUNT;
    renderCurrent();
  }
  prevBtn.onclick = ()=>{ if(current>0) goTo(current-1); };
  nextBtn.onclick = ()=>{ if(current===PAGE_COUNT-1) goTo(0); else goTo(current+1); };

  /* ===== Render & collect ===== */
  function renderCurrent(){
    canvas.innerHTML='';
    updateCoverClass(); updateNav();

    // Build DOM from book[current]
    const items = book[current]?.items || [];
    for(const it of items){
      const box=document.createElement('div'); box.className='scrap-item';
      if(it.style?.left)  box.style.left=it.style.left;
      if(it.style?.top)   box.style.top=it.style.top;
      if(it.style?.width) box.style.width=it.style.width;
      if(it.style?.height)box.style.height=it.style.height;
      if(it.rot){ box.dataset.rot=it.rot; box.style.transform=`rotate(${it.rot}deg)`; }
      if(it.type==='image' && it.src){
        box.dataset.fit=it.fit||'contain'; box.dataset.lock=it.lock?'1':'0';
        box.innerHTML=`<img class="scrap-img" alt="" src="${it.src}" decoding="async">
                       <div class="mover" title="Drag"></div><div class="resizer"></div><div class="rotator"></div>`;
        const imgEl=box.querySelector('.scrap-img');
        const setAspect=()=>{ if(imgEl.naturalWidth&&imgEl.naturalHeight){ box.dataset.aspect=(imgEl.naturalWidth/imgEl.naturalHeight).toFixed(5);} };
        if(imgEl.complete) setAspect(); else imgEl.addEventListener('load',setAspect);
      }else if(it.type==='text' && it.html){
        const holder=document.createElement('div'); holder.innerHTML=(it.html||'').trim();
        const inner=holder.firstElementChild||document.createElement('div'); inner.setAttribute('contenteditable','false'); box.appendChild(inner);
        box.insertAdjacentHTML('beforeend','<div class="mover" title="Drag"></div><div class="resizer"></div><div class="rotator"></div>');
      }
      canvas.appendChild(box); makeDraggable(box); box.dataset._hooked='1';
    }
  }
  function saveDomIntoBook(){
    if(!canvas) return;
    const items=[...canvas.querySelectorAll('.scrap-item')].map(el=>{
      const style={left:el.style.left, top:el.style.top, width:el.style.width, height:el.style.height};
      const rot=parseFloat(el.dataset.rot||'0')||0;
      const img=el.querySelector('.scrap-img');
      if(img){ return {type:'image',style,rot,fit:el.dataset.fit||'contain',lock:el.dataset.lock==='1',src:img.src}; }
      const txt=el.querySelector('.scrap-text'); return {type:'text',style,rot,html:txt?txt.outerHTML:''};
    });
    book[current] = { items };
  }

  /* ===== Draggable / resizable / rotate & HUD ===== */
  function deselect(){ if(selectedItem){ selectedItem.classList.remove('selected'); } selectedItem=null; hideItemHud(); updateToolbarState(); }
  function getRotation(el){ return parseFloat(el?.dataset.rot || '0') || 0; }
  function setRotation(el,deg){
    if(!el) return; el.dataset.rot=String(deg); el.style.transform='rotate('+deg+'deg)';
    hudRot.value=Math.round(getRotation(el)); positionHud();
  }
  function positionHud(){
    if(!selectedItem || itemHud.style.display==='none') return;
    const r=selectedItem.getBoundingClientRect(), sr=pageEl.getBoundingClientRect();
    const hudW=itemHud.offsetWidth, hudH=itemHud.offsetHeight;
    let x=r.right-sr.left-hudW, y=r.top-sr.top-hudH-8;
    x=Math.max(8,Math.min(x,sr.width-hudW-8)); if(y<8) y=r.bottom-sr.top+8;
    itemHud.style.left=x+'px'; itemHud.style.top=y+'px';
  }
  function showItemHud(el){
    if(!el){ hideItemHud(); return; }
    const onImg=!!el.querySelector('.scrap-img');
    const onText=!!el.querySelector('.scrap-text');
    itemHud.querySelectorAll('.only-img').forEach(n=>n.style.display=onImg?'':'none');
    itemHud.querySelectorAll('.only-text').forEach(n=>n.style.display=onText?'':'none');
    if(onImg){
      const fit=el.dataset.fit||'contain', lock=el.dataset.lock==='1';
      hudFit.textContent='Fit: '+(fit==='cover'?'Fill':'Contain');
      hudLock.textContent='Lock: '+(lock?'On':'Off');
    }
    if(onText){
      const t=el.querySelector('.scrap-text');
      hudFont.value=Math.round(parseFloat(getComputedStyle(t).fontSize)||22);
    }
    hudRot.value=Math.round(getRotation(el));
    itemHud.style.display='flex'; requestAnimationFrame(positionHud);
  }
  function hideItemHud(){ itemHud.style.display='none'; }
  window.addEventListener('resize', positionHud);
  itemHud.addEventListener('mousedown', e=>e.stopPropagation());

  function makeDraggable(el){
    let startX=0,startY=0,origX=0,origY=0,resizing=false,startW=0,startH=0;
    let rotating=false,startAngle=0,startPointerAngle=0;
    let dragging=false, dragPointerId=null;

    const res=el.querySelector('.resizer');
    let rot=el.querySelector('.rotator'); if(!rot){ rot=document.createElement('div'); rot.className='rotator'; el.appendChild(rot); }
    let mover=el.querySelector('.mover'); if(!mover){ mover=document.createElement('div'); mover.className='mover'; el.appendChild(mover); }

    el.addEventListener('dragstart', e=>e.preventDefault());

    if(res){
      res.addEventListener('mousedown',e=>{
        if(!document.body.classList.contains('editing')) return;
        e.stopPropagation(); e.preventDefault();
        resizing=true; startX=e.clientX; startY=e.clientY; startW=el.offsetWidth; startH=el.offsetHeight;
        document.addEventListener('mousemove',onMove); document.addEventListener('mouseup',onUp);
      });
    }
    function onMove(e){
      if(!resizing) return;
      const dx=e.clientX-startX, dy=e.clientY-startY;
      const hasImg=!!el.querySelector('.scrap-img');
      const lockOn=hasImg && el.dataset.lock==='1' && !e.shiftKey;
      const ratio=parseFloat(el.dataset.aspect || (el.offsetWidth/Math.max(1,el.offsetHeight)));
      let w=Math.max(60,startW+dx), h=Math.max(40,startH+dy);
      if(lockOn && ratio>0){ if(Math.abs(dx)>=Math.abs(dy)) h=Math.max(40,Math.round(w/ratio)); else w=Math.max(60,Math.round(h*ratio)); }
      el.style.width=w+'px'; el.style.height=h+'px';
      const t=el.querySelector('.scrap-text'); if(t && !hasImg){ t.style.height='auto'; el.style.height=Math.max(40,t.scrollHeight)+'px'; }
      positionHud();
    }
    function onUp(){ document.removeEventListener('mousemove',onMove); document.removeEventListener('mouseup',onUp); resizing=false; }

    rot.addEventListener('mousedown',e=>{
      if(!document.body.classList.contains('editing')) return;
      e.stopPropagation(); e.preventDefault();
      rotating=true; const r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
      startPointerAngle=Math.atan2(e.clientY-cy,e.clientX-cx); startAngle=getRotation(el);
      document.addEventListener('mousemove',onRotate); document.addEventListener('mouseup',endRotate);
    });
    function onRotate(e){
      if(!rotating) return;
      const r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
      const a=Math.atan2(e.clientY-cy,e.clientX-cx);
      setRotation(el, startAngle+(a-startPointerAngle)*180/Math.PI);
      positionHud();
    }
    function endRotate(){ rotating=false; document.removeEventListener('mousemove',onRotate); document.removeEventListener('mouseup',endRotate); }

    el.addEventListener('pointerdown', e=>{
      if(!document.body.classList.contains('editing')) return;
      const isControl = e.target.classList.contains('resizer')||e.target.classList.contains('rotator')||e.target.classList.contains('mover');
      if(isControl) return;
      e.preventDefault(); e.stopPropagation();
      if(selectedItem) selectedItem.classList.remove('selected'); selectedItem=el; el.classList.add('selected');
      updateToolbarState(); showItemHud(el);
      startDrag(e);
    });
    mover.addEventListener('pointerdown', e=>{
      if(!document.body.classList.contains('editing')) return;
      e.preventDefault(); e.stopPropagation();
      if(selectedItem) selectedItem.classList.remove('selected'); selectedItem=el; el.classList.add('selected');
      updateToolbarState(); showItemHud(el);
      startDrag(e);
    });

    function startDrag(e){
      dragging=true; dragPointerId=(e.pointerId!=null)?e.pointerId:'mouse';
      try{ if(e.pointerId!=null && el.setPointerCapture) el.setPointerCapture(e.pointerId);}catch(_){}
      startX=e.clientX; startY=e.clientY; origX=el.offsetLeft; origY=el.offsetTop;
      window.addEventListener('pointermove',onPointerMove);
      window.addEventListener('pointerup',onPointerUp);
      window.addEventListener('pointercancel',onPointerUp);
      el.addEventListener('lostpointercapture',onPointerUp);
    }
    function onPointerMove(e){
      if(!dragging) return;
      const dx=e.clientX-startX, dy=e.clientY-startY;
      el.style.left=(origX+dx)+'px'; el.style.top=(origY+dy)+'px';
      positionHud();
    }
    function onPointerUp(){
      if(!dragging) return;
      try{ if(dragPointerId!=null && el.releasePointerCapture) el.releasePointerCapture(dragPointerId);}catch(_){}
      dragging=false; dragPointerId=null;
      window.removeEventListener('pointermove',onPointerMove);
      window.removeEventListener('pointerup',onPointerUp);
      window.removeEventListener('pointercancel',onPointerUp);
      el.removeEventListener('lostpointercapture',onPointerUp);
    }

    const tnode=el.querySelector('.scrap-text'); if(tnode) enableAutoGrow(el,tnode);
  }
  function enableAutoGrow(box,textEl){
    const grow=()=>{ textEl.style.height='auto'; box.style.height=Math.max(40,textEl.scrollHeight)+'px'; positionHud(); };
    textEl.addEventListener('input',grow); new ResizeObserver(grow).observe(textEl); grow();
  }

  document.addEventListener('click',e=>{
    if(!document.body.classList.contains('editing')) return;
    const onItem=e.target.closest('.scrap-item'), onBar=e.target.closest('#toolbar'), onHud=e.target.closest('#itemHud');
    if(!onItem && !onBar && !onHud) deselect();
  });

  /* ===== Text editing (inline) ===== */
  function editTextBox(box){
    const t = box.querySelector('.scrap-text'); if(!t) return;
    t.setAttribute('contenteditable','true'); t.focus();
    const sel=window.getSelection(), r=document.createRange(); r.selectNodeContents(t); r.collapse(false); sel.removeAllRanges(); sel.addRange(r);
    function end(){ t.removeEventListener('blur',end); t.setAttribute('contenteditable','false'); saveDomIntoBook(); showItemHud(box); }
    t.addEventListener('blur', end, {once:true});
  }
  hudEdit.onclick = ()=>{ if(selectedItem) editTextBox(selectedItem); };

  /* ===== Toolbar actions & sync ===== */
  function selectedTextEl(){ if(!selectedItem) return null; return selectedItem.querySelector('.scrap-text'); }
  function updateFontInput(){
    const t=selectedTextEl(); if(!t){ fontSizeInput.disabled=true; fontSizeInput.value=''; return; }
    fontSizeInput.disabled=false; const curr=Math.round(parseFloat(getComputedStyle(t).fontSize)||22); fontSizeInput.value=curr; hudFont.value=curr;
  }
  function selectedAnyTextEl(){ if(!selectedItem) return null; return selectedItem.querySelector('.scrap-text'); }
  function rgbToHex(rgb){
    const m=String(rgb).match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
    if(!m) return '#000000';
    const r=(+m[1]).toString(16).padStart(2,'0'), g=(+m[2]).toString(16).padStart(2,'0'), b=(+m[3]).toString(16).padStart(2,'0');
    return `#${r}${g}${b}`;
  }
  function updateColorInput(){
    const t=selectedAnyTextEl();
    if(!t){ fontColorInput.disabled=true; return; }
    const comp=getComputedStyle(t).color; fontColorInput.disabled=false; fontColorInput.value=comp.startsWith('#')?comp:rgbToHex(comp);
  }
  fontSizeInput.addEventListener('input',()=>{
    const t=selectedTextEl(); if(!t) return; let v=parseInt(fontSizeInput.value,10); if(isNaN(v)) return;
    v=Math.max(8,Math.min(200,v)); t.style.fontSize=v+'px'; t.style.height='auto';
    const box=t.closest('.scrap-item'); if(box) box.style.height=Math.max(40,t.scrollHeight)+'px'; hudFont.value=v; saveDomIntoBook();
  });
  hudFont.addEventListener('input',()=>{
    const t=selectedTextEl(); if(!t) return; let v=parseInt(hudFont.value,10); if(isNaN(v)) return;
    v=Math.max(8,Math.min(200,v)); t.style.fontSize=v+'px'; t.style.height='auto';
    const box=t.closest('.scrap-item'); if(box) box.style.height=Math.max(40,t.scrollHeight)+'px'; fontSizeInput.value=v; saveDomIntoBook();
  });
  fontColorInput.addEventListener('input',()=>{ const t=selectedAnyTextEl(); if(!t) return; t.style.color=fontColorInput.value; saveDomIntoBook(); });

  function updateImageButtons(){
    const onImg=!!(selectedItem && selectedItem.querySelector('.scrap-img'));
    fitBtn.disabled=!onImg; lockBtn.disabled=!onImg;
    if(onImg){
      const fit=selectedItem.dataset.fit||'contain', lock=selectedItem.dataset.lock==='1';
      fitBtn.textContent='Fit: '+(fit==='cover'?'Fill':'Contain');
      lockBtn.textContent='Lock: '+(lock?'On':'Off');
    } else {
      fitBtn.textContent='Fit: Contain'; lockBtn.textContent='Lock: On';
    }
  }
  function updateToolbarState(){ updateImageButtons(); updateFontInput(); updateColorInput(); }

  fitBtn.onclick = ()=>{ if(!(selectedItem && selectedItem.querySelector('.scrap-img'))) return; const cur=selectedItem.dataset.fit||'contain'; selectedItem.dataset.fit=(cur==='cover')?'contain':'cover'; updateImageButtons(); showItemHud(selectedItem); saveDomIntoBook(); };
  lockBtn.onclick= ()=>{ if(!(selectedItem && selectedItem.querySelector('.scrap-img'))) return; selectedItem.dataset.lock=(selectedItem.dataset.lock==='1')?'0':'1'; updateImageButtons(); showItemHud(selectedItem); saveDomIntoBook(); };

  delBtn.onclick  = ()=>{ if(selectedItem){ selectedItem.remove(); deselect(); saveDomIntoBook(); } };
  clearBtn.onclick= ()=>{
    if(isCover(current)){ alert('Covers are locked. Add content on inner pages.'); return; }
    if(confirm('Clear this page?')){ canvas.querySelectorAll('.scrap-item').forEach(el=>el.remove()); deselect(); saveDomIntoBook(); }
  };

  /* ===== Add Text / Photo ===== */
  addTextBtn.onclick = ()=>{
    if(isCover(current)) { alert('Covers are locked. Add content on inner pages.'); return; }
    const box=document.createElement('div'); box.className='scrap-item'; box.style.left='40px'; box.style.top='40px'; box.style.width='360px';
    box.innerHTML = '<div class="scrap-text" contenteditable="false" style="font-size:28px;color:#0d2a6b">Double-click to edit</div>'
                   + '<div class="mover" title="Drag"></div><div class="resizer"></div><div class="rotator"></div>';
    canvas.appendChild(box); makeDraggable(box); box.dataset._hooked='1'; saveDomIntoBook();
  };
  addPhotoBtn.onclick=()=> fileInput.click();
  fileInput.addEventListener('change',async e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload = ev=>{
      if(isCover(current)) { alert('Covers are locked. Add content on inner pages.'); return; }
      const src=ev.target.result;
      const box=document.createElement('div');
      box.className='scrap-item'; box.style.left='90px'; box.style.top='90px'; box.style.width='360px'; box.style.height='260px';
      box.dataset.fit='contain'; box.dataset.lock='1';
      box.innerHTML=`<img class="scrap-img" alt="" src="${src}" decoding="async"><div class="mover" title="Drag"></div><div class="resizer"></div><div class="rotator"></div>`;
      canvas.appendChild(box); makeDraggable(box); box.dataset._hooked='1';
      const imgEl=box.querySelector('.scrap-img');
      const setAspect=()=>{ if(imgEl.naturalWidth&&imgEl.naturalHeight){ box.dataset.aspect=(imgEl.naturalWidth/imgEl.naturalHeight).toFixed(5);} };
      if(imgEl.complete) setAspect(); else imgEl.addEventListener('load',setAspect);
      fileInput.value=''; saveDomIntoBook();
    };
    reader.readAsDataURL(f);
  });

  /* HUD buttons */
  hudRot.addEventListener('input',()=>{ if(!selectedItem) return; const v=parseFloat(hudRot.value); if(isNaN(v)) return; setRotation(selectedItem,v); saveDomIntoBook(); });
  hudRotL.onclick=()=>{ if(!selectedItem) return; setRotation(selectedItem,getRotation(selectedItem)-5); saveDomIntoBook(); };
  hudRotR.onclick=()=>{ if(!selectedItem) return; setRotation(selectedItem,getRotation(selectedItem)+5); saveDomIntoBook(); };
  hudDup.onclick = ()=>{ if(!selectedItem) return; const clone=selectedItem.cloneNode(true); clone.style.left=(selectedItem.offsetLeft+16)+'px'; clone.style.top=(selectedItem.offsetTop+16)+'px'; canvas.appendChild(clone); makeDraggable(clone); clone.dataset._hooked='1'; saveDomIntoBook(); };
  hudFront.onclick = ()=>{ if(selectedItem){ selectedItem.style.zIndex=++zCounter; saveDomIntoBook(); } };
  hudBack.onclick  = ()=>{ if(selectedItem){ selectedItem.style.zIndex=0; saveDomIntoBook(); } };
  hudDelete.onclick= ()=>{ if(selectedItem){ selectedItem.remove(); deselect(); saveDomIntoBook(); } };

  /* ===== Inline text edit on double-click ===== */
  canvas.addEventListener('dblclick', (e)=>{
    if(!document.body.classList.contains('editing')) return;
    const t = e.target.closest('.scrap-text'); if(!t) return;
    const box = t.closest('.scrap-item'); if(!box) return;
    editTextBox(box);
  });

  /* ===== Supabase save / load ===== */
  async function saveToCloudSimple(){
    saveDomIntoBook(); // capture current page DOM
    const { error } = await sb
      .from('scrapbook_state')
      .upsert({ id: STATE_ID, pages: book, updated_at: new Date().toISOString() }, { onConflict:'id' });
    if (error) { console.error(error); alert('Save failed'); return; }
    alert('Saved ✓');
  }
  async function loadFromCloudSimple(){
    const { data, error } = await sb
      .from('scrapbook_state')
      .select('pages')
      .eq('id', STATE_ID)
      .single();
    if(!error && data && Array.isArray(data.pages) && data.pages.length){
      book = data.pages;
    }
  }
  saveBtn.onclick = ()=> saveToCloudSimple().catch(err => { console.error(err); alert('Save failed'); });

  /* ===== Init ===== */
  (async function init(){
    await loadFromCloudSimple();
    renderCurrent();
    setEditing(false);            // start locked
    updateNav();
  })();

})();
</script>
</body>
</html>
