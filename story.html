<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scrapbook â€” Simple Wordâ€‘style (14 pages, secret 123)</title>
  <link rel="icon" href="data:," />
  <style>
    :root{
      --bg:#0b0f2f; --paper:#f7eddc; --ink:#0d2a6b; --shadow:0 14px 36px rgba(0,0,0,.35);
      --mint:#67e4ca; --purple:#7a5af8;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;}

    /* Word-style: scrollable stack of portrait pages */
    .wrap{ width:min(900px, 96vw); margin:40px auto; padding:0 0 80px; }
    .page{ width:720px; min-height:1020px; margin:34px auto; background:var(--paper); border:2px solid #efe6d5; border-radius:20px; box-shadow:var(--shadow); position:relative; }
    .page.cover{ background:linear-gradient(145deg,#fde7e7,#fffdf8 45%,#e6f8f3); border-color:#fff; }
    .content{ padding:36px 44px; outline:none; }

    /* hidden toolbar (unlocks by typing 123) */
    #toolbar{ position:fixed; right:16px; top:50%; transform:translateY(-50%); z-index:100; background:#fff; color:#111; border:2px solid #e8dcc6; border-radius:14px; padding:12px; width:260px; gap:10px; box-shadow:0 10px 22px rgba(0,0,0,.25); display:none; }
    #toolbar.open{ display:flex; flex-direction:column; }
    #toolbar .group{ display:flex; gap:8px; flex-wrap:wrap; }
    #toolbar button{ border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; color:#fff; background:var(--purple); }
    #toolbar button.mint{ background:var(--mint); color:#022d2c; }
    #toolbar button.warn{ background:#ff9aa2; color:#4c0a17; }
    #fileInput{ display:none; }

    /* small sticky footer */
    #status{ position:fixed; left:0; right:0; bottom:8px; text-align:center; color:#e9f8f4; font-size:14px; pointer-events:none; }

    @media (max-width:820px){ .page{ transform:scale(.9); transform-origin:top center; } }
    @media (max-width:760px){ .page{ transform:scale(.8); } }
    /* allow absolute-positioned text boxes inside pages */
    .content{ position:relative; }
    /* optional (subtle) focus ring while editing a text box; kept minimal */
    .scrap-text[contenteditable="true"]{ outline:2px dashed #7a5af888; outline-offset:4px; }
</style>
</head>
<body>

<div class="wrap" id="doc">
  <!-- 14 pages (1=front cover, 14=back cover). All editable when unlocked. -->
  <div class="page cover" data-page="1"><div class="content" spellcheck="false"></div></div>
  <div class="page" data-page="2"><div class="content" spellcheck="false"></div></div>
  <div class="page" data-page="3"><div class="content" spellcheck="false"></div></div>
  <div class="page" data-page="4"><div class="content" spellcheck="false"></div></div>
  <div class="page" data-page="5"><div class="content" spellcheck="false"></div></div>
  <div class="page" data-page="6"><div class="content" spellcheck="false"></div></div>
  <div class="page" data-page="7"><div class="content" spellcheck="false"></div></div>
  <div class="page" data-page="8"><div class="content" spellcheck="false"></div></div>
  <div class="page" data-page="9"><div class="content" spellcheck="false"></div></div>
  <div class="page" data-page="10"><div class="content" spellcheck="false"></div></div>
  <div class="page" data-page="11"><div class="content" spellcheck="false"></div></div>
  <div class="page" data-page="12"><div class="content" spellcheck="false"></div></div>
  <div class="page" data-page="13"><div class="content" spellcheck="false"></div></div>
  <div class="page cover" data-page="14"><div class="content" spellcheck="false"></div></div>
</div>

<!-- Secret toolbar -->
<div id="toolbar">
  <div class="group">
    <button id="exitEdit" class="warn">Exit Edit</button>
    <button id="insertImg" class="mint">Insert Image</button>
    <input id="fileInput" type="file" accept="image/*">
    <button id="clearPage" class="warn">Clear Page</button>
    <button id="hideBar">ðŸ”’ Hide</button>
  </div>
</div>

<div id="status">type 123 to unlock â€¢ autosaves to cloud + local</div>

<script>
(function(){
  const KEY = 'scrapbook_wordstyle_v1_14p';

  // === Supabase config (cloud persistence) ===
  const SUPABASE_URL  = "https://tmjozxcjylcxgemffnoc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
  const TABLE_STATE   = "scrapbook_state";
  const STATE_ID      = "main"; // change if you want multiple books
  const sbHeaders = { apikey: SUPABASE_ANON, Authorization: "Bearer "+SUPABASE_ANON, "Content-Type":"application/json", Accept:"application/json" };

  const toolbar   = document.getElementById('toolbar');
  const fileInput = document.getElementById('fileInput');
  const insertImg = document.getElementById('insertImg');
  const clearPage = document.getElementById('clearPage');
  const hideBar   = document.getElementById('hideBar');
  const exitEdit  = document.getElementById('exitEdit');
  const pages     = [...document.querySelectorAll('.page')];
  let activeContent = null; // last focused contenteditable

  // ===== SECRET UNLOCK =====
  const PASSCODE='123'; let keyBuffer=''; let keyTimer=null;
  document.addEventListener('keydown', function(e){
    if(e.ctrlKey||e.metaKey||e.altKey) return;
    if(typeof e.key==='string' && e.key.length===1){
      keyBuffer += e.key; clearTimeout(keyTimer); keyTimer=setTimeout(()=> keyBuffer='', 1200);
      if(keyBuffer.slice(-PASSCODE.length)===PASSCODE){ keyBuffer=''; enterEdit(); e.preventDefault(); }
    }
  });

  function enterEdit(){ toolbar.classList.add('open'); setEditable(true); localStorage.setItem(KEY+':unlocked','1'); }
  function exitEditMode(){ setEditable(false); toolbar.classList.remove('open'); localStorage.removeItem(KEY+':unlocked'); }
  exitEdit.addEventListener('click', exitEditMode);
  hideBar.addEventListener('click', ()=> toolbar.classList.remove('open'));

  function setEditable(on){
    document.querySelectorAll('.content').forEach(c=>{
      const isCover = c.closest('.page')?.classList.contains('cover');
      c.contentEditable = (on && !isCover) ? 'true' : 'false';
    });
  }

  // Track active content area + autosave on input
  document.querySelectorAll('.content').forEach(c=>{
    c.addEventListener('focus', ()=> activeContent = c);
    c.addEventListener('click', ()=> activeContent = c);
    c.addEventListener('input', save);
  });

  // Insert image at caret
  insertImg.addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', (e)=>{
    if(!e.target.files || !e.target.files[0]) return;
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = ev => {
      const html = `<img src="${ev.target.result}" style="max-width:100%; height:auto; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.18);"/>`;
      insertHTML(html); save(); fileInput.value='';
    };
    reader.readAsDataURL(file);
  });

  function insertHTML(html){
    let target = (activeContent && document.body.contains(activeContent)) ? activeContent : null;
    if(target && target.closest('.page')?.classList.contains('cover')) target = null; // covers locked
    if(!target){ target = document.querySelector('.page[data-page="2"] .content') || document.querySelector('.content'); }
    target.focus();
    const sel = window.getSelection();
    if(sel && sel.rangeCount){
      const r = sel.getRangeAt(0);
      if(target.contains(r.commonAncestorContainer)){
        r.deleteContents(); r.insertNode(r.createContextualFragment(html)); return;
      }
    }
    target.insertAdjacentHTML('beforeend', html);
  }

  // Clear current page (activeContent's page)
  clearPage.addEventListener('click', ()=>{
    const target = (activeContent && document.body.contains(activeContent)) ? activeContent : null;
    if(!target){ alert('Click into a page first.'); return; }
    if(target.closest('.page')?.classList.contains('cover')){ alert('The cover is locked. Add content on page 2+.'); return; }
    if(confirm('Clear this page?')){ target.innerHTML=''; save(); }
  });

  // ===== Local + Cloud persistence =====
  function snapshot(){
    // store as array of HTML strings (one per page)
    return pages.map(p=> p.querySelector('.content').innerHTML);
  }

  async function cloudSave(pagesArr){
    try{
      await fetch(`${SUPABASE_URL}/rest/v1/${TABLE_STATE}`,{
        method:'POST',
        headers:{...sbHeaders, Prefer:'resolution=merge-duplicates'},
        body: JSON.stringify({ id: STATE_ID, current: 0, pages: pagesArr })
      });
    }catch(err){ console.warn('Cloud save failed:', err); }
  }

  async function cloudLoad(){
    try{
      const url = `${SUPABASE_URL}/rest/v1/${TABLE_STATE}?select=pages,current&id=eq.${encodeURIComponent(STATE_ID)}&limit=1`;
      const res = await fetch(url,{headers:sbHeaders});
      if(!res.ok) throw new Error('state '+res.status);
      const arr = await res.json();
      return arr?.[0] || null;
    }catch(err){ console.warn('Cloud load failed:', err); return null; }
  }

  let cloudTimer=null;
  function saveCloudDebounced(arr){ clearTimeout(cloudTimer); cloudTimer=setTimeout(()=> cloudSave(arr), 600); }

  function save(){
    const arr = snapshot();
    localStorage.setItem(KEY, JSON.stringify(arr));
    saveCloudDebounced(arr);
  }

  async function load(){
    // 1) try cloud
    const cloud = await cloudLoad();
    let arr = null;
    if(cloud && Array.isArray(cloud.pages)){
      arr = cloud.pages;
    } else {
      // 2) fallback to local
      try{ arr = JSON.parse(localStorage.getItem(KEY)||'null'); }catch(_){ arr = null; }
      if(arr) saveCloudDebounced(arr); // seed cloud if only local exists
    }
    if(!arr) return;
    pages.forEach((p,i)=>{ if(arr[i]!=null) p.querySelector('.content').innerHTML = arr[i]; });
  }

  // ===== Init =====
  (async function(){
    await load();
    setEditable(false);
    if(localStorage.getItem(KEY+':unlocked')==='1'){ enterEdit(); }
    // default active content (page 2)
    activeContent = document.querySelector('.page[data-page="2"] .content') || document.querySelector('.content');
  })();
})();
</script>
</body>
</html>
