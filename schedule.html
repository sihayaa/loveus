<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weekly Schedule â€” Realtime</title>
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <style>
    :root{
      --green:#67e4ca;
      --purple:#8a6ee8; 
      --line:#e5e7eb; --ink:#222; --card:#fff; --blue:#e8f0ff;
    }
    *{box-sizing:border-box}
    body{ margin:0; padding:24px; font-family:'Patrick Hand',cursive; background:#f8fafc; color:var(--ink); display:flex; justify-content:center }
    .schedule-container{ display:flex; gap:30px; }
    .schedule{ background:var(--card); border-radius:14px; padding:16px; box-shadow:0 8px 28px rgba(0,0,0,.08); width:360px; }
    h2{ margin:0 0 8px; text-align:center; font-size:24px }
    table{ width:100%; border-collapse:collapse }
    th,td{ border:1px solid var(--line); vertical-align:top }
    th{ width:110px; background:#f3f4f6; padding:8px; text-align:left; font-size:14px }
    td{ padding:8px }
    .day{ font-size:16px }
    .date{ font-size:12px; opacity:.7 }
    .display-text{ font-size:14px; min-height:44px; white-space:pre-line }
    textarea{ width:100%; border:1px dashed #9bb7ff; background:var(--blue); border-radius:8px; padding:6px; font-family:'Patrick Hand',cursive; font-size:14px; display:none }
    .controls{ margin-top:10px; text-align:center }
    .btn{ border:1px solid var(--line); background:#fff; padding:6px 12px; border-radius:8px; cursor:pointer; font-size:14px; margin:0 4px }
    .edit{ background:#dbeafe }
    .save{ background:#bbf7d0 }
    .hint{ font-size:12px; opacity:.8; margin-top:4px }
    .sub{ font-size:13px; margin-top:6px }
    .tag{ padding:2px 8px; border-radius:999px; font-size:12px }
    .manila{ background:#d7fbef; color:#0c5d49 }
    .vegas{ background:#efe7ff; color:#3f2c85 }
  </style>
</head>
<body>
  <div class="schedule-container">
    <div class="schedule" id="col-godbrand">
      <h2>ðŸ’œ Godbrand's schedule</h2>
      <table><tbody id="gb-body"></tbody></table>
      <div class="controls">
        <button class="btn edit" data-col="godbrand">Edit</button>
        <button class="btn save" data-col="godbrand">Save</button>
        <div class="hint">Type like: 10 pm - 6 am (Vegas time)</div>
      </div>
    </div>
    <div class="schedule" id="col-sihaya">
      <h2>ðŸ’š Sihaya's schedule</h2>
      <table><tbody id="sh-body"></tbody></table>
      <div class="controls">
        <button class="btn edit" data-col="sihaya">Edit</button>
        <button class="btn save" data-col="sihaya">Save</button>
        <div class="hint">Type like: 1 pm - 9 pm (Manila time)</div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://tmjozxcjylcxgemffnoc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const vegasTZ = 'America/Los_Angeles';
    const manilaTZ = 'Asia/Manila';
    const DateTime = luxon.DateTime;

    const DAYS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    function mondayInVegas(){
      const now = DateTime.now().setZone(vegasTZ);
      const monday = now.startOf('week').plus({ days:1 }); 
      return monday.startOf('day');
    }
    const weekStartVegas = mondayInVegas();

    function makeRow(dayIndex, forPerson){
      var baseVegas = weekStartVegas.plus({ days: dayIndex });
      var labelVegas = baseVegas.toFormat('LLL dd');
      var baseManila = baseVegas.setZone(manilaTZ);
      var labelManila = baseManila.toFormat('LLL dd');
      var dlabel = (forPerson === 'godbrand') ? labelVegas : labelManila;
      var id = forPerson + '-' + DAYS[dayIndex];
      var html = '';
      html += '<tr>';
      html += '<th><div class="day">' + DAYS[dayIndex] + '</div><div class="date">' + dlabel + '</div></th>';
      html += '<td>';
      html += '<div class="display-text" id="disp-' + id + '"></div>';
      html += '<textarea id="ta-' + id + '" placeholder="e.g. 10 pm - 6 am"></textarea>';
      html += '<div class="sub"><span class="tag ' + (forPerson==='godbrand'?'manila':'vegas') + '">' + (forPerson==='godbrand'?'Manila Time':'Vegas Time') + '</span> <span id="out-' + id + '"></span></div>';
      html += '</td></tr>';
      return html;
    }

    document.getElementById('gb-body').innerHTML = DAYS.map(function(_,i){return makeRow(i,'godbrand')}).join('');
    document.getElementById('sh-body').innerHTML = DAYS.map(function(_,i){return makeRow(i,'sihaya')}).join('');

    function parseRange(input, zone, baseDay){
      if(!input) return null;
      var s = (input+'').replace(/\s+/g,'').toLowerCase();
      var m = s.match(/^([0-9]{1,2})(?::([0-9]{2}))?(am|pm)?-([0-9]{1,2})(?::([0-9]{2}))?(am|pm)?$/);
      if(!m) return null;
      var h1 = parseInt(m[1],10), min1 = parseInt(m[2]||'0',10), ap1 = m[3];
      var h2 = parseInt(m[4],10), min2 = parseInt(m[5]||'0',10), ap2 = m[6];
      function to24(h,ap){ if(ap==='am') return h%12; if(ap==='pm') return h%12+12; return h; }
      var H1 = to24(h1,ap1), H2 = to24(h2,ap2);
      var start = baseDay.set({hour:H1, minute:min1, second:0, millisecond:0}).setZone(zone, { keepLocalTime:true });
      var end   = baseDay.set({hour:H2, minute:min2, second:0, millisecond:0}).setZone(zone, { keepLocalTime:true });
      if(end <= start) end = end.plus({ days:1 });
      return { start:start, end:end };
    }
    function fmtRange(r, zone){
      if(!r) return '';
      var s = r.start.setZone(zone); var e = r.end.setZone(zone);
      var same = s.hasSame(e,'day');
      var note = same? '' : (' (â†’ ' + e.toFormat('ccc') + ')');
      return s.toFormat('h:mm a') + ' - ' + e.toFormat('h:mm a') + note;
    }
    function recalc(person){
      for(var i=0;i<DAYS.length;i++){
        var id = person+'-'+DAYS[i];
        var ta = document.getElementById('ta-'+id);
        var out = document.getElementById('out-'+id);
        var baseV = weekStartVegas.plus({days:i}).setZone(vegasTZ).startOf('day');
        var baseM = baseV.setZone(manilaTZ);
        var r = (person==='godbrand')
          ? parseRange(ta.value, vegasTZ, baseV)
          : parseRange(ta.value, manilaTZ, baseM);
        out.textContent = r ? (person==='godbrand' ? fmtRange(r, manilaTZ) : fmtRange(r, vegasTZ)) : '';
      }
    }

    function setEditMode(person, on){
      for(var i=0;i<DAYS.length;i++){
        var id = person+'-'+DAYS[i];
        var ta = document.getElementById('ta-'+id);
        var disp = document.getElementById('disp-'+id);
        if(on){ ta.style.display='block'; disp.style.display='none'; ta.value = disp.textContent; }
        else { ta.style.display='none'; disp.style.display='block'; }
      }
    }
    document.querySelectorAll('.btn.edit').forEach(function(btn){
      btn.addEventListener('click', function(){
        var person = btn.getAttribute('data-col');
        setEditMode(person, true);
      });
    });
    document.querySelectorAll('.btn.save').forEach(function(btn){
      btn.addEventListener('click', async function(){
        var person = btn.getAttribute('data-col');
        await saveColumn(person);
        setEditMode(person, false);
      });
    });
    document.body.addEventListener('input', function(e){
      var t = e.target;
      if(!t.id || t.tagName!=='TEXTAREA') return;
      var person = t.id.indexOf('godbrand')>-1 ? 'godbrand' : 'sihaya';
      recalc(person);
    });

    async function loadAll(){
      var resp = await supabase.from('couple_schedule').select('*');
      if(resp.error){ console.warn(resp.error); return; }
      var map = {};
      resp.data.forEach(function(r){ map[r.person+'|'+r.day] = r; });
      ['godbrand','sihaya'].forEach(function(person){
        for(var i=0;i<DAYS.length;i++){
          var key = person+'|'+DAYS[i];
          var text = map[key] ? (map[key].content||'') : '';
          document.getElementById('disp-'+person+'-'+DAYS[i]).textContent = text;
          document.getElementById('ta-'+person+'-'+DAYS[i]).value = text;
        }
        recalc(person);
      });
    }
    async function saveColumn(person){
      for(var i=0;i<DAYS.length;i++){
        var id = person+'-'+DAYS[i];
        var text = (document.getElementById('ta-'+id).value||'').trim();
        document.getElementById('disp-'+id).textContent = text;
        var payload = { person:person, day:DAYS[i], content:text };
        var res = await supabase.from('couple_schedule').upsert(payload, { onConflict:'person,day' }).select().single();
        if(res.error){ console.error(res.error); }
      }
      recalc(person);
    }
    function handleChange(payload){
      var r = payload.new; if(!r) return;
      var id = r.person+'-'+r.day;
      document.getElementById('disp-'+id).textContent = r.content||'';
      var ta = document.getElementById('ta-'+id);
      if(ta && ta.style.display==='block'){ ta.value = r.content||''; }
      recalc(r.person);
    }
    supabase.channel('sched_rt')
      .on('postgres_changes', { event:'INSERT', schema:'public', table:'couple_schedule' }, handleChange)
      .on('postgres_changes', { event:'UPDATE', schema:'public', table:'couple_schedule' }, handleChange)
      .subscribe();

    loadAll();
  </script>

</body>
</html>
