<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Our Weekly Schedule ‚Äî build v14</title>

  <!-- Favicon (prevents 404) -->
  <link rel="icon" href="data:,">

  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <style>
    :root { --line:#e5e7eb; --ink:#222; --card:#fff; --blue:#eef2ff; }
    *{box-sizing:border-box}
    body{
      margin:0; padding:24px; min-height:100dvh; color:var(--ink);
      font-family:'Patrick Hand',cursive; display:flex; justify-content:center; align-items:flex-start;
    }
    body::before{
      content:""; position:fixed; inset:0; z-index:-1;
      background:url("https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/schedule_bg.png") center/cover no-repeat;
    }
    .home-btn{
      position:fixed; top:16px; left:16px; z-index:20;
      background:#ffd6e7; color:#7a2d4e; border:1px solid rgba(122,45,78,.12);
      padding:8px 14px; border-radius:999px; text-decoration:none; display:inline-flex; gap:8px; align-items:center;
      box-shadow:0 6px 20px rgba(255,160,195,.35)
    }
    .home-btn svg{width:18px;height:18px}

    .wrap{display:flex; gap:30px; width:min(1100px,96%)}
    .card{background:var(--card); border-radius:12px; padding:16px; box-shadow:0 4px 14px rgba(0,0,0,.08); width:100%}
    h2{margin:0 0 6px; text-align:center}
    .hint{margin:0 0 10px; text-align:center; opacity:.75; font-size:13px}

    table{width:100%; border-collapse:collapse}
    th,td{border:1px solid var(--line); vertical-align:top}
    th{width:120px; background:#f3f4f6; font-size:14px; padding:8px}
    td{padding:8px}

    .display{min-height:24px; padding:4px; white-space:pre-line}
    .edit-row{display:none}
    .group{display:flex; gap:6px; align-items:center; background:var(--blue); padding:6px; border-radius:8px; flex-wrap:wrap}
    .hm{width:82px; padding:6px 8px; border:1px dashed #9bb7ff; border-radius:6px; background:#fff; font-family:'Patrick Hand',cursive}
    .ap{padding:6px 8px; border:1px dashed #9bb7ff; border-radius:6px; background:#fff}
    .dash{opacity:.7}
    .sub{margin-top:6px; font-size:13px}
    .tag{padding:2px 8px; border-radius:999px; font-size:12px}
    .manila{background:#d7fbef; color:#0c5d49}
    .vegas{background:#efe7ff; color:#3f2c85}

    .date-wrap{display:block; margin-top:3px}
    .dlabel,.dlabelR{font-size:12px; opacity:.8}
    .dinput{display:none; width:92px; border:1px dashed #9bb7ff; background:#fff; border-radius:6px; padding:3px 6px; font-family:'Patrick Hand',cursive; font-size:12px}

    .controls{text-align:center; margin-top:10px}
    .btn{border:none; padding:7px 12px; border-radius:8px; cursor:pointer; font-size:14px; margin:0 6px}
    .edit{background:#dbeafe} .save{background:#bbf7d0} .reset{background:#fecaca}

    .rowflex{display:flex; justify-content:space-between; gap:12px}
    .note-chip{max-width:200px; padding:3px 8px; border-radius:999px; background:#f2efff; border:1px solid #dcd4ff; color:#3f2c85; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .note-input{display:none; width:200px; padding:6px; border:1px dashed #c9b8ff; background:#f6f5ff; border-radius:999px; font-family:'Patrick Hand',cursive; font-size:13px}

    .hidden{display:none!important}
    .overlay{position:fixed; inset:0; display:flex; justify-content:center; align-items:center; background:rgba(15,23,42,.55); z-index:1000}
    .modal{width:min(440px,92%); background:#fff; border-radius:16px; padding:20px 18px; text-align:center; box-shadow:0 20px 50px rgba(0,0,0,.25)}
    .modal .actions{display:flex; justify-content:center; gap:10px}
    .gray{background:#e5edff} .danger{background:#fecaca}
  </style>
</head>
<body>
  <a class="home-btn" href="./" aria-label="Back Home">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline><line x1="9" y1="12" x2="21" y2="12"></line></svg>
    Back Home
  </a>

  <div class="wrap">
    <section class="card" id="col-godbrand">
      <h2>üíú Godbrand's Schedule</h2>
      <div class="hint">Use ‚Üë/‚Üì for time fields. ‚Üê/‚Üí toggles Date‚ÜîTime. Press Enter to save.</div>
      <table><tbody id="gbBody"></tbody></table>
      <div class="controls">
        <button class="btn edit" data-person="godbrand">Edit</button>
        <button class="btn save" data-person="godbrand">Save</button>
        <button class="btn reset" data-person="godbrand">Reset</button>
      </div>
    </section>

    <section class="card" id="col-sihaya">
      <h2>üíö Sihaya's Schedule</h2>
      <div class="hint">Use ‚Üë/‚Üì for time fields. ‚Üê/‚Üí toggles Date‚ÜîTime. Press Enter to save.</div>
      <table><tbody id="shBody"></tbody></table>
      <div class="controls">
        <button class="btn edit" data-person="sihaya">Edit</button>
        <button class="btn save" data-person="sihaya">Save</button>
        <button class="btn reset" data-person="sihaya">Reset</button>
      </div>
    </section>
  </div>

  <div id="overlay" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>Reset entries?</h3>
      <p id="modalMsg">This won‚Äôt change the dates.</p>
      <div class="actions">
        <button id="mCancel" class="btn gray">Cancel</button>
        <button id="mConfirm" class="btn danger">Yes, reset</button>
      </div>
    </div>
  </div>

  <script>
    /* Config */
    const supabase = window.supabase.createClient(
      "https://tmjozxcjylcxgemffnoc.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI"
    );
    const { DateTime } = luxon;
    const vegasTZ = "America/Los_Angeles";
    const manilaTZ = "Asia/Manila";
    const DAYS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    const IDX = Object.fromEntries(DAYS.map((d,i)=>[d,i]));
    console.log("Schedule build: v14");

    /* DOM rows */
    function rowHTML(day, person){
      const tag = person==='godbrand'
        ? '<span class="tag manila">Manila Time</span>'
        : '<span class="tag vegas">Vegas Time</span>';

      const dateBits = person==='godbrand'
        ? `<span class="dlabel" id="label-${day}"></span>
           <input class="dinput" id="input-${day}" data-role="date" data-person="godbrand" data-day="${day}" />`
        : `<span class="dlabelR" id="labelR-${day}"></span>`;

      if(person==='godbrand'){
        return `
        <tr>
          <th><div>${day}</div><span class="date-wrap">${dateBits}</span></th>
          <td>
            <div class="display" id="disp-${person}-${day}"></div>
            <div class="edit-row" id="edit-${person}-${day}">
              <div class="group">
                <input class="hm" id="start-hm-${person}-${day}" data-person="${person}" data-day="${day}" data-role="start-hm" />
                <select class="ap" id="start-am-${person}-${day}" data-person="${person}" data-day="${day}" data-role="start-am"><option>AM</option><option>PM</option></select>
                <span class="dash">‚Äì</span>
                <input class="hm" id="end-hm-${person}-${day}" data-person="${person}" data-day="${day}" data-role="end-hm" />
                <select class="ap" id="end-am-${person}-${day}" data-person="${person}" data-day="${day}" data-role="end-am"><option>AM</option><option>PM</option></select>
              </div>
            </div>
            <div class="sub">${tag} <span id="out-${person}-${day}"></span></div>
          </td>
        </tr>`;
      }
      return `
      <tr>
        <th><div>${day}</div><span class="date-wrap">${dateBits}</span></th>
        <td>
          <div class="rowflex">
            <div class="left">
              <div class="display" id="disp-${person}-${day}"></div>
              <div class="edit-row" id="edit-${person}-${day}">
                <div class="group">
                  <input class="hm" id="start-hm-${person}-${day}" data-person="${person}" data-day="${day}" data-role="start-hm" />
                  <select class="ap" id="start-am-${person}-${day}" data-person="${person}" data-day="${day}" data-role="start-am"><option>AM</option><option>PM</option></select>
                  <span class="dash">‚Äì</span>
                  <input class="hm" id="end-hm-${person}-${day}" data-person="${person}" data-day="${day}" data-role="end-hm" />
                  <select class="ap" id="end-am-${person}-${day}" data-person="${person}" data-day="${day}" data-role="end-am"><option>AM</option><option>PM</option></select>
                </div>
              </div>
              <div class="sub">${tag} <span id="out-${person}-${day}"></span></div>
            </div>
            <div class="right">
              <div class="note-chip" id="note-chip-sihaya-${day}"></div>
              <input class="note-input" id="note-input-sihaya-${day}" />
            </div>
          </div>
        </td>
      </tr>`;
    }
    function buildTables(){
      document.getElementById('gbBody').innerHTML = DAYS.map(d=>rowHTML(d,'godbrand')).join('');
      document.getElementById('shBody').innerHTML = DAYS.map(d=>rowHTML(d,'sihaya')).join('');
    }

    /* Edit mode + keyboard */
    function setEditMode(person, on){
      for(const day of DAYS){
        const e = document.getElementById(`edit-${person}-${day}`);
        const d = document.getElementById(`disp-${person}-${day}`);
        e.style.display = on?'block':'none';
        d.style.display = on?'none':'block';
        if(on) prefillFromText(person,day);

        if(person==='sihaya'){
          const chip=document.getElementById(`note-chip-sihaya-${day}`);
          const input=document.getElementById(`note-input-sihaya-${day}`);
          if(chip&&input){ input.style.display=on?'block':'none'; chip.style.display=on?'none':'block'; }
        }
      }
    }
    function setDatesEdit(on){
      for(const day of DAYS){
        const lab=document.getElementById(`label-${day}`);
        const inp=document.getElementById(`input-${day}`);
        if(!inp) continue;
        if(on){ inp.style.display='inline-block'; lab.style.display='none'; inp.value=lab.textContent; }
        else { inp.style.display='none'; lab.style.display='inline'; }
      }
    }
    function exitEdit(){ setDatesEdit(false); setEditMode('godbrand',false); setEditMode('sihaya',false); }

    const order=['start-hm','start-am','end-hm','end-am'];
    function focusRole(role, person, idx){
      const day=DAYS[Math.max(0,Math.min(6,idx))];
      const id= role==='date' ? `input-${day}` : `${role}-${person}-${day}`;
      const el=document.getElementById(id); if(el){ el.focus(); el.select?.(); }
    }
    function move(person, idx, role, dir){
      let r=order.indexOf(role); if(r===-1) r=0; r+=dir;
      if(r<0){ idx-=1; r=order.length-1; }
      if(r>=order.length){ idx+=1; r=0; }
      idx=Math.max(0,Math.min(6,idx));
      focusRole(order[r], person, idx);
    }

    document.addEventListener('keydown', async (e)=>{
      const t=e.target;
      const inEdit=t.matches('.hm,.ap,.dinput,.note-input');
      if(t.matches('.hm,.ap,.dinput')){
        const role=(t.dataset.role || (t.classList.contains('dinput')?'date':'start-hm')).toLowerCase();
        const day=t.dataset.day || (t.classList.contains('dinput')? t.id.replace('input-','') : t.dataset.day);
        const person=t.dataset.person || (t.classList.contains('dinput')? 'godbrand' : t.dataset.person);
        const idx=IDX[day];

        if(e.key==='ArrowUp'){ e.preventDefault(); move(person,idx,role,-1); return; }
        if(e.key==='ArrowDown'){ e.preventDefault(); move(person,idx,role, 1); return; }
        if(e.key==='ArrowLeft'){ e.preventDefault(); const di=document.getElementById(`input-${day}`); if(di && di.style.display!=='none'){ di.focus(); di.select?.(); } return; }
        if(e.key==='ArrowRight'){ e.preventDefault(); focusRole('start-hm','godbrand',idx); return; }
      }
      if(e.key==='Enter' && inEdit){ e.preventDefault(); await saveAll(true); }
    });

    document.addEventListener('input', (e)=>{
      const t=e.target;
      if(t.matches('.hm,.ap')) recalcRow(t.dataset.person, t.dataset.day);
    });

    /* Save/Reset buttons */
    document.addEventListener('click', async (e)=>{
      const b=e.target.closest('.btn'); if(!b) return;
      const who=b.dataset.person;
      if(b.classList.contains('edit')){ setEditMode(who,true); setDatesEdit(true); document.getElementById(`start-hm-${who}-Mon`)?.focus(); }
      if(b.classList.contains('save')){ await saveAll(true); }
      if(b.classList.contains('reset')){ openModal(who); }
    });

    /* Supabase load/save */
    async function loadAll(){
      const d = await supabase.from('couple_schedule_dates').select('*');
      if(!d.error){
        d.data.forEach(r=>{
          const L=document.getElementById(`label-${r.day}`); const R=document.getElementById(`labelR-${r.day}`);
          if(L) L.textContent=r.label||''; if(R) R.textContent=r.label||'';
        });
      }
      const c = await supabase.from('couple_schedule').select('*');
      if(!c.error){
        c.data.forEach(r=>{
          const disp=document.getElementById(`disp-${r.person}-${r.day}`);
          if(disp) disp.textContent=r.content||'';
          recalcRow(r.person, r.day); // conversion NOW on load
        });
      }
      const n = await supabase.from('couple_notes').select('*').eq('person','sihaya');
      if(!n.error){
        n.data.forEach(r=>{
          const chip=document.getElementById(`note-chip-sihaya-${r.day}`);
          const input=document.getElementById(`note-input-sihaya-${r.day}`);
          if(chip) chip.textContent=r.note||''; if(input) input.value=r.note||'';
        });
      }
      recalcAll('godbrand'); recalcAll('sihaya'); // safety pass
    }

    async function saveAll(exitAfter=true){
      await Promise.all([saveDates(),saveCol('godbrand'),saveCol('sihaya'),saveNotes()]);
      recalcAll('godbrand'); recalcAll('sihaya');
      if(exitAfter) exitEdit();
    }
    async function saveDates(){
      const rows=[];
      for(const day of DAYS){
        const inp=document.getElementById(`input-${day}`);
        if(!inp || inp.style.display==='none') continue;
        const val=(inp.value||'').trim();
        document.getElementById(`label-${day}`).textContent=val;
        const r=document.getElementById(`labelR-${day}`); if(r) r.textContent=val;
        rows.push({day,label:val});
      }
      if(rows.length) await supabase.from('couple_schedule_dates').upsert(rows);
    }
    async function saveCol(person){
      const rows=[];
      for(const day of DAYS){
        const content=getContent(person,day);
        document.getElementById(`disp-${person}-${day}`).textContent=content;
        rows.push({person,day,content});
      }
      if(rows.length) await supabase.from('couple_schedule').upsert(rows,{onConflict:'person,day'});
    }
    async function saveNotes(){
      const rows=[];
      for(const day of DAYS){
        const input=document.getElementById(`note-input-sihaya-${day}`);
        const chip=document.getElementById(`note-chip-sihaya-${day}`);
        if(!input||!chip) continue;
        const note=(input.value||'').trim(); chip.textContent=note;
        rows.push({person:'sihaya',day,note});
      }
      if(rows.length) await supabase.from('couple_notes').upsert(rows,{onConflict:'person,day'});
    }
    async function resetCol(person){
      for(const day of DAYS){
        document.getElementById(`disp-${person}-${day}`).textContent='';
        const out=document.getElementById(`out-${person}-${day}`); if(out) out.textContent='';
        ['start-hm','start-am','end-hm','end-am'].forEach(r=>{
          const el=document.getElementById(`${r}-${person}-${day}`); if(el) el.value='';
        });
        if(person==='sihaya'){
          const chip=document.getElementById(`note-chip-sihaya-${day}`); const input=document.getElementById(`note-input-sihaya-${day}`);
          if(chip) chip.textContent=''; if(input) input.value='';
        }
      }
      await supabase.from('couple_schedule').delete().eq('person',person);
      if(person==='sihaya') await supabase.from('couple_notes').delete().eq('person','sihaya');
    }

    /* Conversions */
    const to24=(h,ap)=>ap==='AM'?(h%12):(h%12)+12;
    function parseHM(s){
      const m=String(s||'').trim().match(/^(\d{1,2})(?::(\d{1,2}))?$/);
      if(!m) return null; const h=+m[1], mi=+(m[2]||0); if(h<1||h>12||mi<0||mi>59) return null; return {h, m:mi};
    }
    function normHM(s){ const p=parseHM(s); if(!p) return s; return `${p.h}:${String(p.m).padStart(2,'0')}`; }
    function extractTimes(raw){
      const txt=String(raw||'').replace(/[‚Äì‚Äî‚àí]/g,'-');
      const tok=[...txt.matchAll(/(\d{1,2})(?::(\d{1,2}))?\s*(a\.?m\.?|p\.?m\.?)/gi)];
      if(tok.length<2) return null;
      const a=tok[0], b=tok[1];
      return {
        startHM:`${a[1]}:${String(a[2]||'0').padStart(2,'0')}`,
        startAP:/p/i.test(a[3])?'PM':'AM',
        endHM:`${b[1]}:${String(b[2]||'0').padStart(2,'0')}`,
        endAP:/p/i.test(b[3])?'PM':'AM'
      };
    }
    function mondayInVegas(){
      const now=DateTime.now().setZone(vegasTZ);
      const d=(now.weekday+6)%7; // Mon=0
      return now.startOf('day').minus({days:d});
    }
    function recalcAll(person){ for(const day of DAYS) recalcRow(person,day); }
    function recalcRow(person,day){
      const idx=IDX[day];
      const baseV=mondayInVegas().plus({days:idx}).setZone(vegasTZ).startOf('day');
      const baseM=baseV.setZone(manilaTZ);

      let sHM,sAP,eHM,eAP;
      const editing=document.getElementById(`edit-${person}-${day}`).style.display!=='none';
      if(editing){
        sHM=document.getElementById(`start-hm-${person}-${day}`).value;
        sAP=document.getElementById(`start-am-${person}-${day}`).value;
        eHM=document.getElementById(`end-hm-${person}-${day}`).value;
        eAP=document.getElementById(`end-am-${person}-${day}`).value;
      }else{
        const t=extractTimes(document.getElementById(`disp-${person}-${day}`).textContent);
        if(!t){ document.getElementById(`out-${person}-${day}`).textContent=''; return; }
        ({startHM:sHM,startAP:sAP,endHM:eHM,endAP:eAP}=t);
      }

      const s=parseHM(sHM), e=parseHM(eHM);
      if(!s||!e){ document.getElementById(`out-${person}-${day}`).textContent=''; return; }

      const s24=to24(s.h,sAP), e24=to24(e.h,eAP);
      let start=(person==='godbrand'?baseV:baseM).set({hour:s24,minute:s.m});
      let end  =(person==='godbrand'?baseV:baseM).set({hour:e24,minute:e.m});
      if(end<=start) end=end.plus({days:1});

      const fmt=(a,b,zone)=>`${a.setZone(zone).toFormat('ccc h:mm a')} - ${b.setZone(zone).toFormat('ccc h:mm a')}`;
      document.getElementById(`out-${person}-${day}`).textContent =
        person==='godbrand' ? fmt(start,end,manilaTZ) : fmt(start,end,vegasTZ);
    }
    function getContent(person,day){
      const row=document.getElementById(`edit-${person}-${day}`);
      if(row && row.style.display!=='none'){
        const sHM=document.getElementById(`start-hm-${person}-${day}`).value.trim();
        const sAP=document.getElementById(`start-am-${person}-${day}`).value.trim();
        const eHM=document.getElementById(`end-hm-${person}-${day}`).value.trim();
        const eAP=document.getElementById(`end-am-${person}-${day}`).value.trim();
        if(!sHM||!eHM) return '';
        return `${normHM(sHM)} ${sAP.toLowerCase()} - ${normHM(eHM)} ${eAP.toLowerCase()}`;
      }
      return document.getElementById(`disp-${person}-${day}`).textContent || '';
    }
    function prefillFromText(person,day){
      const t=extractTimes(document.getElementById(`disp-${person}-${day}`).textContent);
      if(!t) return;
      document.getElementById(`start-hm-${person}-${day}`).value=t.startHM;
      document.getElementById(`start-am-${person}-${day}`).value=t.startAP;
      document.getElementById(`end-hm-${person}-${day}`).value=t.endHM;
      document.getElementById(`end-am-${person}-${day}`).value=t.endAP;
    }

    /* Modal */
    const overlay=document.getElementById('overlay'); let pending=null;
    function openModal(who){
      pending=who;
      document.getElementById('modalMsg').textContent = who==='godbrand'
        ? "Clear all Godbrand's entries? Dates won't change."
        : "Clear all Sihaya's entries and notes? Dates won't change.";
      overlay.classList.remove('hidden');
    }
    document.getElementById('mCancel').onclick=()=>{overlay.classList.add('hidden'); pending=null};
    document.getElementById('mConfirm').onclick=async()=>{ if(pending){ await resetCol(pending); overlay.classList.add('hidden'); pending=null; } };
    overlay.addEventListener('click',e=>{ if(e.target===overlay){ overlay.classList.add('hidden'); pending=null; } });

    /* Init */
    buildTables();
    loadAll();
  </script>
</body>
</html>
