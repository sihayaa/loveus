<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Date Plans</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:,">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/dist/umd/supabase.min.js"></script>

  <style>
    :root{
      --bg:#07110e;        /* near-black green */
      --card:#0f1a17;      /* dark card */
      --ink:#eaf7f1;       /* main text */
      --muted:#a6c9bf;     /* secondary text */
      --line:#22332d;      /* borders */

      --green:#1b8f7d;     /* accent green */
      --purple:#5a3ccf;    /* accent purple */
      --danger:#e65353;

      --radius:16px;
      --maxw:1100px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:var(--font);
      min-height:100svh; display:grid; place-items:center;
    }

    .shell{
      width:min(100%, var(--maxw));
      height:min(94svh, 900px);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:0 10px 30px rgba(0,0,0,.55);
      display:grid;
      grid-template-rows:auto auto 1fr;
      overflow:hidden;
    }

    .topbar{
      display:flex; align-items:center; gap:16px;
      padding:14px 18px;
      background:linear-gradient(90deg, #145a4f, #3f2a9e);
      color:#fff; border-bottom:1px solid var(--line);
    }
    .topbar h1{ margin:0; font-size:22px; font-weight:700; letter-spacing:.3px }

    .controls{
      display:flex; flex-wrap:wrap; gap:10px; padding:12px 16px;
      background:#0d1815; border-bottom:1px solid var(--line);
      position:sticky; top:0; z-index:2;
    }
    input[type="date"], input[type="text"], textarea{
      height:40px;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      background:#12231e; color:var(--ink); outline:none;
      font-family:var(--font);
    }
    textarea{
      min-height:40px; height:40px; max-height:140px; resize:vertical;
    }
    input::placeholder, textarea::placeholder{ color:var(--muted) }
    .grow{ flex:1 1 260px }
    .btn{
      border:1px solid #175e54; border-radius:12px; padding:10px 14px; height:40px;
      background:var(--green); color:#fff; cursor:pointer;
      transition:transform .05s ease, filter .1s ease;
      font-weight:600;
    }
    .btn:hover{ transform:translateY(-1px); filter:brightness(1.05) }

    .listwrap{ overflow:auto; padding:0 10px 12px 10px; }
    table{ width:100%; border-collapse:separate; border-spacing:0 12px; }
    thead th{
      position:sticky; top:0; z-index:1; background:#0d1815; color:var(--muted);
      padding:10px 12px; text-align:left; font-weight:700; border-bottom:1px solid var(--line);
    }

    /* brighter rows + subtle accent bar */
    tbody tr{
      position:relative;
      box-shadow:0 10px 18px rgba(0,0,0,.28);
    }
    tbody tr::before{
      content:"";
      position:absolute; inset:0;
      background:#152e27;         /* brighter than card */
      border:1px solid #2b463f;   /* soft ring */
      border-radius:14px;
      z-index:0;
    }
    tbody tr::after{
      content:"";
      position:absolute; left:8px; top:8px; bottom:8px; width:4px;
      border-radius:3px;
      background:linear-gradient(var(--green), var(--purple));
      opacity:.9; z-index:1;
    }
    tbody tr:hover::before{ filter:brightness(1.05) }

    tbody td{
      position:relative; z-index:2; /* sit above ::before background */
      background:transparent; border:none; color:var(--ink);
      padding:14px 14px 16px 18px; vertical-align:top;
    }
    tbody td:first-child{ padding-left:24px }

    /* label-on-top style */
    .cell{ display:flex; flex-direction:column; gap:6px }
    .field-label{ font-size:12px; color:var(--muted); letter-spacing:.2px }

    .row-note{ white-space:pre-wrap }

    /* top-right toolbar */
    .row-tools{
      position:absolute; right:12px; top:10px; z-index:3;
      display:flex; gap:8px;
    }
    .iconbtn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:6px; padding:6px 10px; border-radius:12px; cursor:pointer;
      font-weight:700; border:1px solid var(--line); background:#0f1f1b; color:var(--ink);
      opacity:.9;
    }
    .iconbtn:hover{ opacity:1; filter:brightness(1.08) }
    .iconbtn.delete{ background:#842f2f; border-color:#6d2626; color:#fff }
    .iconbtn.save{ background:#1b8f7d; border-color:#175e54; color:#fff; display:none }

    /* show Save only in edit mode; hide Edit while editing */
    tr.editing .iconbtn.save{ display:inline-flex }
    tr.editing .iconbtn.edit{ display:none }

    @media (max-width:760px){
      thead{ display:none }
      table, tbody, tr, td{ display:block; width:100% }
      tbody tr{ margin-bottom:12px }
      tbody td{ border-radius:14px !important }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="topbar">
      <h1>Date Plans</h1>
    </div>

    <div class="controls">
      <input id="in-date" type="date" title="date" />
      <input id="in-type" type="text" class="grow" placeholder="type (movie, dinner, game night‚Ä¶)" />
      <textarea id="in-notes" class="grow" placeholder="notes (where, what you watched/played, moments, etc.)"></textarea>
      <button class="btn" id="btn-save">Save</button>
    </div>

    <div class="listwrap">
      <table>
        <thead>
          <tr>
            <th style="min-width:120px">date</th>
            <th style="min-width:180px">type</th>
            <th>notes</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

<script>
/* ========== helpers ========== */
const $ = s => document.querySelector(s);
const rowsEl = $('#rows');

function localYYYYMMDD(d=new Date()){
  const tz = d.getTimezoneOffset()*60000;
  return new Date(d - tz).toISOString().slice(0,10);
}
$('#in-date').value = localYYYYMMDD(new Date());

function toast(msg){
  const t = document.createElement('div');
  t.textContent = msg;
  Object.assign(t.style, {
    position:'fixed', left:'50%', top:'10px', transform:'translateX(-50%)',
    background:'#000', color:'#fff', padding:'10px 14px', borderRadius:'10px',
    fontFamily:'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial',
    zIndex:9999, opacity:.94
  });
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), 1600);
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}

/* ========== Supabase init (your creds) ========== */
const SUPABASE_URL  = "https://tmjozxcjylcxgemffnoc.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const TABLE = 'date_plans';

/* ========== CRUD ========== */
async function fetchAll(){
  const { data, error } = await sb.from(TABLE)
    .select('*')
    .order('date', { ascending:false })
    .order('created_at', { ascending:false });
  if (error){ console.error(error); toast('load failed'); return; }
  render(data || []);
}

async function saveNew(){
  const date  = $('#in-date').value;
  const type  = $('#in-type').value.trim();
  const notes = $('#in-notes').value.trim();
  if (!date || !type){ toast('need date + type'); return; }

  const { error } = await sb.from(TABLE).insert({ date, type, notes });
  if (error){ console.error(error); toast('save failed'); return; }

  $('#in-notes').value = '';
  toast('saved');
}

async function saveRow(id, fields){
  const { error } = await sb.from(TABLE).update(fields).eq('id', id);
  if (error){ console.error(error); toast('save failed'); return; }
  toast('saved');
}

async function deleteRow(id){
  const ok = confirm('delete this plan?');
  if (!ok) return;
  const { error } = await sb.from(TABLE).delete().eq('id', id);
  if (error){ console.error(error); toast('delete failed'); return; }
  toast('deleted');
}

/* ========== render ========== */
function render(list){
  rowsEl.innerHTML = '';
  for (const r of list){
    const tr = document.createElement('tr');

    // cells
    const tdDate = document.createElement('td');
    const tdType = document.createElement('td');
    const tdNote = document.createElement('td');

    tdDate.innerHTML = `
      <div class="cell">
        <div class="field-label">Date:</div>
        <input type="date" value="${r.date ?? ''}" data-field="date" disabled
               style="width:160px;background:#101d19;color:#eaf7f1;border:1px solid #22332d">
      </div>
    `;
    tdType.innerHTML = `
      <div class="cell">
        <div class="field-label">Type:</div>
        <input type="text" value="${escapeHtml(r.type||'')}" data-field="type" disabled class="grow"
               style="background:#101d19;color:#eaf7f1;border:1px solid #22332d">
      </div>
    `;
    tdNote.innerHTML = `
      <div class="cell">
        <div class="field-label">Notes:</div>
        <textarea data-field="notes" disabled class="row-note"
                  style="background:#101d19;color:#eaf7f1;border:1px solid #22332d">${escapeHtml(r.notes||'')}</textarea>
      </div>
    `;

    tr.append(tdDate, tdType, tdNote);

    // top-right tools
    const tools = document.createElement('div');
    tools.className = 'row-tools';
    tools.innerHTML = `
      <button class="iconbtn edit"   title="Edit">‚úçüèª</button>
      <button class="iconbtn save"   title="Save">‚úîÔ∏è</button>
      <button class="iconbtn delete" title="Delete">üóëÔ∏è</button>
    `;
    tr.appendChild(tools);

    rowsEl.appendChild(tr);

    // logic per row
    const inputs   = tr.querySelectorAll('[data-field]');
    const btnEdit  = tools.querySelector('.edit');
    const btnSave  = tools.querySelector('.save');
    const btnDel   = tools.querySelector('.delete');

    function setEditing(on){
      inputs.forEach(i => i.disabled = !on);
      tr.classList.toggle('editing', on);
      if (on) inputs[0]?.focus();
    }

    btnEdit.addEventListener('click', ()=> setEditing(true));

    btnSave.addEventListener('click', async ()=>{
      const payload = {};
      inputs.forEach(i => payload[i.dataset.field] = i.value);
      await saveRow(r.id, payload);
      setEditing(false);
    });

    btnDel.addEventListener('click', ()=> deleteRow(r.id));
  }
}

/* ========== keyboard: arrow nav + Enter-to-save-new + Shift+Enter newline ========== */
const inDate  = $('#in-date');
const inType  = $('#in-type');
const inNotes = $('#in-notes');
const btnSaveTop = $('#btn-save');

const fields = [inDate, inType, inNotes, btnSaveTop];
function idxOf(el){ return fields.indexOf(el); }
function focusAt(i){
  const n = ((i % fields.length) + fields.length) % fields.length;
  fields[n]?.focus();
}
function handleArrowNav(e){
  const el = e.target;
  const idx = idxOf(el);
  if (idx === -1) return;

  if (el === inDate){
    if (e.key === 'ArrowLeft'){ e.preventDefault(); focusAt(idx-1); }
    if (e.key === 'ArrowRight'){ e.preventDefault(); focusAt(idx+1); }
    return;
  }
  if (el === inType){
    const pos = el.selectionStart ?? 0;
    const atStart = pos === 0;
    const atEnd = pos === el.value.length;
    if ((e.key === 'ArrowLeft' || e.key === 'ArrowUp') && atStart){ e.preventDefault(); focusAt(idx-1); }
    if ((e.key === 'ArrowRight' || e.key === 'ArrowDown') && atEnd){ e.preventDefault(); focusAt(idx+1); }
    return;
  }
  if (el === inNotes){
    const pos = el.selectionStart ?? 0;
    const atStart = pos === 0;
    const atEnd = pos === el.value.length;
    if (e.key === 'ArrowUp' && atStart){ e.preventDefault(); focusAt(idx-1); }
    if (e.key === 'ArrowDown' && atEnd){ e.preventDefault(); focusAt(idx+1); }
    return;
  }
}
fields.forEach(el => el.addEventListener('keydown', handleArrowNav));

// Enter saves new; Shift+Enter = newline in notes
fields.forEach(el => el.addEventListener('keydown', (e)=>{
  if (e.key !== 'Enter') return;
  if (el === inNotes && e.shiftKey) return; // newline
  e.preventDefault();
  saveNew();
}));

/* ========== click + realtime ========== */
btnSaveTop.addEventListener('click', saveNew);

sb.channel('public:'+TABLE)
  .on('postgres_changes', { event:'*', schema:'public', table:TABLE }, fetchAll)
  .subscribe();

/* start */
fetchAll();
</script>
</body>
</html>
