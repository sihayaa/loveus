<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Date Plans</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:,">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/dist/umd/supabase.min.js"></script>

  <style>
    :root{
      /* dark theme */
      --bg:#07110e;        /* near-black green */
      --card:#0f1a17;      /* dark card */
      --ink:#eaf7f1;       /* main text */
      --muted:#a6c9bf;     /* secondary text */
      --line:#22332d;      /* borders */

      --green:#1b8f7d;     /* accent green */
      --purple:#5a3ccf;    /* accent purple */
      --danger:#e65353;

      --radius:16px;
      --maxw:1100px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:var(--font);
      min-height:100svh; display:grid; place-items:center;
    }

    .shell{
      width:min(100%, var(--maxw));
      height:min(94svh, 900px);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:0 10px 30px rgba(0,0,0,.55);
      display:grid;
      grid-template-rows:auto auto 1fr;
      overflow:hidden;
    }

    .topbar{
      display:flex; align-items:center; gap:16px;
      padding:14px 18px;
      background:linear-gradient(90deg, #145a4f, #3f2a9e);
      color:#fff; border-bottom:1px solid var(--line);
    }
    .topbar h1{ margin:0; font-size:22px; font-weight:700; letter-spacing:.3px }

    .controls{
      display:flex; flex-wrap:wrap; gap:10px; padding:12px 16px;
      background:#0d1815; border-bottom:1px solid var(--line);
      position:sticky; top:0; z-index:2;
    }
    input[type="date"], input[type="text"], textarea{
      height:40px;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      background:#12231e; color:var(--ink); outline:none;
      font-family:var(--font);
    }
    textarea{
      min-height:40px; height:40px; max-height:140px; resize:vertical;
    }
    input::placeholder, textarea::placeholder{ color:var(--muted) }
    .grow{ flex:1 1 260px }
    .btn{
      border:1px solid #2a2550; border-radius:12px; padding:10px 14px; height:40px;
      background:var(--purple); color:#fff; cursor:pointer;
      transition:transform .05s ease, filter .1s ease;
      font-weight:600;
    }
    .btn:hover{ transform:translateY(-1px); filter:brightness(1.05) }
    .btn.green{ background:var(--green); border-color:#175e54 }
    .btn.danger{ background:var(--danger); border-color:#7c2424 }

    .listwrap{ overflow:auto; padding:0 10px 12px 10px; }
    table{ width:100%; border-collapse:separate; border-spacing:0 10px; }
    thead th{
      position:sticky; top:0; z-index:1; background:#0d1815; color:var(--muted);
      padding:10px 12px; text-align:left; font-weight:700; border-bottom:1px solid var(--line);
    }
    tbody td{
      background:#0f1f1b; color:var(--ink); padding:12px; vertical-align:top;
      border:1px solid var(--line);
    }
    tbody tr{ box-shadow:0 8px 16px rgba(0,0,0,.25) }
    tbody td:first-child{ border-top-left-radius:14px; border-bottom-left-radius:14px }
    tbody td:last-child{ border-top-right-radius:14px; border-bottom-right-radius:14px }

    .row-actions{ display:flex; gap:8px; flex-wrap:wrap }
    .row-actions .btn{ padding:8px 10px; height:auto }
    .row-note{ white-space:pre-wrap }

    @media (max-width:760px){
      thead{ display:none }
      table, tbody, tr, td{ display:block; width:100% }
      tbody tr{ margin-bottom:12px }
      tbody td{ border-radius:14px !important }
      .label{ display:block; font-size:12px; color:var(--muted); margin-bottom:4px }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="topbar">
      <h1>Date Plans</h1>
    </div>

    <div class="controls">
      <input id="in-date" type="date" title="date">
      <input id="in-type" type="text" class="grow" placeholder="type (movie, dinner, game nightâ€¦)" />
      <textarea id="in-notes" class="grow" placeholder="notes (where, what you watched/played, moments, etc.)"></textarea>
      <button class="btn green" id="btn-add">Add</button>
    </div>

    <div class="listwrap">
      <table>
        <thead>
          <tr>
            <th style="min-width:120px">date</th>
            <th style="min-width:180px">type</th>
            <th>notes</th>
            <th style="min-width:210px">actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

<script>
/* ========== helpers ========== */
const $ = s => document.querySelector(s);
const rowsEl = $('#rows');

function localYYYYMMDD(d=new Date()){
  const tz = d.getTimezoneOffset()*60000;
  return new Date(d - tz).toISOString().slice(0,10);
}
$('#in-date').value = localYYYYMMDD(new Date());

function toast(msg){
  const t = document.createElement('div');
  t.textContent = msg;
  Object.assign(t.style, {
    position:'fixed', left:'50%', top:'10px', transform:'translateX(-50%)',
    background:'#000', color:'#fff', padding:'10px 14px', borderRadius:'10px',
    fontFamily:'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial',
    zIndex:9999, opacity:.94
  });
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), 1600);
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}

/* ========== Supabase init (your creds) ========== */
const SUPABASE_URL  = "https://tmjozxcjylcxgemffnoc.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const TABLE = 'date_plans';

/* ========== CRUD ========== */
async function fetchAll(){
  const { data, error } = await sb.from(TABLE)
    .select('*')
    .order('date', { ascending:false })
    .order('created_at', { ascending:false });
  if (error){ console.error(error); toast('load failed'); return; }
  render(data || []);
}

async function addRow(){
  const date  = $('#in-date').value;
  const type  = $('#in-type').value.trim();
  const notes = $('#in-notes').value.trim();
  if (!date || !type){ toast('need date + type'); return; }

  const { error } = await sb.from(TABLE).insert({ date, type, notes });
  if (error){ console.error(error); toast('add failed'); return; }

  $('#in-notes').value = '';
  toast('added');
}

async function saveRow(id, fields){
  const { error } = await sb.from(TABLE).update(fields).eq('id', id);
  if (error){ console.error(error); toast('save failed'); return; }
  toast('saved');
}

async function deleteRow(id){
  const ok = confirm('delete this plan?');
  if (!ok) return;
  const { error } = await sb.from(TABLE).delete().eq('id', id);
  if (error){ console.error(error); toast('delete failed'); return; }
  toast('deleted');
}

/* ========== render ========== */
function render(list){
  rowsEl.innerHTML = '';
  for (const r of list){
    const tr = document.createElement('tr');

    const tdDate = document.createElement('td');
    const tdType = document.createElement('td');
    const tdNote = document.createElement('td');
    const tdAct  = document.createElement('td');

    tdDate.innerHTML = `
      <span class="label">date</span>
      <input type="date" value="${r.date ?? ''}" data-field="date" disabled
             style="width:160px;background:#101d19;color:#eaf7f1;border:1px solid #22332d">
    `;
    tdType.innerHTML = `
      <span class="label">type</span>
      <input type="text" value="${escapeHtml(r.type||'')}" data-field="type" disabled class="grow"
             style="background:#101d19;color:#eaf7f1;border:1px solid #22332d">
    `;
    tdNote.innerHTML = `
      <span class="label">notes</span>
      <textarea data-field="notes" disabled class="row-note"
                style="background:#101d19;color:#eaf7f1;border:1px solid #22332d">${escapeHtml(r.notes||'')}</textarea>
    `;
    tdAct.innerHTML = `
      <div class="row-actions">
        <button class="btn green" data-act="edit">Edit</button>
        <button class="btn" data-act="save" disabled>Save</button>
        <button class="btn danger" data-act="delete">Delete</button>
      </div>
    `;

    tr.append(tdDate, tdType, tdNote, tdAct);
    rowsEl.appendChild(tr);

    const inputs   = tr.querySelectorAll('[data-field]');
    const btnEdit  = tr.querySelector('[data-act="edit"]');
    const btnSave  = tr.querySelector('[data-act="save"]');
    const btnDel   = tr.querySelector('[data-act="delete"]');

    const pristine = { date: r.date ?? '', type: r.type ?? '', notes: r.notes ?? '' };

    function setEditing(on){
      inputs.forEach(i => i.disabled = !on);
      btnSave.disabled = !on;
      btnEdit.disabled = on;
    }

    btnEdit.addEventListener('click', ()=> setEditing(true));

    btnSave.addEventListener('click', async ()=>{
      const payload = {};
      inputs.forEach(i => payload[i.dataset.field] = i.value);
      await saveRow(r.id, payload);
      pristine.date = payload.date; pristine.type = payload.type; pristine.notes = payload.notes;
      setEditing(false);
    });

    btnDel.addEventListener('click', ()=> deleteRow(r.id));
  }
}

/* ========== keyboard: arrow nav + enter-to-add ========== */
const fields = [$('#in-date'), $('#in-type'), $('#in-notes'), $('#btn-add')];

function idxOf(el){ return fields.indexOf(el); }
function focusAt(i){
  const n = ((i % fields.length) + fields.length) % fields.length;
  fields[n]?.focus();
}

function handleArrowNav(e){
  const el = e.target;
  const idx = idxOf(el);
  if (idx === -1) return;

  // DATE: Left/Right move focus, Up/Down keep native date adjust
  if (el.id === 'in-date'){
    if (e.key === 'ArrowLeft'){ e.preventDefault(); focusAt(idx-1); }
    if (e.key === 'ArrowRight'){ e.preventDefault(); focusAt(idx+1); }
    return;
  }

  // TYPE: move on edges only
  if (el.id === 'in-type'){
    const pos = el.selectionStart ?? 0;
    const atStart = pos === 0;
    const atEnd = pos === el.value.length;
    if ((e.key === 'ArrowLeft' || e.key === 'ArrowUp') && atStart){ e.preventDefault(); focusAt(idx-1); }
    if ((e.key === 'ArrowRight' || e.key === 'ArrowDown') && atEnd){ e.preventDefault(); focusAt(idx+1); }
    return;
  }

  // NOTES: only vertical edge nav so left/right still edit text
  if (el.id === 'in-notes'){
    const pos = el.selectionStart ?? 0;
    const atStart = pos === 0;
    const atEnd = pos === el.value.length;
    if (e.key === 'ArrowUp' && atStart){ e.preventDefault(); focusAt(idx-1); }
    if (e.key === 'ArrowDown' && atEnd){ e.preventDefault(); focusAt(idx+1); }
    return;
  }
}

fields.forEach(el => el.addEventListener('keydown', handleArrowNav));

// Enter to Add: Enter in date/type; Ctrl+Enter in notes; Enter on button works by default
fields.forEach(el => el.addEventListener('keydown', (e)=>{
  if (e.key !== 'Enter') return;
  if (el.id === 'in-notes' && !e.ctrlKey) return; // allow normal newline
  e.preventDefault();
  addRow();
}));

/* ========== events + realtime ========== */
$('#btn-add').addEventListener('click', addRow);

// realtime updates
sb.channel('public:'+TABLE)
  .on('postgres_changes', { event:'*', schema:'public', table:TABLE }, fetchAll)
  .subscribe();

/* start */
fetchAll();
</script>
</body>
</html>
