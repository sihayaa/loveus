<script>
(function(){
  // --- config ---
  const PASSCODE='123';
  const STORAGE_KEY='scrapbook_edits_v1';
  const EMOJIS=("🎮,👾,🕹️,🖥️,⌨️,💞,🩷,🧡,💛,💚,💙,🩵,🤎,🖤,🩶,🤍,💋,💯,💢,🏜️,🏝️,✈️,♾️,🍎,🍏,🍞,🥐,🥖,🫓,🥨,🥯,🥞,🧇,🧀,🍖,🍗,🥩,🥓,🍔,🍟,🍕,🌭,🥪,🌮,🌯,🫔,🥙,🧆,🥚,🍳,🥘,🫕,🥣,🥗,🍿,🧈,🧂,🥫,🍝,🍐,🍑,🍒,🍦,🍧,🍨,🍩,🍪,🎂,🍰,🧁,🥧,🍫,🍬,🍭,🍮,🍯").split(",");

  const stage=document.getElementById('stage');
  const book =document.getElementById('book');
  if(!stage || !book) return;

  // --- minimal editor styles (injected) ---
  const css = `
  .sb-toast{position:absolute;top:12px;right:12px;z-index:95;background:#11172f;color:#fff;border:2px solid #67e4ca;padding:8px 12px;border-radius:10px;display:none}
  body.sb-editing .stf__block, body.sb-editing .stf__item, body.sb-editing .stf__wrapper{pointer-events:none!important}
  body.sb-editing .sb-canvas, body.sb-editing .sb-item{pointer-events:auto!important}
  .sb-canvas.active{outline:3px dashed #7a5af8; outline-offset:-12px}

  .sb-toolbar{position:absolute;left:50%;bottom:14px;transform:translateX(-50%);display:none;z-index:60;background:rgba(255,255,255,.92);border:2px solid #e8dcc6;border-radius:14px;padding:10px;gap:8px;box-shadow:0 10px 22px rgba(0,0,0,.25);align-items:center;flex-wrap:wrap}
  .sb-toolbar button{border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700;color:#fff;background:#7a5af8}
  .sb-toolbar .sec{background:#5d47d4}.sb-toolbar .mint{background:#67e4ca;color:#022d2c}.sb-toolbar .warn{background:#ff9aa2;color:#4c0a17}

  .sb-item{position:absolute;user-select:none;transform-origin:center}
  .sb-text{background:transparent;border:0;padding:0;color:inherit;font:inherit;white-space:pre-wrap}
  .sb-text[contenteditable="true"]{outline:none}
  .sb-img{display:block;max-width:100%;max-height:100%;border:0;pointer-events:none}
  body.sb-editing .sb-img{border:6px solid #fff;border-radius:8px;box-shadow:4px 6px 18px rgba(0,0,0,.25)}
  body.sb-editing .sb-item.selected{box-shadow:0 0 0 3px #7a5af8}
  body.sb-editing .sb-item .sb-res{display:block;position:absolute;right:-6px;bottom:-6px;width:16px;height:16px;border-radius:4px;background:#67e4ca;border:2px solid #0b2c28;cursor:nwse-resize}
  .sb-res{display:none}
  .sb-rot{display:none;position:absolute;left:50%;top:-18px;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;background:#fff;border:3px solid #7a5af8;box-shadow:0 2px 8px rgba(0,0,0,.25);cursor:grab}
  body.sb-editing .sb-rot{display:block}
  .sb-modal{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:70;background:rgba(0,0,0,.55)}
  .sb-modal.open{display:flex}
  .sb-card{width:min(96%,560px);background:#151a30;color:#fff;border:2px solid #67e4ca;border-radius:14px;padding:16px;box-shadow:0 20px 40px rgba(0,0,0,.45)}
  .sb-card h3{margin:0 0 10px;font-size:20px}
  .sb-card textarea{width:100%;background:#0f1430;color:#fff;border:1px solid #2b3258;border-radius:10px;padding:10px 12px;font-family:inherit;font-size:20px;resize:vertical}
  .sb-actions{margin-top:12px;display:flex;justify-content:flex-end;gap:8px}
  .sb-actions button{border:0;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .sb-btn-mint{background:#67e4ca;color:#05201f}.sb-btn-ghost{background:#2a315d;color:#fff}
  .sb-stickers{display:grid;grid-template-columns:repeat(8,1fr);gap:10px}
  .sb-stickers button{background:#0f1430;border:1px solid #2b3258;border-radius:10px;padding:8px;cursor:pointer}
  .sb-stickers img{width:100%;aspect-ratio:1;object-fit:contain}
  `;
  const style=document.createElement('style'); style.textContent=css; document.head.appendChild(style);

  // --- helper nodes ---
  const toast=document.createElement('div'); toast.className='sb-toast'; toast.id='sbToast'; toast.textContent='Edit mode unlocked ✨'; stage.appendChild(toast);

  // toolbar
  const tb=document.createElement('div'); tb.className='sb-toolbar'; tb.id='sbToolbar';
  tb.innerHTML=`
    <button id="sbLeft" class="sec">Edit Left</button>
    <button id="sbRight" class="sec">Edit Right</button>
    <button id="sbAddText" class="mint">Add Text</button>
    <button id="sbAddPhoto" class="sec">Add Photo</button>
    <button id="sbStickers" class="sec">Stickers</button>
    <button id="sbAddPage" class="sec">Add Page</button>
    <button id="sbDelete" class="warn">Delete Selected</button>
    <button id="sbClear" class="warn">Clear Page</button>
    <button id="sbSave" class="mint">Save</button>
  `;
  stage.appendChild(tb);
  const fileInput=document.createElement('input'); fileInput.type='file'; fileInput.accept='image/*'; fileInput.style.display='none'; stage.appendChild(fileInput);

  // text modal
  const textModal=document.createElement('div'); textModal.className='sb-modal'; textModal.innerHTML=`
    <div class="sb-card">
      <h3>Add Text</h3>
      <textarea id="sbTextArea" rows="5" placeholder="Write something sweet…"></textarea>
      <div class="sb-actions">
        <button class="sb-btn-ghost" id="sbTextCancel">Cancel</button>
        <button class="sb-btn-mint" id="sbTextOk">Add Text</button>
      </div>
    </div>`; stage.appendChild(textModal);

  // stickers modal
  const stickModal=document.createElement('div'); stickModal.className='sb-modal'; stickModal.innerHTML=`
    <div class="sb-card">
      <h3>Pick a sticker</h3>
      <div class="sb-stickers" id="sbStickerGrid"></div>
      <div class="sb-actions"><button class="sb-btn-ghost" id="sbStickClose">Close</button></div>
    </div>`; stage.appendChild(stickModal);

  // --- state ---
  let editing=false, selected=null, activeCanvas=null;

  // canvases marker (class only; doesn’t change your DOM)
  function markCanvases(){
    document.querySelectorAll('#book .page .page-canvas').forEach(c=>c.classList.add('sb-canvas'));
  }
  markCanvases();

  // choose visible left/right
  function getVisibleCanvases(){
    const left  = document.querySelector('.stf__item--left  .page .page-canvas');
    const right = document.querySelector('.stf__item--right .page .page-canvas');
    if(left || right) return {left,right};
    // fallback (single page view)
    const canvases=[...document.querySelectorAll('#book .page .page-canvas')];
    return {left:null, right:canvases[0]||null};
  }
  function setActive(side){
    const {left,right}=getVisibleCanvases();
    const next = side==='left'? left : right;
    if(!next) return;
    document.querySelectorAll('.sb-canvas').forEach(c=>c.classList.remove('active'));
    next.classList.add('active'); activeCanvas=next;
  }

  // enter/exit
  function showToast(msg){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1200); }
  function enterEdit(){
    if(editing) return; editing=true;
    document.body.classList.add('sb-editing'); tb.style.display='flex';
    setActive('right'); showToast('Edit mode unlocked ✨');
  }
  function exitEdit(){
    editing=false; selected=null; document.body.classList.remove('sb-editing'); tb.style.display='none';
    document.querySelectorAll('.sb-canvas').forEach(c=>c.classList.remove('active'));
  }

  let keyBuf='', keyTimer=null;
  document.addEventListener('keydown', (e)=>{
    keyBuf+=e.key; clearTimeout(keyTimer); keyTimer=setTimeout(()=>keyBuf='',1200);
    if(keyBuf.endsWith(PASSCODE)){ keyBuf=''; enterEdit(); }
  });

  // dragging / resizing / rotating
  function makeDraggable(el){
    let sx=0,sy=0,ox=0,oy=0, resizing=false, sw=0,sh=0, rotating=false, sa=0, spa=0;
    const res=el.querySelector('.sb-res'); let rot=el.querySelector('.sb-rot'); if(!rot){ rot=document.createElement('div'); rot.className='sb-rot'; el.appendChild(rot); }

    function getAngle(){ return parseFloat(el.dataset.rot||'0')||0; }
    function setAngle(d){ el.dataset.rot=d; el.style.transform=`rotate(${d}deg)`; }

    if(res){
      res.addEventListener('mousedown', (e)=>{ if(!editing) return; e.stopPropagation(); e.preventDefault();
        resizing=true; sx=e.clientX; sy=e.clientY; sw=el.offsetWidth; sh=el.offsetHeight;
        document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp);
      });
    }
    rot.addEventListener('mousedown', (e)=>{ if(!editing) return; e.stopPropagation(); e.preventDefault();
      rotating=true; const r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
      spa=Math.atan2(e.clientY-cy, e.clientX-cx); sa=getAngle();
      document.addEventListener('mousemove', onRotate); document.addEventListener('mouseup', endRotate);
    });
    function onRotate(e){
      if(!rotating) return; const r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
      const a=Math.atan2(e.clientY-cy, e.clientX-cx); setAngle(sa + (a-spa)*180/Math.PI);
    }
    function endRotate(){ rotating=false; document.removeEventListener('mousemove', onRotate); document.removeEventListener('mouseup', endRotate); }

    el.addEventListener('mousedown', (e)=>{ if(!editing) return;
      if(e.target.classList.contains('sb-res') || e.target.classList.contains('sb-rot')) return;
      selected?.classList.remove('selected'); selected=el; el.classList.add('selected');
      sx=e.clientX; sy=e.clientY; ox=el.offsetLeft; oy=el.offsetTop;
      document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp); e.stopPropagation();
    });
    function onMove(e){
      if(!editing) return;
      if(resizing){ const dx=e.clientX-sx, dy=e.clientY-sy; el.style.width=Math.max(60,sw+dx)+'px'; el.style.height=Math.max(60,sh+dy)+'px'; }
      else{ const dx=e.clientX-sx, dy=e.clientY-sy; el.style.left=(ox+dx)+'px'; el.style.top=(oy+dy)+'px'; }
    }
    function onUp(){ document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); }
  }
  document.addEventListener('click', (e)=>{ if(editing && !e.target.closest('.sb-item')){ selected?.classList.remove('selected'); selected=null; }});

  // add text/photo/sticker
  function addText(val){
    const box=document.createElement('div'); box.className='sb-item'; box.style.left='40px'; box.style.top='40px'; box.style.width='260px';
    const isEd = document.body.classList.contains('sb-editing');
    box.innerHTML=`<div class="sb-text" contenteditable="${isEd?'true':'false'}">${val}</div><div class="sb-res"></div><div class="sb-rot"></div>`;
    (activeCanvas||getVisibleCanvases().right).appendChild(box); makeDraggable(box);
  }
  function addPhoto(dataUrl){
    const box=document.createElement('div'); box.className='sb-item'; box.style.left='90px'; box.style.top='90px'; box.style.width='320px'; box.style.height='230px';
    box.innerHTML=`<img class="sb-img" src="${dataUrl}" alt=""><div class="sb-res"></div><div class="sb-rot"></div>`;
    (activeCanvas||getVisibleCanvases().right).appendChild(box); makeDraggable(box);
  }
  function emojiUrl(ch){
    const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect width='100%' height='100%' fill='white'/><text x='50%' y='55%' font-size='160' text-anchor='middle' dominant-baseline='middle'>${ch}</text></svg>`;
    return "data:image/svg+xml;utf8,"+encodeURIComponent(svg);
  }

  // UI wiring
  tb.querySelector('#sbLeft').onclick = ()=> setActive('left');
  tb.querySelector('#sbRight').onclick= ()=> setActive('right');

  tb.querySelector('#sbAddText').onclick= ()=>{
    textModal.classList.add('open'); setTimeout(()=>document.getElementById('sbTextArea').focus(),10);
  };
  textModal.querySelector('#sbTextCancel').onclick= ()=> textModal.classList.remove('open');
  textModal.querySelector('#sbTextOk').onclick= ()=>{
    const v=document.getElementById('sbTextArea').value.trim(); textModal.classList.remove('open'); if(v) addText(v);
  };

  tb.querySelector('#sbAddPhoto').onclick= ()=> fileInput.click();
  fileInput.onchange = (e)=>{
    const f=e.target.files[0]; if(!f) return; const r=new FileReader();
    r.onload = ev=>{ addPhoto(ev.target.result); fileInput.value=''; }; r.readAsDataURL(f);
  };

  tb.querySelector('#sbStickers').onclick = ()=>{
    const grid=stickModal.querySelector('#sbStickerGrid'); grid.innerHTML='';
    EMOJIS.forEach(ch=>{
      const b=document.createElement('button'); const img=document.createElement('img'); img.src=emojiUrl(ch); img.alt=ch;
      b.appendChild(img); b.onclick=()=>{ addPhoto(emojiUrl(ch)); };
      grid.appendChild(b);
    });
    stickModal.classList.add('open');
  };
  stickModal.querySelector('#sbStickClose').onclick= ()=> stickModal.classList.remove('open');

  tb.querySelector('#sbAddPage').onclick = ()=>{
    const p=document.createElement('div'); p.className='page';
    const c=document.createElement('div'); c.className='page-canvas sb-canvas'; p.appendChild(c);
    book.appendChild(p);
    // If PageFlip is present, reload pages:
    try{ if(window.St && book._pageFlipInstance){ book._pageFlipInstance.loadFromHTML(document.querySelectorAll('#book .page')); } }catch(_){}
    showToast('Page added');
  };

  tb.querySelector('#sbDelete').onclick = ()=>{ if(selected){ selected.remove(); selected=null; } };
  tb.querySelector('#sbClear').onclick  = ()=>{ (activeCanvas||getVisibleCanvases().right).innerHTML=''; };

  tb.querySelector('#sbSave').onclick = ()=>{
    const pages=[...document.querySelectorAll('#book .page .page-canvas')].map(c=>c.innerHTML);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(pages));
    showToast('Saved ✓ Exiting…'); setTimeout(()=>exitEdit(),300);
  };

  // load saved
  (function applySaved(){
    try{
      const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return;
      const arr=JSON.parse(raw);
      const canvases=document.querySelectorAll('#book .page .page-canvas');
      for(let i=0;i<Math.min(arr.length,canvases.length);i++){ canvases[i].innerHTML=arr[i]; }
      document.querySelectorAll('#book .sb-item').forEach(makeDraggable);
    }catch(_){}
  })();

  // block tap-to-flip so you can click to edit; drag still flips
  let tapStart=null;
  function isTap(d,t){ return d<8 && t<300; }
  book.addEventListener('pointerdown',(e)=>{ tapStart={x:e.clientX,y:e.clientY,t:Date.now()}; }, true);
  book.addEventListener('pointerup',  (e)=>{ if(!tapStart) return; const d=Math.hypot(e.clientX-tapStart.x, e.clientY-tapStart.y); const dt=Date.now()-tapStart.t; if(isTap(d,dt)){ e.preventDefault(); e.stopPropagation(); } tapStart=null; }, true);
  book.addEventListener('click',      (e)=>{ e.preventDefault(); e.stopPropagation(); }, true);
})();
</script>
