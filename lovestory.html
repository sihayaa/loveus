<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Our Scrapbook Story</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:,">
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0f2f; --paper:#f7eddc; --ink:#0d2a6b;
  --accent:#7a5af8; --mint:#67e4ca; --font:"Dancing Script", cursive;
  --cover-y:28%;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--ink);
  display:flex; align-items:center; justify-content:center; overflow:hidden;
  font-family:var(--font);
}

/* Stage & Book */
#stage{ width:1000px; height:650px; position:relative; }
#book { position:absolute; inset:0; }
body.editing #stage{ touch-action:none; } /* no rubber-banding while dragging */

/* Pages */
.page{
  width:100%; height:100%; position:relative; overflow:hidden;
  background:var(--paper); box-shadow: inset 0 0 60px rgba(0,0,0,.22);
}
.page-canvas{
  position:relative; width:100%; height:100%; padding:28px;
  color:var(--ink); font-size:22px; line-height:1.35;
}

/* COVER (fixed) */
.page.cover{ box-shadow:0 8px 28px rgba(0,0,0,.35); }
.page.cover .page-canvas{
  padding:0; background:#0c102c;
  background-image:
    url("./lovestory_cover.png?v=8"),
    url("https://raw.githubusercontent.com/sihayaa/loveus/main/lovestory_cover.png"),
    url("https://raw.githubusercontent.com/sihayaa/loveus/HEAD/lovestory_cover.png");
  background-size:cover; background-position:50% var(--cover-y); background-repeat:no-repeat;
}

/* Scrap items */
.scrap-item{
  position:absolute; transform-origin:center; touch-action:none;
  overflow:visible; /* keep knobs clickable even outside the box */
}
.scrap-item.selected{ box-shadow:0 0 0 3px var(--accent); }
.resizer{ display:none; }
.rotator{
  display:none; position:absolute; left:50%; top:-18px; transform:translate(-50%,-50%);
  width:18px; height:18px; border-radius:50%; background:#fff; border:3px solid var(--accent);
  box-shadow:0 2px 8px rgba(0,0,0,.25); cursor:grab; z-index:999; pointer-events:auto;
}
.mover{
  display:none; position:absolute; left:-10px; top:-10px;
  width:18px; height:18px; border-radius:50%; background:#fff; border:3px solid var(--accent);
  box-shadow:0 2px 8px rgba(0,0,0,.25); cursor:grab;
}
body.editing .scrap-item{ cursor:move; }
body.editing .scrap-item .resizer{
  display:block; position:absolute; right:-6px; bottom:-6px; width:16px; height:16px;
  border-radius:4px; background:var(--mint); border:2px solid #0b2c28; cursor:nwse-resize;
}
body.editing .scrap-item .rotator{ display:block; }
body.editing .scrap-item .mover{ display:block; }

/* Images */
.scrap-img{ display:block; width:100%; height:100%; object-fit:contain; pointer-events:none; user-select:none; }
.scrap-item[data-fit="cover"] .scrap-img{ object-fit:cover; }

/* Text (auto grows; no scrollbars) */
.scrap-text{
  display:block; width:100%; background:transparent; border:0; color:inherit; font:inherit;
  white-space:pre-wrap; overflow:visible; min-height:1.2em;
}
.scrap-text.sticker{ display:flex; align-items:center; justify-content:center; line-height:1; }

/* Sidebar toolbar (hidden until 123) */
#toolbar{
  position:fixed; right:16px; top:50%; transform:translateY(-50%);
  z-index:100; background:#fff; border:2px solid #e8dcc6; border-radius:14px; padding:12px;
  width:240px; gap:10px; box-shadow:0 10px 22px rgba(0,0,0,.25);
  display:none; flex-direction:column; align-items:stretch;
}
#toolbar.open{ display:flex; }
#toolbar .group{ display:flex; gap:8px; flex-wrap:wrap; }
#toolbar button{
  border:0; padding:8px 12px; border-radius:8px; cursor:pointer;
  font-weight:700; color:#fff; background:var(--accent); width:100%;
}
#toolbar button.secondary{ background:#5d47d4; }
#toolbar button.mint{ background:var(--mint); color:#022d2c; }
#toolbar button.warn{ background:#ff9aa2; color:#4c0a17; }
#toolbar input[type="number"]{
  width:100%; padding:8px; border-radius:8px; border:2px solid #e8dcc6; font-weight:700; color:#0d2a6b; background:#fff;
}
#fileInput{ display:none; }

/* allow events to pass while editing */
body.editing .page .page-canvas,
body.editing .scrap-item { pointer-events:auto; }

#toast{
  position:absolute; top:12px; right:12px; z-index:95;
  background:#11172f; color:#fff; border:2px solid var(--mint);
  padding:8px 12px; border-radius:10px; display:none;
}
.page-canvas.active-side{ outline:3px dashed var(--accent); outline-offset:-12px; }

/* Modals */
.modal{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; z-index:70; background:rgba(0,0,0,.55); }
.modal.open{ display:flex; }
.modal-card{ width:min(96%,560px); background:#151a30; color:#fff; border:2px solid var(--mint); border-radius:14px; padding:16px; box-shadow:0 20px 40px rgba(0,0,0,.45); }
.modal-card h3{ margin:0 0 10px; font-size:20px; }
#textModal textarea{ width:100%; background:#0f1430; color:#fff; border:1px solid #2b3258; border-radius:10px; padding:10px 12px; font-family:var(--font); font-size:20px; resize:vertical; }
.modal-actions{ margin-top:12px; display:flex; justify-content:flex-end; gap:8px; }
.modal-actions button{ border:0; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700; }
.btn-mint{ background:var(--mint); color:#05201f; }
.btn-ghost{ background:#2a315d; color:#fff; }

/* Stickers grid */
.stickers{ display:grid; grid-template-columns:repeat(8,1fr); gap:10px; }
.stickers button{ background:#0f1430; border:1px solid #2b3258; border-radius:10px; padding:8px; cursor:pointer; font-size:26px; line-height:1; }

/* Per-item HUD */
#itemHud{
  position:absolute; z-index:120; display:none;
  background:#151a30; color:#fff; border:2px solid var(--mint);
  border-radius:10px; padding:6px; gap:6px; box-shadow:0 12px 24px rgba(0,0,0,.35);
  align-items:center; flex-wrap:wrap;
}
#itemHud button{
  border:0; padding:6px 8px; border-radius:8px; cursor:pointer;
  font-weight:700; font-size:12px; color:#fff; background:#5d47d4;
}
#itemHud button.warn{ background:#ff9aa2; color:#4c0a17; }
#itemHud button.mint{ background:var(--mint); color:#022d2c; }
#itemHud input[type="number"]{
  width:70px; padding:6px 8px; border-radius:8px; border:2px solid #2b3258;
  background:#0f1430; color:#fff; font-weight:700; font-size:12px;
}
</style>
</head>
<body>

<div id="stage">
  <div id="book">
    <!-- COVER -->
    <div class="page cover"><div class="page-canvas"></div></div>

    <!-- Inner pages -->
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
  </div>

  <!-- Right toolbar -->
  <div id="toolbar">
    <div class="group">
      <button id="targetLeft" class="secondary">Edit Left</button>
      <button id="targetRight" class="secondary">Edit Right</button>
    </div>
    <div class="group">
      <button id="addTextBtn" class="mint">Add Text</button>
      <button id="addPhotoBtn" class="secondary">Add Photo</button>
      <button id="stickersBtn" class="secondary">Stickers</button>
      <button id="addPageBtn" class="secondary">Add Page</button>
    </div>
    <div class="group">
      <label for="fontSizeInput" style="font-weight:700;color:#0d2a6b;">Text Size (px)</label>
      <input id="fontSizeInput" type="number" min="8" max="200" step="1" placeholder="px" list="fontSizes" disabled>
      <datalist id="fontSizes">
        <option value="12"></option><option value="14"></option><option value="16"></option>
        <option value="18"></option><option value="20"></option><option value="22"></option>
        <option value="24"></option><option value="28"></option><option value="36"></option>
        <option value="48"></option><option value="72"></option>
      </datalist>
    </div>
    <div class="group">
      <button id="fitToggleBtn"  class="secondary">Fit: Contain</button>
      <button id="lockToggleBtn" class="secondary">Lock: On</button>
    </div>
    <div class="group">
      <button id="deleteSelectedBtn" class="warn">Delete Selected</button>
      <button id="clearPageBtn" class="warn">Clear Page</button>
      <button id="saveBtn" class="mint">Save</button>
    </div>
    <input id="fileInput" type="file" accept="image/*" />
  </div>

  <!-- Text modal -->
  <div id="textModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3 id="textModalTitle">Add Text</h3>
      <textarea id="textInput" rows="5" placeholder="Write something sweet…"></textarea>
      <div class="modal-actions">
        <button class="btn-ghost" id="textCancel">Cancel</button>
        <button class="btn-mint" id="textAdd">Add Text</button>
      </div>
    </div>
  </div>

  <!-- Stickers modal -->
  <div id="stickerModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>Pick a sticker</h3>
      <div class="stickers" id="stickersGrid"></div>
      <div class="modal-actions">
        <button class="btn-ghost" id="stickersClose">Close</button>
      </div>
    </div>
  </div>

  <!-- Per-item HUD -->
  <div id="itemHud" aria-hidden="true">
    <button id="hudEdit"  class="mint only-text">Edit</button>
    <input  id="hudFont"  class="only-text" type="number" min="8" max="200" step="1" placeholder="size">
    <button id="hudFit"   class="only-img">Fit: Contain</button>
    <button id="hudLock"  class="only-img">Lock: On</button>

    <!-- rotation controls -->
    <button id="hudRotL" title="Rotate left 5°">↺ 5°</button>
    <input  id="hudRot"  type="number" step="1" style="width:70px" placeholder="deg">
    <button id="hudRotR" title="Rotate right 5°">↻ 5°</button>

    <button id="hudDup">Duplicate</button>
    <button id="hudFront">Front</button>
    <button id="hudBack">Back</button>
    <button id="hudDelete" class="warn">Delete</button>
  </div>

  <div id="toast">Edit mode unlocked ✨</div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script src="./flipbook/page-flip.browser.js"></script>
<script>
/* ========= Supabase ========= */
const SUPABASE_URL  = "https://tmjozxcjylcxgemffnoc.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
const TABLE_IMAGES="scrapbook_images";
const TABLE_STATE ="scrapbook_state";
const STATE_ID="main";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ========= Refs ========= */
const bookEl=document.getElementById('book');
const stageEl=document.getElementById('stage');
const toolbar=document.getElementById('toolbar');
const toast=document.getElementById('toast');
const fileInput=document.getElementById('fileInput');

const textModal=document.getElementById('textModal');
const textModalTitle=document.getElementById('textModalTitle');
const textInput=document.getElementById('textInput');
const textAddBtn=document.getElementById('textAdd');
const textCancel=document.getElementById('textCancel');

const stickersGrid=document.getElementById('stickersGrid');
const stickerModal=document.getElementById('stickerModal');
const stickersClose=document.getElementById('stickersClose');

const fontSizeInput=document.getElementById('fontSizeInput');
const fitBtn=document.getElementById('fitToggleBtn');
const lockBtn=document.getElementById('lockToggleBtn');

const itemHud   = document.getElementById('itemHud');
const hudEdit   = document.getElementById('hudEdit');
const hudFont   = document.getElementById('hudFont');
const hudFit    = document.getElementById('hudFit');
const hudLock   = document.getElementById('hudLock');
const hudDup    = document.getElementById('hudDup');
const hudFront  = document.getElementById('hudFront');
const hudBack   = document.getElementById('hudBack');
const hudDelete = document.getElementById('hudDelete');

/* NEW: rotation HUD refs */
const hudRot   = document.getElementById('hudRot');
const hudRotL  = document.getElementById('hudRotL');
const hudRotR  = document.getElementById('hudRotR');

let pageFlip=null, activeCanvas=null, selectedItem=null, lastPageIndex=0;
let zCounter = 10; // simple z-index counter for Front/Back

/* ========= PageFlip ========= */
function initFlip(startIndex=0){
  try{ pageFlip?.destroy(); }catch(_){}
  pageFlip = new St.PageFlip(bookEl,{
    width:500,height:650,size:"fixed",showCover:true,drawShadow:true,
    flippingTime:800,maxShadowOpacity:0.25,useMouseEvents:true,
    mobileScrollSupport:false,startPage:startIndex
  });
  pageFlip.loadFromHTML(document.querySelectorAll('#book .page'));
  pageFlip.on('flip', ()=>{
    if(!document.body.classList.contains('editing')) return;
    const {left,right}=getVisibleCanvases();
    highlightCanvas((activeCanvas===left||activeCanvas===right)?activeCanvas:(right||left));
  });
}

/* ========= Init ========= */
init().catch(console.error);
async function init(){
  await loadFromTables();
  if (!window.St || !St.PageFlip) alert("PageFlip library missing (./flipbook/page-flip.browser.js).");
  initFlip(0);
}

/* ========= Target left/right ========= */
function getVisibleCanvases(){
  const pr=stageEl.getBoundingClientRect();
  const all=[...document.querySelectorAll('#book .page .page-canvas')].map(el=>{
    const r=el.getBoundingClientRect();
    const w=Math.max(0,Math.min(r.right,pr.right)-Math.max(r.left,pr.left));
    const h=Math.max(0,Math.min(r.bottom,pr.bottom)-Math.max(r.top,pr.top));
    return {el,area:w*h,cx:r.left+r.width/2};
  }).filter(x=>x.area>1000).sort((a,b)=>b.area-a.area);
  const top=all.slice(0,2).sort((a,b)=>a.cx-b.cx);
  return {left:top.length===2?top[0].el:null,right:top.length?top[top.length-1].el:null};
}
function highlightCanvas(canvas){
  if(!canvas){ toastShow('That side is not visible here.'); return; }
  document.querySelectorAll('.page-canvas').forEach(c=>c.classList.remove('active-side'));
  canvas.classList.add('active-side'); activeCanvas=canvas;
}
stageEl.addEventListener('mousedown',e=>{
  if(!document.body.classList.contains('editing')) return;
  const pc=e.target.closest('.page-canvas'); if(pc) highlightCanvas(pc);
});
document.getElementById('targetLeft').onclick = ()=>{ const {left,right}=getVisibleCanvases(); highlightCanvas(left||right); };
document.getElementById('targetRight').onclick= ()=>{ const {left,right}=getVisibleCanvases(); highlightCanvas(right||left); };

/* ========= Secret Edit Mode (type 123) ========= */
const PASSCODE='123'; let keyBuffer='', keyTimer=null;
document.addEventListener('keydown',(e)=>{
  keyBuffer+=e.key; clearTimeout(keyTimer); keyTimer=setTimeout(()=>keyBuffer='',1200);
  if(keyBuffer.endsWith(PASSCODE)){ keyBuffer=''; enterEdit(); }
});
function setEditing(on){
  document.body.classList.toggle('editing', on);
  toolbar.classList.toggle('open', on);
  if(!on){ document.querySelectorAll('.page-canvas').forEach(c=>c.classList.remove('active-side')); activeCanvas=null; }
}

/* keep PageFlip; just disable gestures while editing */
function enterEdit(){
  setEditing(true);
  lastPageIndex = pageFlip?.getCurrentPageIndex?.() ?? 0;
  try{ pageFlip.update({ useMouseEvents:false, swipeDistance:10000 }); }catch(_){}
  document.querySelectorAll('#book .scrap-item').forEach(el=>{
    if(!el.dataset._hooked){ makeDraggable(el); el.dataset._hooked='1'; }
  });
  const { right, left } = getVisibleCanvases();
  highlightCanvas(right || left);
  toastShow('Edit mode unlocked ✨');
}
function exitEdit(){
  setEditing(false); deselect();
  try{
    pageFlip.turnToPage(lastPageIndex);
    pageFlip.update({ useMouseEvents:true, swipeDistance:30 });
  }catch(_){}
}

/* ========= Per-item HUD ========= */
function positionHud(){
  if(!selectedItem || itemHud.style.display==='none') return;
  const r=selectedItem.getBoundingClientRect(), sr=stageEl.getBoundingClientRect();
  const hudW=itemHud.offsetWidth, hudH=itemHud.offsetHeight;
  let x=r.right-sr.left-hudW, y=r.top-sr.top-hudH-8;
  x=Math.max(8,Math.min(x,sr.width-hudW-8)); if(y<8) y=r.bottom-sr.top+8;
  itemHud.style.left=x+'px'; itemHud.style.top=y+'px';
}
function getRotation(el){ return parseFloat(el?.dataset.rot || '0') || 0; }
function setRotation(el, deg){
  if(!el) return;
  el.dataset.rot = String(deg);
  el.style.transform = `rotate(${deg}deg)`;
  hudRot.value = Math.round(getRotation(el));
  positionHud();
}
function showItemHud(el){
  if(!el){ hideItemHud(); return; }
  const onImg=!!el.querySelector('.scrap-img');
  const onText=!!el.querySelector('.scrap-text:not(.sticker)');
  itemHud.querySelectorAll('.only-img').forEach(n=>n.style.display=onImg?'':'none');
  itemHud.querySelectorAll('.only-text').forEach(n=>n.style.display=onText?'':'none');
  if(onImg){
    const fit=el.dataset.fit||'contain', lock=el.dataset.lock==='1';
    hudFit.textContent='Fit: '+(fit==='cover'?'Fill':'Contain');
    hudLock.textContent='Lock: '+(lock?'On':'Off');
  }
  if(onText){
    const t=el.querySelector('.scrap-text');
    hudFont.value=Math.round(parseFloat(getComputedStyle(t).fontSize)||22);
  }
  hudRot.value = Math.round(getRotation(el));   /* show current deg */
  itemHud.style.display='flex'; requestAnimationFrame(positionHud);
}
function hideItemHud(){ itemHud.style.display='none'; }
window.addEventListener('resize', positionHud);
itemHud.addEventListener('mousedown', e=>e.stopPropagation());

/* ========= Drag / Resize / Rotate ========= */
function makeDraggable(el){
  let startX=0,startY=0,origX=0,origY=0,resizing=false,startW=0,startH=0;
  let rotating=false,startAngle=0,startPointerAngle=0;
  let dragging=false, dragPointerId=null;

  const res=el.querySelector('.resizer');
  let rot=el.querySelector('.rotator'); if(!rot){ rot=document.createElement('div'); rot.className='rotator'; el.appendChild(rot); }
  let mover=el.querySelector('.mover');   if(!mover){ mover=document.createElement('div'); mover.className='mover';   el.appendChild(mover); }

  const getAngle=()=>parseFloat(el.dataset.rot||'0')||0;
  const setAngle=(deg)=>{ el.dataset.rot=String(deg); el.style.transform=`rotate(${deg}deg)`; };

  el.addEventListener('dragstart', e=>e.preventDefault());

  if(res){
    res.addEventListener('mousedown',e=>{
      if(!document.body.classList.contains('editing')) return;
      e.stopPropagation(); e.preventDefault();
      resizing=true; startX=e.clientX; startY=e.clientY; startW=el.offsetWidth; startH=el.offsetHeight;
      document.addEventListener('mousemove',onMove); document.addEventListener('mouseup',onUp);
    });
  }
  function onMove(e){
    if(!resizing) return;
    const dx=e.clientX-startX, dy=e.clientY-startY;
    const hasImg=!!el.querySelector('.scrap-img');
    const lockOn=hasImg && el.dataset.lock==='1' && !e.shiftKey;
    const ratio=parseFloat(el.dataset.aspect || (el.offsetWidth/Math.max(1,el.offsetHeight)));
    let w=Math.max(60,startW+dx), h=Math.max(40,startH+dy);
    if(lockOn && ratio>0){ if(Math.abs(dx)>=Math.abs(dy)) h=Math.max(40,Math.round(w/ratio)); else w=Math.max(60,Math.round(h*ratio)); }
    el.style.width=w+'px'; el.style.height=h+'px';
    const t=el.querySelector('.scrap-text:not(.sticker)');
    if(t && !hasImg){ t.style.height='auto'; el.style.height=Math.max(40,t.scrollHeight)+'px'; }
    const st=el.querySelector('.scrap-text.sticker'); if(st){ st.style.fontSize=Math.round(0.64*Math.min(w,h))+'px'; }
    positionHud();
  }
  function onUp(){ document.removeEventListener('mousemove',onMove); document.removeEventListener('mouseup',onUp); resizing=false; }

  rot.addEventListener('mousedown',e=>{
    if(!document.body.classList.contains('editing')) return;
    e.stopPropagation(); e.preventDefault();
    rotating=true; const r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
    startPointerAngle=Math.atan2(e.clientY-cy,e.clientX-cx); startAngle=getAngle();
    document.addEventListener('mousemove',onRotate); document.addEventListener('mouseup',endRotate);
  });
  function onRotate(e){
    if(!rotating) return;
    const r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
    const a=Math.atan2(e.clientY-cy,e.clientX-cx);
    setAngle(startAngle + (a-startPointerAngle)*180/Math.PI);
    positionHud();
  }
  function endRotate(){ rotating=false; document.removeEventListener('mousemove',onRotate); document.removeEventListener('mouseup',endRotate); }

  el.addEventListener('pointerdown', e=>{
    if(!document.body.classList.contains('editing')) return;
    const isControl = e.target.classList.contains('resizer')||
                      e.target.classList.contains('rotator')||
                      e.target.classList.contains('mover');
    if(isControl) return;
    e.preventDefault(); e.stopPropagation();
    selectedItem?.classList.remove('selected'); selectedItem=el; el.classList.add('selected');
    updateToolbarState(); showItemHud(el);
    startDrag(e);
  });
  mover.addEventListener('pointerdown', e=>{
    if(!document.body.classList.contains('editing')) return;
    e.preventDefault(); e.stopPropagation();
    selectedItem?.classList.remove('selected'); selectedItem=el; el.classList.add('selected');
    updateToolbarState(); showItemHud(el);
    startDrag(e);
  });

  function startDrag(e){
    dragging=true;
    dragPointerId=e.pointerId ?? 'mouse';
    try{ if(e.pointerId!=null && el.setPointerCapture) el.setPointerCapture(e.pointerId);}catch{}
    startX=e.clientX; startY=e.clientY; origX=el.offsetLeft; origY=el.offsetTop;
    window.addEventListener('pointermove',onPointerMove);
    window.addEventListener('pointerup',onPointerUp);
    window.addEventListener('pointercancel',onPointerUp);
    el.addEventListener('lostpointercapture',onPointerUp);
  }
  function onPointerMove(e){
    if(!dragging) return;
    const dx=e.clientX-startX, dy=e.clientY-startY;
    el.style.left=(origX+dx)+'px'; el.style.top=(origY+dy)+'px';
    positionHud();
  }
  function onPointerUp(){
    if(!dragging) return;
    try{ if(dragPointerId!=null && el.releasePointerCapture) el.releasePointerCapture(dragPointerId);}catch{}
    dragging=false; dragPointerId=null;
    window.removeEventListener('pointermove',onPointerMove);
    window.removeEventListener('pointerup',onPointerUp);
    window.removeEventListener('pointercancel',onPointerUp);
    el.removeEventListener('lostpointercapture',onPointerUp);
  }

  const tnode=el.querySelector('.scrap-text:not(.sticker)'); if(tnode) enableAutoGrow(el,tnode);
}
function enableAutoGrow(box,textEl){
  const grow=()=>{ textEl.style.height='auto'; box.style.height=Math.max(40,textEl.scrollHeight)+'px'; positionHud(); };
  textEl.addEventListener('input',grow); new ResizeObserver(grow).observe(textEl); grow();
}

/* Selection */
document.addEventListener('click',e=>{
  if(!document.body.classList.contains('editing')) return;
  const onItem=e.target.closest('.scrap-item'), onBar=e.target.closest('#toolbar'), onHud=e.target.closest('#itemHud'), onModal=e.target.closest('.modal');
  if(!onItem && !onBar && !onHud && !onModal) deselect();
});
function deselect(){ selectedItem?.classList.remove('selected'); selectedItem=null; updateToolbarState(); hideItemHud(); }

/* Text modal */
let workingBox=null;
function openTextModalForAdd(){ workingBox=null; textModalTitle.textContent='Add Text'; textAddBtn.textContent='Add Text'; textInput.value=''; openModal(textModal); setTimeout(()=>textInput.focus(),10); }
function openTextModalForEdit(box){ workingBox=box; const t=box.querySelector('.scrap-text'); textModalTitle.textContent='Edit Text'; textAddBtn.textContent='Save'; textInput.value=t?t.textContent:''; openModal(textModal); setTimeout(()=>textInput.focus(),10); }

document.getElementById('addTextBtn').onclick=()=>openTextModalForAdd();
textCancel.onclick=()=>closeModal(textModal);
textAddBtn.onclick=()=>{
  const val=textInput.value;
  if(workingBox){
    const t=workingBox.querySelector('.scrap-text'); if(t){ t.textContent=val; t.style.height='auto'; workingBox.style.height=Math.max(40,t.scrollHeight)+'px'; }
    closeModal(textModal); showItemHud(workingBox); return;
  }
  const box=document.createElement('div');
  box.className='scrap-item'; box.style.left='40px'; box.style.top='40px'; box.style.width='320px';
  box.innerHTML=`<div class="scrap-text" contenteditable="false">${val.replace(/</g,"&lt;")}</div>
                 <div class="mover" title="Drag"></div>
                 <div class="resizer"></div><div class="rotator"></div>`;
  (activeCanvas||getVisibleCanvases().right).appendChild(box); makeDraggable(box); box.dataset._hooked='1';
  closeModal(textModal);
};
document.addEventListener('dblclick',e=>{
  if(!document.body.classList.contains('editing')) return;
  const t=e.target.closest('.scrap-text'); if(t && !t.classList.contains('sticker')){ const box=t.closest('.scrap-item'); if(box){ selectedItem=box; box.classList.add('selected'); updateToolbarState(); showItemHud(box); openTextModalForEdit(box); } }
});
document.addEventListener('keydown',e=>{
  if(!document.body.classList.contains('editing')) return;
  if(!selectedItem) return;
  const key=e.key.toLowerCase();
  if((key==='e'||key==='enter') && selectedItem.querySelector('.scrap-text:not(.sticker)')){ e.preventDefault(); openTextModalForEdit(selectedItem); }

  /* NEW: rotate with keyboard: [ / ]  (Shift = 1°) */
  const step = e.shiftKey ? 1 : 5;
  if (e.key === '[') { e.preventDefault(); setRotation(selectedItem, getRotation(selectedItem) - step); }
  if (e.key === ']') { e.preventDefault(); setRotation(selectedItem, getRotation(selectedItem) + step); }
});

/* Font size (sidebar + HUD) */
function selectedTextEl(){ if(!selectedItem) return null; const t=selectedItem.querySelector('.scrap-text'); return (t && !t.classList.contains('sticker'))?t:null; }
function updateFontInput(){
  const t=selectedTextEl(); if(!t){ fontSizeInput.disabled=true; fontSizeInput.value=''; fontSizeInput.placeholder='px'; return; }
  fontSizeInput.disabled=false; const curr=Math.round(parseFloat(getComputedStyle(t).fontSize)||22); fontSizeInput.value=curr; hudFont.value=curr;
}
fontSizeInput.addEventListener('input',()=>{
  const t=selectedTextEl(); if(!t) return; let v=parseInt(fontSizeInput.value,10); if(isNaN(v)) return;
  v=Math.max(8,Math.min(200,v)); t.style.fontSize=v+'px'; t.style.height='auto';
  const box=t.closest('.scrap-item'); if(box) box.style.height=Math.max(40,t.scrollHeight)+'px'; hudFont.value=v;
});
hudEdit.onclick = ()=>{ if(selectedItem?.querySelector('.scrap-text:not(.sticker)')) openTextModalForEdit(selectedItem); };
hudFont.addEventListener('input',()=>{
  const t=selectedTextEl(); if(!t) return; let v=parseInt(hudFont.value,10); if(isNaN(v)) return;
  v=Math.max(8,Math.min(200,v)); t.style.fontSize=v+'px'; t.style.height='auto';
  const box=t.closest('.scrap-item'); if(box) box.style.height=Math.max(40,t.scrollHeight)+'px'; fontSizeInput.value=v;
});

/* Image fit/lock */
function updateImageButtons(){
  const onImg=!!selectedItem?.querySelector('.scrap-img');
  fitBtn.disabled=!onImg; lockBtn.disabled=!onImg;
  if(onImg){ const fit=selectedItem.dataset.fit||'contain', lock=selectedItem.dataset.lock==='1';
    fitBtn.textContent='Fit: '+(fit==='cover'?'Fill':'Contain'); lockBtn.textContent='Lock: '+(lock?'On':'Off'); }
  else{ fitBtn.textContent='Fit: Contain'; lockBtn.textContent='Lock: On'; }
}
fitBtn.onclick=()=>{ if(!selectedItem?.querySelector('.scrap-img')) return; const cur=selectedItem.dataset.fit||'contain'; selectedItem.dataset.fit=(cur==='cover')?'contain':'cover'; updateImageButtons(); showItemHud(selectedItem); };
lockBtn.onclick=()=>{ if(!selectedItem?.querySelector('.scrap-img')) return; selectedItem.dataset.lock=(selectedItem.dataset.lock==='1')?'0':'1'; updateImageButtons(); showItemHud(selectedItem); };
function updateToolbarState(){ updateImageButtons(); updateFontInput(); }

/* HUD buttons */
hudRot.addEventListener('input', ()=>{
  if(!selectedItem) return;
  const v = parseFloat(hudRot.value);
  if (isNaN(v)) return;
  setRotation(selectedItem, v);
});
hudRotL.onclick = ()=>{ if(!selectedItem) return; setRotation(selectedItem, getRotation(selectedItem) - 5); };
hudRotR.onclick = ()=>{ if(!selectedItem) return; setRotation(selectedItem, getRotation(selectedItem) + 5); };

hudDup.onclick = ()=>{ if(!selectedItem) return; const clone=selectedItem.cloneNode(true); clone.style.left=(selectedItem.offsetLeft+16)+'px'; clone.style.top=(selectedItem.offsetTop+16)+'px'; selectedItem.parentElement.appendChild(clone); makeDraggable(clone); clone.dataset._hooked='1'; };
hudFront.onclick = ()=>{ if(selectedItem){ selectedItem.style.zIndex=++zCounter; } };
hudBack.onclick  = ()=>{ if(selectedItem){ selectedItem.style.zIndex=0; } };
hudDelete.onclick= ()=>{ if(selectedItem){ selectedItem.remove(); deselect(); } };

/* Photos & stickers */
document.getElementById('addPhotoBtn').onclick=()=>fileInput.click();
fileInput.addEventListener('change',async e=>{
  const f=e.target.files[0]; if(!f) return;
  const {mime,base64}=await compressToBase64(f,1600,0.85);
  const box=document.createElement('div');
  box.className='scrap-item'; box.style.left='90px'; box.style.top='90px'; box.style.width='320px'; box.style.height='230px';
  box.dataset.fit='contain'; box.dataset.lock='1';
  box.innerHTML=`<img class="scrap-img" alt="" src="data:${mime};base64,${base64}">
                 <div class="mover" title="Drag"></div>
                 <div class="resizer"></div><div class="rotator"></div>`;
  (activeCanvas||getVisibleCanvases().right).appendChild(box); makeDraggable(box); box.dataset._hooked='1';
  const imgEl=box.querySelector('.scrap-img');
  const setAspect=()=>{ if(imgEl.naturalWidth&&imgEl.naturalHeight){ box.dataset.aspect=(imgEl.naturalWidth/imgEl.naturalHeight).toFixed(5);} };
  if(imgEl.complete) setAspect(); else imgEl.addEventListener('load',setAspect);
  imgEl._preb64={mime,base64}; fileInput.value='';
});
const STICKERS_EMOJI=["🎮","👾","🕹️","🖥️","⌨️","💞","🩷","🧡","💛","💚","💙","🩵","🤎","🖤","🩶","🤍","💋","💯",
"💢","🏜️","🏝️","✈️","♾️","🍎","🍏","🍞","🥐","🥖","🫓","🥨","🥯","🥞","🧇","🧀","🍖","🍗","🥩","🥓",
"🍔","🍟","🍕","🌭","🥪","🌮","🌯","🫔","🥙","🧆","🥚","🍳","🥘","🫕","🥣","🥗","🍿","🧈","🧂","🥫",
"🍝","🍐","🍑","🍒","🍦","🍧","🍨","🍩","🍪","🎂","🍰","🧁","🥧","🍫","🍬","🍭","🍮","🍯"
];
document.getElementById('stickersBtn').onclick=()=>{
  stickersGrid.innerHTML='';
  STICKERS_EMOJI.forEach(ch=>{
    const b=document.createElement('button'); b.textContent=ch; b.title=ch;
    b.addEventListener('click',()=>{
      const box=document.createElement('div');
      box.className='scrap-item'; box.style.left='60px'; box.style.top='60px'; box.style.width='100px';
      box.innerHTML=`<div class="scrap-text sticker" style="font-size:64px;">${ch}</div>
                     <div class="mover" title="Drag"></div>
                     <div class="resizer"></div><div class="rotator"></div>`;
      (activeCanvas||getVisibleCanvases().right).appendChild(box); makeDraggable(box); box.dataset._hooked='1';
    });
    stickersGrid.appendChild(b);
  });
  openModal(stickerModal);
};
stickersClose.onclick=()=>closeModal(stickerModal);

/* Page tools */
document.getElementById('addPageBtn').onclick=()=>{
  const p=document.createElement('div'); p.className='page';
  const c=document.createElement('div'); c.className='page-canvas'; p.appendChild(c);
  bookEl.appendChild(p); toastShow('Page added');
};

/* Delete/Clear/Save */
document.getElementById('deleteSelectedBtn').onclick=()=>{ if(selectedItem){selectedItem.remove(); deselect();} };
document.getElementById('clearPageBtn').onclick=()=>{ (activeCanvas||getVisibleCanvases().right).innerHTML=''; deselect(); };

document.getElementById('saveBtn').onclick=()=>saveToTables().catch(e=>alert('Save failed: '+e));

async function saveToTables(){
  toastShow('Saving…');
  const imgs=[...document.querySelectorAll('#book .scrap-img')];
  for(const img of imgs){
    if(img.dataset.imgid) continue;
    let mime,base64;
    if(img._preb64){({mime,base64}=img._preb64);}
    else{ const r=await fetch(img.src); const b=await r.blob(); const enc=await compressToBase64(b,1600,0.85); mime=enc.mime; base64=enc.base64; }
    const {data,error}=await supabase.from(TABLE_IMAGES).insert([{content_type:mime,data_base64:base64}]).select('id').single();
    if(error) throw error; img.dataset.imgid=data.id; delete img._preb64;
  }
  const canvases=[...document.querySelectorAll('#book .page .page-canvas')];
  const pages=[];
  canvases.forEach(c=>{
    const items=[];
    c.querySelectorAll('.scrap-item').forEach(el=>{
      const style={left:el.style.left, top:el.style.top, width:el.style.width, height:el.style.height};
      const rot=parseFloat(el.dataset.rot||'0')||0;
      const img=el.querySelector('.scrap-img');
      if(img){ items.push({type:'image',style,rot,imageId:img.dataset.imgid||null,fit:el.dataset.fit||'contain',lock:el.dataset.lock==='1'}); }
      else{ const txt=el.querySelector('.scrap-text'); items.push({type:'text',style,rot,html:txt?txt.outerHTML:''}); }
    });
    pages.push({items});
  });
  const {error:upErr}=await supabase.from(TABLE_STATE).upsert({id:STATE_ID,pages}).select('id').single();
  if(upErr) throw upErr;
  toastShow('Saved ✓'); setTimeout(()=>exitEdit(),300);
}

/* Load from tables */
async function loadFromTables(){
  try{
    const {data:state}=await supabase.from(TABLE_STATE).select('pages').eq('id',STATE_ID).maybeSingle();
    if(!state||!state.pages) return;
    const have=document.querySelectorAll('#book .page').length-1, need=state.pages.length;
    for(let i=have;i<need;i++){ const p=document.createElement('div'); p.className='page'; p.innerHTML='<div class="page-canvas"></div>'; bookEl.appendChild(p); }
    const ids=[]; state.pages.forEach(pg=>pg.items?.forEach(it=>{ if(it.type==='image'&&it.imageId) ids.push(it.imageId); }));
    const uniq=[...new Set(ids)]; const urlMap={};
    if(uniq.length){ const {data:imgs}=await supabase.from(TABLE_IMAGES).select('id,content_type,data_base64').in('id',uniq);
      imgs?.forEach(r=>urlMap[r.id]=`data:${r.content_type};base64,${r.data_base64}`); }
    const canvases=[...document.querySelectorAll('#book .page .page-canvas')];
    for(let i=0;i<Math.min(state.pages.length,canvases.length);i++){
      const c=canvases[i]; c.innerHTML='';
      for(const it of state.pages[i].items||[]){
        const box=document.createElement('div'); box.className='scrap-item';
        box.style.left=it.style?.left||'40px'; box.style.top=it.style?.top||'40px';
        if(it.style?.width) box.style.width=it.style.width;
        if(it.style?.height) box.style.height=it.style.height;
        if(it.rot){ box.dataset.rot=it.rot; box.style.transform=`rotate(${it.rot}deg)`; }
        if(it.type==='image'&&it.imageId){
          const url=urlMap[it.imageId]||''; box.dataset.fit=it.fit||'contain'; box.dataset.lock=it.lock?'1':'0';
          box.innerHTML=`<img class="scrap-img" data-imgid="${it.imageId}" src="${url}" alt="">
                         <div class="mover" title="Drag"></div><div class="resizer"></div><div class="rotator"></div>`;
          const imgEl=box.querySelector('.scrap-img'); const setAspect=()=>{ if(imgEl.naturalWidth&&imgEl.naturalHeight){ box.dataset.aspect=(imgEl.naturalWidth/imgEl.naturalHeight).toFixed(5);} };
          if(imgEl.complete) setAspect(); else imgEl.addEventListener('load',setAspect);
        }else if(it.type==='text'&&it.html){
          const holder=document.createElement('div'); holder.innerHTML=it.html.trim();
          const inner=holder.firstElementChild||document.createElement('div'); inner.setAttribute('contenteditable','false'); box.appendChild(inner);
          box.insertAdjacentHTML('beforeend','<div class="mover" title="Drag"></div><div class="resizer"></div><div class="rotator"></div>');
        }
        c.appendChild(box); makeDraggable(box); box.dataset._hooked='1';
      }
    }
  }catch(e){ console.warn('No saved state yet / load error',e); }
}

/* Utils */
function openModal(el){ el.classList.add('open'); el.setAttribute('aria-hidden','false'); }
function closeModal(el){ el.classList.remove('open'); el.setAttribute('aria-hidden','true'); }
function toastShow(msg){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1200); }
document.querySelectorAll('#book .scrap-item').forEach(el=>{ makeDraggable(el); el.dataset._hooked='1'; });

// preserves transparency for PNG/WebP; uses JPEG for opaque photos
async function compressToBase64(fileOrBlob, maxSide = 1600, quality = 0.85, pageColor = '#f7eddc') {
  const blob = fileOrBlob instanceof Blob ? fileOrBlob : new Blob([fileOrBlob]);
  const inputMime = blob.type || 'image/png';

  // load image from a safe blob URL
  const img = await new Promise((res, rej) => {
    const i = new Image();
    i.onload = () => res(i);
    i.onerror = rej;
    i.src = URL.createObjectURL(blob);
  });

  // scale to fit maxSide
  let w = img.width, h = img.height;
  if (Math.max(w, h) > maxSide) {
    if (w > h) { h = Math.round(h * (maxSide / w)); w = maxSide; }
    else       { w = Math.round(w * (maxSide / h)); h = maxSide; }
  }

  const canvas = document.createElement('canvas');
  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext('2d');

  // keep alpha for PNG/WebP; use JPEG otherwise
  const wantsAlpha = /png|webp|gif/i.test(inputMime);

  if (!wantsAlpha) {
    // when exporting JPEG, paint your page color first to avoid “black” transparency
    ctx.fillStyle = pageColor;
    ctx.fillRect(0, 0, w, h);
  }

  ctx.drawImage(img, 0, 0, w, h);

  const outMime = wantsAlpha ? 'image/png' : 'image/jpeg';
  const dataUrl = canvas.toDataURL(outMime, wantsAlpha ? 1.0 : quality);

  URL.revokeObjectURL(img.src);
  return { mime: outMime, base64: dataUrl.split(',')[1] };
}

</script>
</body>
</html>
