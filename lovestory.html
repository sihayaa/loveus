<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Our Scrapbook Story</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:,">
<link href="https://fonts.googleapis.com/css2?family=Lobster&display=swap" rel="stylesheet">
<link rel="preload" as="image" href="./lovestory_cover.png?v=8" fetchpriority="high">

<style>
:root{
  --bg:#0b0f2f; --paper:#f7eddc; --ink:#0d2a6b;
  --accent:#7a5af8; --mint:#67e4ca;
  --font:"Lobster", cursive;
  --cover-y:28%;
  --cover-img:url("./lovestory_cover.png?v=8");
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--ink);
  display:flex; align-items:center; justify-content:center; overflow:hidden;
  font-family:var(--font);
}

/* Boot / status */
#boot{ position:fixed; inset:0; display:grid; place-items:center; background:#0b0f2f; color:#67e4ca; z-index:9999;
  font:600 18px/1.2 system-ui, Segoe UI, sans-serif; letter-spacing:.4px; transition:opacity .35s ease; }
#boot .card{ text-align:center; padding:18px 22px; border:2px solid #67e4ca55; border-radius:12px; box-shadow:0 12px 30px rgba(0,0,0,.35); max-width:520px; }
#boot.hide{ opacity:0; pointer-events:none; }
#retryBtn{ margin-top:10px; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:800; color:#022d2c; background:var(--mint); display:none; }

/* Stage & Book */
#stage{ width:1000px; height:650px; position:relative; }
#book { position:absolute; inset:0; visibility:hidden; will-change:transform; }

/* Pages */
.page{ width:100%; height:100%; position:relative; overflow:hidden; background:var(--paper); box-shadow: inset 0 0 60px rgba(0,0,0,.22); }
.page-canvas{ position:relative; z-index:2; width:100%; height:100%; padding:28px; color:var(--ink); font-size:22px; line-height:1.35;
  content-visibility:auto; contain-intrinsic-size:650px 500px; }

/* COVER */
.page.cover{ box-shadow:0 8px 28px rgba(0,0,0,.35); }
.page.cover .page-canvas{ padding:0; background:#0c102c; background-image:var(--cover-img);
  background-size:cover; background-position:50% var(--cover-y); background-repeat:no-repeat; }

/* Scrap items */
.scrap-item{ position:absolute; transform-origin:center; touch-action:none; overflow:visible; }
.scrap-item.selected{ box-shadow:0 0 0 3px var(--accent); }
.resizer{ display:none; }
.rotator{ display:none; position:absolute; left:50%; top:-18px; transform:translate(-50%,-50%); width:18px; height:18px; border-radius:50%;
  background:#fff; border:3px solid var(--accent); box-shadow:0 2px 8px rgba(0,0,0,.25); cursor:grab; z-index:999; pointer-events:auto; }
.mover{ display:none; position:absolute; left:-10px; top:-10px; width:18px; height:18px; border-radius:50%; background:#fff; border:3px solid {--accent};
  box-shadow:0 2px 8px rgba(0,0,0,.25); cursor:grab; }

/* Images & text */
.scrap-img{ display:block; width:100%; height:100%; object-fit:contain; pointer-events:none; user-select:none; }
.scrap-item[data-fit="cover"] .scrap-img{ object-fit:cover; }
.scrap-text{ display:block; width:100%; background:transparent; border:0; color:inherit; font:inherit; white-space:pre-wrap; overflow:visible; min-height:1.2em; }

/* Toolbar */
#toolbar{ position:fixed; right:16px; top:50%; transform:translateY(-50%); z-index:100; background:#fff; border:2px solid #e8dcc6; border-radius:14px; padding:12px;
  width:260px; gap:10px; box-shadow:0 10px 22px rgba(0,0,0,.25); display:none; flex-direction:column; align-items:stretch; }
#toolbar.open{ display:flex; }
#toolbar .group{ display:flex; gap:8px; flex-wrap:wrap; }
#toolbar button{ border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; color:#fff; background:var(--accent); width:100%; }
#toolbar button.secondary{ background:#5d47d4; }
#toolbar button.mint{ background:var(--mint); color:#022d2c; }
#toolbar button.warn{ background:#ff9aa2; color:#4c0a17; }
#toolbar input[type="number"]{ width:100%; padding:8px; border-radius:8px; border:2px solid #e8dcc6; font-weight:700; color:#0d2a6b; background:#fff; }
#fileInput{ display:none; }
#toolbar input[type="color"]{ width:100%; height:40px; padding:0; border:2px solid #e8dcc6; border-radius:8px; background:#fff; }

/* pointer gating: off by default so PageFlip can capture; on in edit mode */
.page .page-canvas, .scrap-item { pointer-events:none; }
body.editing .page .page-canvas, body.editing .scrap-item { pointer-events:auto; }
body.editing .scrap-item{ cursor:move; }
body.editing .scrap-item .resizer{ display:block; position:absolute; right:-6px; bottom:-6px; width:16px; height:16px; border-radius:4px;
  background:var(--mint); border:2px solid #0b2c28; cursor:nwse-resize; }
body.editing .scrap-item .rotator{ display:block; }
body.editing .scrap-item .mover{ display:block; }

#toast{ position:absolute; top:12px; right:12px; z-index:95; background:#11172f; color:#fff; border:2px solid var(--mint); padding:8px 12px; border-radius:10px; display:none; }
.page-canvas.active-side{ outline:3px dashed var(--accent); outline-offset:-12px; }

/* HUD */
#itemHud{ position:absolute; z-index:120; display:none; background:#151a30; color:#fff; border:2px solid #fff2; border-radius:10px; padding:6px; gap:6px;
  box-shadow:0 12px 24px rgba(0,0,0,.35); align-items:center; flex-wrap:wrap; }
#itemHud button{ border:0; padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:700; font-size:12px; color:#fff; background:#5d47d4; }
#itemHud button.warn{ background:#ff9aa2; color:#4c0a17; }
#itemHud button.mint{ background:var(--mint); color:#022d2c; }
#itemHud input[type="number"]{ width:70px; padding:6px 8px; border-radius:8px; border:2px solid #2b3258; background:#0f1430; color:#fff; font-weight:700; font-size:12px; }

/* Big Text Editor Modal */
#textEditor{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:10000;align-items:center;justify-content:center}
#textEditor.open{display:flex}
#textEditor .panel{width:min(820px,90vw);background:#fff;border-radius:16px;padding:18px;border:2px solid #e8dcc6;box-shadow:0 20px 60px rgba(0,0,0,.5)}
#textEditor textarea{width:100%;height:320px;font:28px/1.35 var(--font);color:var(--ink);padding:12px;border:2px solid #e8dcc6;border-radius:12px;resize:vertical}
#textEditor .row{display:flex;gap:12px;margin-top:10px}
#textEditor input[type="number"]{flex:1;padding:10px;border-radius:10px;border:2px solid #e8dcc6;font-weight:700;color:#0d2a6b}
#textEditor input[type="color"]{width:80px;height:44px;border-radius:10px;border:2px solid #e8dcc6}
#textEditor .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
#textEditor button{border:0;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer}
#editorCancel{background:#ff9aa2;color:#4c0a17}
#editorSave{background:var(--mint);color:#022d2c}
</style>
</head>
<body>

<div id="boot">
  <div class="card">
    <div id="bootMsg">loading scrapbook…</div>
    <button id="retryBtn">Try again</button>
  </div>
</div>

<div id="stage">
  <div id="book">
    <div class="page cover"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
  </div>

  <!-- Right toolbar -->
  <div id="toolbar">
    <div class="group">
      <button id="targetLeft" class="secondary">Edit Left</button>
      <button id="targetRight" class="secondary">Edit Right</button>
    </div>
    <div class="group">
      <button id="exitEditBtn" class="secondary">Done Editing</button>
      <button id="closeBookBtn" class="secondary">Close Book</button>
      <button id="removeSheetBtn" class="warn">Remove Last Sheet</button>
    </div>
    <div class="group">
      <button id="addTextBtn" class="mint">Add Text</button>
      <button id="addPhotoBtn" class="secondary">Add Photo</button>
    </div>
    <div class="group">
      <label for="fontSizeInput" style="font-weight:700;color:#0d2a6b;">Text Size (px)</label>
      <input id="fontSizeInput" type="number" min="8" max="200" step="1" placeholder="px" disabled>
    </div>
    <div class="group">
      <label for="fontColorInput" style="font-weight:700;color:#0d2a6b;">Text Color</label>
      <input id="fontColorInput" type="color" value="#0d2a6b" disabled>
    </div>
    <div class="group">
      <button id="fitToggleBtn"  class="secondary">Fit: Contain</button>
      <button id="lockToggleBtn" class="secondary">Lock: On</button>
    </div>
    <div class="group">
      <button id="deleteSelectedBtn" class="warn">Delete Selected</button>
      <button id="clearPageBtn" class="warn">Clear Page</button>
      <button id="saveBtn" class="mint">Save</button>
    </div>
    <input id="fileInput" type="file" accept="image/*" />
  </div>

  <!-- HUD -->
  <div id="itemHud" aria-hidden="true">
    <button id="hudEdit"  class="mint only-text">Edit</button>
    <input  id="hudFont"  class="only-text" type="number" min="8" max="200" step="1" placeholder="size">
    <button id="hudFit"   class="only-img">Fit: Contain</button>
    <button id="hudLock"  class="only-img">Lock: On</button>
    <button id="hudRotL" title="Rotate left 5°">↺ 5°</button>
    <input  id="hudRot"  type="number" step="1" style="width:70px" placeholder="deg">
    <button id="hudRotR" title="Rotate right 5°">↻ 5°</button>
    <button id="hudDup">Duplicate</button>
    <button id="hudFront">Front</button>
    <button id="hudBack">Back</button>
    <button id="hudDelete" class="warn">Delete</button>
  </div>

  <!-- Big Text Editor -->
  <div id="textEditor" aria-hidden="true">
    <div class="panel">
      <h3 style="margin:0 0 8px;color:#0d2a6b">Edit Text</h3>
      <textarea id="editorInput" placeholder="type here…"></textarea>
      <div class="row">
        <label style="font-weight:700;color:#0d2a6b;display:flex;align-items:center;gap:8px;">
          Size (px)
          <input id="editorSize" type="number" min="8" max="200" step="1" value="28">
        </label>
        <label style="font-weight:700;color:#0d2a6b;display:flex;align-items:center;gap:8px;">
          Color
          <input id="editorColor" type="color" value="#0d2a6b">
        </label>
      </div>
      <div class="actions">
        <button id="editorCancel">Cancel</button>
        <button id="editorSave">Save</button>
      </div>
    </div>
  </div>

  <div id="toast">Edit mode unlocked ✨</div>
</div>

<script src="./flipbook/page-flip.browser.js"></script>

<script>
/* ========= Supabase (REST) ========= */
const SUPABASE_URL  = "https://tmjozxcjylcxgemffnoc.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
const TABLE_IMAGES="scrapbook_images";
const TABLE_STATE ="scrapbook_state";
const STATE_ID="main";
const CLOUD_ONLY = true;
const IMG_CHUNK  = 20;

const sbHeaders = {
  "apikey": SUPABASE_ANON,
  "Authorization": "Bearer " + SUPABASE_ANON,
  "Content-Type": "application/json",
  "Accept": "application/json"
};

/* ========= Refs ========= */
const bookEl   = document.getElementById('book');
const stageEl  = document.getElementById('stage');
const toolbar  = document.getElementById('toolbar');
const toast    = document.getElementById('toast');
const fileInput= document.getElementById('fileInput');
const boot     = document.getElementById('boot');
const bootMsg  = document.getElementById('bootMsg');
const retryBtn = document.getElementById('retryBtn');

const fontSizeInput=document.getElementById('fontSizeInput');
const fitBtn=document.getElementById('fitToggleBtn');
const lockBtn=document.getElementById('lockToggleBtn');
const fontColorInput=document.getElementById('fontColorInput');

const itemHud   = document.getElementById('itemHud');
const hudEdit   = document.getElementById('hudEdit');
const hudFont   = document.getElementById('hudFont');
const hudFit    = document.getElementById('hudFit');
const hudLock   = document.getElementById('hudLock');
const hudDup    = document.getElementById('hudDup');
const hudFront  = document.getElementById('hudFront');
const hudBack   = document.getElementById('hudBack');
const hudDelete = document.getElementById('hudDelete');
const hudRot    = document.getElementById('hudRot');
const hudRotL   = document.getElementById('hudRotL');
const hudRotR   = document.getElementById('hudRotR');

let pageFlip=null, activeCanvas=null, selectedItem=null, lastPageIndex=0;
let zCounter = 10;

/* ========= Utils ========= */
const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
function isPageEmpty(p){ return (p?.querySelectorAll('.scrap-item').length||0)===0; }
function ensureTrailingBlankSheets(nSheets=2){
  const all=[...document.querySelectorAll('#book .page')];
  const inner = all.slice(1);
  let trailing=0;
  for(let i=inner.length-1; i>=0; i--){
    if(isPageEmpty(inner[i])) trailing++; else break;
  }
  const needPages = Math.max(0, nSheets*2 - trailing);
  for(let k=0;k<needPages;k++){
    const p=document.createElement('div'); p.className='page';
    p.innerHTML='<div class="page-canvas"></div>';
    bookEl.appendChild(p);
  }
}
function afterBootShow(){ bookEl.style.visibility='visible'; }
function toastShow(msg){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1800); }

/* ========= Flip init ========= */
function initFlip(startIndex=0){
  try{ pageFlip?.destroy?.(); }catch(_){}
  if(!window.St || !St.PageFlip){ alert("PageFlip library missing."); afterBootShow(); return; }
  const pgCount = document.querySelectorAll('#book .page').length;
  if (pgCount < 2) {
    const p=document.createElement('div'); p.className='page'; p.innerHTML='<div class="page-canvas"></div>';
    bookEl.appendChild(p);
  }
  pageFlip = new St.PageFlip(bookEl,{
    width:500,height:650,size:"fixed",showCover:true,
    drawShadow:true, flippingTime:800,maxShadowOpacity:0.25,useMouseEvents:true,
    mobileScrollSupport:false,startPage:Math.max(0,startIndex|0)
  });
  pageFlip.loadFromHTML(document.querySelectorAll('#book .page'));
  pageFlip.on('flip', ()=>{
    if(!document.body.classList.contains('editing')) return;
    const {left,right}=getVisibleCanvases();
    highlightCanvas((activeCanvas===left||activeCanvas===right)?activeCanvas:(right||left));
  });
}

/* ========= ID helpers ========= */
const isUUID = s => typeof s === 'string' &&
  /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(s);

/* resolve legacy numeric ids → real UUIDs (by scanning ids only) */
async function resolveLegacyNumericToUUID(legacyList){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE_IMAGES}?select=id`, { headers: sbHeaders });
  if(!res.ok) throw new Error('id scan ' + res.status);
  const rows = await res.json();
  const all = rows.map(r => String(r.id));
  const map = {};
  legacyList.map(String).forEach(num => {
    const hit = all.find(uid => uid.startsWith(num + '-'));
    if (hit) map[num] = hit;
  });
  return map;
}

/* robust UUID fetch with auto-bisect on 400 */
async function fetchImageRowsUUID(list){
  if (list.length === 0) return [];
  const quoted = list.map(v => `"${v}"`).join(',');
  const url = `${SUPABASE_URL}/rest/v1/${TABLE_IMAGES}?select=id,content_type,data_base64&id=in.(${quoted})`;
  const res = await fetch(url, { headers: sbHeaders });
  if (res.ok) return res.json();
  if (res.status !== 400 || list.length === 1) throw new Error('images load ' + res.status);
  const mid = Math.floor(list.length/2);
  const left  = await fetchImageRowsUUID(list.slice(0, mid));
  const right = await fetchImageRowsUUID(list.slice(mid));
  return left.concat(right);
}

/* ========= Init / Cloud load ========= */
init().catch(err=>console.error(err));
async function init(){
  const coverReady = new Promise(res=>{ const i=new Image(); i.onload=i.onerror=res; i.src="./lovestory_cover.png?v=8"; });
  await Promise.allSettled([coverReady]);

  bootMsg.textContent = 'Loading pages…';
  retryBtn.style.display='none';

  try{
    // 1) Load state row
    const stateUrl = `${SUPABASE_URL}/rest/v1/${TABLE_STATE}?select=pages&id=eq.${encodeURIComponent(STATE_ID)}&limit=1`;
    const stateRes = await fetch(stateUrl, { headers: sbHeaders });
    if(!stateRes.ok) throw new Error('state load '+stateRes.status);
    const stateArr = await stateRes.json();
    const state = stateArr && stateArr[0];
    const pages = state?.pages || [];

    // 2) Ensure enough page nodes
    const have=document.querySelectorAll('#book .page').length-1;
    const need=pages.length;
    for(let i=have;i<need;i++){
      const p=document.createElement('div'); p.className='page'; p.innerHTML='<div class="page-canvas"></div>'; bookEl.appendChild(p);
    }

    // 3) Collect IDs (UUIDs + resolve legacy numeric)
    const uuidIds=[], legacyNumeric=[], badIds=[];
    pages.forEach(pg=>pg.items?.forEach(it=>{
      if(it.type==='image'){
        if(isUUID(it.imageId)) uuidIds.push(it.imageId);
        else if (typeof it.imageId==='number' || /^[0-9]+$/.test(String(it.imageId||''))) legacyNumeric.push(it.imageId);
        else if (it.imageId!=null) badIds.push(it.imageId);
      }
    }));

    let legacyMap = {};
    if (legacyNumeric.length){
      try{
        legacyMap = await resolveLegacyNumericToUUID(legacyNumeric);
        uuidIds.push(...Object.values(legacyMap));
      }catch(e){ console.warn('Legacy id resolution failed:', e); }
    }
    if(badIds.length){ console.warn('Skipping invalid imageId(s):', badIds); }

    // 3b) fetch in chunks
    const urlMap={};
    for(let i=0;i<uuidIds.length;i+=IMG_CHUNK){
      const rows = await fetchImageRowsUUID(uuidIds.slice(i,i+IMG_CHUNK));
      rows.forEach(r=>{ urlMap[r.id]=`data:${r.content_type};base64,${r.data_base64}`; });
      bootMsg.textContent = `Loading photos ${Math.min(i+1,uuidIds.length)}–${Math.min(i+IMG_CHUNK,uuidIds.length)} of ${uuidIds.length}…`;
    }

    // 4) Render
    let missingCount=0;
    const canvases=[...document.querySelectorAll('#book .page .page-canvas')];
    for(let j=0;j<Math.min(pages.length,canvases.length);j++){
      const c=canvases[j]; c.innerHTML='';
      const items=pages[j].items||[];
      for(const it of items){
        const box=document.createElement('div'); box.className='scrap-item';
        if(it.style?.left)  box.style.left=it.style.left;
        if(it.style?.top)   box.style.top=it.style.top;
        if(it.style?.width) box.style.width=it.style.width;
        if(it.style?.height)box.style.height=it.style.height;
        if(it.rot){ box.dataset.rot=it.rot; box.style.transform=`rotate(${it.rot}deg)`; }

        if(it.type==='image'){
          let imgId = isUUID(it.imageId) ? it.imageId : (legacyMap[String(it.imageId)] || null);
          if(!imgId){ missingCount++; continue; }
          const url=urlMap[imgId];
          if(!url){ missingCount++; continue; }
          box.dataset.fit=it.fit||'contain'; box.dataset.lock=it.lock?'1':'0';
          box.innerHTML=`<img class="scrap-img" data-imgid="${imgId}" src="${url}" alt="" decoding="async">
                         <div class="mover" title="Drag"></div><div class="resizer"></div><div class="rotator"></div>`;
          const imgEl=box.querySelector('.scrap-img');
          const setAspect=()=>{ if(imgEl.naturalWidth&&imgEl.naturalHeight){ box.dataset.aspect=(imgEl.naturalWidth/imgEl.naturalHeight).toFixed(5);} };
          if(imgEl.complete) setAspect(); else imgEl.addEventListener('load',setAspect);
        }else if(it.type==='text'&&it.html){
          const holder=document.createElement('div'); holder.innerHTML=(it.html||'').trim();
          const inner=holder.firstElementChild||document.createElement('div'); inner.setAttribute('contenteditable','false'); box.appendChild(inner);
          box.insertAdjacentHTML('beforeend','<div class="mover" title="Drag"></div><div class="resizer"></div><div class="rotator"></div>');
        }
        c.appendChild(box); makeDraggable(box); box.dataset._hooked='1';
      }
    }

    ensureTrailingBlankSheets(2);
    afterBootShow();
    initFlip(0);

    if(missingCount){ toastShow(`${missingCount} photo${missingCount>1?'s':''} couldn’t load (old refs)`); }
    if(Object.keys(legacyMap).length){ toastShow(`Legacy images restored — press Save to clean`); }

    boot.classList.add('hide'); setTimeout(()=>{ try{boot.remove();}catch(_){} },400);
  }catch(err){
    console.warn('Cloud load failed:', err);
    if (CLOUD_ONLY){
      bootMsg.textContent = "Couldn’t reach the cloud. Please check your internet and try again.";
      retryBtn.style.display='inline-block';
      retryBtn.onclick=()=>{ location.reload(); };
      throw err;
    } else {
      afterBootShow(); initFlip(0);
    }
  }
}

/* ========= Target left/right ========= */
function getVisibleCanvases(){
  const pr=stageEl.getBoundingClientRect();
  const all=[...document.querySelectorAll('#book .page .page-canvas')].map(el=>{
    const r=el.getBoundingClientRect();
    const w=Math.max(0,Math.min(r.right,pr.right)-Math.max(r.left,pr.left));
    const h=Math.max(0,Math.min(r.bottom,pr.bottom)-Math.max(r.top,pr.top));
    return {el,area:w*h,cx:r.left+r.width/2};
  }).filter(x=>x.area>1000).sort((a,b)=>b.area-a.area);
  const top=all.slice(0,2).sort((a,b)=>a.cx-b.cx);
  return {left:top.length===2?top[0].el:null,right:top.length?top[top.length-1].el:null};
}
function highlightCanvas(canvas){
  if(!canvas){ toastShow('That side is not visible here.'); return; }
  document.querySelectorAll('.page-canvas').forEach(c=>c.classList.remove('active-side'));
  canvas.classList.add('active-side'); activeCanvas=canvas;
}
stageEl.addEventListener('mousedown',e=>{
  if(!document.body.classList.contains('editing')) return;
  const pc=e.target.closest('.page-canvas'); if(pc) highlightCanvas(pc);
});
document.getElementById('targetLeft').onclick = ()=>{ const v=getVisibleCanvases(); highlightCanvas(v.left||v.right); };
document.getElementById('targetRight').onclick= ()=>{ const v=getVisibleCanvases(); highlightCanvas(v.right||v.left); };

/* ========= Secret Edit Mode (type 123) ========= */
const PASSCODE='123'; let keyBuffer='', keyTimer=null;
document.addEventListener('keydown',(e)=>{
  keyBuffer+=e.key; clearTimeout(keyTimer); keyTimer=setTimeout(()=>keyBuffer='',1200);
  if(keyBuffer.endsWith(PASSCODE)){ keyBuffer=''; enterEdit(); }
});
function setEditing(on){
  document.body.classList.toggle('editing', on);
  toolbar.classList.toggle('open', on);
  if(!on){ document.querySelectorAll('.page-canvas').forEach(c=>c.classList.remove('active-side')); activeCanvas=null; }
}
function enterEdit(){
  setEditing(true);
  lastPageIndex = pageFlip?.getCurrentPageIndex?.() ?? 0;
  try{ pageFlip?.update?.({ useMouseEvents:false, swipeDistance:10000 }); }catch(_){}
  // make all existing items draggable
  document.querySelectorAll('#book .scrap-item').forEach(el=>{
    if(!el.dataset._hooked){ makeDraggable(el); el.dataset._hooked='1'; }
  });
  const v = getVisibleCanvases();
  highlightCanvas(v.right || v.left);
  toastShow('Edit mode unlocked ✨');
}
function exitEdit(){
  setEditing(false); deselect();
  try{
    pageFlip?.turnToPage?.(lastPageIndex);
    pageFlip?.update?.({ useMouseEvents:true, swipeDistance:30 });
  }catch(_){}
}
document.getElementById('exitEditBtn').onclick = ()=> exitEdit();
document.getElementById('closeBookBtn').onclick = ()=>{
  exitEdit();
  try{
    const total = pageFlip?.getPageCount?.() ?? 1;
    const curr  = pageFlip?.getCurrentPageIndex?.() ?? 0;
    const mid   = Math.floor(total/2);
    pageFlip?.turnToPage?.(curr <= mid ? 0 : total - 1);
  }catch(_){}
};
document.getElementById('removeSheetBtn').onclick = ()=>{
  const pages = [...document.querySelectorAll('#book .page')];
  if (pages.length <= 2){ toastShow('No sheet to remove.'); return; }
  const inner = pages.slice(1);
  const last = inner[inner.length-1];
  const prev = inner[inner.length-2];
  const empty = (p)=> (p?.querySelectorAll('.scrap-item').length||0)===0;
  if (!empty(last) || !empty(prev)){ toastShow('Last sheet has content.'); return; }
  const curr = pageFlip?.getCurrentPageIndex?.() ?? 0;
  last.remove(); prev.remove();
  const newIndex = Math.max(0, Math.min(curr, document.querySelectorAll('#book .page').length - 1));
  initFlip(newIndex);
  toastShow('Removed last sheet ✓');
};

/* ========= HUD / drag / resize / rotate ========= */
function positionHud(){
  if(!selectedItem || itemHud.style.display==='none') return;
  const r=selectedItem.getBoundingClientRect(), sr=stageEl.getBoundingClientRect();
  const hudW=itemHud.offsetWidth, hudH=itemHud.offsetHeight;
  let x=r.right-sr.left-hudW, y=r.top-sr.top-hudH-8;
  x=Math.max(8,Math.min(x,sr.width-hudW-8)); if(y<8) y=r.bottom-sr.top+8;
  itemHud.style.left=x+'px'; itemHud.style.top=y+'px';
}
function getRotation(el){ return parseFloat(el?.dataset.rot || '0') || 0; }
function setRotation(el,deg){
  if(!el) return; el.dataset.rot=String(deg); el.style.transform=`rotate(${deg}deg)`; hudRot.value=Math.round(getRotation(el)); positionHud();
}
function showItemHud(el){
  if(!el){ hideItemHud(); return; }
  const onImg=!!el.querySelector('.scrap-img');
  const onText=!!el.querySelector('.scrap-text');
  itemHud.querySelectorAll('.only-img').forEach(n=>n.style.display=onImg?'':'none');
  itemHud.querySelectorAll('.only-text').forEach(n=>n.style.display=onText?'':'none');
  if(onImg){
    const fit=el.dataset.fit||'contain', lock=el.dataset.lock==='1';
    hudFit.textContent='Fit: '+(fit==='cover'?'Fill':'Contain');
    hudLock.textContent='Lock: '+(lock?'On':'Off');
  }
  if(onText){
    const t=el.querySelector('.scrap-text');
    hudFont.value=Math.round(parseFloat(getComputedStyle(t).fontSize)||22);
  }
  hudRot.value=Math.round(getRotation(el));
  itemHud.style.display='flex'; requestAnimationFrame(positionHud);
}
function hideItemHud(){ itemHud.style.display='none'; }
window.addEventListener('resize', positionHud);
itemHud.addEventListener('mousedown', e=>e.stopPropagation());

function makeDraggable(el){
  let startX=0,startY=0,origX=0,origY=0,resizing=false,startW=0,startH=0;
  let rotating=false,startAngle=0,startPointerAngle=0;
  let dragging=false, dragPointerId=null;

  const res=el.querySelector('.resizer');
  let rot=el.querySelector('.rotator'); if(!rot){ rot=document.createElement('div'); rot.className='rotator'; el.appendChild(rot); }
  let mover=el.querySelector('.mover'); if(!mover){ mover=document.createElement('div'); mover.className='mover'; el.appendChild(mover); }

  el.addEventListener('dragstart', e=>e.preventDefault());

  if(res){
    res.addEventListener('mousedown',e=>{
      if(!document.body.classList.contains('editing')) return;
      e.stopPropagation(); e.preventDefault();
      resizing=true; startX=e.clientX; startY=e.clientY; startW=el.offsetWidth; startH=el.offsetHeight;
      document.addEventListener('mousemove',onMove); document.addEventListener('mouseup',onUp);
    });
  }
  function onMove(e){
    if(!resizing) return;
    const dx=e.clientX-startX, dy=e.clientY-startY;
    const hasImg=!!el.querySelector('.scrap-img');
    const lockOn=hasImg && el.dataset.lock==='1' && !e.shiftKey;
    const ratio=parseFloat(el.dataset.aspect || (el.offsetWidth/Math.max(1,el.offsetHeight)));
    let w=Math.max(60,startW+dx), h=Math.max(40,startH+dy);
    if(lockOn && ratio>0){ if(Math.abs(dx)>=Math.abs(dy)) h=Math.max(40,Math.round(w/ratio)); else w=Math.max(60,Math.round(h*ratio)); }
    el.style.width=w+'px'; el.style.height=h+'px';
    const t=el.querySelector('.scrap-text'); if(t && !hasImg){ t.style.height='auto'; el.style.height=Math.max(40,t.scrollHeight)+'px'; }
    positionHud();
  }
  function onUp(){ document.removeEventListener('mousemove',onMove); document.removeEventListener('mouseup',onUp); resizing=false; }

  rot.addEventListener('mousedown',e=>{
    if(!document.body.classList.contains('editing')) return;
    e.stopPropagation(); e.preventDefault();
    rotating=true; const r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
    startPointerAngle=Math.atan2(e.clientY-cy,e.clientX-cx); startAngle=getRotation(el);
    document.addEventListener('mousemove',onRotate); document.addEventListener('mouseup',endRotate);
  });
  function onRotate(e){
    if(!rotating) return;
    const r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
    const a=Math.atan2(e.clientY-cy,e.clientX-cx);
    setRotation(el, startAngle+(a-startPointerAngle)*180/Math.PI);
    positionHud();
  }
  function endRotate(){ rotating=false; document.removeEventListener('mousemove',onRotate); document.removeEventListener('mouseup',endRotate); }

  el.addEventListener('pointerdown', e=>{
    if(!document.body.classList.contains('editing')) return;
    const isControl = e.target.classList.contains('resizer')||e.target.classList.contains('rotator')||e.target.classList.contains('mover');
    if(isControl) return;
    e.preventDefault(); e.stopPropagation();
    selectedItem?.classList.remove('selected'); selectedItem=el; el.classList.add('selected');
    updateToolbarState(); showItemHud(el);
    startDrag(e);
  });
  mover.addEventListener('pointerdown', e=>{
    if(!document.body.classList.contains('editing')) return;
    e.preventDefault(); e.stopPropagation();
    selectedItem?.classList.remove('selected'); selectedItem=el; el.classList.add('selected');
    updateToolbarState(); showItemHud(el);
    startDrag(e);
  });

  function startDrag(e){
    dragging=true; dragPointerId=e.pointerId ?? 'mouse';
    try{ if(e.pointerId!=null && el.setPointerCapture) el.setPointerCapture(e.pointerId);}catch(_){}
    startX=e.clientX; startY=e.clientY; origX=el.offsetLeft; origY=el.offsetTop;
    window.addEventListener('pointermove',onPointerMove);
    window.addEventListener('pointerup',onPointerUp);
    window.addEventListener('pointercancel',onPointerUp);
    el.addEventListener('lostpointercapture',onPointerUp);
  }
  function onPointerMove(e){
    if(!dragging) return;
    const dx=e.clientX-startX, dy=e.clientY-startY;
    el.style.left=(origX+dx)+'px'; el.style.top=(origY+dy)+'px';
    positionHud();
  }
  function onPointerUp(){
    if(!dragging) return;
    try{ if(dragPointerId!=null && el.releasePointerCapture) el.releasePointerCapture(dragPointerId);}catch(_){}
    dragging=false; dragPointerId=null;
    window.removeEventListener('pointermove',onPointerMove);
    window.removeEventListener('pointerup',onPointerUp);
    window.removeEventListener('pointercancel',onPointerUp);
    el.removeEventListener('lostpointercapture',onPointerUp);
  }

  const tnode=el.querySelector('.scrap-text'); if(tnode) enableAutoGrow(el,tnode);
}
function enableAutoGrow(box,textEl){
  const grow=()=>{ textEl.style.height='auto'; box.style.height=Math.max(40,textEl.scrollHeight)+'px'; positionHud(); };
  textEl.addEventListener('input',grow); new ResizeObserver(grow).observe(textEl); grow();
}

document.addEventListener('click',e=>{
  if(!document.body.classList.contains('editing')) return;
  const onItem=e.target.closest('.scrap-item'), onBar=e.target.closest('#toolbar'), onHud=e.target.closest('#itemHud');
  if(!onItem && !onBar && !onHud) deselect();
});
function deselect(){ selectedItem?.classList.remove('selected'); selectedItem=null; updateToolbarState(); hideItemHud(); }

/* ========= Big Text Editor ========= */
const editor = {
  el: document.getElementById('textEditor'),
  input: document.getElementById('editorInput'),
  size: document.getElementById('editorSize'),
  color: document.getElementById('editorColor'),
  save: document.getElementById('editorSave'),
  cancel: document.getElementById('editorCancel'),
  targetBox: null
};
function openTextEditor({ text = '', size = 28, color = '#0d2a6b', targetBox = null } = {}) {
  editor.targetBox = targetBox;
  editor.input.value = text;
  editor.size.value = size;
  editor.color.value = color;
  editor.el.classList.add('open');
  setTimeout(() => editor.input.focus(), 0);
}
function closeTextEditor() { editor.el.classList.remove('open'); editor.targetBox = null; }
editor.cancel.onclick = closeTextEditor;
editor.el.addEventListener('click', e => { if (e.target === editor.el) closeTextEditor(); });
document.addEventListener('keydown', e => { if (e.key === 'Escape' && editor.el.classList.contains('open')) closeTextEditor(); });
editor.save.onclick = () => {
  const text = editor.input.value;
  const size = Math.max(8, Math.min(200, parseInt(editor.size.value || '22', 10)));
  const color = editor.color.value || '#0d2a6b';

  if (editor.targetBox) {
    const t = editor.targetBox.querySelector('.scrap-text');
    if (!t) return;
    t.textContent = text;
    t.style.fontSize = size + 'px';
    t.style.color = color;
    t.style.height = 'auto';
    editor.targetBox.style.height = Math.max(40, t.scrollHeight) + 'px';
    showItemHud(editor.targetBox);
  } else {
    const box = document.createElement('div');
    box.className = 'scrap-item';
    box.style.left = '40px';
    box.style.top = '40px';
    box.style.width = '320px';
    box.innerHTML = `
      <div class="scrap-text" contenteditable="false" style="font-size:${size}px;color:${color}"></div>
      <div class="mover" title="Drag"></div>
      <div class="resizer"></div><div class="rotator"></div>`;
    box.querySelector('.scrap-text').textContent = text;
    (activeCanvas || getVisibleCanvases().right).appendChild(box);
    makeDraggable(box); box.dataset._hooked='1';
  }
  closeTextEditor();
};

/* Image controls + small inputs */
function updateImageButtons(){
  const onImg=!!selectedItem?.querySelector('.scrap-img');
  fitBtn.disabled=!onImg; lockBtn.disabled=!onImg;
  if(onImg){ const fit=selectedItem.dataset.fit||'contain', lock=selectedItem.dataset.lock==='1';
    fitBtn.textContent='Fit: '+(fit==='cover'?'Fill':'Contain');
    lockBtn.textContent='Lock: '+(lock?'On':'Off'); }
  else{ fitBtn.textContent='Fit: Contain'; lockBtn.textContent='Lock: On'; }
}
fitBtn.onclick=()=>{ if(!selectedItem?.querySelector('.scrap-img')) return; const cur=selectedItem.dataset.fit||'contain'; selectedItem.dataset.fit=(cur==='cover')?'contain':'cover'; updateImageButtons(); showItemHud(selectedItem); };
lockBtn.onclick=()=>{ if(!selectedItem?.querySelector('.scrap-img')) return; selectedItem.dataset.lock=(selectedItem.dataset.lock==='1')?'0':'1'; updateImageButtons(); showItemHud(selectedItem); };
function updateToolbarState(){ updateImageButtons(); updateFontInput(); updateColorInput(); }

function selectedTextEl(){ if(!selectedItem) return null; const t=selectedItem.querySelector('.scrap-text'); return t||null; }
function updateFontInput(){
  const t=selectedTextEl(); if(!t){ fontSizeInput.disabled=true; fontSizeInput.value=''; return; }
  fontSizeInput.disabled=false; const curr=Math.round(parseFloat(getComputedStyle(t).fontSize)||22); fontSizeInput.value=curr; hudFont.value=curr;
}
fontSizeInput.addEventListener('input',()=>{
  const t=selectedTextEl(); if(!t) return; let v=parseInt(fontSizeInput.value,10); if(isNaN(v)) return;
  v=Math.max(8,Math.min(200,v)); t.style.fontSize=v+'px'; t.style.height='auto';
  const box=t.closest('.scrap-item'); if(box) box.style.height=Math.max(40,t.scrollHeight)+'px'; hudFont.value=v;
});
hudFont.addEventListener('input',()=>{
  const t=selectedTextEl(); if(!t) return; let v=parseInt(hudFont.value,10); if(isNaN(v)) return;
  v=Math.max(8,Math.min(200,v)); t.style.fontSize=v+'px'; t.style.height='auto';
  const box=t.closest('.scrap-item'); if(box) box.style.height=Math.max(40,t.scrollHeight)+'px'; fontSizeInput.value=v;
});
function selectedAnyTextEl(){ if(!selectedItem) return null; return selectedItem.querySelector('.scrap-text'); }
function rgbToHex(rgb){
  const m=String(rgb).match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
  if(!m) return '#000000';
  const r=(+m[1]).toString(16).padStart(2,'0'), g=(+m[2]).toString(16).padStart(2,'0'), b=(+m[3]).toString(16).padStart(2,'0');
  return `#${r}${g}${b}`;
}
function updateColorInput(){
  const t=selectedAnyTextEl();
  if(!t){ fontColorInput.disabled=true; fontColorInput.title=""; return; }
  fontColorInput.disabled=false; fontColorInput.title="";
  const comp=getComputedStyle(t).color; fontColorInput.value=comp.startsWith('#')?comp:rgbToHex(comp);
}
fontColorInput.addEventListener('input',()=>{
  const t=selectedAnyTextEl(); if(!t) return;
  t.style.color=fontColorInput.value;
});

/* HUD buttons */
hudRot.addEventListener('input',()=>{ if(!selectedItem) return; const v=parseFloat(hudRot.value); if(isNaN(v)) return; setRotation(selectedItem,v); });
hudRotL.onclick=()=>{ if(!selectedItem) return; setRotation(selectedItem,getRotation(selectedItem)-5); };
hudRotR.onclick=()=>{ if(!selectedItem) return; setRotation(selectedItem,getRotation(selectedItem)+5); };
hudDup.onclick = ()=>{ if(!selectedItem) return; const clone=selectedItem.cloneNode(true); clone.style.left=(selectedItem.offsetLeft+16)+'px'; clone.style.top=(selectedItem.offsetTop+16)+'px'; selectedItem.parentElement.appendChild(clone); makeDraggable(clone); clone.dataset._hooked='1'; };
hudFront.onclick = ()=>{ if(selectedItem){ selectedItem.style.zIndex=++zCounter; } };
hudBack.onclick  = ()=>{ if(selectedItem){ selectedItem.style.zIndex=0; } };
hudDelete.onclick= ()=>{ if(selectedItem){ selectedItem.remove(); deselect(); } };

/* Photos (local add) */
document.getElementById('addPhotoBtn').onclick=()=>fileInput.click();
fileInput.addEventListener('change',async e=>{
  const f=e.target.files[0]; if(!f) return;
  const {mime,base64}=await compressToBase64(f,1600,0.85);
  const box=document.createElement('div');
  box.className='scrap-item'; box.style.left='90px'; box.style.top='90px'; box.style.width='320px'; box.style.height='230px';
  box.dataset.fit='contain'; box.dataset.lock='1';
  box.innerHTML=`<img class="scrap-img" alt="" src="data:${mime};base64,${base64}" decoding="async">
                 <div class="mover" title="Drag"></div>
                 <div class="resizer"></div><div class="rotator"></div>`;
  (activeCanvas||getVisibleCanvases().right).appendChild(box); makeDraggable(box); box.dataset._hooked='1';
  const imgEl=box.querySelector('.scrap-img');
  const setAspect=()=>{ if(imgEl.naturalWidth&&imgEl.naturalHeight){ box.dataset.aspect=(imgEl.naturalWidth/imgEl.naturalHeight).toFixed(5);} };
  if(imgEl.complete) setAspect(); else imgEl.addEventListener('load',setAspect);
  imgEl._preb64={mime,base64}; fileInput.value='';
});

/* ========= Save (REST) ========= */
document.getElementById('saveBtn').onclick=()=>saveToCloud().catch(e=>alert('Save failed: '+e));
async function saveToCloud(){
  toastShow('Saving…');

  // 1) Upload any new images
  const imgs=[...document.querySelectorAll('#book .scrap-img')];
  for(const img of imgs){
    if(img.dataset.imgid) continue;
    let mime,base64;
    if(img._preb64){ ({mime,base64}=img._preb64); }
    else{
      const r=await fetch(img.src); const b=await r.blob(); const enc=await compressToBase64(b,1600,0.85); mime=enc.mime; base64=enc.base64;
    }
    const insUrl = `${SUPABASE_URL}/rest/v1/${TABLE_IMAGES}`;
    const insRes = await fetch(insUrl,{
      method:'POST', headers:{...sbHeaders, "Prefer":"return=representation"},
      body: JSON.stringify([{content_type:mime,data_base64:base64}])
    });
    if(!insRes.ok) throw new Error('image insert '+insRes.status);
    const row = (await insRes.json())[0];
    img.dataset.imgid=String(row.id); // keep UUID string
    delete img._preb64;
  }

  // 2) Gather pages back from DOM
  const canvases=[...document.querySelectorAll('#book .page .page-canvas')];
  const pages=[];
  canvases.forEach(c=>{
    const items=[];
    c.querySelectorAll('.scrap-item').forEach(el=>{
      const style={left:el.style.left, top:el.style.top, width:el.style.width, height:el.style.height};
      const rot=parseFloat(el.dataset.rot||'0')||0;
      const img=el.querySelector('.scrap-img');
      if(img){
        items.push({
          type:'image',style,rot,
          imageId:(img.dataset.imgid??null),
          fit:el.dataset.fit||'contain',
          lock:el.dataset.lock==='1'
        });
      }else{
        const txt=el.querySelector('.scrap-text');
        items.push({type:'text',style,rot,html:txt?txt.outerHTML:''});
      }
    });
    pages.push({items});
  });

  // 3) Upsert state
  const upUrl = `${SUPABASE_URL}/rest/v1/${TABLE_STATE}`;
  const upRes = await fetch(upUrl,{
    method:'POST',
    headers:{...sbHeaders, "Prefer":"resolution=merge-duplicates,return=representation"},
    body: JSON.stringify({ id: STATE_ID, pages })
  });
  if(!upRes.ok) throw new Error('state upsert '+upRes.status);
  toastShow('Saved ✓'); exitEdit();
}

/* ========= Misc utils ========= */
async function compressToBase64(fileOrBlob, maxSide=1600, quality=0.85, pageColor='#f7eddc'){
  const blob=fileOrBlob instanceof Blob?fileOrBlob:new Blob([fileOrBlob]);
  const inputMime=blob.type||'image/png';
  const img=await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=URL.createObjectURL(blob); });
  let w=img.width,h=img.height;
  if(Math.max(w,h)>maxSide){ if(w>h){ h=Math.round(h*(maxSide/w)); w=maxSide; } else { w=Math.round(h*(maxSide/h)); h=maxSide; } }
  const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext('2d');
  const wantsAlpha=/png|webp|gif/i.test(inputMime);
  if(!wantsAlpha){ ctx.fillStyle=pageColor; ctx.fillRect(0,0,w,h); }
  ctx.drawImage(img,0,0,w,h);
  const outMime=wantsAlpha?'image/png':'image/jpeg';
  const dataUrl=canvas.toDataURL(outMime,wantsAlpha?1.0:quality);
  URL.revokeObjectURL(img.src);
  return { mime:outMime, base64:dataUrl.split(',')[1] };
}
</script>
</body>
</html>
