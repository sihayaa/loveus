<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Our Scrapbook Story</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:,">
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b0f2f; --paper:#f7eddc; --ink:#0d2a6b;
  --accent:#7a5af8; --mint:#67e4ca; --font:"Dancing Script", cursive;
  --cover-y:28%;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);display:flex;align-items:center;justify-content:center;overflow:hidden;font-family:var(--font)}
#stage{width:1000px;height:650px;position:relative}
#book{position:absolute;inset:0}

/* pages */
.page{width:100%;height:100%;position:relative;overflow:hidden;background:var(--paper);box-shadow:inset 0 0 60px rgba(0,0,0,.22)}
.page-canvas{position:relative;width:100%;height:100%;padding:28px;color:var(--ink);font-size:22px;line-height:1.35}

/* cover */
.page.cover{box-shadow:0 8px 28px rgba(0,0,0,.35)}
.page.cover .page-canvas{padding:0;background:#0c102c}
.cover-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:50% var(--cover-y);display:block;border:0}

/* items */
.scrap-item{position:absolute;user-select:none;transform-origin:center}
.scrap-text{background:transparent;border:0;color:inherit;font:inherit;white-space:pre-wrap}
.scrap-text[contenteditable="true"]{outline:none}
.scrap-img{display:block;max-width:100%;max-height:100%;border:0;pointer-events:none}
.resizer{display:none}
.rotator{display:none;position:absolute;left:50%;top:-18px;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;background:#fff;border:3px solid var(--accent);box-shadow:0 2px 8px rgba(0,0,0,.25);cursor:grab}
.rotator:active{cursor:grabbing}

body.editing .scrap-item{cursor:move}
body.editing .scrap-item.selected{box-shadow:0 0 0 3px var(--accent)}
body.editing .scrap-text{background:rgba(255,255,255,.55);padding:10px 12px;border:1px solid rgba(0,0,0,.1);border-radius:8px}
body.editing .scrap-img{border:6px solid #fff;border-radius:8px;box-shadow:4px 6px 18px rgba(0,0,0,.25)}
body.editing .scrap-item .resizer{display:block;position:absolute;right:-6px;bottom:-6px;width:16px;height:16px;border-radius:4px;background:var(--mint);border:2px solid #0b2c28;cursor:nwse-resize}
body.editing .scrap-item .rotator{display:block}

/* toolbar & helpers */
#toolbar{position:absolute;left:50%;bottom:14px;transform:translateX(-50%);display:none;z-index:60;background:rgba(255,255,255,.95);border:2px solid #e8dcc6;border-radius:14px;padding:10px;gap:8px;box-shadow:0 10px 22px rgba(0,0,0,.25);align-items:center;flex-wrap:wrap}
#toolbar button{border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700;color:#fff;background:var(--accent)}
#toolbar button.secondary{background:#5d47d4}
#toolbar button.mint{background:var(--mint);color:#022d2c}
#toolbar button.warn{background:#ff9aa2;color:#4c0a17}
#toolbar .group{display:flex;gap:8px;align-items:center}
#fileInput{display:none}
#toast{position:absolute;top:12px;right:12px;z-index:95;background:#11172f;color:#fff;border:2px solid var(--mint);padding:8px 12px;border-radius:10px;display:none}
.page-canvas.active-side{outline:3px dashed var(--accent);outline-offset:-12px}

/* modals */
.modal{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:70;background:rgba(0,0,0,.55)}
.modal.open{display:flex}
.modal-card{width:min(96%,560px);background:#151a30;color:#fff;border:2px solid var(--mint);border-radius:14px;padding:16px;box-shadow:0 20px 40px rgba(0,0,0,.45)}
.modal-card h3{margin:0 0 10px;font-size:20px}
#textModal textarea{width:100%;background:#0f1430;color:#fff;border:1px solid #2b3258;border-radius:10px;padding:10px 12px;font-family:var(--font);font-size:20px;resize:vertical}
.modal-actions{margin-top:12px;display:flex;justify-content:flex-end;gap:8px}
.modal-actions button{border:0;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
.btn-mint{background:var(--mint);color:#05201f}
.btn-ghost{background:#2a315d;color:#fff}
.stickers{display:grid;grid-template-columns:repeat(8,1fr);gap:10px}
.stickers button{background:#0f1430;border:1px solid #2b3258;border-radius:10px;padding:8px;cursor:pointer;font-size:26px;line-height:1}
</style>
</head>
<body>

<div id="stage">
  <div id="book">
    <!-- COVER (unchanged) -->
    <div class="page cover">
      <div class="page-canvas">
        <img class="cover-img" alt="Cover"
          src="https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/lovestory_cover.png">
      </div>
    </div>

    <!-- inner pages -->
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
  </div>

  <!-- Toolbar -->
  <div id="toolbar">
    <div class="group">
      <button id="targetLeft" class="secondary">Edit Left</button>
      <button id="targetRight" class="secondary">Edit Right</button>
    </div>
    <div class="group">
      <button id="addTextBtn" class="mint">Add Text</button>
      <button id="addPhotoBtn" class="secondary">Add Photo</button>
      <button id="stickersBtn" class="secondary">Stickers</button>
      <button id="addPageBtn" class="secondary">Add Page</button>
    </div>
    <div class="group">
      <button id="deleteSelectedBtn" class="warn">Delete Selected</button>
      <button id="clearPageBtn" class="warn">Clear Page</button>
      <button id="saveBtn" class="mint">Save</button>
    </div>
    <input id="fileInput" type="file" accept="image/*" />
  </div>

  <!-- Text modal -->
  <div id="textModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>Add Text</h3>
      <textarea id="textInput" rows="5" placeholder="Write something sweet…"></textarea>
      <div class="modal-actions">
        <button class="btn-ghost" id="textCancel">Cancel</button>
        <button class="btn-mint" id="textAdd">Add Text</button>
      </div>
    </div>
  </div>

  <!-- Stickers modal -->
  <div id="stickerModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>Pick a sticker</h3>
      <div class="stickers" id="stickersGrid"></div>
      <div class="modal-actions">
        <button class="btn-ghost" id="stickersClose">Close</button>
      </div>
    </div>
  </div>

  <div id="toast">Edit mode unlocked ✨</div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script src="./flipbook/page-flip.browser.js"></script>
<script>
/* ============ Supabase config (your creds) ============ */
const SUPABASE_URL  = "https://tmjozxcjylcxgemffnoc.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
const TABLE_IMAGES = "scrapbook_images";   // stores photos (base64)
const TABLE_STATE  = "scrapbook_state";    // stores {pages: ...}
const STATE_ID     = "main";               // single row id
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ============ refs ============ */
const bookEl=document.getElementById('book'), toolbar=document.getElementById('toolbar'), toast=document.getElementById('toast');
const fileInput=document.getElementById('fileInput');
const textModal=document.getElementById('textModal'), textInput=document.getElementById('textInput');
const stickersGrid=document.getElementById('stickersGrid');
let pageFlip, activeCanvas=null, selectedItem=null;

/* ============ init ============ */
init().catch(console.error);
async function init(){
  await loadFromTables();
  if (!window.St || !St.PageFlip) alert("PageFlip library missing.");
  pageFlip = new St.PageFlip(bookEl,{width:500,height:650,size:"fixed",showCover:true,drawShadow:true,flippingTime:800,maxShadowOpacity:0.25,useMouseEvents:true,mobileScrollSupport:false,startPage:0});
  pageFlip.loadFromHTML(document.querySelectorAll('#book .page'));
}

/* ============ page target helpers ============ */
function getVisibleCanvases(){
  const bookR = bookEl.getBoundingClientRect();
  const list=[...document.querySelectorAll('#book .page .page-canvas')].map(el=>{
    const r=el.getBoundingClientRect();
    const w=Math.max(0,Math.min(r.right,bookR.right)-Math.max(r.left,bookR.left));
    const h=Math.max(0,Math.min(r.bottom,bookR.bottom)-Math.max(r.top,bookR.top));
    return {el,area:w*h,cx:r.left+r.width/2};
  }).filter(x=>x.area>1000).sort((a,b)=>b.area-a.area);
  const top=list.slice(0,2).sort((a,b)=>a.cx-b.cx);
  return {left:top.length===2?top[0].el:null,right:top.length?top[top.length-1].el:null};
}
function highlightCanvas(canvas){
  if(!canvas){ toastShow('That side is not visible here.'); return; }
  document.querySelectorAll('.page-canvas').forEach(c=>c.classList.remove('active-side'));
  canvas.classList.add('active-side'); activeCanvas=canvas;
}
document.getElementById('stage').addEventListener('mousedown',e=>{
  if(!document.body.classList.contains('editing')) return;
  const pc=e.target.closest('.page-canvas'); if(pc) highlightCanvas(pc);
});
document.getElementById('targetLeft').onclick=()=>{
  const {left,right}=getVisibleCanvases();
  if(!left && right && pageFlip.getCurrentPageIndex?.()===0){
    toastShow('Opening first spread…'); try{pageFlip.turnToPage(1);}catch{}
    setTimeout(()=>{const lr=getVisibleCanvases(); highlightCanvas(lr.left||lr.right);},450); return;
  }
  highlightCanvas(left||right);
};
document.getElementById('targetRight').onclick=()=>{
  const {right,left}=getVisibleCanvases(); highlightCanvas(right||left);
};
if(pageFlip?.on){
  pageFlip.on('flip',()=>{
    if(!document.body.classList.contains('editing')) return;
    const {left,right}=getVisibleCanvases();
    if(activeCanvas===left||activeCanvas===right) highlightCanvas(activeCanvas);
    else highlightCanvas(right||left);
  });
}

/* ============ edit mode (type 123) ============ */
const PASSCODE='123'; let editEnabled=false, keyBuffer='', keyTimer=null;
document.addEventListener('keydown',(e)=>{
  keyBuffer+=e.key; clearTimeout(keyTimer); keyTimer=setTimeout(()=>keyBuffer='',1200);
  if(keyBuffer.endsWith(PASSCODE)){ keyBuffer=''; enterEdit(); }
});
function setAllTextEditable(on){ document.querySelectorAll('#book .scrap-text').forEach(el=>el.setAttribute('contenteditable', on?'true':'false')); }
function setEditing(on){
  if(on){ document.body.classList.add('editing'); setAllTextEditable(true); toolbar.style.display='flex'; }
  else  { document.body.classList.remove('editing'); setAllTextEditable(false); toolbar.style.display='none';
          document.querySelectorAll('.page-canvas').forEach(c=>c.classList.remove('active-side')); activeCanvas=null; }
}
function enterEdit(){
  editEnabled=true; setEditing(true);
  const {right,left}=getVisibleCanvases(); highlightCanvas(right||left);
  try{ pageFlip.update?.({useMouseEvents:false,swipeDistance:10000}); }catch(_){}
  toastShow('Edit mode unlocked ✨');
}
function exitEdit(){
  editEnabled=false; setEditing(false); deselect();
  try{ pageFlip.update?.({useMouseEvents:true,swipeDistance:30}); }catch(_){}
}

/* ============ drag/resize/rotate ============ */
function makeDraggable(el){
  let startX=0,startY=0,origX=0,origY=0,resizing=false,startW=0,startH=0,rotating=false,startAngle=0,startPointerAngle=0;
  const res=el.querySelector('.resizer'); let rot=el.querySelector('.rotator'); if(!rot){rot=document.createElement('div'); rot.className='rotator'; el.appendChild(rot);}
  const getAngle=()=>parseFloat(el.dataset.rot||'0')||0; const setAngle=(deg)=>{ el.dataset.rot=String(deg); el.style.transform=`rotate(${deg}deg)`; };
  if(res){ res.addEventListener('mousedown',e=>{ if(!editEnabled) return; e.stopPropagation(); e.preventDefault();
    resizing=true; startX=e.clientX; startY=e.clientY; startW=el.offsetWidth; startH=el.offsetHeight;
    document.addEventListener('mousemove',onMove); document.addEventListener('mouseup',onUp); }); }
  rot.addEventListener('mousedown',e=>{ if(!editEnabled) return; e.stopPropagation(); e.preventDefault();
    rotating=true; const r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
    startPointerAngle=Math.atan2(e.clientY-cy,e.clientX-cx); startAngle=getAngle();
    document.addEventListener('mousemove',onRotate); document.addEventListener('mouseup',endRotate); });
  function onRotate(e){ if(!rotating) return; const r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2; const a=Math.atan2(e.clientY-cy,e.clientX-cx); setAngle(startAngle + (a-startPointerAngle)*180/Math.PI); }
  function endRotate(){ rotating=false; document.removeEventListener('mousemove',onRotate); document.removeEventListener('mouseup',endRotate); }
  el.addEventListener('mousedown',e=>{ if(!editEnabled) return;
    if(e.target.classList.contains('resizer')||e.target.classList.contains('rotator')) return;
    selectedItem?.classList.remove('selected'); selectedItem=el; el.classList.add('selected');
    startX=e.clientX; startY=e.clientY; origX=el.offsetLeft; origY=el.offsetTop;
    document.addEventListener('mousemove',onMove); document.addEventListener('mouseup',onUp); e.stopPropagation();
  });
  function onMove(e){ if(!editEnabled) return;
    if(resizing){ const dx=e.clientX-startX, dy=e.clientY-startY; el.style.width=Math.max(60,startW+dx)+'px'; el.style.height=Math.max(60,startH+dy)+'px'; }
    else{ const dx=e.clientX-startX, dy=e.clientY-startY; el.style.left=(origX+dx)+'px'; el.style.top=(origY+dy)+'px'; }
  }
  function onUp(){ document.removeEventListener('mousemove',onMove); document.removeEventListener('mouseup',onUp); resizing=false; }
}
function deselect(){ selectedItem?.classList.remove('selected'); selectedItem=null; }
document.addEventListener('click',e=>{ if(editEnabled && !e.target.closest('.scrap-item')) deselect(); });

/* ============ add text/photo/stickers ============ */
document.getElementById('addTextBtn').onclick=()=>{ openModal(textModal); textInput.value=''; setTimeout(()=>textInput.focus(),10); };
document.getElementById('textCancel').onclick=()=> closeModal(textModal);
document.getElementById('textAdd').onclick=()=>{
  const val=textInput.value.trim(); closeModal(textModal); if(!val) return;
  const box=document.createElement('div'); box.className='scrap-item'; box.style.left='40px'; box.style.top='40px'; box.style.width='260px';
  const isEditing=document.body.classList.contains('editing');
  box.innerHTML=`<div class="scrap-text" contenteditable="${isEditing?'true':'false'}">${val}</div><div class="resizer"></div><div class="rotator"></div>`;
  (activeCanvas||getVisibleCanvases().right).appendChild(box); makeDraggable(box);
};

document.getElementById('addPhotoBtn').onclick=()=> fileInput.click();
fileInput.addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  const url=URL.createObjectURL(f);
  const localId='local_'+(crypto.randomUUID?crypto.randomUUID():Date.now());
  const box=document.createElement('div');
  box.className='scrap-item'; box.style.left='90px'; box.style.top='90px'; box.style.width='320px'; box.style.height='230px';
  box.innerHTML=`<img class="scrap-img" data-localid="${localId}" alt="" src="${url}"><div class="resizer"></div><div class="rotator"></div>`;
  (activeCanvas||getVisibleCanvases().right).appendChild(box); makeDraggable(box);
  box.querySelector('.scrap-img')._file = f; // keep file for SAVE
  fileInput.value='';
});

const STICKERS_EMOJI=["🎮","👾","🕹️","🖥️","⌨️","💞","🩷","🧡","💛","💚","💙","🩵","🤎","🖤","🩶","🤍","💋","💯","🍔","🍟","🍕","🌭","🥪","🍒","🍦","🍪","🎂","🍰","🧁","🍫"];
document.getElementById('stickersBtn').onclick=()=>{ stickersGrid.innerHTML=''; STICKERS_EMOJI.forEach(ch=>{ const b=document.createElement('button'); b.textContent=ch; b.onclick=()=>{ const box=document.createElement('div'); box.className='scrap-item'; box.style.left='60px'; box.style.top='60px'; box.style.width='100px'; box.style.height='100px'; box.innerHTML=`<div class="scrap-text" style="font-size:64px;line-height:1;" contenteditable="false">${ch}</div><div class="resizer"></div><div class="rotator"></div>`; (activeCanvas||getVisibleCanvases().right).appendChild(box); makeDraggable(box); }; stickersGrid.appendChild(b); }); openModal(document.getElementById('stickerModal')); };
document.getElementById('stickersClose').onclick=()=> closeModal(document.getElementById('stickerModal'));

/* ============ page tools ============ */
document.getElementById('addPageBtn').onclick=()=>{ const p=document.createElement('div'); p.className='page'; const c=document.createElement('div'); c.className='page-canvas'; p.appendChild(c); bookEl.appendChild(p); pageFlip.loadFromHTML(document.querySelectorAll('#book .page')); toastShow('Page added'); };
document.getElementById('deleteSelectedBtn').onclick=()=>{ if(selectedItem){selectedItem.remove(); selectedItem=null;} };
document.getElementById('clearPageBtn').onclick=()=>{ (activeCanvas||getVisibleCanvases().right).innerHTML=''; deselect(); };

/* ============ SAVE -> tables ============ */
document.getElementById('saveBtn').onclick=()=>saveToTables().catch(e=>alert('Save failed: '+e));

async function saveToTables(){
  toastShow('Saving…');
  // 1) upload any new local images into the images table (store as base64)
  const imgs=[...document.querySelectorAll('#book .scrap-img')];
  for(const img of imgs){
    if(img.dataset.imgid) continue; // already in DB
    if(!img._file) continue;
    const {base64, mime} = await fileToBase64(img._file);
    const { data, error } = await supabase
      .from(TABLE_IMAGES)
      .insert([{ content_type: mime, data_base64: base64 }])
      .select('id')
      .single();
    if(error) throw error;
    img.dataset.imgid = data.id;
    delete img.dataset.localid;
    delete img._file;
    // swap preview to data URL (optional)
    img.src = `data:${mime};base64,${base64}`;
  }

  // 2) save lightweight layout JSON to state table
  const canvases=[...document.querySelectorAll('#book .page .page-canvas')];
  const pages=[];
  canvases.forEach(canvas=>{
    const items=[];
    canvas.querySelectorAll('.scrap-item').forEach(el=>{
      const style={left:el.style.left, top:el.style.top, width:el.style.width, height:el.style.height};
      const rot=parseFloat(el.dataset.rot||'0')||0;
      const img=el.querySelector('.scrap-img');
      if(img){ items.push({type:'image', style, rot, imageId: img.dataset.imgid||null}); }
      else{ const txt=el.querySelector('.scrap-text'); items.push({type:'text', style, rot, html: txt?txt.innerHTML:''}); }
    });
    pages.push({items});
  });

  const { error: upsertErr } = await supabase
    .from(TABLE_STATE)
    .upsert({ id: STATE_ID, pages })
    .select('id')
    .single();
  if(upsertErr) throw upsertErr;

  toastShow('Saved ✓'); setTimeout(()=>exitEdit(),300);
}

/* ============ LOAD <- tables ============ */
async function loadFromTables(){
  try{
    const { data:state, error } = await supabase
      .from(TABLE_STATE).select('pages').eq('id', STATE_ID).maybeSingle();
    if(error || !state || !state.pages) return;

    // ensure enough blank shells exist
    const have = document.querySelectorAll('#book .page').length - 1;
    const need = state.pages.length;
    for(let i=have; i<need; i++){
      const p=document.createElement('div'); p.className='page';
      const c=document.createElement('div'); c.className='page-canvas'; p.appendChild(c);
      bookEl.appendChild(p);
    }

    // collect image ids to bulk fetch
    const ids = [];
    state.pages.forEach(pg => pg.items?.forEach(it=>{ if(it.type==='image' && it.imageId) ids.push(it.imageId) }));
    const idSet = [...new Set(ids)];
    const urlMap = {};
    if(idSet.length){
      const { data:imgs, error:imgErr } = await supabase
        .from(TABLE_IMAGES)
        .select('id, content_type, data_base64')
        .in('id', idSet);
      if(imgErr) throw imgErr;
      imgs.forEach(row => { urlMap[row.id] = `data:${row.content_type};base64,${row.data_base64}`; });
    }

    const canvases=[...document.querySelectorAll('#book .page .page-canvas')];
    for(let i=0;i<Math.min(state.pages.length, canvases.length); i++){
      const canvas=canvases[i]; canvas.innerHTML='';
      for(const it of state.pages[i].items||[]){
        const box=document.createElement('div'); box.className='scrap-item';
        box.style.left=it.style?.left||'40px'; box.style.top=it.style?.top||'40px';
        if(it.style?.width) box.style.width=it.style.width;
        if(it.style?.height) box.style.height=it.style.height;
        if(it.rot){ box.dataset.rot=it.rot; box.style.transform=`rotate(${it.rot}deg)`; }

        if(it.type==='image' && it.imageId){
          const url = urlMap[it.imageId] || '';
          box.innerHTML = `<img class="scrap-img" data-imgid="${it.imageId}" src="${url}" alt=""><div class="resizer"></div><div class="rotator"></div>`;
        }else{
          box.innerHTML = `<div class="scrap-text" contenteditable="false">${it.html||''}</div><div class="resizer"></div><div class="rotator"></div>`;
        }
        canvas.appendChild(box); makeDraggable(box);
      }
    }
  }catch(e){ console.warn('No saved state yet or load error', e); }
}

/* ============ utils ============ */
function openModal(el){ el.classList.add('open'); el.setAttribute('aria-hidden','false'); }
function closeModal(el){ el.classList.remove('open'); el.setAttribute('aria-hidden','true'); }
function toastShow(msg){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1200); }
let tapStart=null; function isTap(d,t){return d<8&&t<280}
bookEl.addEventListener('pointerdown',e=>{tapStart={x:e.clientX,y:e.clientY,t:Date.now()}},true);
bookEl.addEventListener('pointerup',e=>{ if(!tapStart)return; const d=Math.hypot(e.clientX-tapStart.x,e.clientY-tapStart.y); const dt=Date.now()-tapStart.t; if(isTap(d,dt)){e.preventDefault();e.stopPropagation()} tapStart=null },true);
['click','dblclick'].forEach(evt=>bookEl.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation()},true));
document.querySelectorAll('#book .scrap-item').forEach(makeDraggable);

function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload = ()=> {
      const dataUrl = r.result; // "data:mime;base64,XXXX"
      const [head,base64] = String(dataUrl).split(',');
      const mime = head.substring(head.indexOf(':')+1, head.indexOf(';'));
      resolve({base64, mime});
    };
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}
</script>
</body>
</html>
