<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Our Scrapbook Story</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:,">
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b0f2f; --paper:#f7eddc; --ink:#0d2a6b;
  --accent:#7a5af8; --mint:#67e4ca; --font:"Dancing Script", cursive;
  --cover-y:28%;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--ink);
  display:flex; align-items:center; justify-content:center; overflow:hidden;
  font-family:var(--font);
}

/* Stage & Book */
#stage{ width:1000px; height:650px; position:relative; }
#book { position:absolute; inset:0; }

/* Pages */
.page{
  width:100%; height:100%; position:relative; overflow:hidden;
  background:var(--paper); box-shadow: inset 0 0 60px rgba(0,0,0,.22);
}
.page-canvas{
  position:relative; width:100%; height:100%; padding:28px;
  color:var(--ink); font-size:22px; line-height:1.35;
}

/* COVER (fixed, uneditable): CSS background with local + GitHub fallbacks */
.page.cover{ box-shadow: 0 8px 28px rgba(0,0,0,.35); }
.page.cover .page-canvas{
  padding:0;
  background-color:#0c102c;
  background-image:
    url("./lovestory_cover.png?v=4"),
    url("https://raw.githubusercontent.com/sihayaa/loveus/main/lovestory_cover.png"),
    url("https://raw.githubusercontent.com/sihayaa/loveus/HEAD/lovestory_cover.png");
  background-size:cover;
  background-position:50% var(--cover-y);
  background-repeat:no-repeat;
}

/* Scrap items */
.scrap-item{
  position:absolute; user-select:none; transform-origin:center;
  touch-action:none; /* reliable pointer dragging */
}
.scrap-item.selected{ box-shadow:0 0 0 3px var(--accent); }
.resizer{ display:none; }
.rotator{
  display:none; position:absolute; left:50%; top:-18px; transform:translate(-50%,-50%);
  width:18px; height:18px; border-radius:50%; background:#fff; border:3px solid var(--accent);
  box-shadow:0 2px 8px rgba(0,0,0,.25); cursor:grab;
}
.rotator:active{ cursor:grabbing; }

body.editing .scrap-item{ cursor:move; }
body.editing .scrap-item .resizer{
  display:block; position:absolute; right:-6px; bottom:-6px; width:16px; height:16px;
  border-radius:4px; background:var(--mint); border:2px solid #0b2c28; cursor:nwse-resize;
}
body.editing .scrap-item .rotator{ display:block; }

/* Images default to CONTAIN; per-item toggle to COVER */
.scrap-img{
  display:block; width:100%; height:100%;
  object-fit:contain;
  border:0; pointer-events:none;
  -webkit-user-drag:none; user-select:none;
}
.scrap-item[data-fit="cover"] .scrap-img{ object-fit:cover; }

/* Text */
.scrap-text{
  display:block; width:100%; height:100%;
  background:transparent; border:0; color:inherit; font:inherit;
  white-space:pre-wrap; overflow:auto;
}
.scrap-text[contenteditable="true"]{ outline:none; }
.scrap-text.sticker{ display:flex; align-items:center; justify-content:center; line-height:1; }

/* RIGHT SIDEBAR TOOLBAR (secret, fixed) */
#toolbar{
  position:fixed; right:16px; top:50%; transform:translateY(-50%);
  display:none; z-index:100; background:rgba(255,255,255,.98);
  border:2px solid #e8dcc6; border-radius:14px; padding:12px;
  width: 240px; gap:10px;
  box-shadow:0 10px 22px rgba(0,0,0,.25);
  display:flex; flex-direction:column; align-items:stretch;
}
#toolbar .group{ display:flex; gap:8px; flex-wrap:wrap; }
#toolbar button{
  border:0; padding:8px 12px; border-radius:8px; cursor:pointer;
  font-weight:700; color:#fff; background:var(--accent); width:100%;
}
#toolbar button.secondary{ background:#5d47d4; }
#toolbar button.mint{ background:var(--mint); color:#022d2c; }
#toolbar button.warn{ background:#ff9aa2; color:#4c0a17; }
#toolbar input[type="number"]{
  width:100%; padding:8px; border-radius:8px; border:2px solid #e8dcc6;
  font-weight:700; color:#0d2a6b; background:#fff;
}
#fileInput{ display:none; }

#toast{
  position:absolute; top:12px; right:12px; z-index:95;
  background:#11172f; color:#fff; border:2px solid var(--mint);
  padding:8px 12px; border-radius:10px; display:none;
}
.page-canvas.active-side{ outline:3px dashed var(--accent); outline-offset:-12px; }

/* Modals */
.modal{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; z-index:70; background:rgba(0,0,0,.55); }
.modal.open{ display:flex; }
.modal-card{ width:min(96%,560px); background:#151a30; color:#fff; border:2px solid var(--mint); border-radius:14px; padding:16px; box-shadow:0 20px 40px rgba(0,0,0,.45); }
.modal-card h3{ margin:0 0 10px; font-size:20px; }
#textModal textarea{ width:100%; background:#0f1430; color:#fff; border:1px solid #2b3258; border-radius:10px; padding:10px 12px; font-family:var(--font); font-size:20px; resize:vertical; }
.modal-actions{ margin-top:12px; display:flex; justify-content:flex-end; gap:8px; }
.modal-actions button{ border:0; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700; }
.btn-mint{ background:var(--mint); color:#05201f; }
.btn-ghost{ background:#2a315d; color:#fff; }

/* Stickers grid */
.stickers{ display:grid; grid-template-columns:repeat(8,1fr); gap:10px; }
.stickers button{ background:#0f1430; border:1px solid #2b3258; border-radius:10px; padding:8px; cursor:pointer; font-size:26px; line-height:1; }
</style>
</head>
<body>

<div id="stage">
  <div id="book">
    <!-- COVER (fixed) -->
    <div class="page cover"><div class="page-canvas"></div></div>

    <!-- Inner pages -->
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
  </div>

  <!-- Right sidebar toolbar -->
  <div id="toolbar">
    <div class="group">
      <button id="targetLeft" class="secondary">Edit Left</button>
      <button id="targetRight" class="secondary">Edit Right</button>
    </div>

    <div class="group">
      <button id="addTextBtn" class="mint">Add Text</button>
      <button id="addPhotoBtn" class="secondary">Add Photo</button>
      <button id="stickersBtn" class="secondary">Stickers</button>
      <button id="addPageBtn" class="secondary">Add Page</button>
    </div>

    <!-- Word-style font size -->
    <div class="group">
      <label for="fontSizeInput" style="font-weight:700;color:#0d2a6b;">Text Size (px)</label>
      <input id="fontSizeInput" type="number" min="8" max="200" step="1" placeholder="px" list="fontSizes" disabled>
      <datalist id="fontSizes">
        <option value="8"></option><option value="9"></option><option value="10"></option>
        <option value="11"></option><option value="12"></option><option value="14"></option>
        <option value="16"></option><option value="18"></option><option value="20"></option>
        <option value="22"></option><option value="24"></option><option value="26"></option>
        <option value="28"></option><option value="36"></option><option value="48"></option>
        <option value="72"></option>
      </datalist>
    </div>

    <!-- Per-image controls -->
    <div class="group">
      <button id="fitToggleBtn"  class="secondary" title="Toggle photo fit">Fit: Contain</button>
      <button id="lockToggleBtn" class="secondary" title="Lock aspect ratio">Lock: On</button>
    </div>

    <div class="group">
      <button id="deleteSelectedBtn" class="warn">Delete Selected</button>
      <button id="clearPageBtn" class="warn">Clear Page</button>
      <button id="saveBtn" class="mint">Save</button>
    </div>

    <input id="fileInput" type="file" accept="image/*" />
  </div>

  <!-- Text modal -->
  <div id="textModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>Add Text</h3>
      <textarea id="textInput" rows="5" placeholder="Write something sweet…"></textarea>
      <div class="modal-actions">
        <button class="btn-ghost" id="textCancel">Cancel</button>
        <button class="btn-mint" id="textAdd">Add Text</button>
      </div>
    </div>
  </div>

  <!-- Stickers modal -->
  <div id="stickerModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>Pick a sticker</h3>
      <div class="stickers" id="stickersGrid"></div>
      <div class="modal-actions">
        <button class="btn-ghost" id="stickersClose">Close</button>
      </div>
    </div>
  </div>

  <div id="toast">Edit mode unlocked ✨</div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script src="./flipbook/page-flip.browser.js"></script>
<script>
/* ========= Supabase (tables for inner pages) ========= */
const SUPABASE_URL  = "https://tmjozxcjylcxgemffnoc.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
const TABLE_IMAGES = "scrapbook_images";
const TABLE_STATE  = "scrapbook_state";
const STATE_ID     = "main";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ========= Refs ========= */
const bookEl=document.getElementById('book');
const toolbar=document.getElementById('toolbar');
const toast=document.getElementById('toast');
const fileInput=document.getElementById('fileInput');
const textModal=document.getElementById('textModal');
const textInput=document.getElementById('textInput');
const stickersGrid=document.getElementById('stickersGrid');
const stickerModal=document.getElementById('stickerModal');
const stickersClose=document.getElementById('stickersClose');
const fontSizeInput=document.getElementById('fontSizeInput');
const fitBtn=document.getElementById('fitToggleBtn');
const lockBtn=document.getElementById('lockToggleBtn');

let pageFlip, activeCanvas=null, selectedItem=null;

/* ========= Init ========= */
init().catch(console.error);
async function init(){
  await loadFromTables();

  if (!window.St || !St.PageFlip) alert("PageFlip library missing (./flipbook/page-flip.browser.js).");
  pageFlip = new St.PageFlip(bookEl,{
    width:500,height:650,size:"fixed",showCover:true,drawShadow:true,
    flippingTime:800,maxShadowOpacity:0.25,useMouseEvents:true,
    mobileScrollSupport:false,startPage:0
  });
  pageFlip.loadFromHTML(document.querySelectorAll('#book .page'));
  pageFlip.on('flip', ()=>{
    if(!document.body.classList.contains('editing')) return;
    const {left,right}=getVisibleCanvases();
    highlightCanvas((activeCanvas===left||activeCanvas===right)?activeCanvas:(right||left));
  });
}

/* ========= Visible page targeting ========= */
function getVisibleCanvases(){
  const bookR = bookEl.getBoundingClientRect();
  const list=[...document.querySelectorAll('#book .page .page-canvas')].map(el=>{
    const r=el.getBoundingClientRect();
    const w=Math.max(0,Math.min(r.right,bookR.right)-Math.max(r.left,bookR.left));
    const h=Math.max(0,Math.min(r.bottom,bookR.bottom)-Math.max(r.top,bookR.top));
    return {el,area:w*h,cx:r.left+r.width/2};
  }).filter(x=>x.area>1000).sort((a,b)=>b.area-a.area);
  const top=list.slice(0,2).sort((a,b)=>a.cx-b.cx);
  return {left:top.length===2?top[0].el:null,right:top.length?top[top.length-1].el:null};
}
function highlightCanvas(canvas){
  if(!canvas){ toastShow('That side is not visible here.'); return; }
  document.querySelectorAll('.page-canvas').forEach(c=>c.classList.remove('active-side'));
  canvas.classList.add('active-side'); activeCanvas=canvas;
}
document.getElementById('stage').addEventListener('mousedown',e=>{
  if(!document.body.classList.contains('editing')) return;
  const pc=e.target.closest('.page-canvas'); if(pc) highlightCanvas(pc);
});
document.getElementById('targetLeft').onclick=()=>{
  const {left,right}=getVisibleCanvases();
  if(!left && right && pageFlip.getCurrentPageIndex?.()===0){
    toastShow('Opening first spread…'); try{pageFlip.turnToPage(1);}catch{}
    setTimeout(()=>{const lr=getVisibleCanvases(); highlightCanvas(lr.left||lr.right);},450); return;
  }
  highlightCanvas(left||right);
};
document.getElementById('targetRight').onclick=()=>{
  const {right,left}=getVisibleCanvases(); highlightCanvas(right||left);
};

/* ========= Edit mode (type 123) ========= */
const PASSCODE='123'; let editEnabled=false, keyBuffer='', keyTimer=null;
document.addEventListener('keydown',(e)=>{
  keyBuffer+=e.key; clearTimeout(keyTimer); keyTimer=setTimeout(()=>keyBuffer='',1200);
  if(keyBuffer.endsWith(PASSCODE)){ keyBuffer=''; enterEdit(); }
});
function setAllTextEditable(on){
  document.querySelectorAll('#book .scrap-text').forEach(el=>{
    if(!el.classList.contains('sticker')) el.setAttribute('contenteditable', on?'true':'false');
  });
}
function setEditing(on){
  if(on){ document.body.classList.add('editing'); setAllTextEditable(true); toolbar.style.display='flex'; }
  else  { document.body.classList.remove('editing'); setAllTextEditable(false); toolbar.style.display='none';
          document.querySelectorAll('.page-canvas').forEach(c=>c.classList.remove('active-side')); activeCanvas=null; }
}
function enterEdit(){
  editEnabled=true; setEditing(true);
  const {right,left}=getVisibleCanvases(); highlightCanvas(right||left);
  try{ pageFlip.update?.({useMouseEvents:false,swipeDistance:10000}); }catch(_){}
  toastShow('Edit mode unlocked ✨');
}
function exitEdit(){
  editEnabled=false; setEditing(false); deselect();
  try{ pageFlip.update?.({useMouseEvents:true,swipeDistance:30}); }catch(_){}
}

/* ========= Drag / Resize / Rotate (fixed) ========= */
function makeDraggable(el){
  let startX=0,startY=0,origX=0,origY=0,resizing=false,startW=0,startH=0,rotating=false,startAngle=0,startPointerAngle=0;
  const res=el.querySelector('.resizer'); let rot=el.querySelector('.rotator'); if(!rot){rot=document.createElement('div'); rot.className='rotator'; el.appendChild(rot);}
  const getAngle=()=>parseFloat(el.dataset.rot||'0')||0;
  const setAngle=(deg)=>{ el.dataset.rot=String(deg); el.style.transform=`rotate(${deg}deg)`; };

  // prevent native drag
  el.addEventListener('dragstart', e=>e.preventDefault());

  if(res){
    res.addEventListener('mousedown',e=>{
      if(!editEnabled) return; e.stopPropagation(); e.preventDefault();
      resizing=true; startX=e.clientX; startY=e.clientY; startW=el.offsetWidth; startH=el.offsetHeight;
      document.addEventListener('mousemove',onMove); document.addEventListener('mouseup',onUp);
    });
  }
  rot.addEventListener('mousedown',e=>{
    if(!editEnabled) return; e.stopPropagation(); e.preventDefault();
    rotating=true; const r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
    startPointerAngle=Math.atan2(e.clientY-cy,e.clientX-cx); startAngle=getAngle();
    document.addEventListener('mousemove',onRotate); document.addEventListener('mouseup',endRotate);
  });
  function onRotate(e){
    if(!rotating) return;
    const r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
    const a=Math.atan2(e.clientY-cy,e.clientX-cx);
    setAngle(startAngle + (a-startPointerAngle)*180/Math.PI);
  }
  function endRotate(){ rotating=false; document.removeEventListener('mousemove',onRotate); document.removeEventListener('mouseup',endRotate); }

  el.addEventListener('mousedown',e=>{
    if(!editEnabled) return;
    if(e.target.classList.contains('resizer')||e.target.classList.contains('rotator')) return;

    // allow caret when clicking text, but still start drag if you move
    const clickedText = e.target.closest('.scrap-text');
    if(!clickedText) e.preventDefault();

    selectedItem?.classList.remove('selected');
    selectedItem=el; el.classList.add('selected'); updateToolbarState();

    startX=e.clientX; startY=e.clientY; origX=el.offsetLeft; origY=el.offsetTop;
    document.addEventListener('mousemove',onMove); document.addEventListener('mouseup',onUp);
    e.stopPropagation();
  });

  function onMove(e){
    if(!editEnabled) return;

    if(resizing){
      const dx = e.clientX - startX, dy = e.clientY - startY;
      const hasImg   = !!el.querySelector('.scrap-img');
      const lockOn   = hasImg && el.dataset.lock === '1' && !e.shiftKey;
      const ratio    = parseFloat(el.dataset.aspect || (el.offsetWidth / Math.max(1, el.offsetHeight)));

      let newW = Math.max(60, startW + dx);
      let newH = Math.max(60, startH + dy);

      if (lockOn && ratio > 0){
        if (Math.abs(dx) >= Math.abs(dy)) { newH = Math.max(60, Math.round(newW / ratio)); }
        else { newW = Math.max(60, Math.round(newH * ratio)); }
      }
      el.style.width  = newW + 'px';
      el.style.height = newH + 'px';

      const sticker = el.querySelector('.scrap-text.sticker');
      if (sticker){
        const scale = 0.64;
        sticker.style.fontSize = Math.round(scale * Math.min(newW, newH)) + 'px';
      }
    }else{
      const dx=e.clientX-startX, dy=e.clientY-startY;
      // only treat as drag if movement > a few pixels (so single click can place caret)
      if (Math.abs(dx) + Math.abs(dy) > 2){
        el.style.left=(origX+dx)+'px'; el.style.top=(origY+dy)+'px';
      }
    }
  }
  function onUp(){
    document.removeEventListener('mousemove',onMove);
    document.removeEventListener('mouseup',onUp);
    resizing=false;
  }
}
function deselect(){ selectedItem?.classList.remove('selected'); selectedItem=null; updateToolbarState(); }

/* IMPORTANT: clicking toolbar or modal does NOT deselect */
document.addEventListener('click', e=>{
  if(!editEnabled) return;
  const onItem   = e.target.closest('.scrap-item');
  const onBar    = e.target.closest('#toolbar');
  const onModal  = e.target.closest('.modal');
  if(!onItem && !onBar && !onModal) deselect();
});

/* ========= Add text / photos / stickers ========= */
document.getElementById('addTextBtn').onclick=()=>{ openModal(textModal); textInput.value=''; setTimeout(()=>textInput.focus(),10); };
document.getElementById('textCancel').onclick=()=> closeModal(textModal);
document.getElementById('textAdd').onclick=()=>{
  const val=textInput.value.trim(); closeModal(textModal); if(!val) return;
  const box=document.createElement('div');
  box.className='scrap-item'; box.style.left='40px'; box.style.top='40px'; box.style.width='260px'; box.style.height='72px';
  const isEditing=document.body.classList.contains('editing');
  box.innerHTML=`<div class="scrap-text" contenteditable="${isEditing?'true':'false'}">${val}</div><div class="resizer"></div><div class="rotator"></div>`;
  (activeCanvas||getVisibleCanvases().right).appendChild(box); makeDraggable(box);
};

document.getElementById('addPhotoBtn').onclick=()=> fileInput.click();
fileInput.addEventListener('change',async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const { mime, base64 } = await compressToBase64(f, 1600, 0.85);

  const box=document.createElement('div');
  box.className='scrap-item'; box.style.left='90px'; box.style.top='90px'; box.style.width='320px'; box.style.height='230px';
  box.dataset.fit  = 'contain'; // default
  box.dataset.lock = '1';       // lock aspect ratio
  box.innerHTML=`<img class="scrap-img" alt="" src="data:${mime};base64,${base64}"><div class="resizer"></div><div class="rotator"></div>`;
  (activeCanvas||getVisibleCanvases().right).appendChild(box); makeDraggable(box);

  const imgEl = box.querySelector('.scrap-img');
  const setAspect = () => {
    if (imgEl.naturalWidth && imgEl.naturalHeight) {
      box.dataset.aspect = (imgEl.naturalWidth / imgEl.naturalHeight).toFixed(5);
    }
  };
  if (imgEl.complete) setAspect(); else imgEl.addEventListener('load', setAspect);

  imgEl._preb64 = { mime, base64 }; // Save will insert to DB
  fileInput.value='';
});

/* Stickers */
const STICKERS_EMOJI=["🎮","👾","🕹️","🖥️","⌨️","💞","🩷","🧡","💛","💚","💙","🩵","🤎","🖤","🩶","🤍","💋","💯","🍔","🍟","🍕","🌭","🥪","🍒","🍦","🍪","🎂","🍰","🧁","🍫"];
document.getElementById('stickersBtn').onclick=()=>{
  stickersGrid.innerHTML='';
  STICKERS_EMOJI.forEach(ch=>{
    const b=document.createElement('button'); b.textContent=ch; b.title=ch;
    b.onclick=()=>{
      const box=document.createElement('div');
      box.className='scrap-item'; box.style.left='60px'; box.style.top='60px'; box.style.width='100px'; box.style.height='100px';
      box.innerHTML=`<div class="scrap-text sticker" style="font-size:64px;" contenteditable="false">${ch}</div><div class="resizer"></div><div class="rotator"></div>`;
      (activeCanvas||getVisibleCanvases().right).appendChild(box); makeDraggable(box);
    };
    stickersGrid.appendChild(b);
  });
  openModal(stickerModal);
};
stickersClose.onclick=()=> closeModal(stickerModal);
stickerModal.addEventListener('click',e=>{ if(e.target===stickerModal) closeModal(stickerModal); });

/* ========= Word-style font size control ========= */
function selectedTextEl(){
  if(!selectedItem) return null;
  const t=selectedItem.querySelector('.scrap-text');
  if(!t || t.classList.contains('sticker')) return null;
  return t;
}
function updateFontInput(){
  const t = selectedTextEl();
  if(!t){ fontSizeInput.disabled=true; fontSizeInput.value=''; fontSizeInput.placeholder='px'; return; }
  fontSizeInput.disabled=false;
  const curr = Math.round(parseFloat(getComputedStyle(t).fontSize)||22);
  fontSizeInput.value = curr;
}
fontSizeInput.addEventListener('input', ()=>{
  const t = selectedTextEl(); if(!t) return;
  let v = parseInt(fontSizeInput.value,10);
  if(isNaN(v)) return;
  v = Math.max(8, Math.min(200, v));
  t.style.fontSize = v + 'px';
});

/* ========= Image fit/lock controls ========= */
function isImageBox(el){ return !!el?.querySelector?.('.scrap-img'); }
function updateImageButtons(){
  const onImg = isImageBox(selectedItem);
  fitBtn.disabled  = !onImg;
  lockBtn.disabled = !onImg;
  if (onImg){
    const fit  = selectedItem.dataset.fit  || 'contain';
    const lock = selectedItem.dataset.lock === '1';
    fitBtn.textContent  = 'Fit: ' + (fit === 'cover' ? 'Fill' : 'Contain');
    lockBtn.textContent = 'Lock: ' + (lock ? 'On' : 'Off');
  }else{
    fitBtn.textContent  = 'Fit: Contain';
    lockBtn.textContent = 'Lock: On';
  }
}
fitBtn.addEventListener('click', ()=>{
  if (!isImageBox(selectedItem)) return;
  const cur = selectedItem.dataset.fit || 'contain';
  selectedItem.dataset.fit = (cur === 'cover') ? 'contain' : 'cover';
  updateImageButtons();
});
lockBtn.addEventListener('click', ()=>{
  if (!isImageBox(selectedItem)) return;
  selectedItem.dataset.lock = (selectedItem.dataset.lock === '1') ? '0' : '1';
  updateImageButtons();
});
document.addEventListener('keydown', (e)=>{
  if (!isImageBox(selectedItem)) return;
  if (e.key.toLowerCase() === 'f'){ fitBtn.click(); }
  if (e.key.toLowerCase() === 'r'){ lockBtn.click(); }
});

/* ========= Keep toolbar in sync ========= */
function updateToolbarState(){ updateImageButtons(); updateFontInput(); }

/* ========= Page tools ========= */
document.getElementById('addPageBtn').onclick=()=>{
  const p=document.createElement('div'); p.className='page';
  const c=document.createElement('div'); c.className='page-canvas'; p.appendChild(c);
  bookEl.appendChild(p);
  pageFlip.loadFromHTML(document.querySelectorAll('#book .page'));
  toastShow('Page added');
};
document.getElementById('deleteSelectedBtn').onclick=()=>{ if(selectedItem){selectedItem.remove(); selectedItem=null; updateToolbarState();} };
document.getElementById('clearPageBtn').onclick=()=>{ (activeCanvas||getVisibleCanvases().right).innerHTML=''; deselect(); };

/* ========= SAVE -> Supabase tables ========= */
document.getElementById('saveBtn').onclick=()=>saveToTables().catch(e=>alert('Save failed: '+e));
async function saveToTables(){
  toastShow('Saving…');

  // Insert any new images
  const imgs=[...document.querySelectorAll('#book .scrap-img')];
  for(const img of imgs){
    if(img.dataset.imgid) continue;
    let mime, base64;
    if(img._preb64){ ({mime,base64}=img._preb64); }
    else { const r=await fetch(img.src); const b=await r.blob(); const enc=await compressToBase64(b,1600,0.85); mime=enc.mime; base64=enc.base64; }
    const { data, error } = await supabase
      .from(TABLE_IMAGES)
      .insert([{ content_type: mime, data_base64: base64 }])
      .select('id')
      .single();
    if(error) throw error;
    img.dataset.imgid = data.id;
    delete img._preb64;
  }

  // Build layout JSON and upsert
  const canvases=[...document.querySelectorAll('#book .page .page-canvas')];
  const pages=[];
  canvases.forEach(canvas=>{
    const items=[];
    canvas.querySelectorAll('.scrap-item').forEach(el=>{
      const style={left:el.style.left, top:el.style.top, width:el.style.width, height:el.style.height};
      const rot=parseFloat(el.dataset.rot||'0')||0;
      const img=el.querySelector('.scrap-img');
      if(img){
        items.push({
          type:'image', style, rot,
          imageId: img.dataset.imgid||null,
          fit: el.dataset.fit || 'contain',
          lock: el.dataset.lock === '1'
        });
      }else{
        const txt=el.querySelector('.scrap-text');
        items.push({type:'text', style, rot, html: txt?txt.outerHTML:''});
      }
    });
    pages.push({items});
  });

  const { error: upErr } = await supabase
    .from(TABLE_STATE)
    .upsert({ id: STATE_ID, pages })
    .select('id')
    .single();
  if(upErr) throw upErr;

  toastShow('Saved ✓'); setTimeout(()=>exitEdit(),300);
}

/* ========= LOAD <- Supabase tables ========= */
async function loadFromTables(){
  try{
    const { data:state } = await supabase
      .from(TABLE_STATE).select('pages').eq('id', STATE_ID).maybeSingle();
    if(!state || !state.pages) return;

    // ensure enough page shells
    const have=document.querySelectorAll('#book .page').length - 1;
    const need=state.pages.length;
    for(let i=have;i<need;i++){
      const p=document.createElement('div'); p.className='page';
      const c=document.createElement('div'); c.className='page-canvas'; p.appendChild(c);
      bookEl.appendChild(p);
    }

    // fetch needed images once
    const ids=[]; state.pages.forEach(pg=>pg.items?.forEach(it=>{ if(it.type==='image' && it.imageId) ids.push(it.imageId); }));
    const idSet=[...new Set(ids)];
    const urlMap={};
    if(idSet.length){
      const { data:imgs } = await supabase
        .from(TABLE_IMAGES).select('id, content_type, data_base64').in('id', idSet);
      if (imgs) { imgs.forEach(r => { urlMap[r.id] = `data:${r.content_type};base64,${r.data_base64}`; }); }
    }

    // rebuild
    const canvases=[...document.querySelectorAll('#book .page .page-canvas')];
    for(let i=0;i<Math.min(state.pages.length, canvases.length); i++){
      const canvas=canvases[i]; canvas.innerHTML='';
      for(const it of state.pages[i].items||[]){
        const box=document.createElement('div'); box.className='scrap-item';
        box.style.left=it.style?.left||'40px'; box.style.top=it.style?.top||'40px';
        if(it.style?.width)  box.style.width=it.style.width;
        if(it.style?.height) box.style.height=it.style.height;
        if(it.rot){ box.dataset.rot=it.rot; box.style.transform=`rotate(${it.rot}deg)`; }

        if(it.type==='image' && it.imageId){
          const url=urlMap[it.imageId]||'';
          box.dataset.fit  = it.fit  || 'contain';
          box.dataset.lock = it.lock ? '1' : '0';
          box.innerHTML=`<img class="scrap-img" data-imgid="${it.imageId}" src="${url}" alt=""><div class="resizer"></div><div class="rotator"></div>`;

          const imgEl = box.querySelector('.scrap-img');
          const setAspect = () => {
            if (imgEl.naturalWidth && imgEl.naturalHeight) {
              box.dataset.aspect = (imgEl.naturalWidth / imgEl.naturalHeight).toFixed(5);
            }
          };
          if (imgEl.complete) setAspect(); else imgEl.addEventListener('load', setAspect);

        }else if(it.type==='text' && it.html){
          const holder=document.createElement('div'); holder.innerHTML=it.html.trim();
          const inner=holder.firstElementChild || document.createElement('div');
          inner.setAttribute('contenteditable','false');
          box.appendChild(inner);
          box.insertAdjacentHTML('beforeend','<div class="resizer"></div><div class="rotator"></div>');
        }
        canvas.appendChild(box); makeDraggable(box);
      }
    }
  }catch(e){ console.warn('No saved state yet or load error', e); }
}

/* ========= Utilities ========= */
function openModal(el){ el.classList.add('open'); el.setAttribute('aria-hidden','false'); }
function closeModal(el){ el.classList.remove('open'); el.setAttribute('aria-hidden','true'); }
function toastShow(msg){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1200); }

let tapStart=null; function isTap(d,t){return d<8&&t<280}
bookEl.addEventListener('pointerdown',e=>{tapStart={x:e.clientX,y:e.clientY,t:Date.now()}},true);
bookEl.addEventListener('pointerup',e=>{ if(!tapStart)return; const d=Math.hypot(e.clientX-tapStart.x,e.clientY-tapStart.y); const dt=Date.now()-tapStart.t; if(isTap(d,dt)){e.preventDefault();e.stopPropagation()} tapStart=null },true);
['click','dblclick'].forEach(evt=>bookEl.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation()},true));

document.querySelectorAll('#book .scrap-item').forEach(makeDraggable);

/* image compression to keep table rows small */
async function compressToBase64(fileOrBlob, maxSide=1600, quality=0.85){
  const blob = fileOrBlob instanceof Blob ? fileOrBlob : new Blob([fileOrBlob]);
  const img = await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=URL.createObjectURL(blob); });
  const canvas = document.createElement('canvas');
  let {width:w, height:h} = img;
  if(Math.max(w,h) > maxSide){
    if(w>h){ h = Math.round(h * (maxSide / w)); w = maxSide; }
    else   { w = Math.round(w * (maxSide / h)); h = maxSide; }
  }
  canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
  const mime = 'image/jpeg';
  const dataUrl = canvas.toDataURL(mime, quality);
  URL.revokeObjectURL(img.src);
  const base64 = dataUrl.split(',')[1];
  return { mime, base64 };
}
</script>
</body>
</html>
