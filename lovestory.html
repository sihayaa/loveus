<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Our Scrapbook Story</title>
  <!-- avoid favicon 404 -->
  <link rel="icon" href="data:,">
  <style>
    :root{
      --night:#0b0f2f;
      --mint:#67e4ca;
      --paper:#f7eddc;
      --ink:#241a14;
      --accent:#7a5af8;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--night);
      height:100vh; display:flex; align-items:center; justify-content:center;
      font-family: Georgia, "Times New Roman", serif; overflow:hidden;
    }
    #book{ width:min(92vw,1100px); height:min(90vh,760px); }

    .page{
      width:100%; height:100%; position:relative;
      background:
        radial-gradient(ellipse at 50% -10%, rgba(0,0,0,.06), transparent 40%),
        url("https://www.transparenttextures.com/patterns/paper.png");
      background-color:var(--paper);
      border:3px solid rgba(0,0,0,.06);
      box-shadow: inset 0 0 60px rgba(0,0,0,.22);
      overflow:hidden;
    }
    .page-canvas{ position:relative; width:100%; height:100%; padding:28px; color:var(--ink); }

    /* Scrap items */
    .scrap-item{ position:absolute; cursor:move; user-select:none; transform-origin:top left; }
    .scrap-item.selected{ box-shadow:0 0 0 3px var(--accent); }
    .scrap-text{
      background:rgba(255,255,255,.55); backdrop-filter: blur(2px);
      padding:10px 12px; border-radius:8px; border:1px solid rgba(0,0,0,.1);
      min-width:120px; min-height:44px; white-space:pre-wrap;
    }
    .scrap-text[contenteditable="true"]{ outline:none; }
    .scrap-img{ display:block; border:6px solid #fff; border-radius:8px; box-shadow:4px 6px 18px rgba(0,0,0,.25); max-width:100%; max-height:100%; pointer-events:none; }
    .resizer{ position:absolute; right:-6px; bottom:-6px; width:16px; height:16px; border-radius:4px; background:var(--mint); border:2px solid #0b2c28; cursor:nwse-resize; }

    /* Secret toolbar (hidden until 123 typed) */
    #toolbar{
      position:fixed; bottom:18px; left:50%; transform:translateX(-50%);
      display:none; z-index:60; background:rgba(255,255,255,.92);
      border:2px solid #e8dcc6; border-radius:14px; padding:10px;
      box-shadow:0 10px 22px rgba(0,0,0,.25); gap:8px; flex-wrap:wrap; align-items:center;
    }
    #toolbar button{
      border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; color:#fff; background:var(--accent);
    }
    #toolbar button.secondary{ background:#5d47d4; }
    #toolbar button.mint{ background:var(--mint); color:#022d2c; }
    #toolbar button.warn{ background:#ff9aa2; color:#4c0a17; }
    #toolbar span.hint{ color:#333; font-size:14px; margin-left:6px; }

    /* Modal */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:70; background:rgba(0,0,0,.55); }
    .modal.open{ display:flex; }
    .modal-card{
      width:min(92vw,420px); background:#151a30; color:#fff; border:2px solid var(--mint);
      border-radius:14px; padding:20px; box-shadow:0 20px 40px rgba(0,0,0,.45);
    }
    .modal-card h3{ margin:0 0 10px; font-size:22px; letter-spacing:.3px; }
    .modal-card textarea{ width:100%; background:#0f1430; color:#fff; border:1px solid #2b3258; border-radius:10px; padding:10px 12px; margin-top:10px; font-family:inherit; font-size:16px; resize:vertical; }
    .modal-actions{ margin-top:12px; display:flex; gap:8px; justify-content:flex-end; }
    .modal-actions button{ border:0; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700; }
    .btn-mint{ background:var(--mint); color:#05201f; }
    .btn-ghost{ background:#2a315d; color:#fff; }

    /* Toast */
    #toast{ position:fixed; top:14px; right:14px; z-index:80; background:#11172f; color:#fff; border:2px solid var(--mint); padding:8px 12px; border-radius:10px; display:none; }
  </style>
</head>
<body>

  <!-- Book with 10 pages -->
  <div id="book">
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
  </div>

  <!-- Hidden editor toolbar (appears after typing 123) -->
  <div id="toolbar">
    <button id="addTextBtn" class="mint">Add Text</button>
    <button id="addPhotoBtn" class="secondary">Add Photo</button>
    <button id="addPageBtn" class="secondary">Add Page</button>
    <button id="deleteSelectedBtn" class="warn">Delete Selected</button>
    <button id="clearPageBtn" class="warn">Clear Page</button>
    <button id="saveBtn" class="mint">Save</button>
    <span class="hint">Press ESC to exit edit</span>
    <input id="fileInput" type="file" accept="image/*" hidden />
  </div>

  <!-- Text composer modal -->
  <div id="textModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>Add Text</h3>
      <textarea id="textInput" rows="5" placeholder="Write something sweet…"></textarea>
      <div class="modal-actions">
        <button class="btn-ghost" id="textCancel">Cancel</button>
        <button class="btn-mint" id="textAdd">Add Text</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast">Edit mode unlocked ✨</div>

  <!-- 1) Load your local PageFlip FIRST -->
  <script src="./flipbook/page-flip.browser.js"></script>

  <!-- 2) Then run your app -->
  <script>
    const PASSCODE = '123';
    const STORAGE_KEY = 'scrapbook_pages_v1';

    const bookEl   = document.getElementById('book');
    const toolbar  = document.getElementById('toolbar');
    const fileInput= document.getElementById('fileInput');
    const textModal= document.getElementById('textModal');
    const textInput= document.getElementById('textInput');
    const textAdd  = document.getElementById('textAdd');
    const textCancel = document.getElementById('textCancel');
    const toast    = document.getElementById('toast');

    // ---------- load saved into canvases BEFORE book init ----------
    applySaved();

    // ---------- PageFlip ----------
    const pageFlip = new St.PageFlip(bookEl, {
      width: 520,
      height: 700,
      size: "stretch",
      minWidth: 320,
      minHeight: 420,
      drawShadow: true,
      flippingTime: 800,
      showCover: true,
      useMouseEvents: true
    });
    pageFlip.loadFromHTML(document.querySelectorAll('#book .page'));

    // ---------- Always add to the page you're on (or clicked) ----------
    let activeCanvas =
      document.querySelectorAll('#book .page .page-canvas')[pageFlip.getCurrentPageIndex()] ||
      document.querySelector('#book .page .page-canvas');

    // When the page flips, update active canvas
    if (pageFlip.on) {
      pageFlip.on('flip', (e) => {
        const canvases = document.querySelectorAll('#book .page .page-canvas');
        const idx = (typeof e?.data === 'number')
          ? e.data
          : (e?.data?.page ?? (pageFlip.getCurrentPageIndex?.() ?? 0));
        activeCanvas = canvases[idx] || canvases[0];
      });
    }

    // Clicking any page makes it the target
    bookEl.addEventListener('pointerdown', (ev) => {
      const c = ev.target.closest('.page .page-canvas');
      if (c) activeCanvas = c;
    });

    function getActivePageCanvas(){
      if (activeCanvas && activeCanvas.isConnected) return activeCanvas;
      const canvases = document.querySelectorAll('#book .page .page-canvas');
      const idx = pageFlip.getCurrentPageIndex?.() ?? 0;
      return canvases[idx] || canvases[0];
    }

    // ---------- edit mode unlock ----------
    let editEnabled=false, selectedItem=null, keyBuffer='', keyTimer=null;
    document.addEventListener('keydown',(e)=>{
      if(e.key==='Escape' && editEnabled){ exitEdit(); return; }
      keyBuffer += e.key;
      clearTimeout(keyTimer);
      keyTimer=setTimeout(()=> keyBuffer='', 1200);
      if(keyBuffer.endsWith(PASSCODE)){ keyBuffer=''; enterEdit(); }
    });
    function enterEdit(){ editEnabled=true; toolbar.style.display='flex'; toastShow('Edit mode unlocked ✨'); }
    function exitEdit(){ editEnabled=false; toolbar.style.display='none'; deselect(); }

    // ---------- drag/resize ----------
    function makeDraggable(el){
      let startX=0,startY=0,origX=0,origY=0,resizing=false,startW=0,startH=0;
      const res=el.querySelector('.resizer');
      if(res){
        res.addEventListener('mousedown',(e)=>{
          if(!editEnabled) return; e.stopPropagation();
          resizing=true; startX=e.clientX; startY=e.clientY; startW=el.offsetWidth; startH=el.offsetHeight;
          document.addEventListener('mousemove',onMove); document.addEventListener('mouseup',onUp);
        });
      }
      el.addEventListener('mousedown',(e)=>{
        if(!editEnabled) return;
        if(e.target.classList.contains('resizer')) return;
        selectedItem?.classList.remove('selected'); selectedItem=el; el.classList.add('selected');
        startX=e.clientX; startY=e.clientY; origX=el.offsetLeft; origY=el.offsetTop;
        document.addEventListener('mousemove',onMove); document.addEventListener('mouseup',onUp);
      });
      function onMove(e){
        if(!editEnabled) return;
        if(resizing){
          const dx=e.clientX-startX, dy=e.clientY-startY;
          el.style.width=Math.max(60,startW+dx)+'px';
          el.style.height=Math.max(60,startH+dy)+'px';
        }else{
          const dx=e.clientX-startX, dy=e.clientY-startY;
          el.style.left=(origX+dx)+'px';
          el.style.top =(origY+dy)+'px';
        }
      }
      function onUp(){ document.removeEventListener('mousemove',onMove); document.removeEventListener('mouseup',onUp); resizing=false; }
    }
    function deselect(){ selectedItem?.classList.remove('selected'); selectedItem=null; }
    document.addEventListener('click',(e)=>{ if(editEnabled && !e.target.closest('.scrap-item')) deselect(); });

    // ---------- toolbar actions ----------
    document.getElementById('addTextBtn').addEventListener('click',()=>{
      textInput.value=''; openModal(textModal); setTimeout(()=>textInput.focus(),10);
    });
    textCancel.addEventListener('click',()=> closeModal(textModal));
    textAdd.addEventListener('click',()=>{
      const val=textInput.value.trim(); if(!val) return closeModal(textModal);
      const box=document.createElement('div');
      box.className='scrap-item'; box.style.left='40px'; box.style.top='40px'; box.style.width='260px';
      box.innerHTML=`<div class="scrap-text" contenteditable="true">${val}</div><div class="resizer" title="Resize"></div>`;
      getActivePageCanvas().appendChild(box); makeDraggable(box); closeModal(textModal);
    });

    document.getElementById('addPhotoBtn').addEventListener('click',()=> fileInput.click());
    fileInput.addEventListener('change',(e)=>{
      const f=e.target.files[0]; if(!f) return;
      const reader=new FileReader();
      reader.onload=(ev)=>{
        const box=document.createElement('div');
        box.className='scrap-item'; box.style.left='90px'; box.style.top='90px'; box.style.width='320px'; box.style.height='230px';
        box.innerHTML=`<img class="scrap-img" src="${ev.target.result}" alt=""><div class="resizer" title="Resize"></div>`;
        getActivePageCanvas().appendChild(box); makeDraggable(box); fileInput.value='';
      };
      reader.readAsDataURL(f);
    });

    document.getElementById('deleteSelectedBtn').addEventListener('click',()=>{ if(selectedItem){ selectedItem.remove(); selectedItem=null; }});
    document.getElementById('clearPageBtn').addEventListener('click',()=>{ getActivePageCanvas().innerHTML=''; deselect(); });

    document.getElementById('addPageBtn').addEventListener('click',()=>{
      const p=document.createElement('div'); p.className='page';
      const c=document.createElement('div'); c.className='page-canvas'; p.appendChild(c);
      bookEl.appendChild(p);
      pageFlip.loadFromHTML(document.querySelectorAll('#book .page'));
      // set target to the newly added page
      const canvases = document.querySelectorAll('#book .page .page-canvas');
      activeCanvas = canvases[canvases.length-1];
      toastShow('Page added');
    });

    document.getElementById('saveBtn').addEventListener('click',()=>{
      const pages=[...document.querySelectorAll('#book .page')].map(p=>p.querySelector('.page-canvas').innerHTML);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(pages));
      toastShow('Saved ✓');
    });

    // ---------- utils ----------
    function openModal(el){ el.classList.add('open'); el.setAttribute('aria-hidden','false'); }
    function closeModal(el){ el.classList.remove('open'); el.setAttribute('aria-hidden','true'); }
    function toastShow(msg){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1200); }

    function applySaved(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return;
        const arr = JSON.parse(raw);
        const canvases = document.querySelectorAll('#book .page .page-canvas');
        for(let i=0;i<Math.min(arr.length,canvases.length);i++){
          canvases[i].innerHTML = arr[i];
        }
        document.querySelectorAll('#book .scrap-item').forEach(makeDraggable);
      }catch(e){}
    }
  </script>
</body>
</html>
