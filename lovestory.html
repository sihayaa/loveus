<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Our Scrapbook Story</title>
<link rel="icon" href="data:,">
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&display=swap" rel="stylesheet">

<!-- Preload cover to avoid flicker/white seams -->
<link rel="preload" as="image" href="https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/lovestory_cover.png">

<style>
:root{
  --bg:#0b0f2f;       /* midnight blue */
  --paper:#f7eddc;    /* parchment */
  --ink:#0d2a6b;      /* dark blue ink */
  --accent:#7a5af8;
  --mint:#67e4ca;
  --font:"Dancing Script", cursive;
}

*{ box-sizing:border-box }
html,body{ height:100% }
body{
  margin:0; background:var(--bg); color:var(--ink);
  display:flex; align-items:center; justify-content:center; overflow:hidden;
  font-family:var(--font);
}

/* Stage & fixed-size book */
#stage{ width:1000px; height:650px; position:relative; perspective:1600px; }
#book{ position:absolute; inset:0; }

/* Page visuals */
.page{
  width:100%; height:100%; position:relative; overflow:hidden;
  background: radial-gradient(ellipse at 50% -10%, rgba(0,0,0,.07), transparent 40%);
  background-color: var(--paper);
  border:3px solid rgba(0,0,0,.06);
  box-shadow:inset 0 0 60px rgba(0,0,0,.22);
  backface-visibility:hidden; transform:translateZ(0);
}
.page-canvas{
  position:relative; width:100%; height:100%; padding:28px;
  color:var(--ink); font-family:var(--font);
  font-size:22px; line-height:1.35;
}

/* ---------- CLOSED COVER OVERLAY (book board, no zoom, no seams) ---------- */
#closedCover{
  position:absolute; inset:0; z-index:90; display:grid; place-items:center;
}
#closedCover .cover3D{
  width:1000px; height:650px; position:relative;
  transform-style:preserve-3d; transform-origin:left center;
  transition:transform .9s ease-in-out;
}
#closedCover .board{
  position:absolute; inset:0;
  background: #efe4cf;            /* board color */
  border-radius:18px;
  box-shadow: 0 20px 40px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.35);
  overflow:hidden;
}
/* inner jacket with 1px bleed to kill hairlines */
#closedCover .jacket{
  position:absolute; left:15px; right:15px; top:15px; bottom:15px; /* 1px bleed vs 16px lip */
  border-radius:12px;
  background: center / cover no-repeat url("https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/lovestory_cover.png");
  outline:1px solid #efe4cf; outline-offset:-1px;
  opacity:0; transition:opacity .12s ease-out;
}
#closedCover.ready .jacket{ opacity:1 }

/* spine shimmer + page edge hint to look like a book */
#closedCover .spine{
  position:absolute; left:0; top:0; bottom:0; width:30px; border-top-left-radius:18px; border-bottom-left-radius:18px;
  background:linear-gradient(90deg, rgba(0,0,0,.45), rgba(0,0,0,.15) 40%, rgba(255,255,255,.12));
}

/* open animation */
#closedCover.opening .cover3D{ transform:rotateY(-120deg); }

/* -------------- Edit items -------------- */
.scrap-item{ position:absolute; user-select:none; cursor:default; transform-origin:center center; }
.scrap-text{ background:transparent; border:0; padding:0; color:inherit; font:inherit; white-space:pre-wrap; }
.scrap-text[contenteditable="true"]{ outline:none; }
.scrap-img{ display:block; max-width:100%; max-height:100%; border:0; border-radius:0; box-shadow:none; pointer-events:none; }
.resizer{ display:none; }
.rotator{
  display:none; position:absolute; left:50%; top:-18px; transform:translate(-50%,-50%);
  width:18px; height:18px; border-radius:50%; background:#fff; border:3px solid var(--accent);
  box-shadow:0 2px 8px rgba(0,0,0,.25); cursor:grab;
}
.rotator:active{ cursor:grabbing; }

body.editing .scrap-item{ cursor:move; }
body.editing .scrap-item.selected{ box-shadow:0 0 0 3px var(--accent); }
body.editing .scrap-text{ background:rgba(255,255,255,.55); padding:10px 12px; border:1px solid rgba(0,0,0,.1); border-radius:8px; }
body.editing .scrap-img{ border:6px solid #fff; border-radius:8px; box-shadow:4px 6px 18px rgba(0,0,0,.25); }
body.editing .scrap-item .resizer{ display:block; position:absolute; right:-6px; bottom:-6px; width:16px; height:16px; border-radius:4px; background:var(--mint); border:2px solid #0b2c28; cursor:nwse-resize; }
body.editing .scrap-item .rotator{ display:block; }

body.editing .stf__block, body.editing .stf__item, body.editing .stf__wrapper{ pointer-events:none !important; }
body.editing .page-canvas, body.editing .scrap-item{ pointer-events:auto !important; }

#toolbar{
  position:absolute; left:50%; bottom:14px; transform:translateX(-50%);
  display:none; z-index:60; background:rgba(255,255,255,.92);
  border:2px solid #e8dcc6; border-radius:14px; padding:10px; gap:8px;
  box-shadow:0 10px 22px rgba(0,0,0,.25); align-items:center; flex-wrap:wrap;
}
#toolbar button{
  border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; color:#fff; background:var(--accent);
}
#toolbar button.secondary{ background:#5d47d4; }
#toolbar button.mint{ background:var(--mint); color:#022d2c; }
#toolbar button.warn{ background:#ff9aa2; color:#4c0a17; }
#toolbar .group{ display:flex; gap:8px; align-items:center; }
#fileInput{ display:none; }

/* Modals */
.modal{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; z-index:70; background:rgba(0,0,0,.55); }
.modal.open{ display:flex; }
.modal-card{ width:min(96%,560px); background:#151a30; color:#fff; border:2px solid var(--mint); border-radius:14px; padding:16px; box-shadow:0 20px 40px rgba(0,0,0,.45); }
.modal-card h3{ margin:0 0 10px; font-size:20px; }
#textModal textarea{ width:100%; background:#0f1430; color:#fff; border:1px solid #2b3258; border-radius:10px; padding:10px 12px; font-family:var(--font); font-size:20px; resize:vertical; }
.modal-actions{ margin-top:12px; display:flex; justify-content:flex-end; gap:8px; }
.modal-actions button{ border:0; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700; }
.btn-mint{ background:var(--mint); color:#05201f; }
.btn-ghost{ background:#2a315d; color:#fff; }

/* Stickers grid */
.stickers{ display:grid; grid-template-columns:repeat(8,1fr); gap:8px; }
.stickers button{ background:#0f1430; border:1px solid #2b3258; border-radius:10px; padding:10px; cursor:pointer; font-size:26px; line-height:1; }
.stickers img{ width:100%; aspect-ratio:1; object-fit:contain; }

#toast{ position:absolute; top:12px; right:12px; z-index:95; background:#11172f; color:#fff; border:2px solid var(--mint); padding:8px 12px; border-radius:10px; display:none; }
.page-canvas.active-side{ outline:3px dashed var(--accent); outline-offset:-12px; }
</style>
</head>
<body>

<div id="stage">
  <!-- CLOSED COVER OVERLAY -->
  <div id="closedCover" title="Drag or click to open">
    <div class="cover3D">
      <div class="board">
        <div class="jacket"></div>
        <div class="spine"></div>
      </div>
    </div>
  </div>

  <!-- Flipbook (pages are blank; you add content in edit mode) -->
  <div id="book">
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
  </div>

  <!-- Toolbar -->
  <div id="toolbar">
    <div class="group">
      <button id="targetLeft" class="secondary">Edit Left</button>
      <button id="targetRight" class="secondary">Edit Right</button>
    </div>
    <div class="group">
      <button id="addTextBtn" class="mint">Add Text</button>
      <button id="addPhotoBtn" class="secondary">Add Photo</button>
      <button id="stickersBtn" class="secondary">Stickers</button>
      <button id="addPageBtn" class="secondary">Add Page</button>
    </div>
    <div class="group">
      <button id="deleteSelectedBtn" class="warn">Delete Selected</button>
      <button id="clearPageBtn" class="warn">Clear Page</button>
      <button id="saveBtn" class="mint">Save</button>
    </div>
    <input id="fileInput" type="file" accept="image/*" />
  </div>

  <!-- Text modal -->
  <div id="textModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>Add Text</h3>
      <textarea id="textInput" rows="5" placeholder="Write something sweet…"></textarea>
      <div class="modal-actions">
        <button class="btn-ghost" id="textCancel">Cancel</button>
        <button class="btn-mint" id="textAdd">Add Text</button>
      </div>
    </div>
  </div>

  <!-- Stickers (emoji) modal -->
  <div id="stickerModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>Pick a sticker</h3>
      <div class="stickers" id="stickersGrid"></div>
      <div class="modal-actions">
        <button class="btn-ghost" id="stickersClose">Close</button>
      </div>
    </div>
  </div>

  <div id="toast">Edit mode unlocked ✨</div>
</div>

<!-- Try local lib first -->
<script id="pf-local" src="./flipbook/page-flip.browser.js"></script>
<script>
/* ---------- Loader: local -> CDN fallback ---------- */
(function(){
  const PASSCODE='123';
  const STORAGE_KEY='scrapbook_v8';
  const COVER_URL='https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/lovestory_cover.png';

  function start(){
    // Cover preload (no seams/flicker)
    const cc = document.getElementById('closedCover');
    const pre = new Image(); pre.decoding='async'; pre.src=COVER_URL;
    if (pre.complete) cc.classList.add('ready'); else pre.onload = ()=> cc.classList.add('ready');

    const bookEl = document.getElementById('book');
    /* Flipbook init */
    const pageFlip = new St.PageFlip(bookEl, {
      width: 500, height: 650,
      size: "fixed",
      showCover: true,
      drawShadow: true,
      flippingTime: 800,
      maxShadowOpacity: 0.25,
      useMouseEvents: true,
      mobileScrollSupport: false,
      startPage: 0
    });
    pageFlip.loadFromHTML(document.querySelectorAll('#book .page'));

    /* Drag-only flipping: block taps/clicks */
    let tapStart=null;
    function isTap(d,t){ return d<8 && t<300; }
    bookEl.addEventListener('pointerdown',e=>{ tapStart={x:e.clientX,y:e.clientY,t:Date.now()}; }, true);
    bookEl.addEventListener('pointerup',e=>{
      if(!tapStart) return;
      const d=Math.hypot(e.clientX-tapStart.x, e.clientY-tapStart.y);
      const dt=Date.now()-tapStart.t;
      if(isTap(d,dt)){ e.preventDefault(); e.stopPropagation(); }
      tapStart=null;
    }, true);
    bookEl.addEventListener('click',e=>{ e.preventDefault(); e.stopPropagation(); }, true);
    bookEl.addEventListener('dblclick',e=>{ e.preventDefault(); e.stopPropagation(); }, true);

    /* Cover open */
    function openCover(){
      cc.classList.add('opening');
      setTimeout(()=>{ cc.style.display='none'; try{ pageFlip.turnToPage(1);}catch(_){ } }, 900);
    }
    let dragStart=null;
    cc.addEventListener('pointerdown',e=> dragStart={x:e.clientX,y:e.clientY});
    cc.addEventListener('pointerup',e=>{
      if(!dragStart) return;
      const dx=e.clientX-dragStart.x;
      if(Math.abs(dx)>40) openCover(); else openCover(); // click or short drag
      dragStart=null;
    });
    cc.addEventListener('click', openCover);

    /* --------- Editing --------- */
    const toolbar=document.getElementById('toolbar');
    const toast=document.getElementById('toast');
    const textModal=document.getElementById('textModal');
    const textInput=document.getElementById('textInput');
    const stickerModal=document.getElementById('stickerModal');
    const stickersGrid=document.getElementById('stickersGrid');
    const fileInput=document.getElementById('fileInput');

    function openModal(el){ el.classList.add('open'); el.setAttribute('aria-hidden','false'); }
    function closeModal(el){ el.classList.remove('open'); el.setAttribute('aria-hidden','true'); }
    function toastShow(msg){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1200); }

    let editEnabled=false, selectedItem=null, activeCanvas=null, keyBuffer='', keyTimer=null;

    function setAllTextEditable(on){
      document.querySelectorAll('#book .scrap-text')
        .forEach(el=> el.setAttribute('contenteditable', on?'true':'false'));
    }
    function setEditing(on){
      if(on){ document.body.classList.add('editing'); setAllTextEditable(true); toolbar.style.display='flex'; }
      else  { document.body.classList.remove('editing'); setAllTextEditable(false); toolbar.style.display='none';
              document.querySelectorAll('.page-canvas').forEach(c=>c.classList.remove('active-side')); activeCanvas=null; }
    }
    function enterEdit(){
      editEnabled=true; setEditing(true); setActiveCanvas('right');
      try{ pageFlip.update?.({useMouseEvents:false, swipeDistance:10000}); }catch(_){}
      toastShow('Edit mode unlocked ✨');
    }
    function exitEdit(){
      editEnabled=false; setEditing(false); selectedItem=null;
      try{ pageFlip.update?.({useMouseEvents:true, swipeDistance:30}); }catch(_){}
    }

    document.addEventListener('keydown',(e)=>{
      keyBuffer += e.key; clearTimeout(keyTimer); keyTimer=setTimeout(()=> keyBuffer='', 1200);
      if(keyBuffer.endsWith(PASSCODE)){ keyBuffer=''; enterEdit(); }
    });

    /* Which canvases are visible */
    function getVisibleCanvases(){
      let left = document.querySelector('.stf__item--left  .page .page-canvas');
      let right= document.querySelector('.stf__item--right .page .page-canvas');
      if(left || right) return {left,right};
      const canvases=[...document.querySelectorAll('#book .page .page-canvas')];
      const idx=pageFlip.getCurrentPageIndex?.() ?? 0;
      if(idx===0) return {left:null, right:canvases[0]};
      const base = idx%2===0 ? idx : idx-1;
      return {left:canvases[base], right:canvases[base+1]||null};
    }
    function setActiveCanvas(side){
      const {left,right}=getVisibleCanvases();
      const next = side==='left'? left : right;
      if(!next) return;
      document.querySelectorAll('.page-canvas').forEach(c=>c.classList.remove('active-side'));
      next.classList.add('active-side');
      activeCanvas = next;
    }
    document.getElementById('targetLeft').addEventListener('click', ()=> setActiveCanvas('left'));
    document.getElementById('targetRight').addEventListener('click',()=> setActiveCanvas('right'));
    if(pageFlip.on){ pageFlip.on('flip', ()=>{ if(!activeCanvas) setActiveCanvas('right'); }); }

    /* Drag/Resize/Rotate */
    function makeDraggable(el){
      let startX=0,startY=0,origX=0,origY=0, resizing=false,startW=0,startH=0, rotating=false,startAngle=0,startPointerAngle=0;
      const res=el.querySelector('.resizer');
      let rot=el.querySelector('.rotator'); if(!rot){ rot=document.createElement('div'); rot.className='rotator'; el.appendChild(rot); }
      function getAngle(){ return parseFloat(el.dataset.rot||'0')||0; }
      function setAngle(d){ el.dataset.rot=String(d); el.style.transform=`rotate(${d}deg)`; }

      if(res){ res.addEventListener('mousedown',(e)=>{ if(!editEnabled) return; e.stopPropagation(); e.preventDefault();
        resizing=true; startX=e.clientX; startY=e.clientY; startW=el.offsetWidth; startH=el.offsetHeight;
        document.addEventListener('mousemove',onMove); document.addEventListener('mouseup',onUp); });
      }
      rot.addEventListener('mousedown',(e)=>{ if(!editEnabled) return; e.stopPropagation(); e.preventDefault();
        rotating=true; const r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
        startPointerAngle=Math.atan2(e.clientY-cy, e.clientX-cx); startAngle=getAngle();
        document.addEventListener('mousemove',onRotate); document.addEventListener('mouseup',endRotate); });
      function onRotate(e){ if(!rotating) return;
        const r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
        const a=Math.atan2(e.clientY-cy, e.clientX-cx);
        setAngle(startAngle + (a-startPointerAngle)*180/Math.PI);
      }
      function endRotate(){ rotating=false; document.removeEventListener('mousemove',onRotate); document.removeEventListener('mouseup',endRotate); }

      el.addEventListener('mousedown',(e)=>{ if(!editEnabled) return;
        if(e.target.classList.contains('resizer') || e.target.classList.contains('rotator')) return;
        selectedItem?.classList.remove('selected'); selectedItem=el; el.classList.add('selected');
        startX=e.clientX; startY=e.clientY; origX=el.offsetLeft; origY=el.offsetTop;
        document.addEventListener('mousemove',onMove); document.addEventListener('mouseup',onUp); e.stopPropagation();
      });
      function onMove(e){ if(!editEnabled) return;
        if(resizing){
          const dx=e.clientX-startX, dy=e.clientY-startY;
          el.style.width=Math.max(60,startW+dx)+'px'; el.style.height=Math.max(60,startH+dy)+'px';
          if(el.classList.contains('emoji')){
            const s=Math.min(el.offsetWidth, el.offsetHeight)*0.8; el.style.fontSize=s+'px';
          }
        }else{
          const dx=e.clientX-startX, dy=e.clientY-startY;
          el.style.left=(origX+dx)+'px'; el.style.top =(origY+dy)+'px';
        }
      }
      function onUp(){ document.removeEventListener('mousemove',onMove); document.removeEventListener('mouseup',onUp); resizing=false; }
    }
    function deselect(){ selectedItem?.classList.remove('selected'); selectedItem=null; }
    document.addEventListener('click',(e)=>{ if(editEnabled && !e.target.closest('.scrap-item')) deselect(); });

    /* Add text / photo */
    document.getElementById('addTextBtn').addEventListener('click',()=>{ openModal(textModal); textInput.value=''; setTimeout(()=>textInput.focus(),10); });
    document.getElementById('textCancel').addEventListener('click',()=> closeModal(textModal));
    document.getElementById('textAdd').addEventListener('click',()=>{
      const val=textInput.value.trim(); closeModal(textModal); if(!val) return;
      const box=document.createElement('div');
      box.className='scrap-item'; box.style.left='40px'; box.style.top='40px'; box.style.width='260px';
      const isEditing=document.body.classList.contains('editing');
      box.innerHTML=`<div class="scrap-text" contenteditable="${isEditing?'true':'false'}">${val}</div><div class="resizer"></div><div class="rotator"></div>`;
      (activeCanvas||getVisibleCanvases().right).appendChild(box); makeDraggable(box);
    });

    document.getElementById('addPhotoBtn').addEventListener('click',()=> fileInput.click());
    fileInput.addEventListener('change',(e)=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=(ev)=>{
        const box=document.createElement('div');
        box.className='scrap-item'; box.style.left='90px'; box.style.top='90px'; box.style.width='320px'; box.style.height='230px';
        box.innerHTML=`<img class="scrap-img" src="${ev.target.result}" alt=""><div class="resizer"></div><div class="rotator"></div>`;
        (activeCanvas||getVisibleCanvases().right).appendChild(box); makeDraggable(box); fileInput.value='';
      };
      r.readAsDataURL(f);
    });

    /* Emoji stickers */
    const EMOJIS = ["🎮","👾","🕹️","🖥️","⌨️","💞","🩷","🧡","💛","💚","💙","🩵","🤎","🖤","🩶","🤍","💋","💯","💢","🏜️","🏝️","✈️","♾️","🍎","🍏","🍞","🥐","🥖","🫓","🥨","🥯","🥞","🧇","🧀","🍖","🍗","🥩","🥓","🍔","🍟","🍕","🌭","🥪","🌮","🌯","🫔","🥙","🧆","🥚","🍳","🥘","🫕","🥣","🥗","🍿","🧈","🧂","🥫","🍝","🍐","🍑","🍒","🍦","🍧","🍨","🍩","🍪","🎂","🍰","🧁","🥧","🍫","🍬","🍭","🍮","🍯"];
    function openStickers(){
      stickersGrid.innerHTML='';
      EMOJIS.forEach(ch=>{
        const b=document.createElement('button'); b.textContent=ch; b.title=ch;
        b.addEventListener('click',()=>{
          const box=document.createElement('div');
          box.className='scrap-item emoji'; box.style.left='60px'; box.style.top='60px'; box.style.width='120px'; box.style.height='120px'; box.style.display='grid'; box.style.placeItems='center'; box.style.fontSize='96px';
          box.innerHTML=`<div>${ch}</div><div class="resizer"></div><div class="rotator"></div>`;
          (activeCanvas||getVisibleCanvases().right).appendChild(box); makeDraggable(box);
        });
        stickersGrid.appendChild(b);
      });
      openModal(stickerModal);
    }
    document.getElementById('stickersBtn').addEventListener('click', openStickers);
    stickerModal.addEventListener('click',(e)=>{ if(e.target===stickerModal) closeModal(stickerModal); });
    document.getElementById('stickersClose').addEventListener('click',()=> closeModal(stickerModal));

    /* Page tools */
    document.getElementById('addPageBtn').addEventListener('click',()=>{
      const p=document.createElement('div'); p.className='page';
      const c=document.createElement('div'); c.className='page-canvas'; p.appendChild(c);
      bookEl.appendChild(p);
      pageFlip.loadFromHTML(document.querySelectorAll('#book .page'));
      toastShow('Page added');
    });
    document.getElementById('deleteSelectedBtn').addEventListener('click',()=>{ if(selectedItem){ selectedItem.remove(); selectedItem=null; }});
    document.getElementById('clearPageBtn').addEventListener('click',()=>{ (activeCanvas||getVisibleCanvases().right).innerHTML=''; deselect(); });

    /* Save => persist + auto-exit */
    document.getElementById('saveBtn').addEventListener('click',()=>{
      const pages=[...document.querySelectorAll('#book .page')].map(p=>p.querySelector('.page-canvas').innerHTML);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(pages));
      toastShow('Saved ✓ Exiting…');
      setTimeout(()=> exitEdit(), 300);
    });

    /* Apply saved content */
    (function applySaved(){
      try{
        const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return;
        const arr=JSON.parse(raw);
        const canvases=document.querySelectorAll('#book .page .page-canvas');
        for(let i=0;i<Math.min(arr.length,canvases.length);i++){ canvases[i].innerHTML=arr[i]; }
        document.querySelectorAll('#book .scrap-item').forEach(makeDraggable);
      }catch(e){}
    })();
  }

  function tryStart(){
    if(window.St && St.PageFlip){ start(); return; }
    // local script tag
    const s=document.getElementById('pf-local');
    function go(){ if(window.St && St.PageFlip) start(); else fallback(); }
    function fallback(){
      const cdn=document.createElement('script');
      cdn.src='https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js';
      cdn.onload=()=> (window.St && St.PageFlip) ? start() : alert('PageFlip library not found.');
      document.head.appendChild(cdn);
    }
    if(s){ s.addEventListener('load', go); s.addEventListener('error', fallback); }
    else { fallback(); }
  }
  tryStart();
})();
</script>
</body>
</html>
