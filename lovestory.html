<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Our Scrapbook Story</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:,">
<link href="https://fonts.googleapis.com/css2?family=Lobster&display=swap" rel="stylesheet">
<link rel="preload" as="image" href="./lovestory_cover.png?v=8" fetchpriority="high">

<style>
:root{
  --bg:#0b0f2f; --paper:#f7eddc; --ink:#0d2a6b;
  --accent:#7a5af8; --mint:#67e4ca;
  --font:"Lobster", cursive;
  --cover-y:28%;
  --cover-img:url("./lovestory_cover.png?v=8");
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--ink);
  display:flex; align-items:center; justify-content:center; overflow:hidden;
  font-family:var(--font);
}

/* Boot */
#boot{ position:fixed; inset:0; display:grid; place-items:center; background:#0b0f2f; color:#67e4ca; z-index:9999;
  font:600 18px/1.2 system-ui,Segoe UI,sans-serif; letter-spacing:.4px; transition:opacity .35s ease; }
#boot .card{ text-align:center; padding:18px 22px; border:2px solid #67e4ca55; border-radius:12px; box-shadow:0 12px 30px rgba(0,0,0,.35); max-width:520px; }
#boot.hide{ opacity:0; pointer-events:none; }
#retryBtn{ margin-top:10px; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:800; color:#022d2c; background:var(--mint); display:none; }

/* Stage & Book */
#stage{ width:1000px; height:650px; position:relative; }
#book { position:absolute; inset:0; visibility:hidden; }

/* Pages */
.page{ width:100%; height:100%; position:relative; overflow:hidden; background:var(--paper); box-shadow: inset 0 0 60px rgba(0,0,0,.22); }
.page-canvas{ position:relative; width:100%; height:100%; padding:28px; color:var(--ink); font-size:22px; line-height:1.35; }

/* Cover */
.page.cover{ box-shadow:0 8px 28px rgba(0,0,0,.35); }
.page.cover .page-canvas{
  padding:0; background:#0c102c;
  background-image:var(--cover-img);
  background-size:cover; background-position:50% var(--cover-y); background-repeat:no-repeat;
}

/* Items */
.scrap-item{ position:absolute; transform-origin:center; touch-action:none; overflow:visible; }
.scrap-item.selected{ box-shadow:0 0 0 3px var(--accent); }
.rotator{ display:none; position:absolute; left:50%; top:-18px; transform:translate(-50%,-50%); width:18px; height:18px; border-radius:50%;
  background:#fff; border:3px solid var(--accent); box-shadow:0 2px 8px rgba(0,0,0,.25); cursor:grab; z-index:999; }
.mover{ display:none; position:absolute; left:-10px; top:-10px; width:18px; height:18px; border-radius:50%; background:#fff; border:3px solid var(--accent); cursor:grab; }
.resizer{ display:none; position:absolute; right:-6px; bottom:-6px; width:16px; height:16px; border-radius:4px; background:var(--mint); border:2px solid #0b2c28; cursor:nwse-resize; }

.scrap-img{ display:block; width:100%; height:100%; object-fit:contain; user-select:none; pointer-events:none; }
.scrap-item[data-fit="cover"] .scrap-img{ object-fit:cover; }
.scrap-text{ width:100%; background:transparent; border:0; color:inherit; font:inherit; white-space:pre-wrap; overflow:visible; min-height:1.2em; }

/* Only interactive while editing */
.page .page-canvas, .scrap-item { pointer-events:none; }
body.editing .page .page-canvas, body.editing .scrap-item { pointer-events:auto; }
body.editing .scrap-item{ cursor:move; }
body.editing .scrap-item .rotator, body.editing .scrap-item .mover, body.editing .scrap-item .resizer{ display:block; }

/* Toolbar (trimmed) */
#toolbar{ position:fixed; right:16px; top:50%; transform:translateY(-50%); z-index:100; background:#fff; border:2px solid #e8dcc6; border-radius:14px; padding:12px;
  width:260px; gap:10px; box-shadow:0 10px 22px rgba(0,0,0,.25); display:none; flex-direction:column; }
#toolbar.open{ display:flex; }
#toolbar .group{ display:flex; gap:8px; flex-wrap:wrap; }
#toolbar button{ border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; color:#fff; background:var(--accent); width:100%; }
#toolbar button.secondary{ background:#5d47d4; }
#toolbar button.mint{ background:var(--mint); color:#022d2c; }
#toolbar button.warn{ background:#ff9aa2; color:#4c0a17; }
#toolbar input[type="number"]{ width:100%; padding:8px; border-radius:8px; border:2px solid #e8dcc6; font-weight:700; color:#0d2a6b; background:#fff; }
#toolbar input[type="color"]{ width:100%; height:40px; padding:0; border:2px solid #e8dcc6; border-radius:8px; background:#fff; }
#fileInput{ display:none; }

#toast{ position:absolute; top:12px; right:12px; z-index:95; background:#11172f; color:#fff; border:2px solid var(--mint); padding:8px 12px; border-radius:10px; display:none; }
.page-canvas.active-side{ outline:3px dashed var(--accent); outline-offset:-12px; }

/* HUD */
#itemHud{ position:absolute; z-index:120; display:none; background:#151a30; color:#fff; border:2px solid #fff2; border-radius:10px; padding:6px; gap:6px;
  box-shadow:0 12px 24px rgba(0,0,0,.35); align-items:center; flex-wrap:wrap; }
#itemHud button{ border:0; padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:700; font-size:12px; color:#fff; background:#5d47d4; }
#itemHud button.warn{ background:#ff9aa2; color:#4c0a17; }
#itemHud button.mint{ background:var(--mint); color:#022d2c; }
#itemHud input[type="number"]{ width:70px; padding:6px 8px; border-radius:8px; border:2px solid #2b3258; background:#0f1430; color:#fff; font-weight:700; font-size:12px; }

/* Big Text Editor */
#textEditor{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:10000;align-items:center;justify-content:center}
#textEditor.open{display:flex}
#textEditor .panel{width:min(820px,90vw);background:#fff;border-radius:16px;padding:18px;border:2px solid #e8dcc6;box-shadow:0 20px 60px rgba(0,0,0,.5)}
#textEditor textarea{width:100%;height:320px;font:28px/1.35 var(--font);color:var(--ink);padding:12px;border:2px solid #e8dcc6;border-radius:12px;resize:vertical}
#textEditor .row{display:flex;gap:12px;margin-top:10px}
#textEditor input[type="number"]{flex:1;padding:10px;border-radius:10px;border:2px solid #e8dcc6;font-weight:700;color:#0d2a6b}
#textEditor input[type="color"]{width:80px;height:44px;border-radius:10px;border:2px solid #e8dcc6}
#textEditor .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
#textEditor button{border:0;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer}
#editorCancel{background:#ff9aa2;color:#4c0a17}
#editorSave{background:var(--mint);color:#022d2c}
</style>
</head>
<body>

<div id="boot">
  <div class="card">
    <div id="bootMsg">loading scrapbook…</div>
    <button id="retryBtn">Try again</button>
  </div>
</div>

<div id="stage">
  <div id="book">
    <!-- COVER -->
    <div class="page cover"><div class="page-canvas"></div></div>
  </div>

  <!-- Trimmed toolbar -->
  <div id="toolbar">
    <div class="group">
      <button id="targetLeft" class="secondary">Edit Left</button>
      <button id="targetRight" class="secondary">Edit Right</button>
    </div>
    <div class="group">
      <button id="addTextBtn" class="mint">Add Text</button>
      <button id="addPhotoBtn" class="secondary">Add Photo</button>
    </div>
    <div class="group">
      <label for="fontSizeInput" style="font-weight:700;color:#0d2a6b;">Text Size (px)</label>
      <input id="fontSizeInput" type="number" min="8" max="200" step="1" placeholder="px" disabled>
    </div>
    <div class="group">
      <label for="fontColorInput" style="font-weight:700;color:#0d2a6b;">Text Color</label>
      <input id="fontColorInput" type="color" value="#0d2a6b" disabled>
    </div>
    <div class="group">
      <button id="fitToggleBtn"  class="secondary">Fit: Contain</button>
      <button id="lockToggleBtn" class="secondary">Lock: On</button>
    </div>
    <div class="group">
      <button id="deleteSelectedBtn" class="warn">Delete Selected</button>
      <button id="clearPageBtn" class="warn">Clear Page</button>
      <button id="saveBtn" class="mint">Save</button>
    </div>
    <input id="fileInput" type="file" accept="image/*" />
  </div>

  <!-- HUD -->
  <div id="itemHud" aria-hidden="true">
    <button id="hudEdit"  class="mint only-text">Edit</button>
    <input  id="hudFont"  class="only-text" type="number" min="8" max="200" step="1" placeholder="size">
    <button id="hudFit"   class="only-img">Fit: Contain</button>
    <button id="hudLock"  class="only-img">Lock: On</button>
    <button id="hudRotL" title="Rotate left 5°">↺ 5°</button>
    <input  id="hudRot"  type="number" step="1" style="width:70px" placeholder="deg">
    <button id="hudRotR" title="Rotate right 5°">↻ 5°</button>
    <button id="hudDup">Duplicate</button>
    <button id="hudFront">Front</button>
    <button id="hudBack">Back</button>
    <button id="hudDelete" class="warn">Delete</button>
  </div>

  <!-- Big Text Editor -->
  <div id="textEditor" aria-hidden="true">
    <div class="panel">
      <h3 style="margin:0 0 8px;color:#0d2a6b">Edit Text</h3>
      <textarea id="editorInput" placeholder="type here…"></textarea>
      <div class="row">
        <label style="font-weight:700;color:#0d2a6b;display:flex;align-items:center;gap:8px;">
          Size (px)
          <input id="editorSize" type="number" min="8" max="200" step="1" value="28">
        </label>
        <label style="font-weight:700;color:#0d2a6b;display:flex;align-items:center;gap:8px;">
          Color
          <input id="editorColor" type="color" value="#0d2a6b">
        </label>
      </div>
      <div class="actions">
        <button id="editorCancel">Cancel</button>
        <button id="editorSave">Save</button>
      </div>
    </div>
  </div>

  <div id="toast">Edit mode unlocked ✨</div>
</div>

<script src="./flipbook/page-flip.browser.js"></script>
<script>
/* ==== Layout choices ==== */
var LEADING_BLANKS_DESIRED = 2;   // After cover: pages 1 & 2 blank
var TRAILING_BLANKS_DESIRED = 4;  // Append 4 blanks at end on load

/* ==== Supabase (REST) ==== */
var SUPABASE_URL  = "https://tmjozxcjylcxgemffnoc.supabase.co";
var SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
var TABLE_IMAGES="scrapbook_images";
var TABLE_STATE ="scrapbook_state";
var STATE_ID="main";
var sbHeaders = { apikey: SUPABASE_ANON, Authorization: "Bearer " + SUPABASE_ANON, "Content-Type":"application/json", Accept:"application/json" };

/* ==== Refs ==== */
var bookEl   = document.getElementById('book');
var stageEl  = document.getElementById('stage');
var toolbar  = document.getElementById('toolbar');
var toast    = document.getElementById('toast');
var fileInput= document.getElementById('fileInput');
var boot     = document.getElementById('boot');
var bootMsg  = document.getElementById('bootMsg');
var retryBtn = document.getElementById('retryBtn');

var fontSizeInput=document.getElementById('fontSizeInput');
var fitBtn=document.getElementById('fitToggleBtn');
var lockBtn=document.getElementById('lockToggleBtn');
var fontColorInput=document.getElementById('fontColorInput');

var itemHud   = document.getElementById('itemHud');
var hudEdit   = document.getElementById('hudEdit');
var hudFont   = document.getElementById('hudFont');
var hudFit    = document.getElementById('hudFit');
var hudLock   = document.getElementById('hudLock');
var hudDup    = document.getElementById('hudDup');
var hudFront  = document.getElementById('hudFront');
var hudBack   = document.getElementById('hudBack');
var hudDelete = document.getElementById('hudDelete');
var hudRot    = document.getElementById('hudRot');
var hudRotL   = document.getElementById('hudRotL');
var hudRotR   = document.getElementById('hudRotR');

var pageFlip=null, activeCanvas=null, selectedItem=null, lastPageIndex=0;
var zCounter = 10;
var leadingPrepended = 0;

/* ==== Helpers ==== */
function toastShow(msg){ toast.textContent=msg; toast.style.display='block'; setTimeout(function(){toast.style.display='none';},1600); }
function afterBootShow(){ bookEl.style.visibility='visible'; }
function deselect(){ if(selectedItem){ selectedItem.classList.remove('selected'); } selectedItem=null; updateToolbarState(); hideItemHud(); }
function rgbToHex(rgb){
  var m=String(rgb).match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
  if(!m) return '#000000';
  var r=(+m[1]).toString(16).padStart(2,'0'), g=(+m[2]).toString(16).padStart(2,'0'), b=(+m[3]).toString(16).padStart(2,'0');
  return '#'+r+g+b;
}

/* ==== Flip ==== */
function initFlip(startIndex){
  if(typeof startIndex!=='number') startIndex=0;
  try{ if(pageFlip && typeof pageFlip.destroy==='function') pageFlip.destroy(); }catch(_){}
  if(!(window.St && St.PageFlip)){ alert("PageFlip library missing."); afterBootShow(); return; }
  pageFlip = new St.PageFlip(bookEl,{
    width:500,height:650,size:"fixed",
    showCover:true, drawShadow:true, flippingTime:800, maxShadowOpacity:0.25,
    useMouseEvents:true, mobileScrollSupport:false, startPage:Math.max(0,startIndex|0)
  });
  pageFlip.loadFromHTML(document.querySelectorAll('#book .page'));
  pageFlip.on('flip', function(){
    if(!document.body.classList.contains('editing')) return;
    var vis=getVisibleCanvases();
    highlightCanvas((activeCanvas===vis.left||activeCanvas===vis.right)?activeCanvas:(vis.right||vis.left));
  });
}

/* ==== Init ==== */
init().catch(function(err){console.error(err);});
async function init(){
  await new Promise(function(res){ var i=new Image(); i.onload=i.onerror=res; i.src="./lovestory_cover.png?v=8"; });
  bootMsg.textContent = 'Loading pages…'; retryBtn.style.display='none';

  try{
    // Load state
    var stateUrl = SUPABASE_URL + "/rest/v1/" + TABLE_STATE + "?select=pages&id=eq." + encodeURIComponent(STATE_ID) + "&limit=1";
    var stateRes = await fetch(stateUrl,{headers:sbHeaders});
    if(!stateRes.ok) throw new Error('state load '+stateRes.status);
    var stateArr = await stateRes.json();
    var pages = (stateArr && stateArr[0] && stateArr[0].pages) ? stateArr[0].pages : [];

    // Count existing leading empties
    var savedLeadingEmpty = 0;
    for(var i=0;i<pages.length;i++){
      var items = (pages[i] && pages[i].items) ? pages[i].items : [];
      if(items.length===0) savedLeadingEmpty++; else break;
      if(savedLeadingEmpty>=LEADING_BLANKS_DESIRED) break;
    }
    leadingPrepended = Math.max(0, LEADING_BLANKS_DESIRED - savedLeadingEmpty);

    // Add leading blanks after cover
    for(var k=0;k<leadingPrepended;k++){
      var p=document.createElement('div'); p.className='page'; p.innerHTML='<div class="page-canvas"></div>';
      bookEl.appendChild(p);
    }

    // Create DOM nodes for saved pages
    for(i=0;i<pages.length;i++){
      p=document.createElement('div'); p.className='page'; p.innerHTML='<div class="page-canvas"></div>';
      bookEl.appendChild(p);
    }

    // Fetch images
    var ids=[]; pages.forEach(function(pg){ (pg.items||[]).forEach(function(it){ if(it.type==='image' && it.imageId!=null) ids.push(String(it.imageId)); }); });
    var urlMap=await fetchImageRowsSafe(Array.from(new Set(ids)));

    // Render saved pages starting after cover + leading blanks
    var canvases=Array.prototype.slice.call(document.querySelectorAll('#book .page .page-canvas'), 1 + leadingPrepended);
    for(var j=0;j<Math.min(pages.length,canvases.length);j++){
      var c=canvases[j]; c.innerHTML='';
      items=pages[j].items||[];
      for(var t=0;t<items.length;t++){
        var it=items[t];
        var box=document.createElement('div'); box.className='scrap-item';
        if(it.style && it.style.left)  box.style.left=it.style.left;
        if(it.style && it.style.top)   box.style.top=it.style.top;
        if(it.style && it.style.width) box.style.width=it.style.width;
        if(it.style && it.style.height)box.style.height=it.style.height;
        if(it.rot){ box.dataset.rot=it.rot; box.style.transform='rotate('+it.rot+'deg)'; }
        if(it.type==='image' && it.imageId!=null){
          var url=urlMap[String(it.imageId)]||'';
          box.dataset.fit=it.fit||'contain'; box.dataset.lock=it.lock?'1':'0';
          box.innerHTML='<img class="scrap-img" data-imgid="'+String(it.imageId)+'" src="'+url+'" alt="" decoding="async">'
                       +'<div class="mover" title="Drag"></div><div class="resizer"></div><div class="rotator"></div>';
          (function(box){
            var imgEl=box.querySelector('.scrap-img');
            var setAspect=function(){ if(imgEl.naturalWidth&&imgEl.naturalHeight){ box.dataset.aspect=(imgEl.naturalWidth/imgEl.naturalHeight).toFixed(5);} };
            if(imgEl.complete) setAspect(); else imgEl.addEventListener('load',setAspect);
          })(box);
        }else if(it.type==='text' && it.html){
          var holder=document.createElement('div'); holder.innerHTML=(it.html||'').trim();
          var inner=holder.firstElementChild||document.createElement('div'); inner.setAttribute('contenteditable','false'); box.appendChild(inner);
          box.insertAdjacentHTML('beforeend','<div class="mover" title="Drag"></div><div class="resizer"></div><div class="rotator"></div>');
        }
        c.appendChild(box); makeDraggable(box); box.dataset._hooked='1';
      }
    }

    // Append 4 blanks at end (not saved unless used)
    addTrailingBlankPages(TRAILING_BLANKS_DESIRED);

    afterBootShow();
    initFlip(0);
    boot.classList.add('hide'); setTimeout(function(){ try{boot.remove();}catch(_){}} ,400);
  }catch(err){
    console.warn('Cloud load failed:', err);
    bootMsg.textContent = "Couldn’t reach the cloud. Please check your internet and try again.";
    retryBtn.style.display='inline-block';
    retryBtn.onclick=function(){ location.reload(); };
    throw err;
  }
}

/* Append N blank pages at the very end */
function addTrailingBlankPages(n){
  if(typeof n!=='number') n=4;
  for(var i=0;i<n;i++){
    var p=document.createElement('div'); p.className='page'; p.innerHTML='<div class="page-canvas"></div>';
    bookEl.appendChild(p);
  }
}

/* Robust image fetcher (avoids 400 with id list) */
async function fetchImageRowsSafe(idList){
  var map={};
  if(!idList || !idList.length) return map;
  var chunkSize=12;
  for(var i=0;i<idList.length;i+=chunkSize){
    var chunk=idList.slice(i,i+chunkSize);
    var conds=chunk.map(function(id){ return (/^\d+$/.test(id))?('id.eq.'+id):('id.eq."'+id+'"'); }).join(',');
    var url=SUPABASE_URL+'/rest/v1/'+TABLE_IMAGES+'?select=id,content_type,data_base64&or=(' + encodeURIComponent(conds) + ')';
    var res=await fetch(url,{headers:sbHeaders});
    if(!res.ok) throw new Error('images load '+res.status);
    var rows=await res.json();
    rows.forEach(function(r){ map[String(r.id)]='data:'+r.content_type+';base64,'+r.data_base64; });
  }
  return map;
}

/* Target left/right */
function getVisibleCanvases(){
  var pr=stageEl.getBoundingClientRect();
  var all=[].slice.call(document.querySelectorAll('#book .page .page-canvas')).map(function(el){
    var r=el.getBoundingClientRect();
    var w=Math.max(0,Math.min(r.right,pr.right)-Math.max(r.left,pr.left));
    var h=Math.max(0,Math.min(r.bottom,pr.bottom)-Math.max(r.top,pr.top));
    return {el:el,area:w*h,cx:r.left+r.width/2};
  }).filter(function(x){return x.area>1000;}).sort(function(a,b){return b.area-a.area;});
  var top=all.slice(0,2).sort(function(a,b){return a.cx-b.cx;});
  return {left:top.length===2?top[0].el:null,right:top.length?top[top.length-1].el:null};
}
function highlightCanvas(canvas){
  if(!canvas){ toastShow('That side is not visible here.'); return; }
  [].forEach.call(document.querySelectorAll('.page-canvas'), function(c){ c.classList.remove('active-side'); });
  canvas.classList.add('active-side'); activeCanvas=canvas;
}
stageEl.addEventListener('mousedown',function(e){
  if(!document.body.classList.contains('editing')) return;
  var pc=e.target.closest('.page-canvas'); if(pc) highlightCanvas(pc);
});
document.getElementById('targetLeft').onclick = function(){ var v=getVisibleCanvases(); highlightCanvas(v.left||v.right); };
document.getElementById('targetRight').onclick= function(){ var v=getVisibleCanvases(); highlightCanvas(v.right||v.left); };

/* Secret Edit Mode (type 123) */
var PASSCODE='123'; var keyBuffer=''; var keyTimer=null;
document.addEventListener('keydown',function(e){
  keyBuffer+=e.key; clearTimeout(keyTimer); keyTimer=setTimeout(function(){keyBuffer='';},1200);
  if(keyBuffer.slice(-PASSCODE.length)===PASSCODE){ keyBuffer=''; enterEdit(); }
});
function setEditing(on){
  document.body.classList.toggle('editing', on);
  toolbar.classList.toggle('open', on);
  if(!on){
    [].forEach.call(document.querySelectorAll('.page-canvas'), function(c){ c.classList.remove('active-side'); });
    activeCanvas=null;
  }
}
function enterEdit(){
  setEditing(true);
  lastPageIndex = (pageFlip && pageFlip.getCurrentPageIndex) ? pageFlip.getCurrentPageIndex() : 0;
  try{
    if(pageFlip && pageFlip.update) pageFlip.update({ useMouseEvents:false, swipeDistance:10000 });
  }catch(_){}
  [].forEach.call(document.querySelectorAll('#book .scrap-item'), function(el){
    if(!el.dataset._hooked){ makeDraggable(el); el.dataset._hooked='1'; }
  });
  var v = getVisibleCanvases();
  highlightCanvas(v.right || v.left);
  toastShow('Edit mode unlocked ✨');
}
function exitEdit(){
  setEditing(false); deselect();
  try{
    var curr = lastPageIndex || 0;
    if(pageFlip && pageFlip.turnToPage) pageFlip.turnToPage(curr);
    if(pageFlip && pageFlip.update) pageFlip.update({ useMouseEvents:true, swipeDistance:30 });
  }catch(_){}
}

/* “Close book” without a button: double-click background */
stageEl.addEventListener('dblclick', function(){
  try{
    var total = (pageFlip && pageFlip.getPageCount)? pageFlip.getPageCount() : 1;
    var curr  = (pageFlip && pageFlip.getCurrentPageIndex)? pageFlip.getCurrentPageIndex() : 0;
    var mid   = Math.floor(total/2);
    var target = (curr <= mid) ? 0 : total - 1;
    if(pageFlip && pageFlip.turnToPage) pageFlip.turnToPage(target);
  }catch(_){}
});

/* HUD / drag / resize / rotate */
function positionHud(){
  if(!selectedItem || itemHud.style.display==='none') return;
  var r=selectedItem.getBoundingClientRect(), sr=stageEl.getBoundingClientRect();
  var hudW=itemHud.offsetWidth, hudH=itemHud.offsetHeight;
  var x=r.right-sr.left-hudW, y=r.top-sr.top-hudH-8;
  x=Math.max(8,Math.min(x,sr.width-hudW-8)); if(y<8) y=r.bottom-sr.top+8;
  itemHud.style.left=x+'px'; itemHud.style.top=y+'px';
}
function getRotation(el){ return parseFloat(el && el.dataset.rot || '0') || 0; }
function setRotation(el,deg){
  if(!el) return; el.dataset.rot=String(deg); el.style.transform='rotate('+deg+'deg)'; hudRot.value=Math.round(getRotation(el)); positionHud();
}
function showItemHud(el){
  if(!el){ hideItemHud(); return; }
  var onImg=!!el.querySelector('.scrap-img');
  var onText=!!el.querySelector('.scrap-text');
  [].forEach.call(itemHud.querySelectorAll('.only-img'), function(n){ n.style.display=onImg?'':'none'; });
  [].forEach.call(itemHud.querySelectorAll('.only-text'), function(n){ n.style.display=onText?'':'none'; });
  if(onImg){
    var fit=el.dataset.fit||'contain', lock=el.dataset.lock==='1';
    hudFit.textContent='Fit: '+(fit==='cover'?'Fill':'Contain');
    hudLock.textContent='Lock: '+(lock?'On':'Off');
  }
  if(onText){
    var t=el.querySelector('.scrap-text');
    hudFont.value=Math.round(parseFloat(getComputedStyle(t).fontSize)||22);
  }
  hudRot.value=Math.round(getRotation(el));
  itemHud.style.display='flex'; requestAnimationFrame(positionHud);
}
function hideItemHud(){ itemHud.style.display='none'; }
window.addEventListener('resize', positionHud);
itemHud.addEventListener('mousedown', function(e){ e.stopPropagation(); });

function makeDraggable(el){
  var startX=0,startY=0,origX=0,origY=0,resizing=false,startW=0,startH=0;
  var rotating=false,startAngle=0,startPointerAngle=0;
  var dragging=false, dragPointerId=null;

  var res=el.querySelector('.resizer');
  var rot=el.querySelector('.rotator'); if(!rot){ rot=document.createElement('div'); rot.className='rotator'; el.appendChild(rot); }
  var mover=el.querySelector('.mover'); if(!mover){ mover=document.createElement('div'); mover.className='mover'; el.appendChild(mover); }

  el.addEventListener('dragstart', function(e){ e.preventDefault(); });

  if(res){
    res.addEventListener('mousedown',function(e){
      if(!document.body.classList.contains('editing')) return;
      e.stopPropagation(); e.preventDefault();
      resizing=true; startX=e.clientX; startY=e.clientY; startW=el.offsetWidth; startH=el.offsetHeight;
      document.addEventListener('mousemove',onMove); document.addEventListener('mouseup',onUp);
    });
  }
  function onMove(e){
    if(!resizing) return;
    var dx=e.clientX-startX, dy=e.clientY-startY;
    var hasImg=!!el.querySelector('.scrap-img');
    var lockOn=hasImg && el.dataset.lock==='1' && !e.shiftKey;
    var ratio=parseFloat(el.dataset.aspect || (el.offsetWidth/Math.max(1,el.offsetHeight)));
    var w=Math.max(60,startW+dx), h=Math.max(40,startH+dy);
    if(lockOn && ratio>0){ if(Math.abs(dx)>=Math.abs(dy)) h=Math.max(40,Math.round(w/ratio)); else w=Math.max(60,Math.round(h*ratio)); }
    el.style.width=w+'px'; el.style.height=h+'px';
    var t=el.querySelector('.scrap-text'); if(t && !hasImg){ t.style.height='auto'; el.style.height=Math.max(40,t.scrollHeight)+'px'; }
    positionHud();
  }
  function onUp(){ document.removeEventListener('mousemove',onMove); document.removeEventListener('mouseup',onUp); resizing=false; }

  rot.addEventListener('mousedown',function(e){
    if(!document.body.classList.contains('editing')) return;
    e.stopPropagation(); e.preventDefault();
    rotating=true; var r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
    startPointerAngle=Math.atan2(e.clientY-cy,e.clientX-cx); startAngle=getRotation(el);
    document.addEventListener('mousemove',onRotate); document.addEventListener('mouseup',endRotate);
  });
  function onRotate(e){
    if(!rotating) return;
    var r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
    var a=Math.atan2(e.clientY-cy,e.clientX-cx);
    setRotation(el, startAngle+(a-startPointerAngle)*180/Math.PI);
    positionHud();
  }
  function endRotate(){ rotating=false; document.removeEventListener('mousemove',onRotate); document.removeEventListener('mouseup',endRotate); }

  el.addEventListener('pointerdown', function(e){
    if(!document.body.classList.contains('editing')) return;
    var isControl = e.target.classList.contains('resizer')||e.target.classList.contains('rotator')||e.target.classList.contains('mover');
    if(isControl) return;
    e.preventDefault(); e.stopPropagation();
    if(selectedItem) selectedItem.classList.remove('selected'); selectedItem=el; el.classList.add('selected');
    updateToolbarState(); showItemHud(el);
    startDrag(e);
  });
  mover.addEventListener('pointerdown', function(e){
    if(!document.body.classList.contains('editing')) return;
    e.preventDefault(); e.stopPropagation();
    if(selectedItem) selectedItem.classList.remove('selected'); selectedItem=el; el.classList.add('selected');
    updateToolbarState(); showItemHud(el);
    startDrag(e);
  });

  function startDrag(e){
    dragging=true; dragPointerId=(e.pointerId!=null)?e.pointerId:'mouse';
    try{ if(e.pointerId!=null && el.setPointerCapture) el.setPointerCapture(e.pointerId);}catch(_){}
    startX=e.clientX; startY=e.clientY; origX=el.offsetLeft; origY=el.offsetTop;
    window.addEventListener('pointermove',onPointerMove);
    window.addEventListener('pointerup',onPointerUp);
    window.addEventListener('pointercancel',onPointerUp);
    el.addEventListener('lostpointercapture',onPointerUp);
  }
  function onPointerMove(e){
    if(!dragging) return;
    var dx=e.clientX-startX, dy=e.clientY-startY;
    el.style.left=(origX+dx)+'px'; el.style.top=(origY+dy)+'px';
    positionHud();
  }
  function onPointerUp(){
    if(!dragging) return;
    try{ if(dragPointerId!=null && el.releasePointerCapture) el.releasePointerCapture(dragPointerId);}catch(_){}
    dragging=false; dragPointerId=null;
    window.removeEventListener('pointermove',onPointerMove);
    window.removeEventListener('pointerup',onPointerUp);
    window.removeEventListener('pointercancel',onPointerUp);
    el.removeEventListener('lostpointercapture',onPointerUp);
  }

  var tnode=el.querySelector('.scrap-text'); if(tnode) enableAutoGrow(el,tnode);
}
function enableAutoGrow(box,textEl){
  var grow=function(){ textEl.style.height='auto'; box.style.height=Math.max(40,textEl.scrollHeight)+'px'; positionHud(); };
  textEl.addEventListener('input',grow); new ResizeObserver(grow).observe(textEl); grow();
}

document.addEventListener('click',function(e){
  if(!document.body.classList.contains('editing')) return;
  var onItem=e.target.closest('.scrap-item'), onBar=e.target.closest('#toolbar'), onHud=e.target.closest('#itemHud');
  if(!onItem && !onBar && !onHud) deselect();
});

/* ==== Big Text Editor ==== */
var editor = {
  el: document.getElementById('textEditor'),
  input: document.getElementById('editorInput'),
  size: document.getElementById('editorSize'),
  color: document.getElementById('editorColor'),
  save: document.getElementById('editorSave'),
  cancel: document.getElementById('editorCancel'),
  targetBox: null
};
document.getElementById('addTextBtn').onclick = function(){ openTextEditor({}); };
function openTextEditor(opts){
  opts = opts || {};
  editor.targetBox = opts.targetBox || null;
  editor.input.value = opts.text || '';
  editor.size.value = (typeof opts.size==='number'? opts.size : 28);
  editor.color.value = opts.color || '#0d2a6b';
  editor.el.classList.add('open');
  setTimeout(function(){ editor.input.focus(); }, 0);
}
function closeTextEditor(){ editor.el.classList.remove('open'); editor.targetBox=null; }
editor.cancel.onclick = closeTextEditor;
editor.el.addEventListener('click', function(e){ if (e.target === editor.el) closeTextEditor(); });
document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && editor.el.classList.contains('open')) closeTextEditor(); });
editor.save.onclick = function(){
  var text = editor.input.value;
  var size = Math.max(8, Math.min(200, parseInt(editor.size.value || '22', 10)));
  var color = editor.color.value || '#0d2a6b';
  if (editor.targetBox) {
    var t = editor.targetBox.querySelector('.scrap-text'); if (!t) return;
    t.textContent = text; t.style.fontSize = size+'px'; t.style.color = color; t.style.height = 'auto';
    editor.targetBox.style.height = Math.max(40, t.scrollHeight)+'px';
    showItemHud(editor.targetBox);
  } else {
    var box=document.createElement('div'); box.className='scrap-item'; box.style.left='40px'; box.style.top='40px'; box.style.width='320px';
    box.innerHTML = '<div class="scrap-text" contenteditable="false" style="font-size:'+size+'px;color:'+color+'"></div>'
                   + '<div class="mover" title="Drag"></div><div class="resizer"></div><div class="rotator"></div>';
    box.querySelector('.scrap-text').textContent = text;
    (activeCanvas||getVisibleCanvases().right).appendChild(box); makeDraggable(box); box.dataset._hooked='1';
  }
  closeTextEditor();
};
hudEdit.onclick = function(){
  if(!selectedItem) return;
  var t = selectedItem.querySelector('.scrap-text'); if(!t) return;
  var size = Math.round(parseFloat(getComputedStyle(t).fontSize)||28);
  var color = rgbToHex(getComputedStyle(t).color);
  openTextEditor({ text: t.textContent||'', size: size, color: color, targetBox: selectedItem });
};

/* ==== Toolbar actions ==== */
document.getElementById('deleteSelectedBtn').onclick=function(){ if(selectedItem){ selectedItem.remove(); deselect(); } };
document.getElementById('clearPageBtn').onclick=function(){
  if(!activeCanvas){ toastShow('Pick a side (Edit Left/Right)'); return; }
  activeCanvas.querySelectorAll('.scrap-item').forEach(function(el){ el.remove(); });
};
function updateImageButtons(){
  var onImg=!!(selectedItem && selectedItem.querySelector('.scrap-img'));
  fitBtn.disabled=!onImg; lockBtn.disabled=!onImg;
  if(onImg){
    var fit=selectedItem.dataset.fit||'contain', lock=selectedItem.dataset.lock==='1';
    fitBtn.textContent='Fit: '+(fit==='cover'?'Fill':'Contain');
    lockBtn.textContent='Lock: '+(lock?'On':'Off');
  } else {
    fitBtn.textContent='Fit: Contain'; lockBtn.textContent='Lock: On';
  }
}
document.getElementById('fitToggleBtn').onclick=function(){ if(!(selectedItem && selectedItem.querySelector('.scrap-img'))) return; var cur=selectedItem.dataset.fit||'contain'; selectedItem.dataset.fit=(cur==='cover')?'contain':'cover'; updateImageButtons(); showItemHud(selectedItem); };
document.getElementById('lockToggleBtn').onclick=function(){ if(!(selectedItem && selectedItem.querySelector('.scrap-img'))) return; selectedItem.dataset.lock=(selectedItem.dataset.lock==='1')?'0':'1'; updateImageButtons(); showItemHud(selectedItem); };
function updateToolbarState(){ updateImageButtons(); updateFontInput(); updateColorInput(); }

/* Font + color utils */
function selectedTextEl(){ if(!selectedItem) return null; return selectedItem.querySelector('.scrap-text'); }
function updateFontInput(){
  var t=selectedTextEl(); if(!t){ fontSizeInput.disabled=true; fontSizeInput.value=''; return; }
  fontSizeInput.disabled=false; var curr=Math.round(parseFloat(getComputedStyle(t).fontSize)||22); fontSizeInput.value=curr; hudFont.value=curr;
}
fontSizeInput.addEventListener('input',function(){
  var t=selectedTextEl(); if(!t) return; var v=parseInt(fontSizeInput.value,10); if(isNaN(v)) return;
  v=Math.max(8,Math.min(200,v)); t.style.fontSize=v+'px'; t.style.height='auto';
  var box=t.closest('.scrap-item'); if(box) box.style.height=Math.max(40,t.scrollHeight)+'px'; hudFont.value=v;
});
hudFont.addEventListener('input',function(){
  var t=selectedTextEl(); if(!t) return; var v=parseInt(hudFont.value,10); if(isNaN(v)) return;
  v=Math.max(8,Math.min(200,v)); t.style.fontSize=v+'px'; t.style.height='auto';
  var box=t.closest('.scrap-item'); if(box) box.style.height=Math.max(40,t.scrollHeight)+'px'; fontSizeInput.value=v;
});
function selectedAnyTextEl(){ if(!selectedItem) return null; return selectedItem.querySelector('.scrap-text'); }
function updateColorInput(){
  var t=selectedAnyTextEl();
  if(!t){ fontColorInput.disabled=true; return; }
  var comp=getComputedStyle(t).color; fontColorInput.disabled=false; fontColorInput.value=comp.indexOf('#')===0?comp:rgbToHex(comp);
}
fontColorInput.addEventListener('input',function(){ var t=selectedAnyTextEl(); if(!t) return; t.style.color=fontColorInput.value; });

/* HUD buttons */
hudRot.addEventListener('input',function(){ if(!selectedItem) return; var v=parseFloat(hudRot.value); if(isNaN(v)) return; setRotation(selectedItem,v); });
hudRotL.onclick=function(){ if(!selectedItem) return; setRotation(selectedItem,getRotation(selectedItem)-5); };
hudRotR.onclick=function(){ if(!selectedItem) return; setRotation(selectedItem,getRotation(selectedItem)+5); };
hudDup.onclick = function(){ if(!selectedItem) return; var clone=selectedItem.cloneNode(true); clone.style.left=(selectedItem.offsetLeft+16)+'px'; clone.style.top=(selectedItem.offsetTop+16)+'px'; selectedItem.parentElement.appendChild(clone); makeDraggable(clone); clone.dataset._hooked='1'; };
hudFront.onclick = function(){ if(selectedItem){ selectedItem.style.zIndex=++zCounter; } };
hudBack.onclick  = function(){ if(selectedItem){ selectedItem.style.zIndex=0; } };
hudDelete.onclick= function(){ if(selectedItem){ selectedItem.remove(); deselect(); } };

/* Photos (local add) */
document.getElementById('addPhotoBtn').onclick=function(){ fileInput.click(); };
fileInput.addEventListener('change',async function(e){
  var f=e.target.files[0]; if(!f) return;
  var enc=await compressToBase64(f,3000,0.95); // sharper
  var mime=enc.mime, base64=enc.base64;
  var box=document.createElement('div');
  box.className='scrap-item'; box.style.left='90px'; box.style.top='90px'; box.style.width='320px'; box.style.height='230px';
  box.dataset.fit='contain'; box.dataset.lock='1';
  box.innerHTML='<img class="scrap-img" alt="" src="data:'+mime+';base64,'+base64+'" decoding="async">'
               +'<div class="mover" title="Drag"></div><div class="resizer"></div><div class="rotator"></div>';
  (activeCanvas||getVisibleCanvases().right).appendChild(box); makeDraggable(box); box.dataset._hooked='1';
  var imgEl=box.querySelector('.scrap-img');
  var setAspect=function(){ if(imgEl.naturalWidth&&imgEl.naturalHeight){ box.dataset.aspect=(imgEl.naturalWidth/imgEl.naturalHeight).toFixed(5);} };
  if(imgEl.complete) setAspect(); else imgEl.addEventListener('load',setAspect);
  imgEl._preb64={mime:mime,base64:base64}; fileInput.value='';
});

/* Save (exits edit mode) – ignores auto blanks when saving */
document.getElementById('saveBtn').onclick=function(){ saveToCloud().catch(function(e){ alert('Save failed: '+e); }); };
async function saveToCloud(){
  toastShow('Saving…');

  // Upload new images
  var imgs=[].slice.call(document.querySelectorAll('#book .scrap-img'));
  for(var i=0;i<imgs.length;i++){
    var img=imgs[i];
    if(img.dataset.imgid) continue;
    var mime,base64;
    if(img._preb64){ mime=img._preb64.mime; base64=img._preb64.base64; }
    else{
      var r=await fetch(img.src); var b=await r.blob(); var enc=await compressToBase64(b,3000,0.95); mime=enc.mime; base64=enc.base64;
    }
    var insRes = await fetch(SUPABASE_URL+'/rest/v1/'+TABLE_IMAGES,{
      method:'POST', headers:Object.assign({}, sbHeaders, {"Prefer":"return=representation"}),
      body: JSON.stringify([{content_type:mime,data_base64:base64}])
    });
    if(!insRes.ok) throw new Error('image insert '+insRes.status);
    var row=(await insRes.json())[0]; img.dataset.imgid=String(row.id); delete img._preb64;
  }

  // Gather pages (skip cover and the auto-prepended leading blanks; trim trailing empties)
  var allInner=[].slice.call(document.querySelectorAll('#book .page .page-canvas'), 1);
  var saveList = allInner.slice(leadingPrepended);
  var lastIdx = saveList.length - 1;
  var hasItems = function(c){ return c.querySelectorAll('.scrap-item').length > 0; };
  while(lastIdx >= 0 && !hasItems(saveList[lastIdx])) lastIdx--;
  var finalCanvases = saveList.slice(0, lastIdx + 1);

  var pages=[];
  finalCanvases.forEach(function(c){
    var items=[];
    c.querySelectorAll('.scrap-item').forEach(function(el){
      var style={left:el.style.left, top:el.style.top, width:el.style.width, height:el.style.height};
      var rot=parseFloat(el.dataset.rot||'0')||0;
      var img=el.querySelector('.scrap-img');
      if(img){ items.push({type:'image',style:style,rot:rot,imageId:String(img.dataset.imgid||''),fit:el.dataset.fit||'contain',lock:el.dataset.lock==='1'}); }
      else{ var txt=el.querySelector('.scrap-text'); items.push({type:'text',style:style,rot:rot,html:txt?txt.outerHTML:''}); }
    });
    pages.push({items:items});
  });

  var upRes = await fetch(SUPABASE_URL+'/rest/v1/'+TABLE_STATE,{
    method:'POST',
    headers:Object.assign({}, sbHeaders, {"Prefer":"resolution=merge-duplicates,return=representation"}),
    body: JSON.stringify({ id: STATE_ID, pages: pages })
  });
  if(!upRes.ok) throw new Error('state upsert '+upRes.status);
  toastShow('Saved ✓'); exitEdit();
}

/* Sharper, format-preserving encoder */
async function compressToBase64(fileOrBlob, maxSide, quality) {
  if(typeof maxSide!=='number') maxSide=3000;
  if(typeof quality!=='number') quality=0.95;

  var blob = (fileOrBlob instanceof Blob) ? fileOrBlob : new Blob([fileOrBlob]);
  var inputMime = blob.type || 'image/jpeg';

  // If already small (<=3MB), keep original bytes as-is
  if (blob.size <= 3000000) {
    var buf = await blob.arrayBuffer();
    var bytes = new Uint8Array(buf);
    var binary = '';
    for (var i=0; i<bytes.length; i++) binary += String.fromCharCode(bytes[i]);
    var base64 = btoa(binary);
    return { mime: inputMime, base64: base64 };
  }

  var img = await new Promise(function(res, rej){
    var i = new Image();
    i.onload = function(){ res(i); };
    i.onerror = rej;
    i.src = URL.createObjectURL(blob);
  });

  var w = img.width, h = img.height;
  if (Math.max(w, h) > maxSide) {
    if (w > h) { h = Math.round(h * (maxSide / w)); w = maxSide; }
    else { w = Math.round(w * (maxSide / h)); h = maxSide; }
  }

  var canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  var ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, w, h);
  URL.revokeObjectURL(img.src);

  var encodable = /^(image\/jpeg|image\/png|image\/webp)$/i.test(inputMime);
  var outMime = encodable ? inputMime : 'image/jpeg';
  var dataUrl = canvas.toDataURL(outMime, (/^image\/jpe?g$/i.test(outMime) ? quality : 1.0));
  return { mime: outMime, base64: dataUrl.split(',')[1] };
}

/* Reused helper */
function getVisibleCanvases(){
  var pr=stageEl.getBoundingClientRect();
  var all=[].slice.call(document.querySelectorAll('#book .page .page-canvas')).map(function(el){
    var r=el.getBoundingClientRect();
    var w=Math.max(0,Math.min(r.right,pr.right)-Math.max(r.left,pr.left));
    var h=Math.max(0,Math.min(r.bottom,pr.bottom)-Math.max(r.top,pr.top));
    return {el:el,area:w*h,cx:r.left+r.width/2};
  }).filter(function(x){return x.area>1000;}).sort(function(a,b){return b.area-a.area;});
  var top=all.slice(0,2).sort(function(a,b){return a.cx-b.cx;});
  return {left:top.length===2?top[0].el:null,right:top.length?top[top.length-1].el:null};
}
</script>
</body>
</html>
