<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Our Scrapbook Story</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:,">

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lobster&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">

<!-- preload cover -->
<link rel="preload" as="image" href="./lovestory_cover.png?v=8" fetchpriority="high">

<style>
:root{
  --bg:#0b0f2f; --paper:#f7eddc; --ink:#0d2a6b;
  --accent:#7a5af8; --mint:#67e4ca;
  /* viewer default: Lobster */
  --font:"Lobster","Dancing Script",cursive;
  --cover-y:28%;
  --cover-img:url("./lovestory_cover.png?v=8");
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--ink);
  display:flex; align-items:center; justify-content:center; overflow:hidden;
  font-family:var(--font);
}

/* boot / toast */
#boot{
  position:fixed; inset:0; display:grid; place-items:center;
  background:#0b0f2f; color:#67e4ca; z-index:9999;
  font:600 18px/1.2 system-ui, Segoe UI, sans-serif; letter-spacing:.4px;
  transition:opacity .35s ease;
}
#boot.hide{ opacity:0; pointer-events:none; }
#toast{
  position:absolute; top:12px; right:12px; z-index:95;
  background:#11172f; color:#fff; border:2px solid var(--mint);
  padding:8px 12px; border-radius:10px; display:none;
}

/* Stage & Book */
#stage{ width:1000px; height:650px; position:relative; }
#book { position:absolute; inset:0; visibility:hidden; will-change:transform; }

/* Pages */
.page{
  width:100%; height:100%; position:relative; overflow:hidden;
  background:var(--paper); box-shadow: inset 0 0 60px rgba(0,0,0,.22);
}
.page-canvas{
  position:relative; width:100%; height:100%; padding:28px;
  color:var(--ink); font-size:22px; line-height:1.35;
  content-visibility:auto; contain-intrinsic-size:650px 500px;
}

/* COVER */
.page.cover{ box-shadow:0 8px 28px rgba(0,0,0,.35); }
.page.cover .page-canvas{
  padding:0; background:#0c102c;
  background-image:var(--cover-img);
  background-size:cover; background-position:50% var(--cover-y); background-repeat:no-repeat;
}

/* Items (view-only) */
.scrap-item{ position:absolute; transform-origin:center; touch-action:none; overflow:visible; }
.scrap-img{ display:block; width:100%; height:100%; object-fit:contain; pointer-events:none; user-select:none; }
.scrap-item[data-fit="cover"] .scrap-img{ object-fit:cover; }
.scrap-text{
  display:block; width:100%; background:transparent; border:0; color:inherit; font:inherit;
  white-space:pre-wrap; overflow:visible; min-height:1.2em;
}
.scrap-text.sticker{
  display:flex; align-items:center; justify-content:center; line-height:1;
  font-family: var(--font),
               "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Twemoji Mozilla",
               "Segoe UI Symbol","Noto Sans Symbols 2","Noto Sans Math",sans-serif;
}
.scrap-item[data-emoji="1"] .scrap-text.sticker{
  font-family:"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Twemoji Mozilla",system-ui,sans-serif;
}
</style>
</head>
<body>

<div id="boot">loading scrapbookâ€¦</div>

<div id="stage">
  <div id="book">
    <!-- COVER -->
    <div class="page cover"><div class="page-canvas"></div></div>

    <!-- simple placeholders; real pages are built from Supabase -->
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
  </div>
  <div id="toast"></div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script src="./flipbook/page-flip.browser.js"></script>
<script>
/* ========= Config ========= */
const SUPABASE_URL  = "https://tmjozxcjylcxgemffnoc.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
const TABLE_IMAGES="scrapbook_images";
const TABLE_STATE ="scrapbook_state";
const STATE_ID="main";
const CACHE_KEY = "scrap_pages_cache_v1";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ========= Refs ========= */
const bookEl=document.getElementById('book');
const stageEl=document.getElementById('stage');
const toast=document.getElementById('toast');
const boot=document.getElementById('boot');

let pageFlip=null;

/* ========= Helpers ========= */
function toastShow(msg){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1800); }
function timeout(ms){ return new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')), ms)); }
function looksLikeEmoji(s){ try{ return /\p{Extended_Pictographic}/u.test(s||""); } catch{ return /[\uD83C-\uDBFF\uDC00-\uDFFF]/.test(s||""); } }

/* Fonts: honor prior picker choice if present, else Lobster */
(function setFontFromStorage(){
  const saved = localStorage.getItem('scrap_font') || 'lobster';
  const map = {
    lobster: `"Lobster","Dancing Script",cursive`,
    dancing: `"Dancing Script",cursive`
  };
  document.documentElement.style.setProperty('--font', map[saved] || map.lobster);
})();

/* ========= PageFlip viewer ========= */
function initFlip(startIndex=0){
  try{ pageFlip?.destroy(); }catch(_){}
  if(!window.St || !St.PageFlip){ alert("Missing flipbook script (./flipbook/page-flip.browser.js)."); return; }
  // at least cover + one inner
  const pgCount = document.querySelectorAll('#book .page').length;
  if (pgCount < 2) {
    const p=document.createElement('div'); p.className='page'; p.innerHTML='<div class="page-canvas"></div>';
    bookEl.appendChild(p);
  }
  pageFlip = new St.PageFlip(bookEl,{
    width:500,height:650,size:"fixed",showCover:true,
    drawShadow:true, flippingTime:800,maxShadowOpacity:0.25,
    useMouseEvents:true,mobileScrollSupport:false,startPage:Math.max(0,startIndex|0)
  });
  pageFlip.loadFromHTML(document.querySelectorAll('#book .page'));
}

/* ========= Render pages (exactly, no extras) ========= */
function renderPages(pages, urlMap){
  // rebuild the DOM to exactly match saved pages
  bookEl.innerHTML = '';
  for(let i=0;i<pages.length;i++){
    const p=document.createElement('div'); p.className='page'+(i===0?' cover':'');
    const c=document.createElement('div'); c.className='page-canvas'; p.appendChild(c);
    for(const it of pages[i].items||[]){
      const box=document.createElement('div'); box.className='scrap-item';
      // geometry
      box.style.left = it.style?.left || '40px';
      box.style.top  = it.style?.top  || '40px';
      if(it.style?.width)  box.style.width  = it.style.width;
      if(it.style?.height) box.style.height = it.style.height;
      if(it.rot){ box.dataset.rot=it.rot; box.style.transform=`rotate(${it.rot}deg)`; }
      // content
      if(it.type==='image'){
        const url = (it.imageId && urlMap[it.imageId]) ? urlMap[it.imageId] : '';
        box.dataset.fit = it.fit || 'contain';
        box.innerHTML = `<img class="scrap-img" alt="" src="${url}" decoding="async">`;
      }else if(it.type==='text'){
        const holder=document.createElement('div'); holder.innerHTML=(it.html||'').trim();
        const inner=holder.firstElementChild||document.createElement('div');
        // make sure it's view-only
        inner.removeAttribute('contenteditable');
        inner.classList.add(...(inner.classList || []));
        box.appendChild(inner);
        if(inner.classList.contains('sticker')){
          box.dataset.emoji = looksLikeEmoji(inner.textContent) ? '1' : '0';
        }
      }
      c.appendChild(box);
    }
    bookEl.appendChild(p);
  }
}

/* ========= Load from Supabase (with cache fallback) ========= */
async function loadFromTables(){
  const {data:state} = await supabase.from(TABLE_STATE).select('pages').eq('id',STATE_ID).maybeSingle();
  if(!state || !state.pages){ return false; }

  // Collect image IDs and fetch them
  const ids=[]; state.pages.forEach(pg=>pg.items?.forEach(it=>{ if(it.type==='image' && it.imageId) ids.push(it.imageId); }));
  const uniq=[...new Set(ids)];
  const urlMap={};
  if(uniq.length){
    const {data:imgs} = await supabase.from(TABLE_IMAGES).select('id,content_type,data_base64').in('id',uniq);
    imgs?.forEach(r=> urlMap[r.id] = `data:${r.content_type};base64,${r.data_base64}`);
  }

  renderPages(state.pages, urlMap);
  // cache for offline
  try{ localStorage.setItem(CACHE_KEY, JSON.stringify(state.pages)); }catch(_){}
  return true;
}

/* ========= Boot ========= */
(async function init(){
  // wait for cover font/image, then try loading cloud (longer timeout)
  const coverReady = new Promise(res=>{ const i=new Image(); i.onload=i.onerror=res; i.src="./lovestory_cover.png?v=8"; });
  const fontsReady = (document.fonts && document.fonts.ready) ? document.fonts.ready : Promise.resolve();
  await Promise.allSettled([coverReady, fontsReady]);

  let loaded=false;
  try{
    loaded = await Promise.race([loadFromTables(), timeout(10000)]);
  }catch(e){
    console.warn('Cloud load skipped:', e);
  }

  if(!loaded){
    // try device cache
    const cached = localStorage.getItem(CACHE_KEY);
    if(cached){
      try{
        renderPages(JSON.parse(cached), {});
        toastShow('Showing cached copy.');
        loaded = true;
      }catch(_){}
    }
  }

  // show viewer (even if placeholders)
  bookEl.style.visibility='visible';
  initFlip(0);
  if(!loaded) toastShow("Couldn't reach cloud right now.");
  boot.classList.add('hide');
  setTimeout(()=>boot.remove(),400);
})();
</script>
</body>
</html>
