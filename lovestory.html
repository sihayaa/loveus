<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Our Scrapbook Story</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/4.1.0/turn.min.js"></script>
  <style>
    body {
      margin: 0;
      background: midnightblue;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: 'Georgia', serif;
      overflow: hidden;
    }
    #book {
      width: 900px;
      height: 600px;
    }
    .page {
      background: url('https://www.transparenttextures.com/patterns/aged-paper.png');
      background-size: cover;
      box-shadow: inset 0 0 40px rgba(0,0,0,0.4);
      padding: 20px;
      position: relative;
    }
    .scrap-item {
      position: absolute;
      cursor: move;
      resize: both;
      overflow: auto;
    }
    .scrap-item img {
      max-width: 100%;
      max-height: 100%;
      display: block;
    }
    /* Password modal */
    #passwordModal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex; justify-content: center; align-items: center;
      z-index: 1000;
    }
    #passwordBox {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    }
    #passwordBox input {
      padding: 8px; margin: 10px;
    }
    /* Themed popup */
    #editorModal {
      position: fixed; top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.7);
      display:none; justify-content:center; align-items:center;
      z-index: 2000;
    }
    #editorBox {
      background: #f5deb3;
      border: 3px solid #8b5a2b;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    #editorBox textarea {
      width: 300px; height: 100px;
    }
    .toolbar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.9);
      border-radius: 10px;
      padding: 10px;
      display: none;
      z-index: 1500;
    }
    .toolbar button {
      margin: 5px;
      padding: 8px 12px;
    }
  </style>
</head>
<body>
  <!-- Password Modal -->
  <div id="passwordModal">
    <div id="passwordBox">
      <h2>Enter Password</h2>
      <input type="password" id="passwordInput" placeholder="Password">
      <button onclick="checkPassword()">Unlock</button>
    </div>
  </div>

  <!-- Scrapbook -->
  <div id="book">
    <div class="page">Cover</div>
    <div class="page"></div>
    <div class="page"></div>
    <div class="page"></div>
    <div class="page"></div>
    <div class="page"></div>
    <div class="page"></div>
    <div class="page"></div>
    <div class="page"></div>
    <div class="page"></div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar" id="toolbar">
    <button onclick="openTextEditor()">Add Text</button>
    <input type="file" id="imageUpload" accept="image/*">
    <button onclick="saveScrapbook()">Save</button>
  </div>

  <!-- Themed Editor Modal -->
  <div id="editorModal">
    <div id="editorBox">
      <h3>Add Text</h3>
      <textarea id="editorText"></textarea><br>
      <button onclick="addText()">Add</button>
      <button onclick="closeEditor()">Cancel</button>
    </div>
  </div>

<script>
  const SUPABASE_URL = "https://tmjozxcjylcxgemffnoc.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let editMode = false;

  // Init book
  document.addEventListener("DOMContentLoaded", () => {
    $('#book').turn({ width: 900, height: 600, autoCenter: true });
  });

  function checkPassword() {
    const val = document.getElementById("passwordInput").value;
    if (val === "123") {
      editMode = true;
      document.getElementById("toolbar").style.display = "block";
      alert("Edit mode unlocked!");
    } else {
      alert("Read-only mode");
    }
    document.getElementById("passwordModal").style.display = "none";
    loadScrapbook();
  }

  function openTextEditor() {
    document.getElementById("editorModal").style.display = "flex";
  }

  function closeEditor() {
    document.getElementById("editorModal").style.display = "none";
  }

  function addText() {
    const txt = document.getElementById("editorText").value;
    if (!txt) return;
    const node = document.createElement("div");
    node.className = "scrap-item";
    node.style.left = "50px";
    node.style.top = "50px";
    node.textContent = txt;
    makeDraggable(node);
    document.querySelector(".page:nth-child(2)").appendChild(node);
    document.getElementById("editorModal").style.display = "none";
  }

  document.getElementById("imageUpload").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const imgDiv = document.createElement("div");
      imgDiv.className = "scrap-item";
      imgDiv.style.left = "100px";
      imgDiv.style.top = "100px";
      imgDiv.innerHTML = `<img src="${ev.target.result}">`;
      makeDraggable(imgDiv);
      document.querySelector(".page:nth-child(2)").appendChild(imgDiv);
    };
    reader.readAsDataURL(file);
  });

  function makeDraggable(el) {
    let offsetX, offsetY;
    el.onmousedown = function(e) {
      offsetX = e.clientX - el.offsetLeft;
      offsetY = e.clientY - el.offsetTop;
      document.onmousemove = function(ev) {
        el.style.left = (ev.clientX - offsetX) + "px";
        el.style.top = (ev.clientY - offsetY) + "px";
      };
      document.onmouseup = function() {
        document.onmousemove = null;
      };
    };
  }

  async function saveScrapbook() {
    let pages = [];
    document.querySelectorAll(".page").forEach((page, idx) => {
      let content = page.innerHTML;
      pages.push({page: idx, html: content});
    });
    await supabase.from("scrapbook").upsert({id: 1, data: JSON.stringify(pages)});
    alert("Saved!");
  }

  async function loadScrapbook() {
    let { data, error } = await supabase.from("scrapbook").select("data").eq("id",1).single();
    if (data) {
      const pages = JSON.parse(data.data);
      pages.forEach(p => {
        document.querySelectorAll(".page")[p.page].innerHTML = p.html;
      });
    }
  }
</script>
</body>
</html>
