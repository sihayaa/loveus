<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Our Scrapbook Story</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:,">

<!-- fonts (don't block boot) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Alex+Brush&family=Courgette&family=Dancing+Script:wght@600&family=Great+Vibes&family=Kaushan+Script&family=Lobster&family=Pacifico&display=swap" rel="stylesheet">

<!-- preload cover -->
<link rel="preload" as="image" href="./lovestory_cover.png?v=8" fetchpriority="high">

<style>
:root{
  --bg:#0b0f2f; --paper:#f7eddc; --ink:#0d2a6b;
  --accent:#7a5af8; --mint:#67e4ca;
  --font:"Dancing Script", cursive; /* set via picker; default becomes Lobster at runtime */
  --cover-y:28%;
  --cover-img:url("./lovestory_cover.png?v=8");
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--ink);
  display:flex; align-items:center; justify-content:center; overflow:hidden;
  font-family:var(--font);
}

/* boot overlay */
#boot{
  position:fixed; inset:0; display:grid; place-items:center;
  background:#0b0f2f; color:#67e4ca; z-index:9999;
  font:600 18px/1.2 system-ui, Segoe UI, sans-serif; letter-spacing:.4px;
  transition:opacity .35s ease;
}
#boot .card{
  text-align:center; padding:18px 22px; border:2px solid #67e4ca55; border-radius:12px;
  box-shadow:0 12px 30px rgba(0,0,0,.35);
}
#boot.hide{ opacity:0; pointer-events:none; }
#retryBtn{
  margin-top:10px; border:0; padding:8px 12px; border-radius:8px; cursor:pointer;
  font-weight:800; color:#022d2c; background:var(--mint); display:none;
}

/* Stage & Book */
#stage{ width:1000px; height:650px; position:relative; }
#book { position:absolute; inset:0; visibility:hidden; will-change:transform; }

/* Pages */
.page{
  width:100%; height:100%; position:relative; overflow:hidden;
  background:var(--paper); box-shadow: inset 0 0 60px rgba(0,0,0,.22);
}
.page-canvas{
  position:relative; width:100%; height:100%; padding:28px;
  color:var(--ink); font-size:22px; line-height:1.35;
  content-visibility:auto; contain-intrinsic-size:650px 500px;
}

/* COVER */
.page.cover{ box-shadow:0 8px 28px rgba(0,0,0,.35); }
.page.cover .page-canvas{
  padding:0; background:#0c102c;
  background-image:var(--cover-img);
  background-size:cover; background-position:50% var(--cover-y); background-repeat:no-repeat;
}

/* Scrap items */
.scrap-item{ position:absolute; transform-origin:center; touch-action:none; overflow:visible; }
.scrap-item.selected{ box-shadow:0 0 0 3px var(--accent); }
.resizer{ display:none; }
.rotator{
  display:none; position:absolute; left:50%; top:-18px; transform:translate(-50%,-50%);
  width:18px; height:18px; border-radius:50%; background:#fff; border:3px solid var(--accent);
  box-shadow:0 2px 8px rgba(0,0,0,.25); cursor:grab; z-index:999; pointer-events:auto;
}
.mover{
  display:none; position:absolute; left:-10px; top:-10px;
  width:18px; height:18px; border-radius:50%; background:#fff; border:3px solid var(--accent);
  box-shadow:0 2px 8px rgba(0,0,0,.25); cursor:grab;
}
body.editing .scrap-item{ cursor:move; }
body.editing .scrap-item .resizer{
  display:block; position:absolute; right:-6px; bottom:-6px; width:16px; height:16px;
  border-radius:4px; background:var(--mint); border:2px solid #0b2c28; cursor:nwse-resize;
}
body.editing .scrap-item .rotator{ display:block; }
body.editing .scrap-item .mover{ display:block; }

/* Images */
.scrap-img{ display:block; width:100%; height:100%; object-fit:contain; pointer-events:none; user-select:none; }
.scrap-item[data-fit="cover"] .scrap-img{ object-fit:cover; }

/* Text */
.scrap-text{
  display:block; width:100%; background:transparent; border:0; color:inherit; font:inherit;
  white-space:pre-wrap; overflow:visible; min-height:1.2em;
}
.scrap-text.sticker{
  display:flex; align-items:center; justify-content:center; line-height:1;
  font-family: var(--font),
               "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Twemoji Mozilla",
               "Segoe UI Symbol","Noto Sans Symbols 2","Noto Sans Math",sans-serif;
}
.scrap-item[data-emoji="1"] .scrap-text.sticker{
  font-family:"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Twemoji Mozilla",system-ui,sans-serif;
}

/* Sidebar toolbar */
#toolbar{
  position:fixed; right:16px; top:50%; transform:translateY(-50%);
  z-index:100; background:#fff; border:2px solid #e8dcc6; border-radius:14px; padding:12px;
  width:260px; gap:10px; box-shadow:0 10px 22px rgba(0,0,0,.25);
  display:none; flex-direction:column; align-items:stretch;
}
#toolbar.open{ display:flex; }
#toolbar .group{ display:flex; gap:8px; flex-wrap:wrap; }
#toolbar button{
  border:0; padding:8px 12px; border-radius:8px; cursor:pointer;
  font-weight:700; color:#fff; background:var(--accent); width:100%;
}
#toolbar button.secondary{ background:#5d47d4; }
#toolbar button.mint{ background:var(--mint); color:#022d2c; }
#toolbar button.warn{ background:#ff9aa2; color:#4c0a17; }
#toolbar input[type="number"]{
  width:100%; padding:8px; border-radius:8px; border:2px solid #e8dcc6; font-weight:700; color:#0d2a6b; background:#fff;
}
#fileInput{ display:none; }
#toolbar input[type="color"]{
  width:100%; height:40px; padding:0; border:2px solid #e8dcc6; border-radius:8px; background:#fff;
}

/* allow events while editing */
body.editing .page .page-canvas, body.editing .scrap-item { pointer-events:auto; }

#toast{
  position:absolute; top:12px; right:12px; z-index:95;
  background:#11172f; color:#fff; border:2px solid var(--mint);
  padding:8px 12px; border-radius:10px; display:none;
}
.page-canvas.active-side{ outline:3px dashed var(--accent); outline-offset:-12px; }

/* Modals, stickers, HUD */
.modal{
  position:absolute; inset:0; display:none; align-items:center; justify-content:center;
  z-index:1000; background:rgba(0,0,0,.55);
}
.modal.open{ display:flex; }
.modal-card{ width:min(96%,560px); background:#151a30; color:#fff; border:2px solid #fff2; border-radius:14px; padding:16px; box-shadow:0 20px 40px rgba(0,0,0,.45); }
.modal-card h3{ margin:0 0 10px; font-size:20px; }
#textModal textarea{ width:100%; background:#0f1430; color:#fff; border:1px solid #2b3258; border-radius:10px; padding:10px 12px; font-family:var(--font); font-size:20px; resize:vertical; }
.modal-actions{ margin-top:12px; display:flex; justify-content:flex-end; gap:8px; }
.modal-actions button{ border:0; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700; }
.btn-mint{ background:var(--mint); color:#05201f; }
.btn-ghost{ background:#2a315d; color:#fff; }
.stickers{ display:grid; grid-template-columns:repeat(8,1fr); gap:10px; }
.stickers button{ background:#0f1430; border:1px solid #2b3258; border-radius:10px; padding:8px; cursor:pointer; font-size:26px; line-height:1; }

body.modal-open #itemHud{ display:none !important; }
body.modal-open #book, body.modal-open #toolbar{ pointer-events:none; }

#itemHud{
  position:absolute; z-index:120; display:none; background:#151a30; color:#fff;
  border:2px solid #fff2; border-radius:10px; padding:6px; gap:6px; box-shadow:0 12px 24px rgba(0,0,0,.35);
  align-items:center; flex-wrap:wrap;
}
#itemHud button{ border:0; padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:700; font-size:12px; color:#fff; background:#5d47d4; }
#itemHud button.warn{ background:#ff9aa2; color:#4c0a17; }
#itemHud button.mint{ background:var(--mint); color:#022d2c; }
#itemHud input[type="number"]{
  width:70px; padding:6px 8px; border-radius:8px; border:2px solid #2b3258; background:#0f1430; color:#fff; font-weight:700; font-size:12px;
}
</style>
</head>
<body>

<div id="boot">
  <div class="card">
    <div id="bootMsg">loading scrapbook…</div>
    <button id="retryBtn">Try again</button>
  </div>
</div>

<div id="stage">
  <div id="book">
    <!-- COVER -->
    <div class="page cover"><div class="page-canvas"></div></div>

    <!-- placeholders; real pages come from cloud -->
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
    <div class="page"><div class="page-canvas"></div></div>
  </div>

  <!-- Right toolbar -->
  <div id="toolbar">
    <div class="group">
      <button id="targetLeft" class="secondary">Edit Left</button>
      <button id="targetRight" class="secondary">Edit Right</button>
    </div>

    <!-- Book actions -->
    <div class="group">
      <button id="exitEditBtn" class="secondary">Done Editing</button>
      <button id="closeBookBtn" class="secondary">Close Book</button>
      <button id="removeSheetBtn" class="warn">Remove Last Sheet</button>
    </div>

    <!-- Global font picker -->
    <div class="group">
      <label style="font-weight:700;color:#0d2a6b;width:100%;">Font</label>
      <select id="fontPicker" style="width:100%;padding:8px;border-radius:8px;border:2px solid #e8dcc6;font-weight:700;color:#0d2a6b;background:#fff">
        <option value="lobster">Lobster (default)</option>
        <option value="pacifico">Pacifico</option>
        <option value="kaushan">Kaushan Script</option>
        <option value="courgette">Courgette</option>
        <option value="alex">Alex Brush</option>
        <option value="greatvibes">Great Vibes</option>
        <option value="dancing">Dancing Script</option>
      </select>
    </div>

    <div class="group">
      <button id="addTextBtn" class="mint">Add Text</button>
      <button id="addPhotoBtn" class="secondary">Add Photo</button>
      <button id="stickersBtn" class="secondary">Stickers</button>
    </div>
    <div class="group">
      <label for="fontSizeInput" style="font-weight:700;color:#0d2a6b;">Text Size (px)</label>
      <input id="fontSizeInput" type="number" min="8" max="200" step="1" placeholder="px" list="fontSizes" disabled>
      <datalist id="fontSizes">
        <option value="12"></option><option value="14"></option><option value="16"></option>
        <option value="18"></option><option value="20"></option><option value="22"></option>
        <option value="24"></option><option value="28"></option><option value="36"></option>
        <option value="48"></option><option value="72"></option>
      </datalist>
    </div>
    <div class="group">
      <label for="fontColorInput" style="font-weight:700;color:#0d2a6b;">Text Color</label>
      <input id="fontColorInput" type="color" value="#0d2a6b" disabled>
    </div>
    <div class="group">
      <button id="fitToggleBtn"  class="secondary">Fit: Contain</button>
      <button id="lockToggleBtn" class="secondary">Lock: On</button>
    </div>
    <div class="group">
      <button id="deleteSelectedBtn" class="warn">Delete Selected</button>
      <button id="clearPageBtn" class="warn">Clear Page</button>
      <button id="saveBtn" class="mint">Save</button>
    </div>
    <input id="fileInput" type="file" accept="image/*" />
  </div>

  <!-- Text modal -->
  <div id="textModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3 id="textModalTitle">Add Text</h3>
      <textarea id="textInput" rows="5" placeholder="Write something sweet…"></textarea>
      <div class="modal-actions">
        <button class="btn-ghost" id="textCancel">Cancel</button>
        <button class="btn-mint" id="textAdd">Add Text</button>
      </div>
    </div>
  </div>

  <!-- Stickers modal -->
  <div id="stickerModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>Pick a sticker</h3>
      <div class="stickers" id="stickersGrid"></div>
      <div class="modal-actions">
        <button class="btn-ghost" id="stickersClose">Close</button>
      </div>
    </div>
  </div>

  <!-- Per-item HUD -->
  <div id="itemHud" aria-hidden="true">
    <button id="hudEdit"  class="mint only-text">Edit</button>
    <input  id="hudFont"  class="only-text" type="number" min="8" max="200" step="1" placeholder="size">
    <button id="hudFit"   class="only-img">Fit: Contain</button>
    <button id="hudLock"  class="only-img">Lock: On</button>
    <button id="hudRotL" title="Rotate left 5°">↺ 5°</button>
    <input  id="hudRot"  type="number" step="1" style="width:70px" placeholder="deg">
    <button id="hudRotR" title="Rotate right 5°">↻ 5°</button>
    <button id="hudDup">Duplicate</button>
    <button id="hudFront">Front</button>
    <button id="hudBack">Back</button>
    <button id="hudDelete" class="warn">Delete</button>
  </div>

  <div id="toast">Edit mode unlocked ✨</div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script src="https://unpkg.com/page-flip/dist/js/page-flip.browser.min.js"></script>

<script>
/* ========= Supabase ========= */
const SUPABASE_URL  = "https://tmjozxcjylcxgemffnoc.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
const TABLE_IMAGES="scrapbook_images";
const TABLE_STATE ="scrapbook_state";
const STATE_ID="main";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ========= Cloud-only boot policy ========= */
const CLOUD_ONLY       = true;
const CLOUD_TIMEOUT_MS = 12000;
const CLOUD_RETRIES    = 2;
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ========= Refs ========= */
const bookEl=document.getElementById('book');
const stageEl=document.getElementById('stage');
const toolbar=document.getElementById('toolbar');
const toast=document.getElementById('toast');
const fileInput=document.getElementById('fileInput');
const boot=document.getElementById('boot');
const bootMsg=document.getElementById('bootMsg');
const retryBtn=document.getElementById('retryBtn');

const textModal=document.getElementById('textModal');
const textModalTitle=document.getElementById('textModalTitle');
const textInput=document.getElementById('textInput');
const textAddBtn=document.getElementById('textAdd');
const textCancel=document.getElementById('textCancel');

const stickersGrid=document.getElementById('stickersGrid');
const stickerModal=document.getElementById('stickerModal');
const stickersClose=document.getElementById('stickersClose');

const fontSizeInput=document.getElementById('fontSizeInput');
const fitBtn=document.getElementById('fitToggleBtn');
const lockBtn=document.getElementById('lockToggleBtn');
const fontColorInput=document.getElementById('fontColorInput');

const itemHud   = document.getElementById('itemHud');
const hudEdit   = document.getElementById('hudEdit');
const hudFont   = document.getElementById('hudFont');
const hudFit    = document.getElementById('hudFit');
const hudLock   = document.getElementById('hudLock');
const hudDup    = document.getElementById('hudDup');
const hudFront  = document.getElementById('hudFront');
const hudBack   = document.getElementById('hudBack');
const hudDelete = document.getElementById('hudDelete');
const hudRot    = document.getElementById('hudRot');
const hudRotL   = document.getElementById('hudRotL');
const hudRotR   = document.getElementById('hudRotR');

/* ========= Global font switcher ========= */
const FONT_MAP = {
  lobster: "Lobster, 'Dancing Script', cursive",
  pacifico: "Pacifico, 'Dancing Script', cursive",
  kaushan: "Kaushan Script, 'Dancing Script', cursive",
  courgette: "Courgette, 'Dancing Script', cursive",
  alex: "Alex Brush, 'Dancing Script', cursive",
  greatvibes: "Great Vibes, 'Dancing Script', cursive",
  dancing: "'Dancing Script', cursive"
};
function setGlobalFont(which){
  var family = FONT_MAP[which] || FONT_MAP.lobster;
  document.documentElement.style.setProperty('--font', family);
  try{ localStorage.setItem('scrap_font', which); }catch(e){}
  var nodes = document.querySelectorAll('#book .scrap-text:not(.sticker)');
  for(var i=0;i<nodes.length;i++){ nodes[i].style.fontFamily=''; }
  var picker = document.getElementById('fontPicker');
  if (picker) picker.value = which;
}
function initFontPicker(){
  var picker = document.getElementById('fontPicker');
  var saved = 'lobster';
  try{ saved = localStorage.getItem('scrap_font') || 'lobster'; }catch(e){}
  setGlobalFont(saved);
  if (picker){
    picker.value = saved;
    picker.addEventListener('change', function(){ setGlobalFont(picker.value); });
  }
}

var pageFlip=null, activeCanvas=null, selectedItem=null, lastPageIndex=0;
var zCounter = 10;

/* ========= PageFlip ========= */
function initFlip(startIndex){
  if (typeof startIndex === 'undefined') startIndex = 0;
  try{ pageFlip && pageFlip.destroy && pageFlip.destroy(); }catch(_){}
  if(!(window.St && St.PageFlip)){ alert("PageFlip library missing."); return; }

  // ensure cover + one inner minimum
  var pgCount = document.querySelectorAll('#book .page').length;
  if (pgCount < 2) {
    var p=document.createElement('div'); p.className='page'; p.innerHTML='<div class="page-canvas"></div>';
    bookEl.appendChild(p);
  }

  pageFlip = new St.PageFlip(bookEl,{
    width:500,height:650,size:"fixed",showCover:true,
    drawShadow:true, flippingTime:800,maxShadowOpacity:0.25,useMouseEvents:true,
    mobileScrollSupport:false,startPage:Math.max(0,startIndex|0)
  });
  pageFlip.loadFromHTML(document.querySelectorAll('#book .page'));
  pageFlip.on('flip', function(){
    if(!document.body.classList.contains('editing')) return;
    var canv = getVisibleCanvases();
    var pick = (activeCanvas===canv.left||activeCanvas===canv.right)?activeCanvas:(canv.right||canv.left);
    highlightCanvas(pick);
  });
}

/* ========= Ensure N blank sheets at the end ========= */
function isPageEmpty(p){ return ((p && p.querySelectorAll('.scrap-item').length) || 0)===0; }
function ensureTrailingBlankSheets(nSheets){
  if (typeof nSheets === 'undefined') nSheets = 2;
  var all=[].slice.call(document.querySelectorAll('#book .page'));
  var inner = all.slice(1);
  var trailing=0;
  for(var i=inner.length-1; i>=0; i--){
    if(isPageEmpty(inner[i])) trailing++; else break;
  }
  var needPages = Math.max(0, nSheets*2 - trailing);
  for(var k=0;k<needPages;k++){
    var p=document.createElement('div'); p.className='page';
    p.innerHTML='<div class="page-canvas"></div>';
    bookEl.appendChild(p);
  }
}

/* ========= Boot helpers ========= */
function afterBootShow(){
  bookEl.style.visibility='visible';
  initFlip(0);
  boot.classList.add('hide');
  setTimeout(function(){ boot.remove(); },400);
}
function timeout(ms){ return new Promise(function(_,rej){ setTimeout(function(){ rej(new Error('timeout')); }, ms); }); }

/* ========= Init (cloud-only, retries) ========= */
init().catch(function(err){ console.error(err); });
async function init(){
  // do not block on fonts
  try{ if (document.fonts && document.fonts.ready) { document.fonts.ready.catch(function(){}); } }catch(e){}
  initFontPicker();

  var coverReady = new Promise(function(res){
    var i=new Image(); i.onload=i.onerror=res; i.src="./lovestory_cover.png?v=8";
  });
  await Promise.allSettled([coverReady]);

  bootMsg.textContent = 'loading scrapbook…';
  retryBtn.style.display='none';
  var loaded = false, lastErr = null;

  for (var attempt = 0; attempt <= CLOUD_RETRIES && !loaded; attempt++){
    try{
      if (CLOUD_TIMEOUT_MS) {
        await Promise.race([loadFromTables(), timeout(CLOUD_TIMEOUT_MS)]);
      } else {
        await loadFromTables();
      }
      loaded = true;
    }catch(err){
      lastErr = err;
      console.warn("Cloud load attempt "+(attempt+1)+" failed:", err);
      if (attempt < CLOUD_RETRIES) await sleep(800 * (attempt + 1));
    }
  }

  if (!loaded){
    if (CLOUD_ONLY){
      bootMsg.textContent = "couldn’t reach the cloud. please check your internet and try again.";
      retryBtn.style.display='inline-block';
      retryBtn.onclick = function(){ init(); };
      throw (lastErr || new Error('cloud-load-failed'));
    }else{
      // not used here
    }
  }

  ensureTrailingBlankSheets(2);
  afterBootShow();
}

/* ========= Target left/right ========= */
function getVisibleCanvases(){
  var pr=stageEl.getBoundingClientRect();
  var all=[].slice.call(document.querySelectorAll('#book .page .page-canvas')).map(function(el){
    var r=el.getBoundingClientRect();
    var w=Math.max(0,Math.min(r.right,pr.right)-Math.max(r.left,pr.left));
    var h=Math.max(0,Math.min(r.bottom,pr.bottom)-Math.max(r.top,pr.top));
    return {el:el,area:w*h,cx:r.left+r.width/2};
  }).filter(function(x){return x.area>1000;}).sort(function(a,b){return b.area-a.area;});
  var top=all.slice(0,2).sort(function(a,b){return a.cx-b.cx;});
  return {left:top.length===2?top[0].el:null,right:top.length?top[top.length-1].el:null};
}
function highlightCanvas(canvas){
  if(!canvas){ toastShow('That side is not visible here.'); return; }
  [].slice.call(document.querySelectorAll('.page-canvas')).forEach(function(c){ c.classList.remove('active-side'); });
  canvas.classList.add('active-side'); activeCanvas=canvas;
}
stageEl.addEventListener('mousedown',function(e){
  if(!document.body.classList.contains('editing')) return;
  var pc=e.target.closest('.page-canvas'); if(pc) highlightCanvas(pc);
});
document.getElementById('targetLeft').onclick = function(){ var vr=getVisibleCanvases(); highlightCanvas(vr.left||vr.right); };
document.getElementById('targetRight').onclick= function(){ var vr=getVisibleCanvases(); highlightCanvas(vr.right||vr.left); };

/* ========= Secret Edit Mode (type 123) ========= */
var PASSCODE='123', keyBuffer='', keyTimer=null;
document.addEventListener('keydown',function(e){
  keyBuffer+=e.key; clearTimeout(keyTimer); keyTimer=setTimeout(function(){ keyBuffer=''; },1200);
  if(keyBuffer.endsWith(PASSCODE)){ keyBuffer=''; enterEdit(); }
});
function setEditing(on){
  document.body.classList.toggle('editing', on);
  toolbar.classList.toggle('open', on);
  if(!on){ [].slice.call(document.querySelectorAll('.page-canvas')).forEach(function(c){ c.classList.remove('active-side'); }); activeCanvas=null; }
}
function enterEdit(){
  setEditing(true);
  lastPageIndex = pageFlip && pageFlip.getCurrentPageIndex ? pageFlip.getCurrentPageIndex() : 0;
  try{ pageFlip.update({ useMouseEvents:false, swipeDistance:10000 }); }catch(_){}
  [].slice.call(document.querySelectorAll('#book .scrap-item')).forEach(function(el){
    if(!el.dataset._hooked){ makeDraggable(el); el.dataset._hooked='1'; }
  });
  var vr = getVisibleCanvases();
  highlightCanvas(vr.right || vr.left);
  toastShow('Edit mode unlocked ✨');
}
function exitEdit(){
  setEditing(false); deselect();
  try{
    pageFlip.turnToPage(lastPageIndex);
    pageFlip.update({ useMouseEvents:true, swipeDistance:30 });
  }catch(_){}
}

/* quick exit via ESC when not in a modal */
document.addEventListener('keydown', function(e){
  var modalOpen = textModal.classList.contains('open') || stickerModal.classList.contains('open');
  if(e.key==='Escape' && document.body.classList.contains('editing') && !modalOpen){
    exitEdit();
    toastShow('Exited editing');
  }
});

/* ========= Book helpers ========= */
function closeBook(){
  exitEdit();
  try{
    var total = pageFlip.getPageCount ? pageFlip.getPageCount() : 1;
    var curr  = pageFlip.getCurrentPageIndex ? pageFlip.getCurrentPageIndex() : 0;
    var mid   = Math.floor(total/2);
    pageFlip.turnToPage(curr <= mid ? 0 : total - 1);
  }catch(_){}
}
function removeLastSheet(){
  var pages = [].slice.call(document.querySelectorAll('#book .page'));
  if (pages.length <= 2){ toastShow('No sheet to remove.'); return; }
  var inner = pages.slice(1);
  var last = inner[inner.length-1];
  var prev = inner[inner.length-2];
  var empty = function(p){ return ((p && p.querySelectorAll('.scrap-item').length) || 0)===0; };
  if (!last || !prev){ toastShow('No sheet to remove.'); return; }
  if (!empty(last) || !empty(prev)){ toastShow('Last sheet has content. Clear it first.'); return; }

  var curr = pageFlip && pageFlip.getCurrentPageIndex ? pageFlip.getCurrentPageIndex() : 0;
  last.remove(); prev.remove();

  var newIndex = Math.max(0, Math.min(curr, document.querySelectorAll('#book .page').length - 1));
  initFlip(newIndex);
  toastShow('Removed last sheet ✓');
}

/* ========= HUD, drag/resize/rotate, text tools, colors, images ========= */
function positionHud(){
  if(!selectedItem || itemHud.style.display==='none') return;
  var r=selectedItem.getBoundingClientRect(), sr=stageEl.getBoundingClientRect();
  var hudW=itemHud.offsetWidth, hudH=itemHud.offsetHeight;
  var x=r.right-sr.left-hudW, y=r.top-sr.top-hudH-8;
  x=Math.max(8,Math.min(x,sr.width-hudW-8)); if(y<8) y=r.bottom-sr.top+8;
  itemHud.style.left=x+'px'; itemHud.style.top=y+'px';
}
function getRotation(el){ return parseFloat((el && el.dataset.rot) ? el.dataset.rot : '0') || 0; }
function setRotation(el,deg){
  if(!el) return; el.dataset.rot=String(deg); el.style.transform='rotate('+deg+'deg)'; hudRot.value=Math.round(getRotation(el)); positionHud();
}
function showItemHud(el){
  if(!el){ hideItemHud(); return; }
  var onImg=!!el.querySelector('.scrap-img');
  var onText=!!el.querySelector('.scrap-text:not(.sticker)');
  [].slice.call(itemHud.querySelectorAll('.only-img')).forEach(function(n){ n.style.display=onImg?'':'none'; });
  [].slice.call(itemHud.querySelectorAll('.only-text')).forEach(function(n){ n.style.display=onText?'':'none'; });
  if(onImg){
    var fit=el.dataset.fit||'contain', lock=el.dataset.lock==='1';
    hudFit.textContent='Fit: '+(fit==='cover'?'Fill':'Contain');
    hudLock.textContent='Lock: '+(lock?'On':'Off');
  }
  if(onText){
    var t=el.querySelector('.scrap-text');
    hudFont.value=Math.round(parseFloat(getComputedStyle(t).fontSize)||22);
  }
  hudRot.value=Math.round(getRotation(el));
  itemHud.style.display='flex'; requestAnimationFrame(positionHud);
}
function hideItemHud(){ itemHud.style.display='none'; }
window.addEventListener('resize', positionHud);
itemHud.addEventListener('mousedown', function(e){ e.stopPropagation(); });

function makeDraggable(el){
  var startX=0,startY=0,origX=0,origY=0,resizing=false,startW=0,startH=0;
  var rotating=false,startAngle=0,startPointerAngle=0;
  var dragging=false, dragPointerId=null;

  var res=el.querySelector('.resizer');
  var rot=el.querySelector('.rotator'); if(!rot){ rot=document.createElement('div'); rot.className='rotator'; el.appendChild(rot); }
  var mover=el.querySelector('.mover'); if(!mover){ mover=document.createElement('div'); mover.className='mover'; el.appendChild(mover); }

  var getAngle=function(){ return parseFloat(el.dataset.rot||'0')||0; };
  var setAngle=function(deg){ el.dataset.rot=String(deg); el.style.transform='rotate('+deg+'deg)'; };

  el.addEventListener('dragstart', function(e){ e.preventDefault(); });

  if(res){
    res.addEventListener('mousedown',function(e){
      if(!document.body.classList.contains('editing')) return;
      e.stopPropagation(); e.preventDefault();
      resizing=true; startX=e.clientX; startY=e.clientY; startW=el.offsetWidth; startH=el.offsetHeight;
      document.addEventListener('mousemove',onMove); document.addEventListener('mouseup',onUp);
    });
  }
  function onMove(e){
    if(!resizing) return;
    var dx=e.clientX-startX, dy=e.clientY-startY;
    var hasImg=!!el.querySelector('.scrap-img');
    var lockOn=hasImg && el.dataset.lock==='1' && !e.shiftKey;
    var ratio=parseFloat(el.dataset.aspect || (el.offsetWidth/Math.max(1,el.offsetHeight)));
    var w=Math.max(60,startW+dx), h=Math.max(40,startH+dy);
    if(lockOn && ratio>0){ if(Math.abs(dx)>=Math.abs(dy)) h=Math.max(40,Math.round(w/ratio)); else w=Math.max(60,Math.round(h*ratio)); }
    el.style.width=w+'px'; el.style.height=h+'px';
    var t=el.querySelector('.scrap-text:not(.sticker)'); if(t && !hasImg){ t.style.height='auto'; el.style.height=Math.max(40,t.scrollHeight)+'px'; }
    var st=el.querySelector('.scrap-text.sticker'); if(st){ st.style.fontSize=Math.round(0.64*Math.min(w,h))+'px'; }
    positionHud();
  }
  function onUp(){ document.removeEventListener('mousemove',onMove); document.removeEventListener('mouseup',onUp); resizing=false; }

  rot.addEventListener('mousedown',function(e){
    if(!document.body.classList.contains('editing')) return;
    e.stopPropagation(); e.preventDefault();
    rotating=true; var r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
    startPointerAngle=Math.atan2(e.clientY-cy,e.clientX-cx); startAngle=getAngle();
    document.addEventListener('mousemove',onRotate); document.addEventListener('mouseup',endRotate);
  });
  function onRotate(e){
    if(!rotating) return;
    var r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
    var a=Math.atan2(e.clientY-cy,e.clientX-cx);
    setAngle(startAngle+(a-startPointerAngle)*180/Math.PI);
    positionHud();
  }
  function endRotate(){ rotating=false; document.removeEventListener('mousemove',onRotate); document.removeEventListener('mouseup',endRotate); }

  el.addEventListener('pointerdown', function(e){
    if(!document.body.classList.contains('editing')) return;
    var isControl = e.target.classList.contains('resizer')||e.target.classList.contains('rotator')||e.target.classList.contains('mover');
    if(isControl) return;
    e.preventDefault(); e.stopPropagation();
    if (selectedItem) selectedItem.classList.remove('selected');
    selectedItem=el; el.classList.add('selected');
    updateToolbarState(); showItemHud(el);
    startDrag(e);
  });
  mover.addEventListener('pointerdown', function(e){
    if(!document.body.classList.contains('editing')) return;
    e.preventDefault(); e.stopPropagation();
    if (selectedItem) selectedItem.classList.remove('selected');
    selectedItem=el; el.classList.add('selected');
    updateToolbarState(); showItemHud(el);
    startDrag(e);
  });

  function startDrag(e){
    dragging=true; dragPointerId=(e.pointerId!=null?e.pointerId:'mouse');
    try{ if(e.pointerId!=null && el.setPointerCapture) el.setPointerCapture(e.pointerId);}catch(_){}
    startX=e.clientX; startY=e.clientY; origX=el.offsetLeft; origY=el.offsetTop;
    window.addEventListener('pointermove',onPointerMove);
    window.addEventListener('pointerup',onPointerUp);
    window.addEventListener('pointercancel',onPointerUp);
    el.addEventListener('lostpointercapture',onPointerUp);
  }
  function onPointerMove(e){
    if(!dragging) return;
    var dx=e.clientX-startX, dy=e.clientY-startY;
    el.style.left=(origX+dx)+'px'; el.style.top=(origY+dy)+'px';
    positionHud();
  }
  function onPointerUp(){
    if(!dragging) return;
    try{ if(dragPointerId!=null && el.releasePointerCapture) el.releasePointerCapture(dragPointerId);}catch(_){}
    dragging=false; dragPointerId=null;
    window.removeEventListener('pointermove',onPointerMove);
    window.removeEventListener('pointerup',onPointerUp);
    window.removeEventListener('pointercancel',onPointerUp);
    el.removeEventListener('lostpointercapture',onPointerUp);
  }

  var tnode=el.querySelector('.scrap-text:not(.sticker)'); if(tnode) enableAutoGrow(el,tnode);
}
function enableAutoGrow(box,textEl){
  function grow(){ textEl.style.height='auto'; box.style.height=Math.max(40,textEl.scrollHeight)+'px'; positionHud(); }
  textEl.addEventListener('input',grow); new ResizeObserver(grow).observe(textEl); grow();
}

document.addEventListener('click',function(e){
  if(!document.body.classList.contains('editing')) return;
  var onItem=e.target.closest('.scrap-item'), onBar=e.target.closest('#toolbar'), onHud=e.target.closest('#itemHud'), onModal=e.target.closest('.modal');
  if(!onItem && !onBar && !onHud && !onModal) deselect();
});
function deselect(){ if (selectedItem) selectedItem.classList.remove('selected'); selectedItem=null; updateToolbarState(); hideItemHud(); }

var workingBox=null;
function openTextModalForAdd(){ workingBox=null; textModalTitle.textContent='Add Text'; textAddBtn.textContent='Add Text'; textInput.value=''; openModal(textModal); setTimeout(function(){ textInput.focus(); },10); }
function openTextModalForEdit(box){ workingBox=box; var t=box.querySelector('.scrap-text'); textModalTitle.textContent='Edit Text'; textAddBtn.textContent='Save'; textInput.value=t?t.textContent:''; openModal(textModal); setTimeout(function(){ textInput.focus(); },10); }

document.getElementById('addTextBtn').onclick=function(){ openTextModalForAdd(); };
textCancel.onclick=function(){ closeModal(textModal); };
textAddBtn.onclick=function(){
  var val=textInput.value;
  if(workingBox){
    var t=workingBox.querySelector('.scrap-text'); if(t){ t.textContent=val; t.style.height='auto'; workingBox.style.height=Math.max(40,t.scrollHeight)+'px'; }
    closeModal(textModal); showItemHud(workingBox); return;
  }
  var box=document.createElement('div');
  box.className='scrap-item'; box.style.left='40px'; box.style.top='40px'; box.style.width='320px';
  box.innerHTML='<div class="scrap-text" contenteditable="false">'+val.replace(/</g,"&lt;")+'</div>'
               +'<div class="mover" title="Drag"></div>'
               +'<div class="resizer"></div><div class="rotator"></div>';
  (activeCanvas||getVisibleCanvases().right).appendChild(box); makeDraggable(box); box.dataset._hooked='1';
  closeModal(textModal);
};
document.addEventListener('dblclick',function(e){
  if(!document.body.classList.contains('editing')) return;
  var t=e.target.closest('.scrap-text'); if(t && !t.classList.contains('sticker')){ var box=t.closest('.scrap-item'); if(box){ selectedItem=box; box.classList.add('selected'); updateToolbarState(); showItemHud(box); openTextModalForEdit(box); } }
});
document.addEventListener('keydown',function(e){
  if(!document.body.classList.contains('editing')) return;
  if(!selectedItem) return;
  var key=e.key.toLowerCase();
  if((key==='e'||key==='enter') && selectedItem.querySelector('.scrap-text:not(.sticker)')){ e.preventDefault(); openTextModalForEdit(selectedItem); }
  var step=e.shiftKey?1:5;
  if(e.key==='['){ e.preventDefault(); setRotation(selectedItem,getRotation(selectedItem)-step); }
  if(e.key===']'){ e.preventDefault(); setRotation(selectedItem,getRotation(selectedItem)+step); }
});

function selectedTextEl(){ if(!selectedItem) return null; var t=selectedItem.querySelector('.scrap-text'); return (t && !t.classList.contains('sticker'))?t:null; }
function updateFontInput(){
  var t=selectedTextEl(); if(!t){ fontSizeInput.disabled=true; fontSizeInput.value=''; fontSizeInput.placeholder='px'; return; }
  fontSizeInput.disabled=false; var curr=Math.round(parseFloat(getComputedStyle(t).fontSize)||22); fontSizeInput.value=curr; hudFont.value=curr;
}
fontSizeInput.addEventListener('input',function(){
  var t=selectedTextEl(); if(!t) return; var v=parseInt(fontSizeInput.value,10); if(isNaN(v)) return;
  v=Math.max(8,Math.min(200,v)); t.style.fontSize=v+'px'; t.style.height='auto';
  var box=t.closest('.scrap-item'); if(box) box.style.height=Math.max(40,t.scrollHeight)+'px'; hudFont.value=v;
});
hudEdit.onclick = function(){
  if (selectedItem && selectedItem.querySelector('.scrap-text:not(.sticker)')) {
    openTextModalForEdit(selectedItem);
  }
};
hudFont.addEventListener('input',function(){
  var t=selectedTextEl(); if(!t) return; var v=parseInt(hudFont.value,10); if(isNaN(v)) return;
  v=Math.max(8,Math.min(200,v)); t.style.fontSize=v+'px'; t.style.height='auto';
  var box=t.closest('.scrap-item'); if(box) box.style.height=Math.max(40,t.scrollHeight)+'px'; fontSizeInput.value=v;
});

function selectedAnyTextEl(){ if(!selectedItem) return null; return selectedItem.querySelector('.scrap-text'); }
function rgbToHex(rgb){
  var m=String(rgb).match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
  if(!m) return '#000000';
  var r=(+m[1]).toString(16).padStart(2,'0'), g=(+m[2]).toString(16).padStart(2,'0'), b=(+m[3]).toString(16).padStart(2,'0');
  return '#'+r+g+b;
}
function looksLikeEmoji(s){
  try{ return /\p{Extended_Pictographic}/u.test(s||''); } catch(_){ return /[\uD83C-\uDBFF\uDC00-\uDFFF]/.test(s||''); }
}
function updateColorInput(){
  var t=selectedAnyTextEl();
  if(!t){ fontColorInput.disabled=true; fontColorInput.title=''; return; }
  var isSticker=t.classList.contains('sticker');
  var emojiLocked=isSticker && (selectedItem && selectedItem.dataset && selectedItem.dataset.emoji==='1' || looksLikeEmoji(t.textContent));
  if(emojiLocked){ fontColorInput.disabled=true; fontColorInput.title='emoji color is locked'; return; }
  fontColorInput.disabled=false; fontColorInput.title='';
  var comp=getComputedStyle(t).color; fontColorInput.value=comp.indexOf('#')===0?comp:rgbToHex(comp);
}
fontColorInput.addEventListener('input',function(){
  var t=selectedAnyTextEl(); if(!t) return;
  var isSticker=t.classList.contains('sticker');
  var emojiLocked=isSticker && (selectedItem && selectedItem.dataset && selectedItem.dataset.emoji==='1' || looksLikeEmoji(t.textContent));
  if(emojiLocked) return;
  t.style.color=fontColorInput.value;
});

function updateImageButtons(){
  var onImg=!!(selectedItem && selectedItem.querySelector('.scrap-img'));
  fitBtn.disabled=!onImg; lockBtn.disabled=!onImg;
  if(onImg){
    var fit=selectedItem.dataset.fit||'contain', lock=selectedItem.dataset.lock==='1';
    fitBtn.textContent='Fit: '+(fit==='cover'?'Fill':'Contain');
    lockBtn.textContent='Lock: '+(lock?'On':'Off');
  } else {
    fitBtn.textContent='Fit: Contain'; lockBtn.textContent='Lock: On';
  }
}
fitBtn.onclick=function(){ if(!(selectedItem && selectedItem.querySelector('.scrap-img'))) return; var cur=selectedItem.dataset.fit||'contain'; selectedItem.dataset.fit=(cur==='cover')?'contain':'cover'; updateImageButtons(); showItemHud(selectedItem); };
lockBtn.onclick=function(){ if(!(selectedItem && selectedItem.querySelector('.scrap-img'))) return; selectedItem.dataset.lock=(selectedItem.dataset.lock==='1')?'0':'1'; updateImageButtons(); showItemHud(selectedItem); };
function updateToolbarState(){ updateImageButtons(); updateFontInput(); updateColorInput(); }

hudRot.addEventListener('input',function(){ if(!selectedItem) return; var v=parseFloat(hudRot.value); if(isNaN(v)) return; setRotation(selectedItem,v); });
hudRotL.onclick=function(){ if(!selectedItem) return; setRotation(selectedItem,getRotation(selectedItem)-5); };
hudRotR.onclick=function(){ if(!selectedItem) return; setRotation(selectedItem,getRotation(selectedItem)+5); };
hudDup.onclick = function(){ if(!selectedItem) return; var clone=selectedItem.cloneNode(true); clone.style.left=(selectedItem.offsetLeft+16)+'px'; clone.style.top=(selectedItem.offsetTop+16)+'px'; selectedItem.parentElement.appendChild(clone); makeDraggable(clone); clone.dataset._hooked='1'; };
hudFront.onclick = function(){ if(selectedItem){ selectedItem.style.zIndex=++zCounter; } };
hudBack.onclick  = function(){ if(selectedItem){ selectedItem.style.zIndex=0; } };
hudDelete.onclick= function(){ if(selectedItem){ selectedItem.remove(); deselect(); } };

/* Photos & stickers */
document.getElementById('addPhotoBtn').onclick=function(){ fileInput.click(); };
fileInput.addEventListener('change',async function(e){
  var f=e.target.files[0]; if(!f) return;
  var enc=await compressToBase64(f,1600,0.85);
  var mime=enc.mime, base64=enc.base64;
  var box=document.createElement('div');
  box.className='scrap-item'; box.style.left='90px'; box.style.top='90px'; box.style.width='320px'; box.style.height='230px';
  box.dataset.fit='contain'; box.dataset.lock='1';
  box.innerHTML='<img class="scrap-img" alt="" src="data:'+mime+';base64,'+base64+'" decoding="async">'
               +'<div class="mover" title="Drag"></div>'
               +'<div class="resizer"></div><div class="rotator"></div>';
  (activeCanvas||getVisibleCanvases().right).appendChild(box); makeDraggable(box); box.dataset._hooked='1';
  var imgEl=box.querySelector('.scrap-img');
  var setAspect=function(){ if(imgEl.naturalWidth&&imgEl.naturalHeight){ box.dataset.aspect=(imgEl.naturalWidth/imgEl.naturalHeight).toFixed(5);} };
  if(imgEl.complete) setAspect(); else imgEl.addEventListener('load',setAspect);
  imgEl._preb64={mime:mime,base64:base64}; fileInput.value='';
});

// safer sticker set (ASCII + emojis)
var STICKERS_EMOJI=[ "🎮","👾","🕹️","💚","💜","💙","💛","🩷","💌","♕","♚","★","☆","♥","♡","✿","♪","♫","∞","💫" ];
document.getElementById('stickersBtn').onclick=function(){
  stickersGrid.innerHTML='';
  STICKERS_EMOJI.forEach(function(ch){
    var b=document.createElement('button'); b.textContent=ch; b.title=ch;
    b.addEventListener('click',function(){
      var box=document.createElement('div');
      box.className='scrap-item'; box.style.left='60px'; box.style.top='60px'; box.style.width='100px';
      var isEmoji=looksLikeEmoji(ch); box.dataset.emoji=isEmoji?'1':'0';
      box.innerHTML='<div class="scrap-text sticker" style="font-size:64px;">'+ch+'</div>'
                   +'<div class="mover" title="Drag"></div>'
                   +'<div class="resizer"></div><div class="rotator"></div>';
      (activeCanvas||getVisibleCanvases().right).appendChild(box); makeDraggable(box); box.dataset._hooked='1';
    });
    stickersGrid.appendChild(b);
  });
  openModal(stickerModal);
};
stickersClose.onclick=function(){ closeModal(stickerModal); };

/* Book buttons */
document.getElementById('exitEditBtn').onclick = function(){ exitEdit(); };
document.getElementById('closeBookBtn').onclick = function(){ closeBook(); };
document.getElementById('removeSheetBtn').onclick = function(){ removeLastSheet(); };

/* Delete/Clear/Save */
document.getElementById('deleteSelectedBtn').onclick=function(){ if(selectedItem){selectedItem.remove(); deselect();} };
document.getElementById('clearPageBtn').onclick=function(){ (activeCanvas||getVisibleCanvases().right).innerHTML=''; deselect(); };
document.getElementById('saveBtn').onclick=function(){ saveToTables().catch(function(e){ alert('Save failed: '+e); }); };

/* Save */
async function saveToTables(){
  toastShow('Saving…');
  var imgs=[].slice.call(document.querySelectorAll('#book .scrap-img'));
  for(var ii=0; ii<imgs.length; ii++){
    var img=imgs[ii];
    if(img.dataset.imgid) continue;
    var mime,base64;
    if(img._preb64){ mime=img._preb64.mime; base64=img._preb64.base64; }
    else{
      var r=await fetch(img.src); var b=await r.blob(); var enc=await compressToBase64(b,1600,0.85); mime=enc.mime; base64=enc.base64;
    }
    var ins=await supabase.from(TABLE_IMAGES).insert([{content_type:mime,data_base64:base64}]).select('id').single();
    if(ins.error) throw ins.error; img.dataset.imgid=ins.data.id; delete img._preb64;
  }
  var canvases=[].slice.call(document.querySelectorAll('#book .page .page-canvas'));
  var pages=[];
  canvases.forEach(function(c){
    var items=[];
    [].slice.call(c.querySelectorAll('.scrap-item')).forEach(function(el){
      var style={left:el.style.left, top:el.style.top, width:el.style.width, height:el.style.height};
      var rot=parseFloat(el.dataset.rot||'0')||0;
      var img=el.querySelector('.scrap-img');
      if(img){ items.push({type:'image',style:style,rot:rot,imageId:img.dataset.imgid||null,fit:el.dataset.fit||'contain',lock:el.dataset.lock==='1'}); }
      else{
        var txt=el.querySelector('.scrap-text'); items.push({type:'text',style:style,rot:rot,html:txt?txt.outerHTML:''});
      }
    });
    pages.push({items:items});
  });
  var up=await supabase.from(TABLE_STATE).upsert({id:STATE_ID,pages:pages}).select('id').single();
  if(up.error) throw up.error;
  toastShow('Saved ✓'); setTimeout(function(){ exitEdit(); },300);
}

/* Load from tables */
async function loadFromTables(){
  var stateRow=await supabase.from(TABLE_STATE).select('pages').eq('id',STATE_ID).maybeSingle();
  if(stateRow.error) throw stateRow.error;
  var state=stateRow.data;
  if(!state || !state.pages){ return; }

  var have=document.querySelectorAll('#book .page').length-1, need=state.pages.length;
  for(var i=have;i<need;i++){
    var p=document.createElement('div'); p.className='page'; p.innerHTML='<div class="page-canvas"></div>'; bookEl.appendChild(p);
  }

  var ids=[]; state.pages.forEach(function(pg){ (pg.items||[]).forEach(function(it){ if(it.type==='image'&&it.imageId) ids.push(it.imageId); }); });
  var uniq=[].filter.call(ids, function(v, i, a){ return a.indexOf(v)===i; });
  var urlMap={};
  if(uniq.length){
    var imgs=await supabase.from(TABLE_IMAGES).select('id,content_type,data_base64').in('id',uniq);
    if(imgs.error) throw imgs.error;
    (imgs.data||[]).forEach(function(r){ urlMap[r.id]='data:'+r.content_type+';base64,'+r.data_base64; });
  }

  var canvases=[].slice.call(document.querySelectorAll('#book .page .page-canvas'));
  for(var j=0;j<Math.min(state.pages.length,canvases.length);j++){
    var c=canvases[j]; c.innerHTML='';
    var items=state.pages[j].items||[];
    for(var k=0;k<items.length;k++){
      var it=items[k];
      var box=document.createElement('div'); box.className='scrap-item';
      box.style.left=(it.style && it.style.left)||'40px'; box.style.top=(it.style && it.style.top)||'40px';
      if(it.style && it.style.width) box.style.width=it.style.width;
      if(it.style && it.style.height) box.style.height=it.style.height;
      if(it.rot){ box.dataset.rot=it.rot; box.style.transform='rotate('+it.rot+'deg)'; }
      if(it.type==='image'&&it.imageId){
        var url=urlMap[it.imageId]||''; box.dataset.fit=it.fit||'contain'; box.dataset.lock=it.lock?'1':'0';
        box.innerHTML='<img class="scrap-img" data-imgid="'+it.imageId+'" src="'+url+'" alt="" decoding="async">'
                     +'<div class="mover" title="Drag"></div><div class="resizer"></div><div class="rotator"></div>';
        (function(bx){
          var imgEl=bx.querySelector('.scrap-img');
          var setAspect=function(){ if(imgEl.naturalWidth&&imgEl.naturalHeight){ bx.dataset.aspect=(imgEl.naturalWidth/imgEl.naturalHeight).toFixed(5);} };
          if(imgEl.complete) setAspect(); else imgEl.addEventListener('load',setAspect);
        })(box);
      }else if(it.type==='text'&&it.html){
        var holder=document.createElement('div'); holder.innerHTML=(it.html||'').trim();
        var inner=holder.firstElementChild||document.createElement('div'); inner.setAttribute('contenteditable','false'); box.appendChild(inner);
        box.insertAdjacentHTML('beforeend','<div class="mover" title="Drag"></div><div class="resizer"></div><div class="rotator"></div>');
        if(inner.classList.contains('sticker')){
          box.dataset.emoji = looksLikeEmoji(inner.textContent) ? '1' : '0';
        }
      }
      c.appendChild(box); makeDraggable(box); box.dataset._hooked='1';
    }
  }
}

/* Modals */
function openModal(el){
  hideItemHud();
  el.classList.add('open');
  el.setAttribute('aria-hidden','false');
  document.body.classList.add('modal-open');
}
function closeModal(el){
  el.classList.remove('open');
  el.setAttribute('aria-hidden','true');
  document.body.classList.remove('modal-open');
}
stickerModal.addEventListener('click', function(e){ if(e.target===stickerModal) closeModal(stickerModal); });
textModal.addEventListener('click', function(e){ if(e.target===textModal) closeModal(textModal); });
document.addEventListener('keydown', function(e){
  if(e.key==='Escape'){
    if(stickerModal.classList.contains('open')) closeModal(stickerModal);
    if(textModal.classList.contains('open'))    closeModal(textModal);
  }
});

/* Utils */
function toastShow(msg){ toast.textContent=msg; toast.style.display='block'; setTimeout(function(){ toast.style.display='none'; },1600); }

async function compressToBase64(fileOrBlob, maxSide, quality, pageColor){
  if (typeof maxSide==='undefined') maxSide=1600;
  if (typeof quality==='undefined') quality=0.85;
  if (typeof pageColor==='undefined') pageColor='#f7eddc';
  var blob=fileOrBlob instanceof Blob?fileOrBlob:new Blob([fileOrBlob]);
  var inputMime=blob.type||'image/png';
  var img=await new Promise(function(res,rej){ var i=new Image(); i.onload=function(){res(i);}; i.onerror=rej; i.src=URL.createObjectURL(blob); });
  var w=img.width,h=img.height;
  if(Math.max(w,h)>maxSide){ if(w>h){ h=Math.round(h*(maxSide/w)); w=maxSide; } else { w=Math.round(h*(maxSide/h)); h=maxSide; } }
  var canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
  var ctx=canvas.getContext('2d');
  var wantsAlpha=/png|webp|gif/i.test(inputMime);
  if(!wantsAlpha){ ctx.fillStyle=pageColor; ctx.fillRect(0,0,w,h); }
  ctx.drawImage(img,0,0,w,h);
  var outMime=wantsAlpha?'image/png':'image/jpeg';
  var dataUrl=canvas.toDataURL(outMime,wantsAlpha?1.0:quality);
  URL.revokeObjectURL(img.src);
  return { mime:outMime, base64:dataUrl.split(',')[1] };
}
</script>
</body>
</html>
