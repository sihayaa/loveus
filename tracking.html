<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Package Tracking</title>
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.min.js"></script>
  <style>
    :root{
      --green:#4fa981;
      --green-ink:#2e6b5e;
      --purple:#a372d1;
      --card:#ffffff;
      --glass: rgba(255,255,255,0.75);
      --shadow: 0 10px 30px rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    body{
      font-family:'Patrick Hand',cursive;
      background:white;margin:0;padding:40px;color:#333;
      display:flex;flex-direction:column;align-items:center;
    }
    h1{color:var(--green);font-size:36px;margin:0 0 20px;text-shadow:0 0 5px #fff;}
    form{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;justify-content:center}
    input{
      padding:8px;border:2px solid var(--green);border-radius:8px;font-size:16px;width:240px
    }
    button{cursor:pointer}

    ul{list-style:none;padding:0;margin:0;width:100%;max-width:680px}
    li{
      background:var(--glass);
      backdrop-filter: blur(8px);
      border:1px solid #e6f4ef;border-radius:12px;
      padding:12px 14px;margin:10px 0;
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      box-shadow: var(--shadow);
    }
    .left{display:flex;align-items:center;gap:10px;min-width:220px}
    .desc{font-weight:700;color:var(--green-ink);text-decoration:none;word-break:break-word;}
    .received .desc{color:gray;text-decoration:line-through}

    .mini-btn{
      border:1px solid #bfa7e4;background:#ede6f8;color:#523b77;
      padding:4px 10px;border-radius:8px;font-size:14px;line-height:1;transition:.15s;
    }
    .mini-btn:hover{transform:translateY(-1px)}
    .mini-btn.invert{border-color:#a6d6c6;background:#e9f6f2;color:var(--green-ink)}

    .icon-btn{
      border:1px solid #e5e5e5;background:#fff;border-radius:10px;
      padding:6px 8px;display:flex;align-items:center;justify-content:center;
      transition:.15s; box-shadow: var(--shadow);
    }
    .icon-btn:hover{transform:translateY(-1px);background:#f7f7f7}
    .icon-red{border-color:#f5c5cc;background:#fdecee}
    .icon-red:hover{background:#fbd9de}
    .right{display:flex;gap:8px;align-items:center}
    .hint{opacity:.75;font-size:14px;margin-top:10px}

    .backdrop{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35); z-index:1000;
    }
    .backdrop.show{display:flex;}

    .modal{
      width:min(92vw,520px);
      border-radius:16px;
      padding:18px;
      background:rgba(255,255,255,.6);
      backdrop-filter: blur(12px);
      box-shadow: 0 20px 50px rgba(0,0,0,.25);
      border:1px solid #e9d9f6;
      color:#222;
      text-align:left;
    }
    .modal h2{
      margin:0 0 12px;
      color:#4a004a;
      text-shadow: 0 0 6px #d2b4de;
      font-size:24px;
    }
    .modal .row{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    .modal label{font-size:14px;color:#4a004a}
    .modal input{
      width:100%; padding:10px; border:2px solid var(--purple); border-radius:10px;
      font-size:16px; background:rgba(255,255,255,.9);
    }
    .modal .actions{
      margin-top:14px; display:flex; gap:10px; justify-content:flex-end;
    }
    .btn{
      padding:8px 14px; border-radius:10px; border:1px solid transparent; font-size:16px;
      box-shadow: var(--shadow);
    }
    .btn-primary{ background: var(--green); color:#fff; }
    .btn-secondary{ background:#ede6f8; color:#523b77; border-color:#bfa7e4;}
    .btn-danger{ background:#e0576a; color:#fff; }
    .btn:hover{transform:translateY(-1px)}

    .modal p{margin:10px 0 0}
  </style>
</head>
<body>
  <h1>üì¶ Package Tracking</h1>

  <form id="tracking-form">
    <input type="text" id="description" placeholder="Description (e.g., Birthday gift)" required />
    <input type="url" id="link" placeholder="Tracking Link (https://‚Ä¶)" required />
    <button type="submit" class="mini-btn invert">Add</button>
  </form>

  <div class="hint">Tip: paste the courier‚Äôs tracking URL (UPS/USPS/FedEx/LBC/etc.). Click ‚ÄúReceive‚Äù to cross it out.</div>

  <ul id="tracking-list"></ul>

  <div class="backdrop" id="edit-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-title">
      <h2 id="edit-title">Edit entry</h2>
      <div class="row">
        <label for="edit-desc">Description</label>
        <input id="edit-desc" type="text" />
      </div>
      <div class="row">
        <label for="edit-link">Tracking link</label>
        <input id="edit-link" type="url" />
      </div>
      <div class="actions">
        <button class="btn btn-secondary" id="edit-cancel">Cancel</button>
        <button class="btn btn-primary" id="edit-save">Save</button>
      </div>
    </div>
  </div>

  <div class="backdrop" id="delete-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="delete-title">
      <h2 id="delete-title">Delete entry?</h2>
      <p>This can‚Äôt be undone.</p>
      <div class="actions">
        <button class="btn btn-secondary" id="delete-cancel">Cancel</button>
        <button class="btn btn-danger" id="delete-confirm">Delete</button>
      </div>
    </div>
  </div>

  <script>

    const supabaseUrl = "https://tmjozxcjylcxgemffnoc.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    function normalizeUrl(u){
      if (!u) return "";
      if (!/^https?:\/\//i.test(u)) return "https://" + u;
      return u;
    }

    let editingItem = null;
    let deletingItem = null;

    function $(id){ return document.getElementById(id); }

    async function loadTracking(){
      const { data, error } = await supabaseClient
        .from("tracking_links")
        .select("*")
        .order("received", { ascending: true })
        .order("id", { ascending: false });

      if (error) { console.error(error); return; }

      const list = $("tracking-list");
      list.innerHTML = "";
      data.forEach(item => list.appendChild(renderItem(item)));
    }

    function renderItem(item){
      const li = document.createElement("li");
      if (item.received) li.classList.add("received");

      const left = document.createElement("div");
      left.className = "left";

      const a = document.createElement("a");
      a.href = item.link; a.target = "_blank"; a.rel = "noopener";
      a.className = "desc"; a.textContent = item.description;
      left.appendChild(a);

      const right = document.createElement("div");
      right.className = "right";

      const receiveBtn = document.createElement("button");
      receiveBtn.className = "mini-btn";
      receiveBtn.textContent = item.received ? "Undo" : "Receive";
      receiveBtn.title = item.received ? "Mark as not received" : "Mark as received";
      receiveBtn.onclick = async () => {
        await supabaseClient.from("tracking_links")
          .update({ received: !item.received })
          .eq("id", item.id);
      };
)
      const editBtn = document.createElement("button");
      editBtn.className = "icon-btn";
      editBtn.setAttribute("aria-label","Edit");
      editBtn.title = "Edit";
      editBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" stroke="#444" stroke-width="1.5" fill="#fff"/>
          <path d="M14.06 6.19l3.75 3.75 1.69-1.69a1.5 1.5 0 0 0 0-2.12l-1.63-1.63a1.5 1.5 0 0 0-2.12 0l-1.69 1.69z" fill="#a372d1"/>
        </svg>`;
      editBtn.onclick = () => openEditModal(item);

      const delBtn = document.createElement("button");
      delBtn.className = "icon-btn icon-red";
      delBtn.setAttribute("aria-label","Delete");
      delBtn.title = "Delete";
      delBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M9 3h6m-9 4h12M6 7l1 13a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-13" stroke="#b82a3a" stroke-width="1.6"/>
          <rect x="9" y="11" width="2" height="7" fill="#b82a3a"/><rect x="13" y="11" width="2" height="7" fill="#b82a3a"/>
        </svg>`;
      delBtn.onclick = () => openDeleteModal(item);

      right.appendChild(receiveBtn);
      right.appendChild(editBtn);
      right.appendChild(delBtn);

      li.appendChild(left);
      li.appendChild(right);
      return li;
    }

    $("tracking-form").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const description = $("description").value.trim();
      let link = $("link").value.trim();
      if (!description || !link) return;
      link = normalizeUrl(link);

      const { error } = await supabaseClient
        .from("tracking_links")
        .insert([{ description, link, received: false }]);

      if (!error){
        e.target.reset();
      } else {
        console.error(error);
        alert("Failed to add. Please try again.");
      }
    });

    function openEditModal(item){
      editingItem = item;
      $("edit-desc").value = item.description || "";
      $("edit-link").value = item.link || "";
      $("edit-backdrop").classList.add("show");
      $("edit-desc").focus();
    }
    function closeEditModal(){
      $("edit-backdrop").classList.remove("show");
      editingItem = null;
    }
    $("edit-cancel").onclick = closeEditModal;
    $("edit-save").onclick = async ()=>{
      if (!editingItem) return;
      const newDesc = $("edit-desc").value.trim();
      let newLink = normalizeUrl($("edit-link").value.trim());
      if (!newDesc || !newLink) return;
      const { error } = await supabaseClient.from("tracking_links")
        .update({ description:newDesc, link:newLink })
        .eq("id", editingItem.id);
      if (error) { alert("Update failed."); return; }
      closeEditModal();
    };

    $("edit-backdrop").addEventListener("click", (e)=>{
      if (e.target.id === "edit-backdrop") closeEditModal();
    });

    document.addEventListener("keydown", (e)=>{
      if (e.key === "Escape"){
        if ($("edit-backdrop").classList.contains("show")) closeEditModal();
        if ($("delete-backdrop").classList.contains("show")) closeDeleteModal();
      }
    });

    function openDeleteModal(item){
      deletingItem = item;
      $("delete-backdrop").classList.add("show");
    }
    function closeDeleteModal(){
      $("delete-backdrop").classList.remove("show");
      deletingItem = null;
    }
    $("delete-cancel").onclick = closeDeleteModal;
    $("delete-confirm").onclick = async ()=>{
      if (!deletingItem) return;
      await supabaseClient.from("tracking_links").delete().eq("id", deletingItem.id);
      closeDeleteModal();
    };
    $("delete-backdrop").addEventListener("click", (e)=>{
      if (e.target.id === "delete-backdrop") closeDeleteModal();
    });

    supabaseClient
      .channel("tracking_changes")
      .on("postgres_changes", { event: "*", schema: "public", table: "tracking_links" }, loadTracking)
      .subscribe();

    loadTracking();
  </script>
</body>
</html>
