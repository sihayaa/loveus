<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Package Tracking</title>
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.min.js"></script>
  <style>
    :root{
      --green:#4fa981;
      --green-ink:#2e6b5e;
      --purple:#a372d1;
      --glass: rgba(255,255,255,0.05);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --manila:#17BD8D;
    }
    *{box-sizing:border-box}
    body{
      font-family:'Patrick Hand',cursive;
      background:#782F54;
      margin:0;padding:40px;
      color:#f0e8f3;
      display:flex;flex-direction:column;align-items:center;
      position: relative;
    }
    #back-home {
      position: absolute;
      top: 20px;
      left: 20px;
      color: var(--green);
      text-decoration: none;
      font-size: 18px;
      background: var(--glass);
      padding: 6px 12px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      transition: 0.15s;
    }
    #back-home:hover {
      transform: translateY(-1px);
      background: rgba(255,255,255,0.1);
    }
    h1{
      color:var(--green);
      font-size:36px;
      margin:0 0 20px;
      text-shadow:0 0 6px rgba(0,0,0,0.6);
    }
    form{
      display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;justify-content:center
    }
    input{
      padding:8px;
      border:2px solid var(--green);
      border-radius:8px;
      font-size:16px;
      width:240px;
      background:rgba(255,255,255,0.1);
      color:#fff;
    }
    input::placeholder{color:#d8c9d4;}
    button{cursor:pointer}
    ul{list-style:none;padding:0;margin:0;width:100%;max-width:680px}
    li{
      background:var(--glass);
      backdrop-filter: blur(6px);
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      padding:12px 14px;margin:10px 0;
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      box-shadow: var(--shadow);
    }
    .left{display:flex;flex-direction:column;align-items:flex-start;gap:4px;min-width:220px}
    .desc{font-weight:700;color:#fff;text-decoration:none;word-break:break-word;}
    .received .desc{color:#aaa;text-decoration:line-through}
    .time-info{
      font-size:12px;opacity:0.95;white-space:nowrap;
      display:flex;gap:8px;align-items:center;
    }
    .v-time{color:#d7b6ff;}
    .m-time{color:var(--manila);}
    .divider{opacity:.6;color:#ccc}
    .mini-btn{
      border:1px solid #bfa7e4;
      background:#2f1b33;
      color:#d8c6ee;
      padding:4px 10px;
      border-radius:8px;
      font-size:14px;
      line-height:1;
      transition:.15s;
    }
    .mini-btn:hover{transform:translateY(-1px);background:#3b2240;}
    .mini-btn.invert{border-color:#a6d6c6;background:#214d43;color:#aaf0d4;}
    .icon-btn{
      border:1px solid #4b3256;
      background:#2e1935;
      border-radius:10px;
      padding:6px 8px;
      display:flex;align-items:center;justify-content:center;
      transition:.15s; box-shadow: var(--shadow);
      color:#fff;
    }
    .icon-btn:hover{transform:translateY(-1px);background:#3b2240}
    .icon-red{border-color:#86444d;background:#521f28}
    .icon-red:hover{background:#6b2833}
    .right{display:flex;gap:8px;align-items:center}
    .hint {
      opacity: 0.9;
      font-size: 14px;
      margin-top: 10px;
      text-align: center;
      color: #e8dcea;
      text-shadow: 0 0 4px rgba(0,0,0,0.5);
    }
    .backdrop{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.5); z-index:1000;
    }
    .backdrop.show{display:flex;}
    .modal{
      width:min(92vw,520px);
      border-radius:16px;
      padding:18px;
      background:rgba(60,30,70,0.95);
      backdrop-filter: blur(12px);
      box-shadow: 0 20px 50px rgba(0,0,0,.4);
      border:1px solid rgba(255,255,255,0.15);
      color:#f0e8f3;
      text-align:left;
    }
    .modal h2{
      margin:0 0 12px;
      color:#caa8f0;
      text-shadow: 0 0 6px #5a3268;
      font-size:24px;
    }
    .modal .row{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    .modal label{font-size:14px;color:#e8d6f6}
    .modal input{
      width:100%; padding:10px; border:2px solid var(--purple); border-radius:10px;
      font-size:16px; background:rgba(255,255,255,0.1); color:#fff;
    }
    .modal .actions{
      margin-top:14px; display:flex; gap:10px; justify-content:flex-end;
    }
    .btn{
      padding:8px 14px; border-radius:10px; border:1px solid transparent; font-size:16px;
      box-shadow: var(--shadow);
    }
    .btn-primary{ background: var(--green); color:#fff; }
    .btn-secondary{ background:#3a1f47; color:#e1cfff; border-color:#bfa7e4;}
    .btn-danger{ background:#e0576a; color:#fff; }
    .btn:hover{transform:translateY(-1px)}
    .modal p{margin:10px 0 0}
  </style>
</head>
<body>
  <a href="index.html" id="back-home">‚Üê Back Home</a>
  <h1>üì¶ Package Tracking</h1>
  <form id="tracking-form">
    <input type="text" id="description" placeholder="Description (e.g., Birthday gift)" required />
    <input type="url" id="link" placeholder="Tracking Link (https://‚Ä¶)" required />
    <button type="submit" class="mini-btn invert">Add</button>
  </form>
  <div class="hint">Tip: paste the courier‚Äôs tracking URL. Click ‚ÄúReceive‚Äù to cross it out.</div>
  <div style="text-align:center; margin:10px 0;">
    <button id="sort-toggle" class="mini-btn invert">Sort: Oldest ‚Üí Newest</button>
  </div>
  <ul id="tracking-list"></ul>

  <div class="backdrop" id="edit-backdrop">
    <div class="modal">
      <h2>Edit entry</h2>
      <div class="row">
        <label for="edit-desc">Description</label>
        <input id="edit-desc" type="text" />
      </div>
      <div class="row">
        <label for="edit-link">Tracking link</label>
        <input id="edit-link" type="url" />
      </div>
      <div class="actions">
        <button class="btn btn-secondary" id="edit-cancel">Cancel</button>
        <button class="btn btn-primary" id="edit-save">Save</button>
      </div>
    </div>
  </div>

  <div class="backdrop" id="delete-backdrop">
    <div class="modal">
      <h2>Delete entry?</h2>
      <p>This can‚Äôt be undone.</p>
      <div class="actions">
        <button class="btn btn-secondary" id="delete-cancel">Cancel</button>
        <button class="btn btn-danger" id="delete-confirm">Delete</button>
      </div>
    </div>
  </div>

  <script>
    const supabaseUrl = "https://tmjozxcjylcxgemffnoc.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    let editingItem = null;
    let deletingItem = null;
    let sortOrder = 'asc';
    function $(id){ return document.getElementById(id); }
    function normalizeUrl(u){
      if (!u) return "";
      if (!/^https?:\/\//i.test(u)) return "https://" + u;
      return u;
    }
    function getTimeInZones(){
      const options = { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', hour12:true };
      const vegas = new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles', ...options });
      const manila = new Date().toLocaleString('en-PH', { timeZone: 'Asia/Manila', ...options });
      return { vegas, manila };
    }
    async function loadTracking(){
      const { data, error } = await supabaseClient
        .from("tracking_links")
        .select("*")
        .order("received", { ascending: true })
        .order("id", { ascending: sortOrder === 'asc' });
      if (error) return;
      const list = $("tracking-list");
      list.innerHTML = "";
      data.forEach(item => {
        const li = document.createElement("li");
        if (item.received) li.classList.add("received");
        const left = document.createElement("div");
        left.className = "left";
        const a = document.createElement("a");
        a.href = item.link; a.target = "_blank"; a.rel = "noopener";
        a.className = "desc"; a.textContent = item.description;
        left.appendChild(a);
        const times = document.createElement("div");
        times.className = "time-info";
        times.innerHTML = `<span class="v-time">Vegas: ${item.vegas_time}</span><span class="divider">|</span><span class="m-time">Manila: ${item.manila_time}</span>`;
        left.appendChild(times);
        const right = document.createElement("div");
        right.className = "right";
        const receiveBtn = document.createElement("button");
        receiveBtn.className = "mini-btn";
        receiveBtn.textContent = item.received ? "Undo" : "Receive";
        receiveBtn.onclick = async () => {
          await supabaseClient.from("tracking_links").update({ received: !item.received }).eq("id", item.id);
        };
        const editBtn = document.createElement("button");
        editBtn.className = "icon-btn";
        editBtn.innerHTML = "‚úèÔ∏è";
        editBtn.onclick = () => openEditModal(item);
        const delBtn = document.createElement("button");
        delBtn.className = "icon-btn icon-red";
        delBtn.innerHTML = "üóëÔ∏è";
        delBtn.onclick = () => openDeleteModal(item);
        right.appendChild(receiveBtn);
        right.appendChild(editBtn);
        right.appendChild(delBtn);
        li.appendChild(left);
        li.appendChild(right);
        list.appendChild(li);
      });
    }
    $("tracking-form").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const description = $("description").value.trim();
      let link = $("link").value.trim();
      if (!description || !link) return;
      link = normalizeUrl(link);
      const { vegas, manila } = getTimeInZones();
      const { error } = await supabaseClient.from("tracking_links").insert([{ description, link, received: false, vegas_time: vegas, manila_time: manila }]);
      if (!error) e.target.reset();
    });
    function openEditModal(item){
      editingItem = item;
      $("edit-desc").value = item.description || "";
      $("edit-link").value = item.link || "";
      $("edit-backdrop").classList.add("show");
      $("edit-desc").focus();
    }
    function closeEditModal(){
      $("edit-backdrop").classList.remove("show");
      editingItem = null;
    }
    $("edit-cancel").onclick = closeEditModal;
    $("edit-save").onclick = async ()=>{
      if (!editingItem) return;
      const newDesc = $("edit-desc").value.trim();
      let newLink = normalizeUrl($("edit-link").value.trim());
      if (!newDesc || !newLink) return;
      const { error } = await supabaseClient.from("tracking_links").update({ description:newDesc, link:newLink }).eq("id", editingItem.id);
      if (!error) closeEditModal();
    };
    $("edit-desc").addEventListener("keydown", (e)=>{
      if (e.key === "Enter") { e.preventDefault(); $("edit-save").click(); }
    });
    $("edit-link").addEventListener("keydown", (e)=>{
      if (e.key === "Enter") { e.preventDefault(); $("edit-save").click(); }
    });
    $("edit-backdrop").addEventListener("click", (e)=>{
      if (e.target.id === "edit-backdrop") closeEditModal();
    });
    function openDeleteModal(item){
      deletingItem = item;
      $("delete-backdrop").classList.add("show");
    }
    function closeDeleteModal(){
      $("delete-backdrop").classList.remove("show");
      deletingItem = null;
    }
    $("delete-cancel").onclick = closeDeleteModal;
    $("delete-confirm").onclick = async ()=>{
      if (!deletingItem) return;
      await supabaseClient.from("tracking_links").delete().eq("id", deletingItem.id);
      closeDeleteModal();
    };
    $("delete-backdrop").addEventListener("click", (e)=>{
      if (e.target.id === "delete-backdrop") closeDeleteModal();
    });
    document.addEventListener("keydown", (e)=>{
      if (e.key === "Escape"){
        if ($("edit-backdrop").classList.contains("show")) closeEditModal();
        if ($("delete-backdrop").classList.contains("show")) closeDeleteModal();
      }
    });
    document.getElementById("sort-toggle").addEventListener("click", () => {
      sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
      document.getElementById("sort-toggle").textContent =
        sortOrder === 'asc' ? "Sort: Oldest ‚Üí Newest" : "Sort: Newest ‚Üí Oldest";
      loadTracking();
    });
    supabaseClient.channel("tracking_changes").on("postgres_changes", { event: "*", schema: "public", table: "tracking_links" }, loadTracking).subscribe();
    loadTracking();
  </script>
</body>
</html>
