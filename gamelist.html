<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Game List</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/dist/umd/supabase.min.js"></script>

  <style>
    :root{
      --green:#67e4ca; --purple:#7a5af8; --ink:#0f172a;
      --card:#ffffff; --border:#e5e7ef; --soft:#f4f6fb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font:16px/1.4 system-ui, Segoe UI, Inter, Arial, sans-serif; color:var(--ink); background:#eef7f5}

    header{padding:16px; display:flex; justify-content:center; align-items:center}
    header h1{margin:0; font-size:20px; font-weight:900}

    .wrap{max-width:760px; margin:0 auto; padding:0 14px 60px; display:flex; flex-direction:column; gap:14px}

    .composer{
      background:var(--card); border:1px solid var(--border); border-radius:16px;
      box-shadow:0 8px 28px #00000014; padding:16px; position:sticky; top:8px; z-index:2;
    }
    .title{margin:0 0 12px; font-weight:900; letter-spacing:.2px; display:flex; align-items:center; gap:10px}
    .title .icon{width:30px;height:30px;border-radius:8px;display:inline-grid;place-items:center;color:#fff;
      background:linear-gradient(135deg,var(--green),var(--purple));}

    .row{display:grid; gap:10px; grid-template-columns:1fr}
    @media (min-width:720px){ .row{grid-template-columns:1.5fr 1fr} }

    input[type="text"], textarea{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:#fff; font:inherit}
    textarea{min-height:72px; resize:vertical}

    .uploader{display:grid; gap:10px}
    .drop{border:2px dashed #cfd7ea; border-radius:12px; background:#fff; padding:12px; text-align:center; color:#475569}
    .drop.highlight{border-color:var(--purple); background:#fafaff}
    .preview{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .preview img{max-height:120px; border-radius:10px; border:1px solid var(--border)}

    .actions{display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap}
    .btn{border:none; padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer}
    .save{color:#fff; background:linear-gradient(90deg,var(--green),var(--purple))}
    .clear{background:#eef1ff; color:#374151}

    .list{display:grid; gap:12px}
    .card{
      background:#fff; border:1px solid var(--border); border-radius:16px; overflow:hidden;
      box-shadow:0 8px 28px #00000012; display:grid; grid-template-columns:120px 1fr
    }
    .thumb{background:#f7fafb; display:grid; place-items:center; cursor:zoom-in}
    .thumb img{max-width:100%; max-height:100%; object-fit:cover; display:block}
    .body{padding:12px; display:grid; gap:8px}
    .card h3{margin:0; font-size:18px; font-weight:900}
    .meta{color:#64748b; font-size:12px}
    .ops{display:flex; gap:8px; justify-content:flex-end}
    .ops .mini{border:1px solid var(--border); background:#fff; padding:6px 10px; border-radius:10px; font-size:12px; cursor:pointer}
    .ops .danger{color:#b42318; border-color:#ffd3cf; background:#fff5f5}
    .card.noimg{grid-template-columns:1fr}

    #zoom{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.75); z-index:9999; cursor:zoom-out;
    }
    #zoom img{
      max-width:95vw; max-height:90vh; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,.5);
    }
  </style>
</head>
<body>
  <header><h1>Game List</h1></header>

  <div id="zoom"><img id="zoomImg" alt=""></div>

  <div class="wrap">
    <section class="composer" id="composer">
      <h2 class="title"><span class="icon">ðŸŽ®</span> Add a game</h2>

      <div class="row">
        <label>Game title
          <input id="title" type="text" placeholder="e.g., Monster Hunter Rise" />
        </label>

        <div class="uploader">
          <div id="drop" class="drop">
            Drop screenshot here or <b>choose file</b><br>
            <input id="file" type="file" accept="image/*" style="margin-top:8px" />
          </div>
          <div id="preview" class="preview" hidden></div>
        </div>
      </div>

      <label>Notes (optional)
        <textarea id="notes" placeholder="why this game, what to check out, etc."></textarea>
      </label>

      <div class="actions">
        <button id="clear" class="btn clear" type="button">Clear</button>
        <button id="save"  class="btn save"  type="button">Save</button>
      </div>
    </section>

    <div id="list" class="list" aria-live="polite"></div>
  </div>

  <script>
    const SUPABASE_URL = "https://tmjozxcjylcxgemffnoc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const TABLE  = "game_list_all";
    const BUCKET = "game_shots";

    const $ = s=>document.querySelector(s);
    const titleEl = $("#title"), fileEl = $("#file"), notesEl = $("#notes");
    const listEl = $("#list"), dropEl = $("#drop"), previewEl = $("#preview");
    const zoom = $("#zoom"), zoomImg = $("#zoomImg");

    let useLocal = false, selectedFile = null;

    ["dragenter","dragover"].forEach(evt=>{
      dropEl.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); dropEl.classList.add("highlight"); });
    });
    ["dragleave","drop"].forEach(evt=>{
      dropEl.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); dropEl.classList.remove("highlight"); });
    });
    dropEl.addEventListener("drop", e=>{
      const f = e.dataTransfer.files?.[0]; if(f){ setFile(f); }
    });
    fileEl.addEventListener("change", e=>{ const f=e.target.files?.[0]; if(f){ setFile(f); } });

    function setFile(f){
      selectedFile = f;
      const r = new FileReader();
      r.onload = () => { previewEl.hidden=false; previewEl.innerHTML = `<img src="${r.result}" alt="preview">`; };
      r.readAsDataURL(f);
    }

    $("#clear").addEventListener("click", ()=>{
      titleEl.value=""; notesEl.value=""; fileEl.value=""; selectedFile=null;
      previewEl.hidden=true; previewEl.innerHTML=""; titleEl.focus();
    });

    function openZoom(src){ zoomImg.src = src; zoom.style.display='flex'; }
    function closeZoom(){ zoom.style.display='none'; zoomImg.src=""; }
    zoom.addEventListener('click', closeZoom);
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeZoom(); });

    $("#save").addEventListener("click", async ()=>{
      const title = titleEl.value.trim();
      if(!title){ alert("Type a game title"); titleEl.focus(); return; }
      const notes = notesEl.value.trim();
      const id = crypto.randomUUID();
      const created_at = new Date().toISOString();

      if(useLocal){
        const image_url = selectedFile ? await fileToDataURL(selectedFile) : null;
        saveLocal({id,title,notes,created_at,image_url});
      }else{
        try{
          let image_url=null, image_path=null;
          if(selectedFile){
            const ext = (selectedFile.name.split(".").pop() || "jpg").toLowerCase();
            image_path = `${id}/${sanitize(title)}_${Date.now()}.${ext}`;
            const { error:upErr } = await sb.storage.from(BUCKET).upload(image_path, selectedFile, { upsert:false });
            if(upErr) throw upErr;
            const { data } = sb.storage.from(BUCKET).getPublicUrl(image_path);
            image_url = data.publicUrl;
          }
          const { error:insErr } = await sb.from(TABLE).insert({ id, title, notes, created_at, image_url, image_path });
          if(insErr) throw insErr;
        }catch(err){
          console.warn("Supabase failed, switching to local mode:", err?.message||err);
          useLocal = true;
          const image_url = selectedFile ? await fileToDataURL(selectedFile) : null;
          saveLocal({id,title,notes,created_at,image_url});
        }
      }
      $("#clear").click();
    });

    function sanitize(s){ return s.replace(/[^a-z0-9_\-]+/gi,"-").slice(0,60) }
    function fileToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }

    function render(rows){
      rows.sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
      listEl.innerHTML = "";
      rows.forEach(r=>{
        const card = document.createElement("article");
        card.className = "card" + (r.image_url? "" : " noimg");
        card.innerHTML = `
          ${r.image_url ? `<div class="thumb"><img src="${r.image_url}" alt="screenshot of ${escapeHtml(r.title)}"></div>` : ""}
          <div class="body">
            <h3>${escapeHtml(r.title)}</h3>
            <div class="meta">${new Date(r.created_at).toLocaleString()}</div>
            ${r.notes ? `<div>${escapeHtml(r.notes)}</div>` : ""}
            <div class="ops">
              <button class="mini danger" data-del="${r.id}">delete</button>
            </div>
          </div>
        `;
        if(r.image_url){
          card.querySelector(".thumb img").addEventListener("click", ()=> openZoom(r.image_url));
        }
        card.querySelector('[data-del]').addEventListener('click', async ()=>{
          if(!confirm('Delete this entry?')) return;
          if(useLocal){
            writeLocal(readLocal().filter(x=>x.id!==r.id));
          }else{
            try{
              if(r.image_path){ await sb.storage.from(BUCKET).remove([r.image_path]).catch(()=>{}); }
              await sb.from(TABLE).delete().eq("id", r.id);
            }catch(err){
              useLocal = true;
              writeLocal(readLocal().filter(x=>x.id!==r.id));
            }
          }
        });
        listEl.appendChild(card);
      });
    }

    function readLocal(){ return JSON.parse(localStorage.getItem("game_list_all")||"[]"); }
    function writeLocal(arr){ localStorage.setItem("game_list_all", JSON.stringify(arr)); render(arr); }
    function saveLocal(row){ const a=readLocal(); a.unshift(row); writeLocal(a); }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }

    async function load(){
      try{
        const { data, error } = await sb.from(TABLE).select("*").order("created_at",{ascending:false}).limit(500);
        if(error) throw error;
        render(data||[]);
        sb.channel('realtime:game_list_all')
          .on('postgres_changes',{event:'*',schema:'public',table:TABLE},()=>load())
          .subscribe();
      }catch(err){
        useLocal = true;
        render(readLocal());
      }
    }
    load();
  </script>

</body>
</html>
