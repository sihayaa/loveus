<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Game List</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/dist/umd/supabase.min.js"></script>
  <style>
    :root{--green:#67e4ca;--purple:#7a5af8;--ink:#0f172a;--card:#fff;--border:#e5e7ef}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font:16px/1.4 system-ui,Segoe UI,Inter,Arial,sans-serif;color:var(--ink);background:#eef7f5}
    header{padding:16px;display:flex;justify-content:center;align-items:center}
    header h1{margin:0;font-size:20px;font-weight:900}
    .wrap{max-width:760px;margin:0 auto;padding:0 14px 60px;display:flex;flex-direction:column;gap:14px}
    .composer{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 28px #00000014;padding:16px;position:sticky;top:8px;z-index:2}
    .title{margin:0 0 12px;font-weight:900;display:flex;align-items:center;gap:10px}
    .title .icon{width:30px;height:30px;border-radius:8px;display:grid;place-items:center;color:#fff;background:linear-gradient(135deg,var(--green),var(--purple))}
    .row{display:grid;gap:10px;grid-template-columns:1fr}
    @media (min-width:720px){.row{grid-template-columns:1.5fr 1fr}}
    input[type="text"],textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;font:inherit}
    textarea{min-height:72px;resize:vertical}
    .uploader{display:grid;gap:10px}
    .drop{border:2px dashed #cfd7ea;border-radius:12px;background:#fff;padding:12px;text-align:center;color:#475569}
    .drop.highlight{border-color:var(--purple);background:#fafaff}
    .preview{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .preview img{max-height:120px;border-radius:10px;border:1px solid var(--border)}
    .actions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
    .btn{border:none;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer}
    .save{color:#fff;background:linear-gradient(90deg,var(--green),var(--purple))}
    .clear{background:#eef1ff;color:#374151}
    .list{display:grid;gap:12px}
    .card{position:relative;background:#fff;border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 8px 28px #00000012;display:grid;grid-template-columns:140px 1fr;min-height:120px}
    .thumb{background:#f7fafb;display:grid;place-items:center;cursor:zoom-in;padding:8px}
    .thumb img{max-width:100%;max-height:120px;object-fit:contain;display:block;border-radius:8px}
    .body{padding:12px;display:grid;gap:8px}
    .card h3{margin:0;font-size:18px;font-weight:900}
    .meta{color:#64748b;font-size:12px}
    .iconbtns{position:absolute;top:8px;right:8px;display:flex;gap:6px}
    .iconbtn{width:28px;height:28px;display:grid;place-items:center;border-radius:8px;cursor:pointer;border:1px solid var(--border);background:#fff;box-shadow:0 2px 8px #00000014}
    .iconbtn svg{width:16px;height:16px}
    .iconbtn.danger{background:#fff5f5;border-color:#ffd3cf}
    .iconbtn.danger svg path{fill:#b42318}
    .card.noimg{grid-template-columns:1fr}
    #zoom{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.75);z-index:9999;cursor:zoom-out}
    #zoom img{max-width:95vw;max-height:90vh;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.5)}
    .editbox{display:grid;gap:8px}
    .hint{font-size:12px;color:#6b7280}
  </style>
</head>
<body>
  <header><h1>Game List</h1></header>
  <div id="zoom"><img id="zoomImg" alt=""></div>

  <div class="wrap">
    <section class="composer" id="composer">
      <h2 class="title"><span class="icon">ðŸŽ®</span> Add a game</h2>
      <div class="row">
        <label>Game title
          <input id="title" type="text" />
        </label>
        <div class="uploader">
          <div id="drop" class="drop">Drop screenshot here or <b>choose file</b><br><input id="file" type="file" accept="image/*" style="margin-top:8px"/></div>
          <div id="preview" class="preview" hidden></div>
        </div>
      </div>
      <label>Notes (optional)
        <textarea id="notes"></textarea>
      </label>
      <div class="actions">
        <button id="clear" class="btn clear" type="button">Clear</button>
        <button id="save" class="btn save" type="button">Save</button>
      </div>
    </section>
    <div id="list" class="list" aria-live="polite"></div>
  </div>

  <script>
    const SUPABASE_URL="https://tmjozxcjylcxgemffnoc.supabase.co";
    const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
    const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
    const TABLE="game_list_all";

    const $=s=>document.querySelector(s);
    const titleEl=$("#title"),fileEl=$("#file"),notesEl=$("#notes");
    const listEl=$("#list"),dropEl=$("#drop"),previewEl=$("#preview");
    const zoom=$("#zoom"),zoomImg=$("#zoomImg");

    let useLocal=false,selectedFile=null;

    ["dragenter","dragover"].forEach(evt=>{
      dropEl.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dropEl.classList.add("highlight");});
    });
    ["dragleave","drop"].forEach(evt=>{
      dropEl.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dropEl.classList.remove("highlight");});
    });
    dropEl.addEventListener("drop",e=>{const f=e.dataTransfer.files?.[0];if(f){setFile(f);}});
    fileEl.addEventListener("change",e=>{const f=e.target.files?.[0];if(f){setFile(f);}});

    function setFile(f){
      selectedFile=f;
      const r=new FileReader();
      r.onload=()=>{previewEl.hidden=false;previewEl.innerHTML=`<img src="${r.result}" alt="preview">`;};
      r.readAsDataURL(f);
    }

    $("#clear").addEventListener("click",()=>{
      titleEl.value="";notesEl.value="";fileEl.value="";selectedFile=null;
      previewEl.hidden=true;previewEl.innerHTML="";titleEl.focus();
    });

    function openZoom(src){zoomImg.src=src;zoom.style.display="flex";}
    function closeZoom(){zoom.style.display="none";zoomImg.src="";}
    zoom.addEventListener("click",closeZoom);
    document.addEventListener("keydown",e=>{if(e.key==="Escape")closeZoom();});

    $("#save").addEventListener("click",saveNew);

    async function saveNew(){
      const title=titleEl.value.trim();
      if(!title){titleEl.focus();return;}
      const notes=notesEl.value.trim();
      const id=crypto.randomUUID();
      const created_at=new Date().toISOString();
      const image_url=selectedFile?await fileToDataURL(selectedFile):null;

      if(useLocal){saveLocal({id,title,notes,created_at,image_url});$("#clear").click();return;}
      try{
        const {error}=await sb.from(TABLE).insert({id,title,notes,created_at,image_url});
        if(error)throw error;
        $("#clear").click();
        await load(true);
      }catch(err){
        useLocal=true;
        saveLocal({id,title,notes,created_at,image_url});
        $("#clear").click();
      }
    }

    function fileToDataURL(file){return new Promise(res=>{const r=new FileReader();r.onload=()=>res(r.result);r.readAsDataURL(file);});}
    function escapeHtml(s){return s.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));}

    function render(rows){
      rows.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
      listEl.innerHTML="";
      rows.forEach(r=>{
        const card=document.createElement("article");
        card.className="card"+(r.image_url?"":" noimg");
        card.dataset.id=r.id;
        const imgBlock=r.image_url?`<div class="thumb"><img src="${r.image_url}" alt="screenshot of ${escapeHtml(r.title)}"></div>`:"";
        card.innerHTML=`
          ${imgBlock}
          <div class="body">
            <h3 class="title-txt">${escapeHtml(r.title)}</h3>
            <div class="meta">${new Date(r.created_at).toLocaleString()}</div>
            ${r.notes?`<div class="notes-txt">${escapeHtml(r.notes)}</div>`:`<div class="notes-txt" style="display:none;"></div>`}
          </div>
          <div class="iconbtns">
            <button class="iconbtn edit" title="edit" aria-label="edit">
              <svg viewBox="0 0 24 24" fill="none"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42L18.37 3.29a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.83z" fill="#111"/></svg>
            </button>
            <button class="iconbtn danger del" title="delete" aria-label="delete">
              <svg viewBox="0 0 24 24" fill="none"><path d="M18 6l-1 14H7L6 6h12zm-5-3h-2l-1 1H6v2h12V4h-4l-1-1z" fill="#b42318"/></svg>
            </button>
          </div>`;
        if(r.image_url){card.querySelector(".thumb img").addEventListener("click",()=>openZoom(r.image_url));}
        card.querySelector(".del").addEventListener("click",async ()=>{
          if(!confirm("Delete this entry?"))return;
          if(useLocal){writeLocal(readLocal().filter(x=>x.id!==r.id));return;}
          try{await sb.from(TABLE).delete().eq("id",r.id);await load(true);}catch(e){useLocal=true;writeLocal(readLocal().filter(x=>x.id!==r.id));}
        });
        card.querySelector(".edit").addEventListener("click",()=>enterEdit(card,r));
        listEl.appendChild(card);
      });
    }

    function enterEdit(card,row){
      const body=card.querySelector(".body");
      const notesTxt=card.querySelector(".notes-txt")?.textContent||"";
      body.innerHTML=`
        <form class="editbox">
          <input id="e-title" type="text" value="${escapeAttr(row.title)}" />
          <textarea id="e-notes" placeholder="notes...">${escapeAttr(notesTxt)}</textarea>
          <div class="hint">Enter = save Â· Shift+Enter = new line</div>
        </form>`;
      const form=body.querySelector(".editbox");
      const et=form.querySelector("#e-title");
      const en=form.querySelector("#e-notes");
      en.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();form.requestSubmit();}});
      form.addEventListener("submit",async e=>{
        e.preventDefault();
        const newTitle=et.value.trim(); const newNotes=en.value.trim(); if(!newTitle){et.focus();return;}
        if(useLocal){
          const a=readLocal().map(x=>x.id===row.id?{...x,title:newTitle,notes:newNotes}:x);
          writeLocal(a);return;
        }
        try{await sb.from(TABLE).update({title:newTitle,notes:newNotes}).eq("id",row.id);await load(true);}catch(e){useLocal=true;const a=readLocal().map(x=>x.id===row.id?{...x,title:newTitle,notes:newNotes}:x);writeLocal(a);}
      });
      et.focus(); et.select();
    }

    function escapeAttr(s){return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}

    function readLocal(){return JSON.parse(localStorage.getItem("game_list_all")||"[]")}
    function writeLocal(arr){localStorage.setItem("game_list_all",JSON.stringify(arr));render(arr)}
    function saveLocal(row){const a=readLocal();a.unshift(row);writeLocal(a)}

    async function load(skipRealtime=false){
      try{
        const {data,error}=await sb.from(TABLE).select("*").order("created_at",{ascending:false}).limit(500);
        if(error)throw error;
        render(data||[]);
        if(!skipRealtime){
          sb.channel("realtime:game_list_all")
            .on("postgres_changes",{event:"*",schema:"public",table:TABLE},()=>load(true))
            .subscribe();
        }
      }catch(err){
        useLocal=true;
        const local=readLocal();
        render(local);
      }
    }

    (async()=>{ 
      const local=readLocal();
      try{
        const {data,error}=await sb.from(TABLE).select("*").order("created_at",{ascending:false}).limit(500);
        if(error)throw error;
        if((data||[]).length===0 && local.length>0){render(local);} else {render(data||[]);}
        sb.channel("realtime:game_list_all")
          .on("postgres_changes",{event:"*",schema:"public",table:TABLE},()=>load(true))
          .subscribe();
      }catch(e){useLocal=true;render(local);}
    })();
  </script>
</body>
</html>
