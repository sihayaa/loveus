<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weekly Diet & Links</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b0f2f; --paper:#10153a; --ink:#e8ecf8;
  --mint:#67e4ca; --purple:#7a5af8; --warn:#ff7a7a;
  --ring:#2b3470; --card:#151c48; --soft:#9fb3ff;
  --accent:#67e4ca; /* switches to purple when you toggle üíú */
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Arial}
a{color:inherit}
button{cursor:pointer;border:0}
input,select,textarea{background:#0e1440;color:var(--ink);border:1px solid #32408f;border-radius:10px;padding:.55rem .7rem}
input::placeholder,textarea::placeholder{color:#9fb0ff}
.small{font-size:.9rem;opacity:.9}

/* center the whole app */
.wrap{width:min(1100px, calc(100% - 32px));margin:24px auto}
.header{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.h1{font-weight:800;font-size:1.3rem;letter-spacing:.4px}
.range{opacity:.85}
.pill{display:inline-flex;align-items:center;gap:8px;padding:.45rem .7rem;border-radius:999px;background:linear-gradient(180deg,#1b2355,#0f1748);border:1px solid #2a3574;box-shadow:0 0 0 1px #000 inset}
.navbtn{padding:.45rem .7rem;border-radius:10px;background:#11184a;border:1px solid #274091}
.navbtn:hover{filter:brightness(1.1)}
.heartbar{margin-left:auto;display:flex;gap:8px}
.heart{font-size:1.1rem;padding:.35rem .65rem;border-radius:999px;border:1px solid #2a3574;background:#0f1748;opacity:.7}
.heart.active{opacity:1;box-shadow:0 0 0 2px #000 inset, 0 0 14px var(--accent)}
.heart.green{color:var(--mint)}
.heart.purple{color:var(--purple)}

.targets{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:14px 0}
.target-card{padding:12px;border-radius:14px;border:1px solid #2a3574;background:linear-gradient(180deg,#141b4a,#0f1646);position:relative;box-shadow:0 0 18px rgba(103,228,202,.08)}
.target-card label{font-size:.8rem;opacity:.8}
.ringrow{display:flex;gap:10px;margin:8px 0}
.ring{flex:1;padding:10px 12px;border:1px solid #2a3574;border-radius:12px;background:#0f1646}
.ring .lbl{font-size:.75rem;opacity:.8}
.ring .val{font-weight:800}

/* responsive grid that wraps and centers */
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:12px;align-items:start}

/* day cards (we later override to your blue) */
.day{border:1px solid #2a3574;border-radius:16px;background:linear-gradient(180deg,#141b4a,#0f1646);padding:12px;box-shadow:0 0 18px rgba(122,90,248,.08)}
.dayhead{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.dayname{font-weight:700}
.tot{font-size:.85rem;opacity:.9}

.section{margin:8px 0;border-top:1px dashed #2a3574;padding-top:8px}
.meal-row{display:grid;grid-template-columns:1fr 70px 70px 92px;gap:6px;align-items:center;margin:4px 0}
.meal-row b{font-weight:600}
.badge{font-size:.72rem;padding:.12rem .45rem;border-radius:8px;border:1px solid #3346a0;background:#0f1d60;opacity:.95}
.badge.breakfast{background:#2a225f;border-color:#6a5af8;color:#e7ddff}
.badge.lunch{background:#123b2f;border-color:#1a8a72;color:#bdf7e8}
.badge.dinner{background:#3b1f37;border-color:#a03b6e;color:#ffd1f5}
.badge.snack{background:#203551;border-color:#3b7bd6;color:#cfe2ff}

.addline{display:grid;grid-template-columns:1fr 70px 70px 92px;gap:6px;margin-top:6px}
.addline input, .addline select{width:100%;background:#0d1444;border-color:#3e4fbf}
.addline .save{background:#16206a;border:1px solid #3551c1;border-radius:10px}
.addline .save:hover{filter:brightness(1.1)}

.row-flex{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.btn{padding:.45rem .65rem;border-radius:10px;background:#142265;border:1px solid #3050b9}
.btn:hover{filter:brightness(1.1)}
.btn.alt{background:#123c2f;border-color:#146d57}
.btn.danger{background:#3a1630;border-color:#a03b6e}
.btn.mini{padding:.28rem .5rem;font-size:.82rem}
.btn.muted{opacity:.85}

.summary{margin:18px 0;padding:14px;border-radius:16px;border:1px solid #2a3574;background:linear-gradient(180deg,#141b4a,#0f1646)}
.summary h3{margin:0 0 8px}
.kv{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.kv .cell{padding:10px;border:1px solid #2a3574;border-radius:12px;background:#0f1646}
.kv .cell .lbl{font-size:.75rem;opacity:.8}
.kv .cell .val{font-size:1.05rem;font-weight:800}

/* collapse toggle */
.toggle{background:transparent;border:1px solid #2a3574;border-radius:10px;padding:.2rem .45rem;line-height:1;font-weight:800;color:var(--ink);opacity:.9}
.toggle:hover{filter:brightness(1.1)}
.day.collapsed .daybody{display:none}
.day.collapsed .toggle{transform:rotate(-90deg)}

/* ----- COLOR OVERRIDES (your picks) ----- */
/* 1) Goals/day row = green #057D3A with white text */
.targets .target-card{background:#057D3A;border-color:#046b33;color:#fff}
.targets .target-card label{color:#fff;opacity:1}
.targets .target-card .ring{background:#046b33;border-color:#03582a;color:#fff}
.targets .target-card input{background:rgba(0,0,0,.2);border-color:#03582a;color:#fff}
.targets .target-card .btn{background:#046b33;border-color:#03582a;color:#fff}

/* 2) Week day boxes = blue #2681AB with white text (buttons inside same blue) */
.day{background:#2681AB;border-color:#1f6c8f;color:#fff;box-shadow:none}
.day input,.day select,.day textarea{background:rgba(0,0,0,.18);border-color:#1c6280;color:#fff}
.day .btn,.day .addline .save{background:#2681AB;border-color:#1f6c8f;color:#fff}
.day .badge{background:rgba(0,0,0,.18);border-color:#1c6280;color:#fff}

/* 3) Weekly summary = purple #6928A6 with white text */
.summary{background:#6928A6;border-color:#4e1f7d;color:#fff}
.summary .kv .cell{background:rgba(0,0,0,.18);border-color:#4e1f7d;color:#fff}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="h1">Weekly Diet Tracker</div>
    <div class="pill"><span id="weekRange" class="range">Week</span></div>
    <button id="prevWeek" class="navbtn">‚Üê Prev</button>
    <button id="nextWeek" class="navbtn">Next ‚Üí</button>
    <div class="heartbar">
      <button id="youBtn" class="heart green active" title="You (mint)">üíö You</button>
      <button id="himBtn" class="heart purple" title="Him (purple)">üíú Him</button>
    </div>
  </div>

  <!-- quick tools -->
  <div class="row-flex" style="justify-content:flex-end;margin-top:6px;margin-bottom:6px">
    <button class="btn mini muted" onclick="collapseAll()">Collapse all</button>
    <button class="btn mini" onclick="expandAll()">Expand all</button>
  </div>

  <!-- Targets -->
  <div class="targets">
    <div class="target-card">
      <label>Calories Goal / day</label>
      <div class="row-flex">
        <input id="goalCal" type="number" min="0" placeholder="e.g. 1600"/>
        <button class="btn mini" onclick="saveGoals()">Save</button>
      </div>
      <div class="ringrow">
        <div class="ring"><div class="lbl">Calories left today</div><div id="ringCal" class="val">‚Äî</div></div>
      </div>
    </div>
    <div class="target-card">
      <label>Sugar Goal (g) / day</label>
      <div class="row-flex">
        <input id="goalSugar" type="number" min="0" placeholder="e.g. 45"/>
        <button class="btn mini" onclick="saveGoals()">Save</button>
      </div>
      <div class="ringrow">
        <div class="ring"><div class="lbl">Sugar left today</div><div id="ringSugar" class="val">‚Äî</div></div>
      </div>
    </div>
    <div class="target-card">
      <label>Water Goal (ml) / day</label>
      <div class="row-flex">
        <input id="goalWater" type="number" min="0" placeholder="e.g. 2000"/>
        <button class="btn mini" onclick="saveGoals()">Save</button>
      </div>
      <div class="ringrow">
        <div class="ring"><div class="lbl">Water so far</div><div id="ringWater" class="val">‚Äî</div></div>
      </div>
    </div>
    <div class="target-card">
      <label>Exercise Goal (min) / day</label>
      <div class="row-flex">
        <input id="goalEx" type="number" min="0" placeholder="e.g. 30"/>
        <button class="btn mini" onclick="saveGoals()">Save</button>
      </div>
      <div class="ringrow">
        <div class="ring"><div class="lbl">Exercise so far</div><div id="ringEx" class="val">‚Äî</div></div>
      </div>
    </div>
  </div>

  <!-- Daily Grid -->
  <div id="grid" class="grid"></div>

  <!-- Weekly Summary -->
  <div class="summary">
    <h3>Weekly Summary</h3>
    <div class="kv">
      <div class="cell"><div class="lbl">Total Calories</div><div id="sumCal" class="val">‚Äî</div></div>
      <div class="cell"><div class="lbl">Total Sugar (g)</div><div id="sumSugar" class="val">‚Äî</div></div>
      <div class="cell"><div class="lbl">Water (ml)</div><div id="sumWater" class="val">‚Äî</div></div>
      <div class="cell"><div class="lbl">Exercise (min)</div><div id="sumEx" class="val">‚Äî</div></div>
    </div>
    <hr class="sep">
    <div class="small">Tip: click the meal badge (Breakfast/Lunch/‚Ä¶) to change it.</div>
  </div>

  <!-- Admin (secret 123) -->
  <div id="adminBar" class="admin">
    <div class="row-flex">
      <button class="btn" onclick="exportJSON()">Export JSON</button>
      <label class="btn" for="imp">Import JSON</label>
      <input id="imp" type="file" accept="application/json" style="display:none" />
      <button class="btn danger" onclick="clearWeek()">Clear This Week</button>
      <span class="small">Admin mode (toggle by typing <b>123</b>)</span>
    </div>
  </div>

  <div class="footer">
    <div class="pill small">Keyboard: Enter = save ¬∑ Shift+Enter = newline ¬∑ ‚Üê/‚Üí = switch week</div>
    <div class="small soft">Local preview mode (storage: browser). We can switch to Supabase later.</div>
  </div>
</div>

<script>
/* ---------- tiny data layer (localStorage) ---------- */
const storageKey = (uid, weekKey) => `dietweek:${uid}:${weekKey}`;
const getUID = () => (state.user === 'you' ? 'you' : 'him');

function readWeek(uid, wk) {
  const raw = localStorage.getItem(storageKey(uid, wk));
  return raw ? JSON.parse(raw) : { goals:{cal:1600,sugar:45,water:2000,ex:30}, days:{} };
}
function writeWeek(uid, wk, data){
  localStorage.setItem(storageKey(uid, wk), JSON.stringify(data));
}

/* ---------- date & week helpers ---------- */
function getIsoWeek(d){
  d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
  return {year:d.getUTCFullYear(), week:weekNo};
}
function weekStartFromYW(y,w
