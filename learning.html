<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Learning Mandarin</title> 
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,600;1,400;1,600&family=Noto+Serif+SC:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f2f;               
      --ink:#e8ecf8;              
      --muted:#a6afc6;          
      --accent:#7a5af8;            
      --accent-2:#67e4ca;         
      --card:#0f152b;             
      --field:#0c1326;            
      --line:rgba(255,255,255,.10);
      --glow1: rgba(122,90,248,.25);
      --glow2: rgba(122,90,248,.18);
      --focusRing: rgba(122,90,248,.28);
      --hover:#141c36;            
    }
    [data-theme="mint"]{
      --accent: var(--accent-2);
      --glow1: rgba(103,228,202,.25);
      --glow2: rgba(103,228,202,.18);
      --focusRing: rgba(103,228,202,.28);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; 
      background-color: var(--bg);
      background-image: url("https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/learn-bg.jpg");
      background-repeat: no-repeat;
      background-size: cover;
      background-position: center top;
      background-attachment: fixed;
      color:var(--ink);
      font:16px/1.5 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      padding:26px;
      min-height: 100dvh;
    }
    @media (max-width: 860px){
      body{ background-attachment: scroll; background-position:center top; }
    }

    .back-btn{
      position: fixed; top:26px; left:26px; z-index: 9999;
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:14px;
      background: var(--accent); color:#fff; text-decoration:none; 
      font-weight:800; letter-spacing:.2px;
      border:1px solid rgba(0,0,0,.06);
      box-shadow:0 6px 16px rgba(0,0,0,.24);
      transition: transform .08s ease, filter .12s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .back-btn:hover{ filter:brightness(1.05); transform:translateY(-1px); }
    .back-btn:active{ transform:translateY(0); }
    .back-btn svg{ width:18px; height:18px; display:block }

    .wrap{max-width:980px;margin:0 auto}
    .card{
      position:relative; background:var(--card); border:1px solid var(--line);
      border-radius:22px; box-shadow:0 10px 30px rgba(0,0,0,.35); padding:22px 22px 18px
    }
    .card:before{
      content:""; position:absolute; inset:-14px; border-radius:32px; z-index:-1;
      background: var(--accent);
      opacity:.16;
      box-shadow: 0 0 18px var(--glow1), 0 0 28px var(--glow2);
      filter: blur(14px);
    }

    h1{margin:4px 0 8px; display:flex; align-items:flex-end; gap:10px; flex-wrap:wrap}
    h1 .script{font-weight:900; font-size:36px; letter-spacing:.2px; color:var(--accent)}
    h1 .tag{font-weight:800; font-size:28px; padding:2px 10px; border-radius:14px; color:#cdd6f2}
    h1 small{display:block; font-weight:600; font-size:14px; color:var(--muted); margin-top:-2px}

    .sub{margin:0 0 16px;color:var(--muted)}

    form#entry-form{
      display:grid; grid-template-columns: 1.1fr .9fr 1fr 1fr auto; 
      gap:12px; align-items:end
    }
    label span{display:block; font-size:12px; color:var(--muted); margin:0 0 6px 6px}
    input[type="text"]{
      width:100%; padding:12px 12px; border:1px solid var(--line); border-radius:14px; outline:none;
      background:var(--field); color:var(--ink);
      transition:box-shadow .16s ease, border .16s ease, transform .06s ease
    }
    input[type="text"]::placeholder{ color:#8fa0c4; opacity:.85; font-style:italic }
    input[type="text"]:focus{border-color:var(--accent); box-shadow:0 0 0 3px var(--focusRing)}
    button.add{height:46px; padding:0 18px; border:0; border-radius:14px; background:var(--accent); color:white; font-weight:800; cursor:pointer; letter-spacing:.3px}
    button.add:active{transform:translateY(1px)}

    .toolbar{display:flex; align-items:center; gap:10px; margin:14px 0 6px}
    .pill{border:1px solid var(--line); background:var(--field); padding:8px 12px; border-radius:999px; font-size:13px; color:#d6dbef}
    .pill strong{color:#fff}
    .right{margin-left:auto}
    .toggle{cursor:pointer}

    .table-wrap{margin-top:8px}
    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{position:sticky; top:0; background:var(--card); z-index:1}
    th, td{border-bottom:1px solid var(--line); padding:14px 10px; text-align:left}
    th{font-size:13px; color:#bac4e4; font-weight:700; letter-spacing:.3px}
    tbody tr{transition:background .12s ease}
    tbody tr:hover td{background:var(--hover)}
    td{vertical-align:middle; color:var(--ink)}
    .num{width:56px; text-align:center; color:#98a3c9}
    .hanzi{font-size:20px; font-family:"Noto Serif SC","Noto Sans SC",system-ui,sans-serif; font-style:normal; font-weight:700}
    .actions{width:88px; text-align:right}

    .icon-btn{border:0; background:transparent; cursor:pointer; font-size:16px; padding:6px 8px; border-radius:10px; color:#cfd6f1}
    .icon-btn svg{width:18px; height:18px; display:block}
    .icon-btn:hover{background:rgba(255,255,255,.06)}
    tr.editing td{background:rgba(122,90,248,.07)}

    tbody td{font-family:"JetBrains Mono","Poppins","Inter",sans-serif; font-weight:600; font-style:italic; letter-spacing:.2px}
    .sample td{color:rgba(255,255,255,.45); opacity:1; font-style:italic; font-weight:500}

    /* keep only native small tooltip via title */
    .pinyin{ cursor: help; }

    @media (max-width:860px){
      form#entry-form{grid-template-columns:1fr;}
      .actions{width:76px}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/dist/umd/supabase.min.js"></script>
</head>
<body>

  <a id="backBtn" class="back-btn" href="#" aria-label="Go back">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
         stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
    <span>Back/返回</span>
  </a>

  <div class="wrap">
    <div class="card">
      <h1>
        <span class="script">Learning</span>
        <span class="tag">Mandarin words that are COOL</span> 
        <small>quick study list • pinyin → details → meaning → 汉字</small>
      </h1>
      <p class="sub">Type the four fields below. Press <strong>Enter</strong> (or click Add) to append to the list. To change a row later, click <strong>Edit</strong>.</p>

      <form id="entry-form" autocomplete="off">
        <label>
          <span>Pronunciation (Pinyin)</span>
          <input id="pinyin" type="text" placeholder="nĭ hăo" required>
        </label>
        <label>
          <span>Details (usage / note)</span>
          <input id="details" type="text" placeholder="greeting; casual" >
        </label>
        <label>
          <span>Meaning (English)</span>
          <input id="meaning" type="text" placeholder="Hello" required>
        </label>
        <label>
          <span>Mandarin (汉字)</span>
          <input id="hanzi" type="text" placeholder="你好" required>
        </label>
        <button class="add" type="submit">Add</button>
      </form>

      <div class="toolbar">
        <span class="pill">Total: <strong id="count">0</strong></span>
        <span class="right pill toggle" id="themeToggle">Switch accent 💜/💚</span>
      </div>

      <div class="table-wrap">
        <table aria-label="Useful Mandarin words list">
          <thead>
            <tr>
              <th class="num">#</th>
              <th>Pronunciation</th>
              <th>Details</th>
              <th>Meaning</th>
              <th>Mandarin</th>
              <th class="actions">&nbsp;</th>
            </tr>
          </thead>
          <tbody id="list"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
  (function(){

    const back = document.getElementById('backBtn');
    back?.addEventListener('click', (e)=>{
      e.preventDefault();
      if (document.referrer && document.referrer !== location.href){
        history.back();
      } else {
        window.location.href = 'index.html'; 
      }
    });

    const SUPABASE_URL = "https://tmjozxcjylcxgemffnoc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const TABLE = 'learning_words';

    const form = document.getElementById('entry-form');
    const pinyinEl = document.getElementById('pinyin');
    const detailsEl = document.getElementById('details');
    const meaningEl = document.getElementById('meaning');
    const hanziEl = document.getElementById('hanzi');
    const listEl = document.getElementById('list');
    const countEl = document.getElementById('count');
    const themeToggle = document.getElementById('themeToggle');

    const THEME_KEY = 'mandarin_words_theme';
    const savedTheme = localStorage.getItem(THEME_KEY);
    if(savedTheme){ document.documentElement.setAttribute('data-theme', savedTheme); }
    themeToggle?.addEventListener('click', ()=>{
      const now = document.documentElement.getAttribute('data-theme') === 'mint' ? '' : 'mint';
      if(now){ document.documentElement.setAttribute('data-theme','mint'); }
      else{ document.documentElement.removeAttribute('data-theme'); }
      localStorage.setItem(THEME_KEY, now);
    });

    let rows = [];        
    let hintMode = false; 

    function sortRows(){
      try{
        rows.sort((a,b)=> ((a?.position??0) - (b?.position??0)) || (new Date(a?.created_at||0) - new Date(b?.created_at||0)));
      }catch(e){ console.warn('sortRows fallback', e); }
    }

    async function loadInitial(){
      const { data, error } = await supabase
        .from(TABLE)
        .select('*')
        .order('position', {ascending: true})
        .order('created_at', {ascending: true});
      if(error){ console.error(error); }
      if(!data || data.length === 0){
        hintMode = true;
        rows = [{ id:'sample', pinyin:'nĭ hăo', details:'greeting', meaning:'Hello', hanzi:'你好', position:0 }];
      }else{
        rows = data; sortRows();
      }
      render();
    }

    function startRealtime(){
      supabase.channel('rt-learning-words')
        .on('postgres_changes', { event:'INSERT', schema:'public', table:TABLE }, payload => { addOrUpdate(payload.new); })
        .on('postgres_changes', { event:'UPDATE', schema:'public', table:TABLE }, payload => { addOrUpdate(payload.new); })
        .on('postgres_changes', { event:'DELETE', schema:'public', table:TABLE }, payload => { removeById(payload.old.id, /*silent*/ true); })
        .subscribe();
    }

    function addOrUpdate(rec){
      if(hintMode){ hintMode = false; rows = []; }
      const i = rows.findIndex(r => r.id === rec.id);
      if(i === -1){ rows.push(rec); } else { rows[i] = rec; }
      sortRows();
      render();
    }

    const deTone = s => {
      const map = {
        'ā':'a','á':'a','ǎ':'a','à':'a','Ā':'A','Á':'A','Ǎ':'A','À':'A',
        'ē':'e','é':'e','ě':'e','è':'e','Ē':'E','É':'E','Ě':'E','È':'E',
        'ī':'i','í':'i','ǐ':'i','ì':'i','Ī':'I','Í':'I','Ǐ':'I','Ì':'I',
        'ō':'o','ó':'o','ǒ':'o','ò':'o','Ō':'O','Ó':'O','Ǒ':'O','Ò':'O',
        'ū':'u','ú':'u','ǔ':'u','ù':'u','Ū':'U','Ú':'U','Ǔ':'U','Ù':'U',
        'ǖ':'ü','ǘ':'ü','ǚ':'ü','ǜ':'ü','Ü':'Ü','Ǖ':'Ü','Ǘ':'Ü','Ǚ':'Ü','Ǜ':'Ü',
        'ń':'n','ň':'n','ǹ':'n','ḿ':'m'
      };
      return s.replace(/./g, ch => map[ch] ?? ch)
              .replace(/[’'·]/g,' ')
              .toLowerCase();
    };

    const splitInitialFinal = syl => {
      const two = ['zh','ch','sh'];
      for (const t of two) if (syl.startsWith(t)) return [t, syl.slice(2)];
      const one = syl[0];
      if (/[bpmfdtnlgkhjqxrzcswy]/.test(one)) return [one, syl.slice(1)];
      return ['', syl];
    };

    const initialEng = ini => ({
      'zh':'j',  'ch':'ch', 'sh':'sh',
      'z':'dz',  'c':'ts',  's':'s',
      'x':'sh',  
      'q':'ch',  
      'j':'j',   
      'r':'r',   'y':'y',   'w':'w',
      'b':'b','p':'p','m':'m','f':'f',
      'd':'d','t':'t','n':'n','l':'l',
      'g':'g','k':'k','h':'h','':''
    }[ini] ?? ini);

    function finalEng(ini, fin){
      if (['zh','ch','sh','r','z','c','s'].includes(ini) && fin === 'i'){
        return 'rr'; 
      }
      if ((ini==='j'||ini==='q'||ini==='x'||ini==='y') && fin.startsWith('ue')) fin = 'weh';
      if (fin === 'ü')  fin = 'yoo';
      if (fin === 'ün') fin = 'yun';
      if (fin === 'üe') fin = 'weh';
      const repl = [
        ['iang','yahng'], ['iong','yong'], ['uang','wahng'],
        ['uan','wahn'],   ['ang','ahng'],   ['ong','ohng'],
        ['iao','yow'],    ['ian','yen'],    ['uai','why'],
        ['ui','way'],     ['iu','yoe'],     ['ie','yeh'],
        ['ia','yah'],     ['uo','woh'],     ['ou','oe'],
        ['ei','ay'],      ['ai','eye'],     ['eng','uhng'],
        ['en','uhn'],     ['an','ahn'],     ['er','ar'],
        ['e','uh'],       ['o','oh'],       ['a','ah'],
        ['u','oo'],       ['i','ee']
      ];
      for (const [pat, to] of repl){
        if (fin === pat) return to;
        if (fin.endsWith(pat)) return fin.replace(pat, to);
      }
      return fin;
    }

    function pinyinToEasyEnglish(pinyin){
      const clean = deTone(pinyin).trim();
      if (!clean) return '';
      const syls = clean.split(/\s+/);
      const out = [];
      for (let syl of syls){
        const [ini, finRaw] = splitInitialFinal(syl);
        let joined = (initialEng(ini) + finalEng(ini, finRaw))
          .replace(/^you$/,'yoe'); // stylistic
        out.push(joined);
      }
      return out.join(' ');
    }

    function applyPhonetics(scope=document){
      scope.querySelectorAll('.pinyin').forEach(td=>{
        const raw = (td.textContent || '').trim();
        if(!raw){ td.removeAttribute('title'); return; }
        td.title = pinyinToEasyEnglish(raw); 
      });
    }


    function render(){
      listEl.innerHTML = '';
      rows.forEach((row, idx)=>{
        const tr = document.createElement('tr');
        if(hintMode) tr.classList.add('sample');
        tr.dataset.id = row.id;

        const num = document.createElement('td'); num.className='num'; num.textContent = hintMode ? '' : (idx+1); tr.appendChild(num);
        tr.appendChild(makeCell(row.pinyin, 'pinyin'));          
        tr.appendChild(makeCell(row.details ?? ''));               
        tr.appendChild(makeCell(row.meaning));                     
        const hanziTd = makeCell(row.hanzi, 'hanzi'); tr.appendChild(hanziTd); 

        const actions = document.createElement('td'); actions.className = 'actions';
        const edit = document.createElement('button'); edit.className='icon-btn'; edit.title='Edit'; edit.innerHTML=pencil(); edit.dataset.mode='edit';
        edit.addEventListener('click', ()=> toggleEdit(tr, edit));
        actions.appendChild(edit);

        const del = document.createElement('button'); del.className='icon-btn'; del.title='Delete'; del.innerHTML=trash();
        del.addEventListener('click', ()=> removeById(row.id));
        actions.appendChild(del);

        tr.appendChild(actions);
        listEl.appendChild(tr);
      });
      countEl.textContent = hintMode ? 0 : rows.length;

      applyPhonetics(listEl);
    }

    function makeCell(text, cls){
      const td=document.createElement('td');
      td.textContent=text ?? '';
      if (cls) td.classList.add(cls);
      td.contentEditable=false; td.spellcheck=false;
      return td;
    }

    function handleEnterToSave(e){
      if(e.key === 'Enter'){
        e.preventDefault();
        const tr=e.currentTarget.closest('tr');
        const btn=tr.querySelector('.icon-btn');
        btn && btn.click();
      }
    }

    function toggleEdit(tr, editBtn){
      if(editBtn.dataset.mode === 'edit'){
        if(hintMode){ hintMode=false; }
        const cells = Array.from(tr.querySelectorAll('td')).slice(1,5); 
        cells.forEach((td,i)=>{ td.contentEditable=true; td.spellcheck=false; td.addEventListener('keydown', handleEnterToSave); if(i===0) td.focus(); });
        tr.classList.add('editing'); editBtn.dataset.mode='save'; editBtn.innerHTML=check();
      }else{
        const id = tr.dataset.id;
        const cells = Array.from(tr.querySelectorAll('td')).slice(1,5);
        const updated = { 
          pinyin: cells[0].textContent.trim(), 
          details: cells[1].textContent.trim(), 
          meaning: cells[2].textContent.trim(), 
          hanzi: cells[3].textContent.trim() 
        };
        cells.forEach(td=>{ td.contentEditable=false; td.removeEventListener('keydown', handleEnterToSave); });
        tr.classList.remove('editing'); editBtn.dataset.mode='edit'; editBtn.innerHTML=pencil();

        applyPhonetics(tr);

        if(id && id !== 'sample'){
          supabase.from(TABLE).update(updated).eq('id', id).then(({error})=>{
            if(error){
              console.warn('Update with details failed; trying without details. To enable details, add a column:\nALTER TABLE public.learning_words ADD COLUMN details text;');
              const { details, ...noDetails } = updated;
              supabase.from(TABLE).update(noDetails).eq('id', id).then(({error:e2})=>{ if(e2) console.error(e2); });
            }
          });
        }
      }
    }

    async function removeById(id, silent){
      if(!id || id==='sample') return;
      if(!silent){
        const i = rows.findIndex(r=>r.id===id); if(i>-1){ rows.splice(i,1); render(); }
      }
      const { error } = await supabase.from(TABLE).delete().eq('id', id);
      if(error) console.error(error);
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const p = pinyinEl.value.trim();
      const d = detailsEl.value.trim();
      const m = meaningEl.value.trim();
      const h = hanziEl.value.trim();
      if(!p || !m || !h){
        [pinyinEl, meaningEl, hanziEl].forEach(el=>{
          if(!el.value?.trim()){
            el.style.boxShadow='0 0 0 3px rgba(255,0,0,.18)';
            el.style.borderColor='#ff9494';
            setTimeout(()=>{el.style.boxShadow=''; el.style.borderColor='';},900);
          }
        });
        return;
      }

      if(hintMode){ rows = []; hintMode = false; }
      const nextPos = rows.length;

      // Try insert with details; if the column doesn't exist, retry without it.
      let { data, error } = await supabase
        .from(TABLE)
        .insert({ pinyin:p, details:d, meaning:m, hanzi:h, position: nextPos })
        .select()
        .single();
      if(error){
        console.warn('Insert with details failed; retrying without details. To enable: ALTER TABLE public.learning_words ADD COLUMN details text;');
        const res2 = await supabase
          .from(TABLE)
          .insert({ pinyin:p, meaning:m, hanzi:h, position: nextPos })
          .select()
          .single();
        data = res2.data; error = res2.error;
      }
      if(error){ console.error(error); return; }
      addOrUpdate(data); 
      form.reset(); pinyinEl.focus();
    });

    function pencil(){return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 1 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>'}
    function check(){return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>'}
    function trash(){return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>'}

    loadInitial();
    startRealtime();
  })();
  </script>
</body>
</html>
