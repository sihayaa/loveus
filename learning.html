<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Learning Mandarin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,600;1,400;1,600&family=Noto+Serif+SC:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f2f; --ink:#e8ecf8; --muted:#a6afc6;
      --accent:#7a5af8; --accent-2:#67e4ca;
      --card:#0f152b; --field:#0c1326; --line:rgba(255,255,255,.10);
      --glow1: rgba(122,90,248,.25); --glow2: rgba(122,90,248,.18);
      --focusRing: rgba(122,90,248,.28); --hover:#141c36; --danger:#ff6b6b;

      /* ring around whole card (tints with theme) */
      --accentRing: rgba(122,90,248,.55);
      --col-gap-hair: rgba(255,255,255,.06);
    }
    [data-theme="mint"]{
      --accent:var(--accent-2);
      --glow1:rgba(103,228,202,.25);
      --glow2:rgba(103,228,202,.18);
      --focusRing:rgba(103,228,202,.28);
      --accentRing:rgba(103,228,202,.55);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg) url("https://raw.githubusercontent.com/sihayaa/loveus/refs/heads/main/learn-bg.jpg") center top/cover no-repeat fixed;
      color:var(--ink); font:16px/1.5 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      padding:26px; min-height:100dvh;
    }
    @media (max-width:860px){ body{ background-attachment:scroll } }

    .back-btn{ position:fixed; top:26px; left:26px; z-index:9999; display:inline-flex; gap:8px; align-items:center;
      padding:10px 14px; border-radius:14px; background:var(--accent); color:#fff; text-decoration:none; font-weight:800;
      border:1px solid rgba(0,0,0,.06); box-shadow:0 6px 16px rgba(0,0,0,.24); transition:.08s }
    .back-btn:hover{ filter:brightness(1.05); transform:translateY(-1px) }

    .wrap{ max-width:clamp(1100px,95vw,1500px); margin:0 auto }

    /* ===== Card with glow + accent ring box ===== */
    .card{
      position:relative; background:var(--card);
      border:1px solid var(--line); border-radius:22px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      padding:22px 22px 18px;
    }
    .card::before{ /* soft glow behind */
      content:""; position:absolute; inset:-14px; border-radius:32px; z-index:-1;
      background:var(--accent); opacity:.16;
      box-shadow:0 0 18px var(--glow1),0 0 28px var(--glow2); filter:blur(14px);
    }
    .card::after{ /* visible ring around whole thing */
      content:""; position:absolute; inset:-2px; border-radius:24px; pointer-events:none;
      box-shadow:
        0 0 0 2px var(--accentRing),              /* outer accent ring */
        inset 0 0 0 1.3px rgba(255,255,255,.18);  /* crisp inner rim */
    }

    h1{margin:4px 0 8px; display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap}
    h1 .script{font-weight:900; font-size:36px; letter-spacing:.2px; color:var(--accent)}
    h1 .tag{font-weight:800; font-size:28px; padding:2px 10px; border-radius:14px; color:#cdd6f2}
    h1 small{display:block; font-weight:600; font-size:14px; color:var(--muted); margin-top:-2px}
    .sub{margin:0 0 16px; color:var(--muted)}

    /* compact add form */
    form#entry-form{
      display:grid; grid-template-columns: 1.2fr 1.2fr 1fr auto;
      gap:12px; align-items:end;
    }
    label span{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px 6px }
    input[type="text"]{
      width:100%; padding:12px; border:1px solid var(--line); border-radius:14px; outline:none;
      background:var(--field); color:var(--ink); transition:box-shadow .16s, border .16s;
    }
    input[type="text"]::placeholder{ color:#8fa0c4; opacity:.9; font-style:italic }
    input[type="text"]:focus{ border-color:var(--accent); box-shadow:0 0 0 3px var(--focusRing) }
    button.add{ height:46px; padding:0 16px; border:0; border-radius:14px; background:var(--accent); color:#fff; font-weight:800; letter-spacing:.3px; cursor:pointer }

    .toolbar{ display:flex; align-items:center; gap:10px; margin:14px 0 6px }
    .pill{ border:1px solid var(--line); background:var(--field); padding:8px 12px; border-radius:999px; font-size:13px; color:#d6dbef }
    .pill strong{ color:#fff } .right{ margin-left:auto } .toggle{ cursor:pointer }

    .table-wrap{ margin-top:8px; overflow:auto }
    table{ width:100%; border-collapse:separate; border-spacing:0 }
    thead th{ position:sticky; top:0; background:var(--card); z-index:1 }
    th,td{ border-bottom:1px solid var(--line); padding:14px 10px; text-align:left }
    th{ font-size:13px; color:#bac4e4; font-weight:700; letter-spacing:.3px }
    tbody tr{ transition:background .12s } tbody tr:hover td{ background:var(--hover) }
    td{ vertical-align:middle; color:var(--ink); overflow-wrap:anywhere }
    .hanzi{ font-size:20px; font-family:"Noto Serif SC","Noto Sans SC",system-ui,sans-serif; font-weight:700 }
    .actions{ width:140px; text-align:right; white-space:nowrap }
    .actions .btnrow{ display:flex; gap:8px; justify-content:flex-end }

    /* balanced column widths */
    col.col-pron{width:26%}
    col.col-details{width:38%}
    col.col-meaning{width:24%}
    col.col-hanzi{width:12%}

    .icon-btn{ border:0; background:transparent; cursor:pointer; padding:6px 8px; border-radius:10px; color:#cfd6f1; display:inline-flex; align-items:center; justify-content:center }
    .icon-btn:hover{ background:rgba(255,255,255,.06) }
    .icon-btn svg{ width:18px; height:18px; display:block }
    tr.editing td{ background:rgba(122,90,248,.07) }
    tbody td{ font-family:"JetBrains Mono","Poppins","Inter",sans-serif; font-weight:600; font-style:italic; letter-spacing:.2px }
    .sample td{ color:rgba(255,255,255,.45) }
    .pinyin{ cursor:help }

    /* Details rendering */
    .details mark{ background:rgba(255,248,115,.3); color:#fff; padding:0 .25em; border-radius:.25em }
    .details img.zoomable{ max-width:100%; max-height:140px; border-radius:12px; display:block; margin:6px 0; box-shadow:0 8px 24px rgba(0,0,0,.25); cursor:zoom-in }
    .details code{ background:rgba(255,255,255,.06); padding:.1em .35em; border-radius:.35em }

    /* WYS editor */
    .wys{
      min-height:120px; padding:10px 12px; border:1px solid var(--line); border-radius:10px;
      background:var(--field); color:var(--ink); font-style:italic; font-weight:600;
    }
    .wys:focus{ outline:none; box-shadow:0 0 0 3px var(--focusRing); border-color:var(--accent) }
    .edit-tools{ display:flex; gap:8px; align-items:center; margin-top:8px }
    .mini{ height:34px; padding:0 12px; border-radius:10px; border:1px solid var(--line); background:transparent; color:#d6dbef; font-weight:800; cursor:pointer }
    .mini:hover{ background:rgba(255,255,255,.06) }

    /* Lightbox (no buttons) */
    #lightbox[hidden]{ display:none }
    #lightbox{ position:fixed; inset:0; background:rgba(0,0,0,.8); display:flex; align-items:center; justify-content:center; z-index:99999 }
    #lightbox .lb-inner{ position:relative; max-width:92vw; max-height:92vh }
    #lightbox img{ max-width:92vw; max-height:92vh; transform-origin:center; transition:transform .08s linear }

    /* spacing polish */
    tbody td:nth-child(2){ padding-right:12px } /* Pronunciation → */
    thead th:nth-child(2){ padding-right:12px }
    tbody td:nth-child(3){ padding-right:22px } /* Details → */
    thead th:nth-child(3){ padding-right:22px }
    tbody td:nth-child(4){ padding-left:22px }  /* ← Meaning */
    thead th:nth-child(4){ padding-left:22px }
    thead th:nth-child(3), tbody td:nth-child(3),
    thead th:nth-child(4), tbody td:nth-child(4){ border-left:1px solid var(--col-gap-hair) }

    /* ===== Number column fix: no wrapping, normal font, tabular digits ===== */
    th.num, td.num{
      width:56px; text-align:center; color:#98a3c9;
      white-space:nowrap; overflow-wrap:normal; word-break:keep-all;
      font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-style:normal; letter-spacing:0;
      font-variant-numeric: tabular-nums; font-feature-settings:"tnum" 1, "lnum" 1;
    }

    @media (max-width:1200px){
      col.col-pron{width:28%} col.col-details{width:38%} col.col-meaning{width:22%} col.col-hanzi{width:12%}
    }
    @media (max-width:860px){
      form#entry-form{ grid-template-columns:1fr }
      .actions{ width:120px }
      thead th:nth-child(3), tbody td:nth-child(3),
      thead th:nth-child(4), tbody td:nth-child(4){ border-left:0 }
      tbody td:nth-child(3){ padding-right:16px }
      tbody td:nth-child(4){ padding-left:16px }
    }

    /* ===== Hidden YouTube holder ===== */
    #yt-holder{ position:absolute; width:1px; height:1px; left:-9999px; top:auto; opacity:0; pointer-events:none }

    /* ===== Bottom-left music controls ===== */
    .bg-audio{
      position:fixed; bottom:20px; left:20px; z-index:9999;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:14px;
      background:rgba(15,21,43,.85); border:1px solid var(--line);
      box-shadow:0 10px 24px rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
    }
    .bg-audio::after{
      content:""; position:absolute; inset:-2px; border-radius:16px; pointer-events:none;
      box-shadow:0 0 0 2px var(--accentRing), inset 0 0 0 1px rgba(255,255,255,.15);
    }
    .music-btn{
      width:38px; height:38px; border:0; border-radius:999px; cursor:pointer;
      background:var(--accent); color:#fff; display:grid; place-items:center;
      box-shadow:0 6px 16px rgba(0,0,0,.25); transition:.12s;
    }
    .music-btn:hover{ filter:brightness(1.05); transform:translateY(-1px) }
    .music-volume{ width:140px }
    .music-vol-label{ font-size:12px; color:var(--muted); min-width:34px; text-align:right }
    @media (max-width:540px){
      .music-volume{ width:110px }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/dist/umd/supabase.min.js"></script>
</head>
<body>
  <a id="backBtn" class="back-btn" href="#"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg><span>Back/返回</span></a>

  <div class="wrap">
    <div class="card">
      <h1>
        <span class="script">Learning</span>
        <span class="tag">Mandarin words that are COOL</span>
        <small>quick study list • pinyin → meaning → 汉字 • add notes/images later via <em>Edit</em></small>
      </h1>
      <p class="sub">Hover Pronunciation for a simple English-y sound guide. Click <strong>Edit</strong> on any row to add <em>Details</em> with text highlighting and real images (no links).</p>

      <!-- compact add form -->
      <form id="entry-form" autocomplete="off">
        <label><span>Pronunciation (Pinyin)</span><input id="pinyin" type="text" placeholder="nĭ hăo" required></label>
        <label><span>Meaning (English)</span><input id="meaning" type="text" placeholder="Hello" required></label>
        <label><span>Mandarin (汉字)</span><input id="hanzi" type="text" placeholder="你好" required></label>
        <button class="add" type="submit">Add</button>
      </form>

      <div class="toolbar">
        <span class="pill">Total: <strong id="count">0</strong></span>
        <span class="right pill toggle" id="themeToggle">Switch accent 💜/💚</span>
      </div>

      <div class="table-wrap">
        <table aria-label="Useful Mandarin words list">
          <colgroup>
            <col style="width:56px">
            <col class="col-pron">
            <col class="col-details">
            <col class="col-meaning">
            <col class="col-hanzi">
            <col style="width:140px">
          </colgroup>
          <thead>
            <tr>
              <th class="num">#</th>
              <th>Pronunciation</th>
              <th>Details</th>
              <th>Meaning</th>
              <th>Mandarin</th>
              <th class="actions">Actions</th>
            </tr>
          </thead>
          <tbody id="list"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Lightbox -->
  <div id="lightbox" hidden>
    <div class="lb-inner">
      <img id="lbImg" src="" alt="">
    </div>
  </div>

  <!-- Hidden YouTube player container -->
  <div id="yt-holder" aria-hidden="true"></div>

  <!-- Bottom-left music controls -->
  <div class="bg-audio" role="group" aria-label="Background music player">
    <button id="musicToggle" class="music-btn" aria-pressed="false" aria-label="Play music" title="Play/Pause"></button>
    <input id="musicVolume" class="music-volume" type="range" min="0" max="100" value="60" aria-label="Volume">
    <span id="musicVolLabel" class="music-vol-label">60%</span>
  </div>

  <script>
  (function(){
    const back = document.getElementById('backBtn');
    back?.addEventListener('click',(e)=>{ e.preventDefault(); if(document.referrer && document.referrer!==location.href){ history.back(); } else { location.href='index.html'; } });

    // Supabase
    const SUPABASE_URL = "https://tmjozxcjylcxgemffnoc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtam96eGNqeWxjeGdlbWZmbm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzQxMzIsImV4cCI6MjA2NzY1MDEzMn0.W3VWFN5tiPhkoVzW_iZsYIZAcWn01LL2YfdI8zBowVI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const TABLE = 'learning_words';
    const BUCKET = 'learning_media';

    // Elements
    const form = document.getElementById('entry-form');
    const pinyinEl = document.getElementById('pinyin');
    const meaningEl = document.getElementById('meaning');
    const hanziEl  = document.getElementById('hanzi');
    const themeToggle = document.getElementById('themeToggle');
    const listEl = document.getElementById('list');
    const countEl = document.getElementById('count');

    // Theme toggle
    const THEME_KEY='mandarin_words_theme';
    const savedTheme=localStorage.getItem(THEME_KEY);
    if(savedTheme){ document.documentElement.setAttribute('data-theme', savedTheme); }
    themeToggle?.addEventListener('click', ()=>{
      const now=document.documentElement.getAttribute('data-theme')==='mint'?'':'mint';
      if(now){ document.documentElement.setAttribute('data-theme','mint'); } else { document.documentElement.removeAttribute('data-theme'); }
      localStorage.setItem(THEME_KEY, now);
    });

    // Data
    let rows=[]; let hintMode=false;
    function sortRows(){ try{ rows.sort((a,b)=>((a?.position??0)-(b?.position??0))||(new Date(a?.created_at||0)-new Date(b?.created_at||0))); }catch{} }

    async function loadInitial(){
      const { data, error } = await supabase.from(TABLE).select('*').order('position',{ascending:true}).order('created_at',{ascending:true});
      if(error) console.error(error);
      if(!data || data.length===0){
        hintMode=true;
        rows=[{ id:'sample', pinyin:'nĭ hăo', details:'', meaning:'Hello', hanzi:'你好', position:0 }];
      }else{ rows=data; sortRows(); }
      render();
    }

    function startRealtime(){
      supabase.channel('rt-learning-words')
        .on('postgres_changes',{event:'INSERT',schema:'public',table:TABLE},p=>addOrUpdate(p.new))
        .on('postgres_changes',{event:'UPDATE',schema:'public',table:TABLE},p=>addOrUpdate(p.new))
        .on('postgres_changes',{event:'DELETE',schema:'public',table:TABLE},p=>removeById(p.old.id,true))
        .subscribe();
    }
    function addOrUpdate(rec){ if(hintMode){ hintMode=false; rows=[]; } const i=rows.findIndex(r=>r.id===rec.id); if(i===-1) rows.push(rec); else rows[i]=rec; sortRows(); render(); }

    /* phonetics */
    const deTone=s=>s.replace(/./g,ch=>({'ā':'a','á':'a','ǎ':'a','à':'a','Ā':'A','Á':'A','Ǎ':'A','À':'A','ē':'e','é':'e','ě':'e','è':'e','Ē':'E','É':'E','Ě':'E','È':'E','ī':'i','í':'i','ǐ':'i','ì':'i','Ī':'I','Í':'I','Ǐ':'I','Ì':'I','ō':'o','ó':'o','ǒ':'o','ò':'o','Ō':'O','Ó':'O','Ǒ':'O','Ò':'O','ū':'u','ú':'u','ǔ':'u','ù':'u','Ū':'U','Ú':'U','Ǔ':'U','Ù':'U','ǖ':'ü','ǘ':'ü','ǚ':'ü','ǜ':'ü','Ü':'Ü','Ǖ':'Ü','Ǘ':'Ü','Ǚ':'Ü','Ǜ':'Ü','ń':'n','ň':'n','ǹ':'n','ḿ':'m'}[ch]??ch)).replace(/[’'·]/g,' ').toLowerCase();
    const splitInitialFinal=s=>{ const two=['zh','ch','sh']; for(const t of two) if(s.startsWith(t)) return [t,s.slice(2)]; const o=s[0]; if(/[bpmfdtnlgkhjqxrzcswy]/.test(o)) return [o,s.slice(1)]; return ['',s]; };
    const initialEng=i=>({'zh':'j','ch':'ch','sh':'sh','z':'dz','c':'ts','s':'s','x':'sh','q':'ch','j':'j','r':'r','y':'y','w':'w','b':'b','p':'p','m':'m','f':'f','d':'d','t':'t','n':'n','l':'l','g':'g','k':'k','h':'h','':''}[i]??i);
    function finalEng(i,f){ if(['zh','ch','sh','r','z','c','s'].includes(i)&&f==='i') return 'rr';
      if((i==='j'||i==='q'||i==='x'||i==='y')&&f.startsWith('ue')) f='weh';
      if(f==='ü') f='yoo'; if(f==='ün') f='yun'; if(f==='üe') f='weh';
      const map=[['iang','yahng'],['iong','yong'],['uang','wahng'],['uan','wahn'],['ang','ahng'],['ong','ohng'],['iao','yow'],['ian','yen'],['uai','why'],['ui','way'],['iu','yoe'],['ie','yeh'],['ia','yah'],['uo','woh'],['ou','oe'],['ei','ay'],['ai','eye'],['eng','uhng'],['en','uhn'],['an','ahn'],['er','ar'],['e','uh'],['o','oh'],['a','ah'],['u','oo'],['i','ee']];
      for(const [pat,to] of map){ if(f===pat) return to; if(f.endsWith(pat)) return f.replace(pat,to); } return f; }
    function pinyinToEasyEnglish(p){ const clean=deTone(p).trim(); if(!clean) return ''; return clean.split(/\s+/).map(s=>{const [i,f]=splitInitialFinal(s); return (initialEng(i)+finalEng(i,f)).replace(/^you$/,'yoe');}).join(' '); }
    function applyPhonetics(scope=document){ scope.querySelectorAll('.pinyin').forEach(td=>{ const raw=(td.textContent||'').trim(); td.title = raw ? pinyinToEasyEnglish(raw) : ''; }); }

    /* Details renderer */
    function renderDetails(raw=''){
      let s=(raw||'').replace(/\r\n?/g,'\n').trim();
      const tokens=[];
      s=s.replace(/<img\b[^>]*>/gi, tag=>{
        const src=(tag.match(/\bsrc\s*=\s*"(.*?)"/i)||[])[1] || '';
        const alt=(tag.match(/\balt\s*=\s*"(.*?)"/i)||[])[1] || '';
        if(!/^https?:\/\//i.test(src)) return '';
        const id=tokens.push(`<img class="zoomable" src="${src}" alt="${alt.replace(/"/g,'&quot;')}">`) - 1;
        return `\u0000IMG${id}\u0000`;
      });
      s=s.replace(/!\[([^\]]*)\]\(([^)]+)\)/g,(_,alt,url)=>{
        const u=(url||'').trim(); if(!u) return _;
        const id=tokens.push(`<img class="zoomable" src="${u}" alt="${(alt||'').replace(/"/g,'&quot;')}">`) - 1;
        return `\u0000IMG${id}\u0000`;
      });
      s=s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      s=s.replace(/==(.+?)==/g,'<mark>$1</mark>')
         .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
         .replace(/\*(.+?)\*/g,'<em>$1</em>')
         .replace(/`(.+?)`/g,'<code>$1</code>')
         .replace(/\n/g,'<br>');
      s=s.replace(/\u0000IMG(\d+)\u0000/g,(_,i)=>tokens[+i]);
      return s;
    }

    function sanitizeWys(html){
      html = html.replace(/<\/?(?!img|strong|em|mark|code|br)\w+[^>]*>/gi, '');
      html = html.replace(/<img\b([^>]*)>/gi, (m,attrs)=>{
        const src=(attrs.match(/\bsrc\s*=\s*"(.*?)"/i)||[])[1]||'';
        const alt=(attrs.match(/\balt\s*=\s*"(.*?)"/i)||[])[1]||'';
        if(!/^https?:\/\//i.test(src)) return '';
        return `<img src="${src}" alt="${alt.replace(/"/g,'&quot;')}">`;
      });
      return html;
    }

    function render(){
      listEl.innerHTML='';
      rows.forEach((row,idx)=>{
        const tr=document.createElement('tr'); if(hintMode) tr.classList.add('sample'); tr.dataset.id=row.id;

        const num=document.createElement('td'); num.className='num'; num.textContent=hintMode?'':(idx+1); tr.appendChild(num);
        tr.appendChild(makeCell(row.pinyin,'pinyin'));

        const det=document.createElement('td'); det.className='details'; det.dataset.raw=row.details??''; det.innerHTML=renderDetails(row.details??''); tr.appendChild(det);

        tr.appendChild(makeCell(row.meaning));
        tr.appendChild(makeCell(row.hanzi,'hanzi'));

        const actions=document.createElement('td'); actions.className='actions';
        const rowBtns=document.createElement('div'); rowBtns.className='btnrow';
        const edit=iconBtn('Edit',pencil()); edit.dataset.mode='edit';
        const del =iconBtn('Delete',trash());
        rowBtns.appendChild(edit); rowBtns.appendChild(del); actions.appendChild(rowBtns);
        tr.appendChild(actions);

        edit.addEventListener('click',()=>toggleEdit(tr, edit, rowBtns));
        del.addEventListener('click',()=>removeById(row.id));

        listEl.appendChild(tr);
      });
      countEl.textContent=hintMode?0:rows.length;
      applyPhonetics(listEl);
    }

    function makeCell(text,cls){ const td=document.createElement('td'); td.textContent=text??''; if(cls) td.classList.add(cls); td.contentEditable=false; td.spellcheck=false; return td; }
    function iconBtn(title,svg){ const b=document.createElement('button'); b.className='icon-btn'; b.title=title; b.innerHTML=svg; return b; }

    async function uploadToBucket(file){
      if(file.size>6*1024*1024){ alert('Please choose an image under 6 MB.'); return null; }
      const ext=(file.name.split('.').pop()||'jpg').toLowerCase();
      const path=`details/${Date.now()}_${Math.random().toString(36).slice(2)}.${ext}`;
      const { error } = await supabase.storage.from(BUCKET).upload(path, file, { upsert:false, cacheControl:'3600' });
      if(error){ console.warn('Upload failed', error); alert('Upload failed. Check bucket + policies.'); return null; }
      const { data } = supabase.storage.from(BUCKET).getPublicUrl(path);
      return data?.publicUrl || null;
    }

    function toggleEdit(tr, editBtn, btnRow){
      const id=tr.dataset.id;
      const [ , pron, det, mean, han ] = tr.querySelectorAll('td');

      if(editBtn.dataset.mode==='edit'){
        if(hintMode){ hintMode=false; }

        [pron,mean,han].forEach(td=>{ td.contentEditable=true; td.spellcheck=false; });
        pron.focus();

        const currentHTML = renderDetails(det.dataset.raw || det.textContent || '');
        det._oldRaw = det.dataset.raw || '';
        det._oldHTML = det.innerHTML;
        det.innerHTML='';
        const wys=document.createElement('div'); wys.className='wys'; wys.contentEditable='true'; wys.innerHTML=currentHTML;
        det.appendChild(wys);

        const tools=document.createElement('div'); tools.className='edit-tools';
        tools.innerHTML = `
          <button type="button" class="mini" data-a="bold">**B**</button>
          <button type="button" class="mini" data-a="italic"><em>i</em></button>
          <button type="button" class="mini" data-a="highlight">==HL==</button>
          <button type="button" class="mini" data-a="photo">📷 Add Photo</button>
          <input type="file" accept="image/*" hidden>
        `;
        det.appendChild(tools);

        const fileInput = tools.querySelector('input[type="file"]');
        tools.addEventListener('click', async (e)=>{
          const a = e.target.closest('button')?.dataset.a;
          if(!a) return;
          if(a==='photo'){ fileInput.click(); return; }
          if(a==='bold') document.execCommand('bold');
          if(a==='italic') document.execCommand('italic');
          if(a==='highlight'){
            const sel=window.getSelection();
            if(sel && sel.rangeCount){
              const span=document.createElement('mark');
              sel.getRangeAt(0).surroundContents(span);
            }
          }
          wys.focus();
        });
        fileInput.addEventListener('change', async ()=>{
          const f=fileInput.files?.[0]; if(!f) return;
          const url=await uploadToBucket(f); if(!url){ fileInput.value=''; return; }
          const img=document.createElement('img'); img.src=url; img.alt=''; img.className='zoomable';
          wys.appendChild(img);
          fileInput.value='';
          wys.focus();
        });

        btnRow.innerHTML='';
        const save=iconBtn('Save',check());
        const cancel=iconBtn('Cancel',xmark());
        btnRow.appendChild(save); btnRow.appendChild(cancel);

        save.addEventListener('click', async ()=>{
          const newPinyin=pron.textContent.trim();
          const newMeaning=mean.textContent.trim();
          const newHanzi=han.textContent.trim();
          const safeHtml = sanitizeWys(wys.innerHTML);
          const newRaw = safeHtml;

          det.dataset.raw=newRaw;
          det.innerHTML=renderDetails(newRaw);

          [pron,mean,han].forEach(td=>{ td.contentEditable=false; });
          btnRow.innerHTML=''; const edit2=iconBtn('Edit',pencil()); const del2=iconBtn('Delete',trash());
          edit2.dataset.mode='edit'; btnRow.appendChild(edit2); btnRow.appendChild(del2);
          edit2.addEventListener('click',()=>toggleEdit(tr, edit2, btnRow));
          del2.addEventListener('click',()=>removeById(id));

          if(id && id!=='sample'){
            const { error } = await supabase.from(TABLE).update({ pinyin:newPinyin, details:newRaw, meaning:newMeaning, hanzi:newHanzi }).eq('id',id);
            if(error){
              console.warn('Update failed (maybe details column missing). Run once:\nALTER TABLE public.learning_words ADD COLUMN details text;', error);
              await supabase.from(TABLE).update({ pinyin:newPinyin, meaning:newMeaning, hanzi:newHanzi }).eq('id',id);
            }
          }
          tr.classList.remove('editing');
          applyPhonetics(tr);
        });

        cancel.addEventListener('click', ()=>{
          det.dataset.raw = det._oldRaw || '';
          det.innerHTML = det._oldHTML || '';
          [pron,mean,han].forEach(td=>{ td.contentEditable=false; });
          btnRow.innerHTML=''; const edit2=iconBtn('Edit',pencil()); const del2=iconBtn('Delete',trash());
          edit2.dataset.mode='edit'; btnRow.appendChild(edit2); btnRow.appendChild(del2);
          edit2.addEventListener('click',()=>toggleEdit(tr, edit2, btnRow));
          del2.addEventListener('click',()=>removeById(id));
          tr.classList.remove('editing');
        });

        tr.classList.add('editing');
      }
    }

    async function removeById(id, silent){
      if(!id || id==='sample') return;
      if(!silent){ const i=rows.findIndex(r=>r.id===id); if(i>-1){ rows.splice(i,1); render(); } }
      const { error } = await supabase.from(TABLE).delete().eq('id', id);
      if(error) console.error(error);
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const p=pinyinEl.value.trim(), m=meaningEl.value.trim(), h=hanziEl.value.trim();
      if(!p || !m || !h){
        [pinyinEl,meaningEl,hanziEl].forEach(el=>{ if(!el.value?.trim()){ el.style.boxShadow='0 0 0 3px rgba(255,0,0,.18)'; el.style.borderColor='#ff9494'; setTimeout(()=>{el.style.boxShadow=''; el.style.borderColor='';},900); } });
        return;
      }
      if(hintMode){ rows=[]; hintMode=false; }
      const nextPos=rows.length;

      const { data, error } = await supabase
        .from(TABLE)
        .insert({ pinyin:p, details:'', meaning:m, hanzi:h, position:nextPos })
        .select().single();

      if(error){ console.error(error); return; }
      addOrUpdate(data);
      form.reset(); pinyinEl.focus();
    });

    const pencil=()=>'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 1 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>';
    const check =()=>'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>';
    const trash =()=>'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>';
    const xmark=()=>'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';

    // Lightbox (scroll to zoom, click outside/ESC to close)
    const lightbox=document.getElementById('lightbox');
    const lbImg=document.getElementById('lbImg');
    let scale=1;
    function openLightbox(src){ lbImg.src=src; scale=1; lbImg.style.transform='scale(1)'; lightbox.hidden=false; }
    function closeLightbox(){ lightbox.hidden=true; }
    lbImg.addEventListener('wheel',(e)=>{
      e.preventDefault();
      scale = e.deltaY<0 ? Math.min(scale*1.2,8) : Math.max(scale/1.2,.5);
      lbImg.style.transform=`scale(${scale})`;
    },{passive:false});
    lightbox.addEventListener('click',(e)=>{ if(e.target===lightbox) closeLightbox(); });
    window.addEventListener('keydown',(e)=>{ if(!lightbox.hidden && e.key==='Escape') closeLightbox(); });
    document.addEventListener('click',(e)=>{ const img=e.target.closest('.details img.zoomable'); if(img) openLightbox(img.src); });

    /* ========== Background music (YouTube) ========== */
    const YT_VIDEO_ID = 'WR8C7qwmurA'; // your song
    const volSlider = document.getElementById('musicVolume');
    const volLabel  = document.getElementById('musicVolLabel');
    const toggleBtn = document.getElementById('musicToggle');
    const PLAY_KEY = 'bg_music_play';
    const VOL_KEY  = 'bg_music_vol';

    const playIcon  = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';
    const pauseIcon = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>';

    let ytPlayer = null;

    function setBtn(isPlaying){
      toggleBtn.innerHTML = isPlaying ? pauseIcon : playIcon;
      toggleBtn.setAttribute('aria-pressed', isPlaying ? 'true' : 'false');
      toggleBtn.setAttribute('aria-label', isPlaying ? 'Pause music' : 'Play music');
    }

    function setVolUI(v){
      volSlider.value = v;
      volLabel.textContent = v + '%';
    }

    // Load saved volume
    const savedVol = Math.min(100, Math.max(0, parseInt(localStorage.getItem(VOL_KEY) || '60', 10)));
    setVolUI(savedVol);
    setBtn(false);

    // Inject YT IFrame API
    (function injectYT(){
      if(document.getElementById('yt-iframe-api')) return;
      const s=document.createElement('script');
      s.id='yt-iframe-api';
      s.src='https://www.youtube.com/iframe_api';
      document.head.appendChild(s);
    })();

    // YT global callback
    window.onYouTubeIframeAPIReady = function(){
      ytPlayer = new YT.Player('yt-holder', {
        height:'1', width:'1', videoId: YT_VIDEO_ID,
        playerVars:{
          controls:0, disablekb:1, fs:0, rel:0, modestbranding:1, playsinline:1,
          loop:1, playlist: YT_VIDEO_ID
        },
        events:{
          onReady: (e)=>{
            ytPlayer.setVolume(parseInt(volSlider.value,10));
            ytPlayer.pauseVideo(); // wait for user gesture
            setBtn(false);
          },
          onStateChange: (e)=>{
            if(e.data === YT.PlayerState.ENDED){ ytPlayer.playVideo(); }
            // Update button icon live
            setBtn(e.data === YT.PlayerState.PLAYING);
          }
        }
      });
    };

    // UI events
    toggleBtn.addEventListener('click', ()=>{
      if(!ytPlayer) return;
      const state = ytPlayer.getPlayerState();
      if(state === YT.PlayerState.PLAYING){
        ytPlayer.pauseVideo();
        localStorage.setItem(PLAY_KEY, '0');
      }else{
        ytPlayer.unMute();
        ytPlayer.playVideo();
        localStorage.setItem(PLAY_KEY, '1');
      }
    });

    volSlider.addEventListener('input', ()=>{
      const v = parseInt(volSlider.value,10);
      volLabel.textContent = v + '%';
      if(ytPlayer) ytPlayer.setVolume(v);
      localStorage.setItem(VOL_KEY, String(v));
    });

    // Init data + realtime
    loadInitial(); startRealtime();
  })();
  </script>
</body>
</html>
